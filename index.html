<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="å€‹äººè²¡å‹™è¨˜å¸³æ‡‰ç”¨ç¨‹å¼">
    <meta name="theme-color" content="#0a0a0c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ledger">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Ledger - Personal Finance</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%230a0a0c'/%3E%3Cpath fill='%23ffffff' d='M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zm80 256h64c44.2 0 80 35.8 80 80c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16c0-44.2 35.8-80 80-80zm-32-96a64 64 0 1 1 128 0 64 64 0 1 1 -128 0zm256-32H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16zm0 64H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16zm0 64H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16z'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%230a0a0c'/%3E%3Cpath fill='%23ffffff' d='M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zm80 256h64c44.2 0 80 35.8 80 80c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16c0-44.2 35.8-80 80-80zm-32-96a64 64 0 1 1 128 0 64 64 0 1 1 -128 0zm256-32H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16zm0 64H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16zm0 64H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');

        :root {
            --primary: #ffffff;
            --accent: #ffffff;
            --accent-rgb: 255, 255, 255;
            --bg-deep: #0a0a0c;
            --card-bg: rgba(28, 28, 32, 0.7);
            --glow: 0 0 20px rgba(255, 255, 255, 0.1);
            --flask-water: #3b82f6;
        }

        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: #ffffff;
            height: 100vh;
            height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡ */
            margin: 0;
            padding: 0;
            overflow: hidden;
            transition: background-color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
            /* æ”¯æŒå…¨å±æ¨¡å¼ */
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }
        
        /* æ”¯æŒ iOS Safari å…¨å±æ¨¡å¼ */
        @supports (-webkit-touch-callout: none) {
            body {
                height: -webkit-fill-available;
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle at 50% 0%, rgba(var(--accent-rgb), 0.08) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            transition: background 0.5s ease;
        }

        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: var(--glow);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .page-transition {
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .hidden-page { display: none !important; }
        
        /* æ‘ºç–Šå€åŸŸéæ¸¡æ•ˆæœ */
        .collapsible-section {
            transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out, padding 0.3s ease-in-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .collapsible-section.expanded {
            max-height: 600px;
            opacity: 1;
        }
        
        /* ç§»å‹•ç«¯éŸ¿æ‡‰å¼å„ªåŒ– */
        @media (max-width: 480px) {
            #app {
                max-width: 100%;
            }
            
            .glass-panel {
                margin: 0 4px;
            }
            
            /* Modal åœ¨ç§»å‹•ç«¯çš„å„ªåŒ– */
            #helpModal > div,
            #recurringModal > div,
            #cardModal > div,
            #paymentModal > div,
            #cloudInfoModal > div {
                max-height: calc(100vh - 32px);
                margin: 16px;
                padding: 20px !important;
            }
            
            /* ç¢ºä¿å…§å®¹ä¸æœƒè¶…å‡ºè¢å¹• */
            main {
                padding-bottom: 120px !important;
            }
            
            /* åº•éƒ¨å°èˆªåœ¨ç§»å‹•ç«¯çš„å„ªåŒ– */
            .nav-dock-container {
                width: calc(100% - 32px);
                bottom: 16px;
            }
        }
        
        /* iOS Safari PWA æ¨¡å¼å„ªåŒ– */
        @supports (-webkit-touch-callout: none) {
            #app {
                height: -webkit-fill-available;
            }
            
            /* ç¢ºä¿ Modal åœ¨ iOS ä¸Šæ­£ç¢ºé¡¯ç¤º */
            #helpModal,
            #recurringModal,
            #cardModal,
            #paymentModal,
            #cloudInfoModal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #helpModal > div,
            #recurringModal > div,
            #cardModal > div,
            #paymentModal > div,
            #cloudInfoModal > div {
                margin: 16px;
                max-height: calc(100vh - 32px);
            }
        }

        /* Auth Page Styles */
        .auth-tab-active {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            color: white;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .auth-tab-inactive {
            background: transparent;
            color: rgba(255, 255, 255, 0.3);
            border: 1px solid transparent;
        }

        .auth-tab-inactive:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .nav-dock-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 50;
        }

        .nav-dock {
            background: rgba(15, 15, 18, 0.85);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(var(--accent-rgb), 0.15);
            border-radius: 40px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .nav-btn { color: rgba(255, 255, 255, 0.2); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-btn.active { color: var(--accent); transform: scale(1.15); filter: drop-shadow(0 0 8px var(--accent)); }

        .center-add-btn {
            width: 60px;
            height: 60px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-20px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5), 0 0 20px rgba(var(--accent-rgb), 0.4);
            transition: all 0.3s ease;
        }

        .brand-title {
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.15em;
            background: linear-gradient(to bottom, #fff 40%, rgba(var(--accent-rgb), 0.4));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .by-owen {
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.3em;
            font-size: 7px;
            text-transform: uppercase;
            opacity: 0.4;
        }

        .dynamic-accent-bg { background-color: var(--accent); transition: all 0.3s ease; }
        .dynamic-accent-text { color: var(--accent); transition: all 0.3s ease; }
        
        .flask-container {
            position: relative;
            width: 150px;
            height: 200px;
            margin: 0 auto;
              animation: flask-sway 7s cubic-bezier(0.45, 0.05, 0.55, 0.95) infinite;
            filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.4));
        }

        .flask {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 160px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.02) 0%,
                rgba(255, 255, 255, 0.005) 50%,
                rgba(255, 255, 255, 0.02) 100%);
            border-radius: 18% 18% 45% 45%;
            border: 2.5px solid rgba(255, 255, 255, 0.3);
            border-left-color: rgba(255, 255, 255, 0.4);
            border-right-color: rgba(255, 255, 255, 0.15);
            overflow: hidden;
            backdrop-filter: blur(12px);
            z-index: 2;
            box-shadow: 
                inset -20px 0 35px rgba(0, 0, 0, 0.25),
                inset 20px 0 35px rgba(255, 255, 255, 0.08),
                inset 0 -15px 25px rgba(0, 0, 0, 0.15);
        }

        .flask::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.03) 25%,
                transparent 50%,
                rgba(0, 0, 0, 0.05) 75%,
                transparent 100%);
            pointer-events: none;
        }

        .flask-neck {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 45px;
            height: 60px;
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.03) 0%,
                rgba(255, 255, 255, 0.01) 100%);
            border: 2.5px solid rgba(255, 255, 255, 0.3);
            border-left-color: rgba(255, 255, 255, 0.4);
            border-right-color: rgba(255, 255, 255, 0.15);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            z-index: 1;
            backdrop-filter: blur(12px);
            box-shadow: 
                inset -10px 0 20px rgba(0, 0, 0, 0.2),
                inset 10px 0 20px rgba(255, 255, 255, 0.08);
        }

        .flask-neck::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px 10px 0 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .flask-measurements {
            position: absolute;
            right: 8px;
            top: 20%;
            height: 60%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 3;
            opacity: 0.3;
        }

        .measurement-line {
            width: 12px;
            height: 1px;
            background: rgba(255, 255, 255, 0.4);
        }

        .measurement-line.major {
            width: 18px;
            height: 1.5px;
            background: rgba(255, 255, 255, 0.6);
        }

        .liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 0%;
            background: transparent;
            transition: height 2s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible;
        }

        .liquid-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 30% 40%, 
                    var(--liquid-color-light, #60a5fa) 0%,
                    transparent 60%),
                radial-gradient(ellipse at 70% 60%, 
                    var(--liquid-color-mid, #2563eb) 0%,
                    transparent 50%),
                linear-gradient(to top, 
                    var(--liquid-color-dark, #1d4ed8) 0%,
                    var(--liquid-color-mid, #2563eb) 50%,
                    var(--liquid-color-light, #60a5fa) 100%);
            transition: background 1.2s ease;
            box-shadow: 
                inset 0 20px 30px rgba(255,255,255,0.2),
                inset 0 -10px 25px rgba(0,0,0,0.3),
                inset -15px 0 25px rgba(0,0,0,0.15),
                inset 15px 0 20px rgba(255,255,255,0.12);
            animation: liquid-shimmer 4s ease-in-out infinite;
        }

        .liquid-surface {
            position: absolute;
            top: -25px;
            left: -10%;
            width: 120%;
            height: 50px;
            background: transparent;
            z-index: 10;
        }

        .wave-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: 
                radial-gradient(ellipse 100% 50% at 25% 50%, 
                    var(--liquid-color-light, #60a5fa) 0%,
                    var(--liquid-color-mid, #2563eb) 40%,
                    transparent 70%);
            filter: url('#liquid-filter');
        }

        .wave-layer:nth-child(1) {
            animation: wave-flow-1 4s ease-in-out infinite;
            opacity: 0.9;
        }

        .wave-layer:nth-child(2) {
            animation: wave-flow-2 5s ease-in-out infinite reverse;
            opacity: 0.7;
        }

        .wave-layer:nth-child(3) {
            animation: wave-flow-3 6s ease-in-out infinite;
            opacity: 0.5;
        }

        @keyframes liquid-shimmer {
            0% {
                filter: brightness(1) saturate(1) contrast(1);
                transform: translateX(0) scale(1);
            }
            25% {
                filter: brightness(1.08) saturate(1.12) contrast(1.05);
                transform: translateX(2px) scale(1.005);
            }
            50% {
                filter: brightness(1.15) saturate(1.2) contrast(1.08);
                transform: translateX(0) scale(1.01);
            }
            75% {
                filter: brightness(1.08) saturate(1.12) contrast(1.05);
                transform: translateX(-2px) scale(1.005);
            }
            100% {
                filter: brightness(1) saturate(1) contrast(1);
                transform: translateX(0) scale(1);
            }
        }

        @keyframes wave-flow-1 {
            0% { 
                transform: translateX(0) translateY(0) rotate(0deg) scaleX(1);
            }
            20% { 
                transform: translateX(-8%) translateY(-5px) rotate(2deg) scaleX(1.05);
            }
            40% { 
                transform: translateX(-16%) translateY(2px) rotate(-1deg) scaleX(0.98);
            }
            60% { 
                transform: translateX(-24%) translateY(-4px) rotate(1deg) scaleX(1.03);
            }
            80% { 
                transform: translateX(-32%) translateY(1px) rotate(-2deg) scaleX(1.02);
            }
            100% { 
                transform: translateX(-40%) translateY(0) rotate(0deg) scaleX(1);
            }
        }

        @keyframes wave-flow-2 {
            0% { 
                transform: translateX(0) translateY(0) scaleY(1) scaleX(1);
            }
            25% { 
                transform: translateX(-10%) translateY(-6px) scaleY(1.2) scaleX(1.08);
            }
            50% { 
                transform: translateX(-20%) translateY(3px) scaleY(0.85) scaleX(0.95);
            }
            75% { 
                transform: translateX(-30%) translateY(-5px) scaleY(1.15) scaleX(1.05);
            }
            100% { 
                transform: translateX(-40%) translateY(0) scaleY(1) scaleX(1);
            }
        }

        @keyframes wave-flow-3 {
            0% { 
                transform: translateX(0) translateY(0) rotate(0deg);
            }
            33% { 
                transform: translateX(-13%) translateY(-3px) rotate(-1.5deg);
            }
            66% { 
                transform: translateX(-26%) translateY(2px) rotate(1deg);
            }
            100% { 
                transform: translateX(-40%) translateY(0) rotate(0deg);
            }
        }

        .bubble {
            position: absolute;
            bottom: 0;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, 
                rgba(255, 255, 255, 0.9), 
                rgba(255, 255, 255, 0.5) 30%,
                rgba(255, 255, 255, 0.1) 60%,
                transparent);
            box-shadow: 
                inset -1px -1px 3px rgba(0, 0, 0, 0.15),
                inset 1px 1px 2px rgba(255, 255, 255, 0.6),
                0 2px 8px rgba(255, 255, 255, 0.2);
            animation: bubble-rise linear infinite;
            opacity: 0;
            z-index: 5;
        }

        .bubble:nth-child(1) {
            left: 15%;
            width: 6px;
            height: 6px;
            animation-duration: 5s;
            animation-delay: 0s;
        }

        .bubble:nth-child(2) {
            left: 40%;
            width: 4px;
            height: 4px;
            animation-duration: 6s;
            animation-delay: 1.2s;
        }

        .bubble:nth-child(3) {
            left: 65%;
            width: 8px;
            height: 8px;
            animation-duration: 7s;
            animation-delay: 2.5s;
        }

        .bubble:nth-child(4) {
            left: 28%;
            width: 5px;
            height: 5px;
            animation-duration: 5.5s;
            animation-delay: 0.8s;
        }

        .bubble:nth-child(5) {
            left: 55%;
            width: 7px;
            height: 7px;
            animation-duration: 6.5s;
            animation-delay: 1.8s;
        }

        .flask-glare {
            position: absolute;
            top: 10%;
            left: 15%;
            width: 25%;
            height: 70%;
            background: linear-gradient(145deg, 
                rgba(255,255,255,0.5) 0%,
                rgba(255,255,255,0.25) 30%,
                rgba(255,255,255,0.08) 60%,
                transparent 100%);
            border-radius: 50% 30% 70% 40%;
            pointer-events: none;
            z-index: 4;
            filter: blur(2px);
            animation: glare-pulse 3s ease-in-out infinite;
        }

        .flask-glare::before {
            content: "";
            position: absolute;
            top: 8%;
            left: 15%;
            width: 35%;
            height: 12%;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            filter: blur(4px);
        }

        .flask-glare::after {
            content: "";
            position: absolute;
            top: 30%;
            left: 10%;
            width: 25%;
            height: 8%;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            filter: blur(3px);
        }

        @keyframes glare-pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.85;
            }
        }

        .flask-shadow {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 20px;
            background: radial-gradient(ellipse at center, 
                rgba(0, 0, 0, 0.3) 0%,
                transparent 70%);
            filter: blur(8px);
            z-index: 0;
            animation: shadow-pulse 6s ease-in-out infinite;
        }

        @keyframes flask-sway {
            0% { transform: rotate(-10deg) translateY(0) translateX(0) scale(1); }
            12.5% { transform: rotate(-7deg) translateY(-6px) translateX(3px) scale(1.008); }
            25% { transform: rotate(-2deg) translateY(-10px) translateX(5px) scale(1.015); }
            37.5% { transform: rotate(4deg) translateY(-12px) translateX(4px) scale(1.02); }
            50% { transform: rotate(10deg) translateY(-14px) translateX(0) scale(1.025); }
            62.5% { transform: rotate(7deg) translateY(-12px) translateX(-4px) scale(1.02); }
            75% { transform: rotate(2deg) translateY(-8px) translateX(-5px) scale(1.015); }
            87.5% { transform: rotate(-4deg) translateY(-4px) translateX(-3px) scale(1.008); }
            100% { transform: rotate(-10deg) translateY(0) translateX(0) scale(1); }
        }

        @keyframes wave-motion-primary {
            0%, 100% { 
                transform: translateX(0) translateY(0) scaleY(1);
            }
            25% { 
                transform: translateX(-12%) translateY(-2px) scaleY(1.1);
            }
            50% { 
                transform: translateX(-25%) translateY(0) scaleY(1);
            }
            75% { 
                transform: translateX(-37%) translateY(-2px) scaleY(1.1);
            }
        }

        @keyframes wave-motion-secondary {
            0%, 100% { 
                transform: translateX(0) translateY(0) rotate(0deg);
            }
            33% { 
                transform: translateX(-15%) translateY(-3px) rotate(1deg);
            }
            66% { 
                transform: translateX(-30%) translateY(0) rotate(-1deg);
            }
        }

        @keyframes bubble-rise {
            0% {
                bottom: 0%;
                opacity: 0;
                transform: translateX(0) translateY(0) scale(0.5);
            }
            5% {
                opacity: 0.8;
                transform: translateX(2px) translateY(0) scale(1);
            }
            25% {
                transform: translateX(8px) translateY(0) scale(1.05);
            }
            50% {
                transform: translateX(-5px) translateY(0) scale(1.1);
            }
            75% {
                transform: translateX(6px) translateY(0) scale(0.95);
                opacity: 0.9;
            }
            95% {
                opacity: 0.3;
            }
            100% {
                bottom: 105%;
                opacity: 0;
                transform: translateX(-3px) translateY(0) scale(0.7);
            }
        }

        @keyframes shadow-pulse {
            0%, 100% { 
                transform: translateX(-50%) scale(1);
                opacity: 0.3;
            }
            50% { 
                transform: translateX(-50%) scale(1.1);
                opacity: 0.5;
            }
        }

        .day-card { transition: all 0.3s ease; cursor: pointer; }
        .day-card.open .day-items-container { max-height: 1000px; opacity: 1; margin-top: 12px; }
        .day-card.open .chevron-icon { transform: rotate(180deg); color: var(--accent); }
        .day-items-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            opacity: 0;
        }
        /* åœ“å½¢è‰²éšé¸æ“‡å™¨ */
        #themePicker {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto;
        }
        
        #themeColorWheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            cursor: crosshair;
            border: 3px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            touch-action: none; /* é˜²æ­¢è§¸æ§æ™‚çš„é»˜èªè¡Œç‚ºï¼ˆå¦‚æ»¾å‹•ï¼‰ */
            user-select: none; /* é˜²æ­¢æ–‡å­—é¸æ“‡ */
        }
        
        #themeColorIndicator {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 3px solid white;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.8), 0 0 20px currentColor, 0 0 30px currentColor;
            transition: border-color 0.1s ease, box-shadow 0.1s ease, opacity 0.2s ease;
            will-change: transform, opacity;
            z-index: 10;
            opacity: 0; /* åˆå§‹éš±è— */
            transform: translate(-50%, -50%); /* å¾ä¸­å¿ƒé»å®šä½ */
        }
        
        .theme-dot {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.05);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .theme-dot.active { border-color: white; transform: scale(1.1) rotate(45deg); box-shadow: 0 0 15px currentColor; }
        
        #currencyPicker button {
            position: relative;
            overflow: hidden;
        }
        
        #currencyPicker button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        #currencyPicker button:hover::before {
            left: 100%;
        }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; max-height: 300px; overflow-y: auto; padding: 10px; }
        .emoji-item { font-size: 1.5rem; padding: 12px; border-radius: 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; cursor: pointer; text-align: center; }
        .emoji-item.selected { background: rgba(var(--accent-rgb), 0.2); border-color: var(--accent); transform: scale(1.1); }
        .chart-selector { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 8px 16px; border-radius: 20px; outline: none; font-weight: 800; font-size: 12px; appearance: none; text-align: center; }
        .history-item-row:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.1); }
        .stats-item-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .stats-item-card:active { transform: scale(0.96); background: rgba(255, 255, 255, 0.1); }
        
        /* è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨æ ·å¼ - ç¬¦åˆä¸»é¢˜çš„æ¯›ç»ç’ƒé£æ ¼ */
        input[type="date"], input[type="month"] {
            position: relative;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            padding: 12px 18px;
            border-radius: 16px;
            outline: none;
            font-weight: 800;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* é˜²æ­¢æº¢å‡º */
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        input[type="date"]:hover, input[type="month"]:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        input[type="date"]:focus, input[type="month"]:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(var(--accent-rgb), 0.2), 0 8px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        
        input[type="date"]:active, input[type="month"]:active {
            transform: translateY(0px);
        }
        
        /* è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨å›¾æ ‡ - æ›´æ˜æ˜¾çš„æ ·å¼ */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.2);
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
            width: 18px;
            height: 18px;
            padding: 2px;
            border-radius: 4px;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="month"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        
        /* æ—¥æœŸå­—æ®µæ ·å¼ - æ›´å¥½çš„å¯è¯»æ€§ */
        input[type="date"]::-webkit-datetime-edit,
        input[type="month"]::-webkit-datetime-edit {
            color: white;
            font-weight: 800;
        }
        
        input[type="date"]::-webkit-datetime-edit-fields-wrapper,
        input[type="month"]::-webkit-datetime-edit-fields-wrapper {
            padding: 0;
        }
        
        input[type="date"]::-webkit-datetime-edit-text,
        input[type="month"]::-webkit-datetime-edit-text {
            color: rgba(255, 255, 255, 0.5);
            padding: 0 3px;
            font-weight: 600;
        }
        
        input[type="date"]::-webkit-datetime-edit-month-field,
        input[type="date"]::-webkit-datetime-edit-day-field,
        input[type="date"]::-webkit-datetime-edit-year-field,
        input[type="month"]::-webkit-datetime-edit-month-field,
        input[type="month"]::-webkit-datetime-edit-year-field {
            color: white;
            padding: 3px 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        input[type="date"]::-webkit-datetime-edit-month-field:hover,
        input[type="date"]::-webkit-datetime-edit-day-field:hover,
        input[type="date"]::-webkit-datetime-edit-year-field:hover,
        input[type="month"]::-webkit-datetime-edit-month-field:hover,
        input[type="month"]::-webkit-datetime-edit-year-field:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        input[type="date"]::-webkit-datetime-edit-month-field:focus,
        input[type="date"]::-webkit-datetime-edit-day-field:focus,
        input[type="date"]::-webkit-datetime-edit-year-field:focus,
        input[type="month"]::-webkit-datetime-edit-month-field:focus,
        input[type="month"]::-webkit-datetime-edit-year-field:focus {
            background: rgba(var(--accent-rgb), 0.4);
            border-radius: 6px;
            color: white;
            outline: none;
            font-weight: 900;
        }
    </style>
</head>
<body>
    <svg style="position: fixed; width: 0; height: 0;">
        <filter id="liquid-filter">
            <feTurbulence type="fractalNoise" baseFrequency="0.015 0.03" numOctaves="3" result="noise" />
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="10" />
        </filter>
    </svg>

    <div id="app" class="max-w-md mx-auto h-screen flex flex-col relative overflow-hidden">
        
        <header id="header-ui" class="pt-12 px-8 pb-4 flex justify-between items-start z-20">
            <div class="flex flex-col">
                <h1 class="brand-title text-3xl font-[900]">LEDGER<span class="text-[14px] font-normal align-top ml-0.5">â„¢</span></h1>
                <div class="by-owen font-bold mt-1 text-[10px] tracking-wider">DESIGNED BY OWEN  |  V3.0</div>
            </div>
            <button onclick="nav('settings')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center mt-1 border border-white/10 hover:border-white/30 transition-colors">
                <i data-lucide="user" class="w-5 h-5"></i>
            </button>
        </header>

        <main id="mainContainer" class="flex-1 overflow-y-auto px-6 no-scrollbar pb-32">
            
            <!-- Login Page -->
            <section id="page-auth" class="page-transition hidden-page min-h-screen flex items-center justify-center px-6 -mx-6 -mt-4">
                <div class="w-full max-w-md space-y-8">
                    <!-- Logo & Title -->
                    <div class="text-center space-y-3">
                        <div class="flex justify-center mb-6">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-white/20 to-white/5 backdrop-blur-xl border border-white/20 flex items-center justify-center">
                                <i data-lucide="sparkles" class="w-10 h-10 text-white"></i>
                            </div>
                        </div>
                        <h1 class="text-4xl font-black text-white">LEDGER<span class="text-sm font-normal align-top ml-1">â„¢</span></h1>
                        <p class="text-sm text-white/40 font-bold uppercase tracking-wider">Personal Finance Tracker</p>
                    </div>

                    <!-- Auth Tabs -->
                    <div class="glass-panel p-2 rounded-[32px] flex gap-2">
                        <button id="tabMagicLink" onclick="switchAuthTab('magiclink')" class="auth-tab-active flex-1 py-3 rounded-[24px] text-sm font-black transition-all">
                            âœ¨ Magic Link
                        </button>
                        <button id="tabCode" onclick="switchAuthTab('code')" class="auth-tab-inactive flex-1 py-3 rounded-[24px] text-sm font-black transition-all">
                            ğŸ”‘ ç™»å…¥ä»£ç¢¼
                        </button>
                    </div>

                    <!-- Magic Link Form -->
                    <div id="formMagicLink" class="space-y-6">
                        <div class="glass-panel p-8 rounded-[32px] space-y-6">
                            <div class="text-center space-y-2 mb-4">
                                <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center">
                                    <span class="text-3xl">âœ¨</span>
                                </div>
                                <h3 class="text-sm font-black text-white">è¨»å†Š / ç™»å…¥</h3>
                                <p class="text-[10px] text-white/40">è¼¸å…¥ Email å³å¯é–‹å§‹ä½¿ç”¨</p>
                            </div>
                            <div>
                                <label class="block text-[10px] font-black text-white/40 uppercase tracking-widest mb-3">Email</label>
                                <input type="email" id="emailMagicLink" placeholder="your@email.com" 
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white placeholder-white/30 outline-none focus:border-white/30 transition-colors font-bold">
                            </div>
                            <button onclick="handleMagicLink()" 
                                class="w-full bg-gradient-to-r from-white/20 to-white/10 backdrop-blur-xl border border-white/20 text-white py-4 rounded-2xl font-black uppercase tracking-wider active:scale-95 transition-all hover:border-white/40">
                                <span id="btnMagicLinkText">âœ¨ ç™¼é€ Magic Link</span>
                            </button>
                        </div>
                        <p class="text-center text-[10px] text-white/30 leading-relaxed px-6">
                            æˆ‘å€‘æœƒå°‡ç™»å…¥é€£çµå¯„åˆ°æ‚¨çš„ä¿¡ç®±<br>
                            é»æ“Šé€£çµå³å¯å®Œæˆè¨»å†Šæˆ–ç™»å…¥ï¼Œç„¡éœ€å¯†ç¢¼<br>
                            <span class="text-white/20 text-[9px]">é©ç”¨æ–¼åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨</span>
                        </p>
                    </div>

                    <!-- Login Code Form -->
                    <div id="formCode" class="space-y-6 hidden">
                        <div class="glass-panel p-8 rounded-[32px] space-y-6">
                            <div class="text-center space-y-2 mb-4">
                                <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-500/20 flex items-center justify-center">
                                    <span class="text-3xl">ğŸ”‘</span>
                                </div>
                                <h3 class="text-sm font-black text-white">è·¨è£ç½®ç™»å…¥</h3>
                                <p class="text-[10px] text-white/40">è«‹è¼¸å…¥å¾å…¶ä»–è£ç½®ç²å¾—çš„ 6 ä½æ•¸ç™»å…¥ä»£ç¢¼</p>
                            </div>
                            <div>
                                <input type="text" id="loginCode" placeholder="è¼¸å…¥ 6 ä½æ•¸ä»£ç¢¼" maxlength="6"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white placeholder-white/30 outline-none focus:border-white/30 transition-colors font-bold text-center text-2xl tracking-[0.5em]"
                                    oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                            </div>
                            <button onclick="verifyLoginCode()" 
                                class="w-full bg-gradient-to-r from-white/20 to-white/10 backdrop-blur-xl border border-white/20 text-white py-4 rounded-2xl font-black uppercase tracking-wider active:scale-95 transition-all hover:border-white/40">
                                <span id="btnVerifyCode">âœ… é©—è­‰ä»£ç¢¼</span>
                            </button>
                        </div>
                        <div class="bg-white/5 rounded-2xl p-4 mx-4">
                            <p class="text-[10px] font-black text-white/40 uppercase mb-2">ğŸ’¡ å¦‚ä½•å–å¾—ä»£ç¢¼ï¼Ÿ</p>
                            <ol class="text-[10px] text-white/60 space-y-1 ml-4 list-decimal">
                                <li>åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨ Magic Link ç™»å…¥</li>
                                <li>å‰å¾€ã€Œè¨­å®šã€é é¢</li>
                                <li>é»æ“Šã€Œé¡¯ç¤ºæˆ‘çš„ç™»å…¥ä»£ç¢¼ã€</li>
                                <li>è¤‡è£½ä»£ç¢¼ä¸¦åœ¨æ­¤è™•è¼¸å…¥</li>
                            </ol>
                        </div>
                        <p class="text-center text-[10px] text-white/30 leading-relaxed px-6">
                            ä»£ç¢¼æœ‰æ•ˆæœŸç‚º 10 åˆ†é˜<br>
                            <span class="text-white/20 text-[9px]">é©ç”¨æ–¼ iOS ä¸»ç•«é¢ App æˆ–å…¶ä»–è£ç½®</span>
                        </p>
                    </div>

                    <!-- Status Messages -->
                    <div id="authMessage" class="hidden glass-panel p-6 rounded-[24px] text-center">
                        <p id="authMessageText" class="text-sm font-bold text-white"></p>
                    </div>

                    <!-- iOS Standalone Mode Warning -->
                    <div id="iosStandaloneWarning" class="hidden bg-yellow-500/10 border border-yellow-500/30 rounded-[24px] p-6 space-y-3">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">âš ï¸</span>
                            <h3 class="text-sm font-black text-yellow-400">iOS ä¸»ç•«é¢ App ä½¿ç”¨æç¤º</h3>
                        </div>
                        <p class="text-[11px] text-yellow-400/80 leading-relaxed">
                            å¦‚æœæ‚¨æ˜¯å¾ iOS ä¸»ç•«é¢é–‹å•Ÿæ­¤ Appï¼ŒMagic Link ç™»å…¥å¯èƒ½æœƒåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿè€Œç„¡æ³•å›åˆ°æ­¤è™•ã€‚
                        </p>
                        <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                            <p class="text-[10px] font-black text-white uppercase">å»ºè­°ä½œæ³•ï¼š</p>
                            <ol class="text-[10px] text-white/70 space-y-1 text-left ml-4 list-decimal">
                                <li>åœ¨ Safari ä¸­é–‹å•Ÿæ­¤ç¶²ç«™ä¸¦å®Œæˆç™»å…¥</li>
                                <li>ç™»å…¥å¾Œå†å›åˆ°ä¸»ç•«é¢ App ä½¿ç”¨</li>
                                <li>æˆ–é¸æ“‡ã€Œåƒ…ä½¿ç”¨æœ¬åœ°æ¨¡å¼ã€è·³éç™»å…¥</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Skip Login (Local Mode) -->
                    <div class="text-center">
                        <button onclick="skipLogin()" class="text-[10px] text-white/20 hover:text-white/40 font-bold uppercase tracking-widest transition-colors">
                            è·³éï¼Œåƒ…ä½¿ç”¨æœ¬åœ°æ¨¡å¼
                        </button>
                    </div>
                </div>
            </section>

            <section id="page-home" class="page-transition space-y-8 mt-4">
                <div class="glass-panel p-8 rounded-[40px] flex flex-col items-center relative overflow-hidden">
                    <div class="w-full flex justify-between items-start mb-4">
                        <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Budget Remaining</p>
                        <p id="hudDate" class="text-[9px] font-bold text-white/30 uppercase"></p>
                    </div>

                    <div class="flask-container mb-6">
                        <div class="flask-shadow"></div>
                        <div class="flask-neck"></div>
                        <div class="flask">
                            <div class="flask-measurements">
                                <div class="measurement-line major"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line major"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line major"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line major"></div>
                            </div>
                            <div class="flask-glare"></div>
                            <div id="liquidLevel" class="liquid" style="height: 0%;">
                                <div class="liquid-fill">
                                    <div class="bubble"></div>
                                    <div class="bubble"></div>
                                    <div class="bubble"></div>
                                    <div class="bubble"></div>
                                    <div class="bubble"></div>
                                </div>
                                <div class="liquid-surface">
                                    <div class="wave-layer"></div>
                                    <div class="wave-layer"></div>
                                    <div class="wave-layer"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <div class="flex items-baseline justify-center gap-1 mb-1">
                            <span class="text-4xl font-black text-white" id="displayRemaining"></span>
                        </div>
                        <div class="flex justify-center gap-6 mb-2">
                            <div class="text-center">
                                <div class="text-[9px] font-bold text-white/30 uppercase tracking-wider mb-1">Spent</div>
                                <div class="text-sm font-black text-white/60" id="displaySpent"></div>
                            </div>
                            <div class="w-px bg-white/10"></div>
                            <div class="text-center">
                                <div class="text-[9px] font-bold text-white/30 uppercase tracking-wider mb-1">Budget</div>
                                <div class="text-sm font-black text-white/60" id="displayBudgetLimit"></div>
                            </div>
                        </div>
                        <p id="budgetMessage" class="text-[10px] font-bold uppercase tracking-widest transition-colors duration-300"></p>
                        <div id="creditCardDueDisplay"></div>
                    </div>
                </div>

                <div id="todaySpentDisplay"></div>

                <div>
                    <h3 class="text-[10px] font-black uppercase text-white/30 tracking-widest mb-4 ml-2">Recent Activities</h3>
                    <div id="recentList" class="space-y-3"></div>
                </div>
                
                <!-- æœªæ¥é¢„å®šæ”¯å‡ºé¢„è§ˆ -->
                <div id="futureExpensesPreview"></div>
            </section>

            <section id="page-history" class="page-transition hidden-page space-y-4">
                <div class="flex items-center gap-3 bg-white/5 border border-white/10 rounded-2xl p-4 mb-4">
                    <i data-lucide="calendar" class="w-5 h-5 text-white/40"></i>
                    <input type="month" id="histMonth" onchange="renderHistory()" class="bg-transparent flex-1 text-white outline-none font-bold">
                </div>
                <div class="flex items-center gap-3 bg-white/5 border border-white/10 rounded-2xl p-4 mb-6">
                    <i data-lucide="search" class="w-5 h-5 text-white/40"></i>
                    <input type="text" id="searchKeyword" placeholder="æœå°‹é—œéµå­—ã€åˆ†é¡ã€å‚™è¨»..." oninput="renderHistory()" class="bg-transparent flex-1 text-white outline-none font-bold placeholder-white/30">
                    <button onclick="clearSearch()" class="px-3 py-1 bg-white/10 rounded-lg text-[9px] font-bold text-white/60">æ¸…é™¤</button>
                </div>
                <div id="historyAccordion" class="space-y-3"></div>
            </section>

            <section id="page-stats" class="page-transition hidden-page space-y-6">
                <div class="flex justify-between items-center px-2">
                    <h3 class="text-[10px] font-black uppercase text-white/40 tracking-widest">Monthly Analysis</h3>
                    <input type="month" id="statsMonth" onchange="renderStats()" class="chart-selector">
                </div>
                <div class="glass-panel p-6 rounded-[40px] flex flex-col items-center">
                    <div id="chartContainer" class="relative w-full aspect-square max-w-[280px]">
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div id="noDataStats" class="hidden py-20 text-center opacity-30">
                        <i data-lucide="bar-chart-2" class="w-12 h-12 mx-auto mb-4"></i>
                        <p class="text-[10px] font-black uppercase tracking-widest">No Data This Month</p>
                    </div>
                </div>
                <div id="statsLegend" class="grid grid-cols-1 gap-3"></div>
                
                <!-- æ¶ˆè²»è¶¨å‹¢åœ–è¡¨ -->
                <div class="glass-panel p-6 rounded-[40px]">
                    <h3 class="text-[10px] font-black uppercase text-white/40 tracking-widest mb-4">Spending Trends (Last 6 Months)</h3>
                    <div class="relative w-full" style="height: 200px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                    <div id="noTrendData" class="hidden py-10 text-center opacity-30">
                        <i data-lucide="trending-up" class="w-8 h-8 mx-auto mb-2"></i>
                        <p class="text-[9px] font-black uppercase tracking-widest">No Trend Data</p>
                    </div>
                </div>
            </section>

            <section id="page-settings" class="page-transition hidden-page space-y-6">
                <!-- å¹«åŠ©æŒ‰éˆ•ï¼ˆç¸®å°ç‰ˆï¼Œæ”¾åœ¨æœ€ä¸Šé¢ï¼‰ -->
                <button onclick="showHelpModal()" class="w-full glass-panel p-3 rounded-2xl flex items-center justify-center gap-2 hover:bg-white/5 transition-all">
                    <i data-lucide="help-circle" class="w-4 h-4 text-purple-400"></i>
                    <span class="text-xs font-bold text-white/80">åŠŸèƒ½èªªæ˜</span>
                </button>
                
                <!-- ä¸»é¡Œè¨­å®šï¼ˆæ‘ºç–Šå¼ï¼‰ -->
                <div class="glass-panel rounded-3xl overflow-hidden">
                    <button onclick="toggleThemeSection()" class="w-full p-4 flex items-center justify-between hover:bg-white/5 transition-all">
                        <div class="flex items-center gap-3">
                            <i data-lucide="palette" class="w-4 h-4 text-white/60"></i>
                            <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Theme Essence</h3>
                        </div>
                        <i data-lucide="chevron-down" id="themeChevron" class="w-4 h-4 text-white/40 transition-transform"></i>
                    </button>
                    <div id="themeSection" class="collapsible-section px-6">
                        <div id="themePicker" class="pb-6 pt-4">
                            <canvas id="themeColorWheel"></canvas>
                            <div id="themeColorIndicator"></div>
                        </div>
                        <div class="text-center mt-4">
                            <div id="selectedThemePreview" class="inline-block px-4 py-2 rounded-xl text-xs font-bold"></div>
                        </div>
                    </div>
                </div>
                
                <!-- å¹£å€¼è¨­å®šï¼ˆæ‘ºç–Šå¼ï¼‰ -->
                <div class="glass-panel rounded-3xl overflow-hidden">
                    <button onclick="toggleCurrencySection()" class="w-full p-4 flex items-center justify-between hover:bg-white/5 transition-all">
                        <div class="flex items-center gap-3">
                            <i data-lucide="dollar-sign" class="w-4 h-4 text-white/60"></i>
                            <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Currency Setting</h3>
                        </div>
                        <i data-lucide="chevron-down" id="currencyChevron" class="w-4 h-4 text-white/40 transition-transform"></i>
                    </button>
                    <div id="currencySection" class="collapsible-section px-6 space-y-2">
                        <p class="text-[10px] text-white/40 font-bold ml-1 pt-2">é¸æ“‡é¡¯ç¤ºçš„å¹£å€¼ï¼š</p>
                        <div id="currencyPicker" class="grid grid-cols-3 gap-3 pb-6"></div>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-3xl space-y-4">
                    <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Budget Setting</h3>
                    <div class="space-y-1">
                        <p class="text-[10px] text-white/40 font-bold ml-1">åœ¨æ­¤è¨­å®šæ‚¨çš„æ¯æœˆæ¶ˆè²»é ç®—ä¸Šé™ï¼š</p>
                        <input type="number" id="budgetInput" placeholder="è¼¸å…¥æ¯æœˆé ç®—é‡‘é¡" class="w-full bg-white/5 p-4 rounded-2xl outline-none text-white font-bold border border-white/5 focus:border-white/20">
                    </div>
                    <button onclick="saveSettings(event)" class="w-full py-4 dynamic-accent-bg text-black rounded-2xl font-black shadow-lg">å„²å­˜é ç®—è®Šæ›´</button>
                </div>

                <!-- å¸³æˆ¶èˆ‡é›²ç«¯åŒæ­¥ç‹€æ…‹ -->
                <div class="glass-panel p-6 rounded-3xl space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Account & Sync</h3>
                        <div id="syncStatusBadge" class="text-[8px] px-2 py-1 rounded-full font-black">
                            <!-- å‹•æ…‹æ›´æ–° -->
                        </div>
                    </div>
                    
                    <!-- ç™»å…¥ç‹€æ…‹é¡¯ç¤º -->
                    <div id="authStatusPanel" class="space-y-3">
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="text-white/40 font-bold">ç™»å…¥ç‹€æ…‹ï¼š</span>
                            <span id="authStatusText" class="text-white font-black">æœ¬åœ°æ¨¡å¼</span>
                        </div>
                        <div id="userEmailDisplay" class="hidden flex items-center justify-between text-[10px] bg-white/5 rounded-xl p-3">
                            <span class="text-white/40 font-bold">å¸³æˆ¶ï¼š</span>
                            <span id="userEmail" class="text-white/80 font-bold truncate ml-2"></span>
                        </div>
                        <div class="flex gap-2">
                            <button id="authActionBtn" onclick="showAuthPage()" class="flex-1 py-3 bg-gradient-to-r from-white/20 to-white/10 border border-white/20 text-white rounded-2xl font-black text-xs transition-all hover:border-white/40">
                                ğŸ” ç™»å…¥é›²ç«¯å¸³æˆ¶
                            </button>
                            <button onclick="showCloudInfoModal()" class="w-12 h-12 bg-white/10 border border-white/20 text-white rounded-2xl font-black text-xs transition-all hover:border-white/40 flex items-center justify-center">
                                <i data-lucide="info" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- åŒæ­¥è³‡è¨Šï¼ˆåƒ…åœ¨ç™»å…¥å¾Œé¡¯ç¤ºï¼‰ -->
                    <div id="syncInfoPanel" class="hidden space-y-3 pt-3 border-t border-white/5">
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="text-white/40 font-bold">æœ¬åœ°è³‡æ–™ï¼š</span>
                            <span id="localDataCount" class="text-white font-black">0 ç­†äº¤æ˜“</span>
                        </div>
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="text-white/40 font-bold">æœ€å¾ŒåŒæ­¥ï¼š</span>
                            <span id="lastSyncDisplay" class="text-white font-black">å¾æœªåŒæ­¥</span>
                        </div>
                        <div id="syncErrorMessage" class="hidden text-[9px] text-red-400 bg-red-500/10 p-2 rounded-lg">
                            <!-- éŒ¯èª¤è³‡è¨Š -->
                        </div>
                        
                        <!-- ç™»å…¥ä»£ç¢¼é¡¯ç¤ºæŒ‰éˆ• -->
                        <button onclick="showLoginCodeModal()" class="w-full py-3 bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border border-blue-500/30 text-blue-300 rounded-2xl font-black text-xs transition-all hover:border-blue-400/50">
                            ğŸ”‘ é¡¯ç¤ºæˆ‘çš„ç™»å…¥ä»£ç¢¼
                        </button>
                        
                        <button id="manualSyncBtn" onclick="manualSync()" class="w-full py-3 bg-white/10 hover:bg-white/15 text-white rounded-2xl font-black text-xs transition-all">
                            <span id="syncBtnText">ğŸ”„ ç«‹å³åŒæ­¥åˆ°é›²ç«¯</span>
                        </button>
                        <p class="text-[9px] text-white/30 text-center">
                            ğŸ’¡ æç¤ºï¼šè«‹é»æ“Šã€Œç«‹å³åŒæ­¥åˆ°é›²ç«¯ã€æŒ‰éˆ•ä¾†åŒæ­¥è³‡æ–™ã€‚é›²ç«¯åƒ…ä¿ç•™æœ€è¿‘ 365 å¤©çš„è³‡æ–™ï¼Œæœ¬åœ°è³‡æ–™æ°¸ä¹…ä¿ç•™ã€‚
                        </p>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-3xl space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Categories</h3>
                        <button onclick="openCatModal()" class="text-[10px] bg-white/10 px-3 py-1 rounded-full">+ æ–°å¢</button>
                    </div>
                    <div id="settingsCatList" class="grid grid-cols-2 gap-2"></div>
                </div>

                <!-- ä¿¡ç”¨å¡ç®¡ç† -->
                <div class="glass-panel p-6 rounded-3xl space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Credit Cards</h3>
                        <button onclick="openCardModal()" class="text-[10px] bg-white/10 px-3 py-1 rounded-full">+ æ–°å¢</button>
                    </div>
                    <div id="settingsCardList" class="space-y-2"></div>
                </div>

                <!-- å®šæœŸäº¤æ˜“ç®¡ç† -->
                <div class="glass-panel p-6 rounded-3xl space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Recurring Transactions</h3>
                        <button onclick="openRecurringModal()" class="text-[10px] bg-white/10 px-3 py-1 rounded-full">+ æ–°å¢</button>
                    </div>
                    <div id="settingsRecurringList" class="space-y-2"></div>
                </div>
            </section>

            <section id="page-add" class="page-transition hidden-page space-y-8">
                <div class="text-center pt-6">
                    <div class="flex items-center justify-center">
                         <span id="currencySymbolAdd" class="text-xl font-black text-white/20 mr-2">NT$</span>
                         <input type="number" id="formAmount" placeholder="0" class="w-full max-w-[200px] bg-transparent text-6xl font-black text-center text-white outline-none">
                    </div>
                </div>
                <div>
                    <p class="text-[9px] font-black text-white/20 uppercase tracking-widest mb-3 text-center">äº¤æ˜“å¹£ç¨®</p>
                    <div id="formCurrencyGrid" class="grid grid-cols-3 gap-3 mb-4"></div>
                </div>
                <div id="formCatGrid" class="grid grid-cols-4 gap-3"></div>
                
                <!-- æ”¯ä»˜æ–¹å¼é€‰æ‹© -->
                <div class="glass-panel p-6 rounded-[32px] space-y-4">
                    <p class="text-[9px] font-black text-white/20 uppercase tracking-widest mb-2 text-center">æ”¯ä»˜æ–¹å¼</p>
                    <div class="flex gap-3">
                        <button id="paymentCashBtn" onclick="selectPaymentMethod('cash')" class="flex-1 py-4 dynamic-accent-bg text-black rounded-2xl font-black">
                            ğŸ’µ ç¾é‡‘
                        </button>
                        <button id="paymentCreditBtn" onclick="selectPaymentMethod('credit')" class="flex-1 py-4 glass-panel rounded-2xl font-bold text-white/50">
                            ğŸ’³ ä¿¡ç”¨å¡
                        </button>
                    </div>
                    <!-- ä¿¡ç”¨å¡é€‰æ‹©ä¸‹æ‹‰èœå• -->
                    <div id="cardSelectContainer" class="hidden">
                        <select id="cardSelect" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white mb-3">
                            <option value="">è«‹é¸æ“‡ä¿¡ç”¨å¡</option>
                        </select>
                        <!-- åˆ†æœŸæœŸæ•°è¾“å…¥ -->
                        <div class="mb-3">
                            <label class="text-[9px] font-bold text-white/40 uppercase mb-2 block">åˆ†æœŸæœŸæ•¸ï¼ˆé è¨­ 1 æœŸï¼‰</label>
                            <input type="number" id="formInstallments" min="1" max="24" value="1" placeholder="1" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                        </div>
                        <!-- å¹´åˆ©ç‡è¾“å…¥ -->
                        <div>
                            <label class="text-[9px] font-bold text-white/40 uppercase mb-2 block">å¹´åˆ©ç‡ï¼ˆ%ï¼Œé è¨­ 0ï¼‰</label>
                            <input type="number" id="formInterestRate" min="0" max="100" step="0.01" value="0" placeholder="0" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                        </div>
                        <!-- æ¯æœŸé‡‘é¢è¯•ç®—æ˜¾ç¤º -->
                        <div id="installmentPreview" class="mt-3 p-3 bg-blue-500/10 border border-blue-500/30 rounded-xl hidden">
                            <div class="text-[9px] font-bold text-blue-400/80 uppercase tracking-wider mb-1">æ¯æœŸè©¦ç®—</div>
                            <div class="text-sm font-black text-blue-400" id="installmentAmountDisplay"></div>
                        </div>
                    </div>
                </div>
                
                <div class="glass-panel p-6 rounded-[32px] space-y-4 overflow-hidden">
                    <div class="flex flex-col gap-4">
                        <div class="w-full">
                            <input type="date" id="formDate" class="w-full text-white font-bold outline-none box-border max-w-full">
                        </div>
                        <div class="w-full">
                            <input type="text" id="formNote" placeholder="è¼¸å…¥å‚™è¨»..." class="w-full bg-white/5 p-4 rounded-2xl text-white font-bold outline-none border border-white/5 box-border">
                        </div>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button onclick="nav(lastPage)" class="flex-1 py-5 glass-panel rounded-3xl font-bold text-white/50">å–æ¶ˆ</button>
                    <button id="saveBtn" onclick="saveTransaction()" class="flex-[2] py-5 dynamic-accent-bg text-black rounded-3xl font-black">å®Œæˆ</button>
                </div>
                <button id="deleteBtn" onclick="deleteCurrentTx()" class="w-full py-4 text-red-500 font-bold hidden">åˆªé™¤æ­¤ç­†äº¤æ˜“</button>
            </section>

        </main>

        <div id="catModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-sm rounded-[40px] p-8 space-y-6">
                <h2 class="text-xl font-black">æ–°å¢åˆ†é¡</h2>
                <input type="text" id="newCatName" placeholder="åˆ†é¡åç¨±" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5">
                <div>
                    <p class="text-[10px] font-bold text-white/40 uppercase mb-3">æŒ‘é¸åœ–ç¤º (130+ é¸é …)</p>
                    <div id="emojiPicker" class="emoji-grid no-scrollbar"></div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeCatModal()" class="flex-1 py-4 glass-panel rounded-2xl font-bold">å–æ¶ˆ</button>
                    <button id="confirmCatBtn" class="flex-1 py-4 dynamic-accent-bg text-black rounded-2xl font-black opacity-30 pointer-events-none">è«‹é¸æ“‡åœ–ç¤º</button>
                </div>
            </div>
        </div>

        <!-- ä¿¡ç”¨å¡ç®¡ç† Modal -->
        <div id="cardModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-sm rounded-[40px] p-8 space-y-6">
                <h2 class="text-xl font-black" id="cardModalTitle">æ–°å¢ä¿¡ç”¨å¡</h2>
                <input type="text" id="cardName" placeholder="ä¿¡ç”¨å¡åç¨±ï¼ˆä¾‹å¦‚ï¼šåœ‹æ³°ï¼‰" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">çµå¸³æ—¥ï¼ˆæ¯æœˆå¹¾è™Ÿï¼‰</label>
                        <input type="number" id="cardClosingDay" placeholder="1-31" min="1" max="31" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">çµå¸³å¾Œå¹¾å¤©ç¹³æ¬¾</label>
                        <input type="number" id="cardDueDays" placeholder="ä¾‹å¦‚ï¼š15" min="1" max="60" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">åˆå§‹æœªç¹³æ¸…é¤˜é¡ï¼ˆé¸å¡«ï¼‰</label>
                        <input type="number" id="cardInitialBalance" placeholder="ä¾‹å¦‚ï¼š5000" min="0" step="0.01" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                        <p class="text-[8px] text-white/30 mt-1">ä½¿ç”¨æ­¤ App å‰å·²å­˜åœ¨çš„æœªç¹³æ¸…å¸³å–®ç¸½é¡</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeCardModal()" class="flex-1 py-4 glass-panel rounded-2xl font-bold">å–æ¶ˆ</button>
                    <button id="confirmCardBtn" onclick="confirmAddCard()" class="flex-1 py-4 dynamic-accent-bg text-black rounded-2xl font-black">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <!-- è¿˜æ¬¾ Modal -->
        <div id="paymentModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-sm rounded-[40px] p-8 space-y-6">
                <h2 class="text-xl font-black" id="paymentModalTitle">è¨˜éŒ„é‚„æ¬¾</h2>
                <div id="paymentCardInfo" class="text-sm text-white/60 mb-4"></div>
                <div id="paymentBillInfo" class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-2xl mb-4">
                    <div class="text-[10px] font-bold text-yellow-400/80 uppercase tracking-wider mb-1">æœ¬æœˆæ‡‰ç¹³ç¸½é¡</div>
                    <div class="text-lg font-black text-yellow-400" id="paymentTotalAmount"></div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">é‚„æ¬¾é‡‘é¡</label>
                    <input type="number" id="paymentAmount" placeholder="è¼¸å…¥é‚„æ¬¾é‡‘é¡" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                </div>
                <div class="flex gap-3">
                    <button onclick="closePaymentModal()" class="flex-1 py-4 glass-panel rounded-2xl font-bold">å–æ¶ˆ</button>
                    <button onclick="confirmPayment()" class="flex-1 py-4 dynamic-accent-bg text-black rounded-2xl font-black">ç¢ºèªé‚„æ¬¾</button>
                </div>
            </div>
        </div>

        <!-- å®šæœŸäº¤æ˜“ Modal -->
        <div id="recurringModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-sm rounded-[40px] p-8 space-y-6 max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-black" id="recurringModalTitle">æ–°å¢å®šæœŸäº¤æ˜“</h2>
                <input type="text" id="recurringNote" placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šæˆ¿ç§Ÿï¼‰" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                <div>
                    <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">é‡‘é¡</label>
                    <input type="number" id="recurringAmount" placeholder="ä¾‹å¦‚ï¼š15000" min="0" step="0.01" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">åˆ†é¡</label>
                    <select id="recurringCategory" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">é »ç‡</label>
                    <select id="recurringFrequency" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                        <option value="daily">æ¯æ—¥</option>
                        <option value="weekly">æ¯é€±</option>
                        <option value="monthly" selected>æ¯æœˆ</option>
                        <option value="yearly">æ¯å¹´</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="recurringStartDate" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">çµæŸæ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
                    <input type="date" id="recurringEndDate" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                    <p class="text-[8px] text-white/30 mt-1">ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ</p>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">æ”¯ä»˜æ–¹å¼</label>
                    <select id="recurringPaymentMethod" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                        <option value="cash">ç¾é‡‘</option>
                        <option value="credit">ä¿¡ç”¨å¡</option>
                    </select>
                </div>
                <div id="recurringCardSelectContainer" class="hidden">
                    <label class="text-[10px] font-bold text-white/40 uppercase mb-2 block">ä¿¡ç”¨å¡</label>
                    <select id="recurringCardSelect" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5 text-white">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </select>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeRecurringModal()" class="flex-1 py-4 glass-panel rounded-2xl font-bold">å–æ¶ˆ</button>
                    <button id="confirmRecurringBtn" onclick="confirmAddRecurring()" class="flex-1 py-4 dynamic-accent-bg text-black rounded-2xl font-black">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <!-- å®Œæ•´åŠŸèƒ½èªªæ˜ Modal -->
        <div id="helpModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-md rounded-[40px] p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4 sticky top-0 bg-[var(--card-bg)] pb-4 border-b border-white/10">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center">
                            <i data-lucide="help-circle" class="w-6 h-6 text-purple-400"></i>
                        </div>
                        <h2 class="text-xl font-black">åŠŸèƒ½èªªæ˜</h2>
                    </div>
                    <button onclick="closeHelpModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div class="space-y-4 text-sm">
                    <!-- é¦–é åŠŸèƒ½ -->
                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <h3 class="font-black text-white mb-2 flex items-center gap-2">
                            <i data-lucide="home" class="w-4 h-4"></i>
                            é¦–é åŠŸèƒ½
                        </h3>
                        <div class="space-y-2 text-xs text-white/70">
                            <p><strong class="text-white">é ç®—é¡¯ç¤ºï¼š</strong>é¡¯ç¤ºæœ¬æœˆå‰©é¤˜é ç®—ã€å·²èŠ±è²»é‡‘é¡å’Œç¸½é ç®—ã€‚æ¶²é«”é«˜åº¦ä»£è¡¨é ç®—ä½¿ç”¨ç‡ã€‚</p>
                            <p><strong class="text-white">ä»Šæ—¥æ¶ˆè²»ï¼š</strong>é¡¯ç¤ºä»Šå¤©çš„ç¾é‡‘æ¶ˆè²»ç¸½é¡å’Œäº¤æ˜“ç­†æ•¸ï¼Œå¹«åŠ©æ‚¨æ§åˆ¶æ¯æ—¥æ”¯å‡ºã€‚</p>
                            <p><strong class="text-white">æœ¬æœˆå¾…ç¹³ä¿¡ç”¨å¡è²»ï¼š</strong>é¡¯ç¤ºæœ¬æœˆéœ€è¦ç¹³ç´çš„ä¿¡ç”¨å¡å¸³å–®ç¸½é¡ï¼ŒåŒ…å«åˆ†æœŸä»˜æ¬¾å’Œçµè½‰é¤˜é¡ã€‚</p>
                            <p><strong class="text-white">æœ€è¿‘æ´»å‹•ï¼š</strong>é¡¯ç¤ºæœ€è¿‘çš„äº¤æ˜“è¨˜éŒ„ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥çœ‹ã€‚</p>
                        </div>
                    </div>

                    <!-- æ–°å¢äº¤æ˜“ -->
                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <h3 class="font-black text-white mb-2 flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            æ–°å¢äº¤æ˜“
                        </h3>
                        <div class="space-y-2 text-xs text-white/70">
                            <p><strong class="text-white">é‡‘é¡è¼¸å…¥ï¼š</strong>é»æ“Šä¸­é–“çš„ + æŒ‰éˆ•ï¼Œè¼¸å…¥äº¤æ˜“é‡‘é¡ã€‚</p>
                            <p><strong class="text-white">å¹£ç¨®é¸æ“‡ï¼š</strong>æ”¯æ´å°å¹£(TWD)ã€ç¾å…ƒ(USD)ã€æ–°åŠ å¡å¹£(SGD)ï¼Œæœƒè‡ªå‹•è½‰æ›ç‚ºæ‚¨è¨­å®šçš„ä¸»è¦å¹£ç¨®ã€‚</p>
                            <p><strong class="text-white">åˆ†é¡é¸æ“‡ï¼š</strong>é¸æ“‡äº¤æ˜“åˆ†é¡ï¼Œå¯åœ¨è¨­å®šä¸­æ–°å¢è‡ªè¨‚åˆ†é¡ã€‚</p>
                            <p><strong class="text-white">æ”¯ä»˜æ–¹å¼ï¼š</strong>
                                <br>â€¢ <strong>ç¾é‡‘ï¼š</strong>ç«‹å³è¨ˆå…¥ç•¶æœˆæ”¯å‡º
                                <br>â€¢ <strong>ä¿¡ç”¨å¡ï¼š</strong>å¯é¸æ“‡ä¿¡ç”¨å¡ã€è¨­å®šåˆ†æœŸæœŸæ•¸å’Œå¹´åˆ©ç‡ï¼Œæœƒåœ¨ç¹³æ¬¾æœˆä»½è¨ˆå…¥æ”¯å‡º</p>
                            <p><strong class="text-white">åˆ†æœŸä»˜æ¬¾ï¼š</strong>è¨­å®šåˆ†æœŸæœŸæ•¸å’Œå¹´åˆ©ç‡ï¼Œç³»çµ±æœƒè‡ªå‹•è¨ˆç®—æ¯æœŸé‡‘é¡ã€‚é¤˜æ•¸æœƒæ”¾åœ¨æœ€å¾Œä¸€æœŸã€‚</p>
                            <p><strong class="text-white">å‚™è¨»ï¼š</strong>å¯è¼¸å…¥äº¤æ˜“å‚™è¨»ï¼Œæ–¹ä¾¿æ—¥å¾ŒæŸ¥æ‰¾ã€‚</p>
                        </div>
                    </div>

                    <!-- æ­·å²è¨˜éŒ„ -->
                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <h3 class="font-black text-white mb-2 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                            æ­·å²è¨˜éŒ„
                        </h3>
                        <div class="space-y-2 text-xs text-white/70">
                            <p><strong class="text-white">æœˆä»½é¸æ“‡ï¼š</strong>é¸æ“‡è¦æŸ¥çœ‹çš„æœˆä»½ï¼Œé¡¯ç¤ºè©²æœˆæ‰€æœ‰äº¤æ˜“ã€‚</p>
                            <p><strong class="text-white">æœå°‹åŠŸèƒ½ï¼š</strong>åœ¨æœå°‹æ¡†è¼¸å…¥é—œéµå­—ï¼Œå¯æœå°‹å‚™è¨»æˆ–åˆ†é¡åç¨±ï¼Œå³æ™‚éæ¿¾çµæœã€‚</p>
                            <p><strong class="text-white">æ—¥æœŸåˆ†çµ„ï¼š</strong>äº¤æ˜“æŒ‰æ—¥æœŸåˆ†çµ„é¡¯ç¤ºï¼Œé»æ“Šæ—¥æœŸå¡ç‰‡å¯å±•é–‹/æ”¶èµ·è©²æ—¥äº¤æ˜“ã€‚</p>
                            <p><strong class="text-white">ç·¨è¼¯/åˆªé™¤ï¼š</strong>é»æ“Šäº¤æ˜“é …ç›®å¯ç·¨è¼¯æˆ–åˆªé™¤è©²ç­†äº¤æ˜“ã€‚</p>
                        </div>
                    </div>

                    <!-- çµ±è¨ˆåˆ†æ -->
                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <h3 class="font-black text-white mb-2 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-4 h-4"></i>
                            çµ±è¨ˆåˆ†æ
                        </h3>
                        <div class="space-y-2 text-xs text-white/70">
                            <p><strong class="text-white">åœ“é¤…åœ–ï¼š</strong>é¡¯ç¤ºè©²æœˆå„åˆ†é¡çš„æ”¯å‡ºæ¯”ä¾‹ï¼ŒåŒ…å«ç¾é‡‘æ¶ˆè²»å’Œä¿¡ç”¨å¡æ¶ˆè²»ã€‚</p>
                            <p><strong class="text-white">åˆ†é¡æ˜ç´°ï¼š</strong>é»æ“Šåˆ†é¡é …ç›®å¯è·³è½‰åˆ°æ­·å²è¨˜éŒ„æŸ¥çœ‹è©²åˆ†é¡çš„æ‰€æœ‰äº¤æ˜“ã€‚</p>
                            <p><strong class="text-white">è¶¨å‹¢åœ–è¡¨ï¼š</strong>é¡¯ç¤ºæœ€è¿‘6å€‹æœˆçš„æ¶ˆè²»è¶¨å‹¢ï¼Œå¹«åŠ©æ‚¨äº†è§£æ”¯å‡ºè®ŠåŒ–ã€‚æ»‘é¼ æ‡¸åœå¯æŸ¥çœ‹è©³ç´°é‡‘é¡ã€‚</p>
                            <p><strong class="text-white">æœˆä»½åˆ‡æ›ï¼š</strong>å¯åˆ‡æ›ä¸åŒæœˆä»½æŸ¥çœ‹æ­·å²çµ±è¨ˆã€‚</p>
                        </div>
                    </div>

                    <!-- ä¿¡ç”¨å¡ç®¡ç† -->
                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <h3 class="font-black text-white mb-2 flex items-center gap-2">
                            <i data-lucide="credit-card" class="w-4 h-4"></i>
                            ä¿¡ç”¨å¡ç®¡ç†
                        </h3>
                        <div class="space-y-2 text-xs text-white/70">
                            <p><strong class="text-white">æ–°å¢ä¿¡ç”¨å¡ï¼š</strong>è¨­å®šä¿¡ç”¨å¡åç¨±ã€çµå¸³æ—¥ã€ç¹³æ¬¾é–“éš”å¤©æ•¸ã€‚å¯é¸å¡«åˆå§‹æœªç¹³æ¸…é¤˜é¡ï¼ˆä½¿ç”¨Appå‰å·²å­˜åœ¨çš„æ¬ æ¬¾ï¼‰ã€‚</p>
                            <p><strong class="text-white">çµå¸³æ—¥ï¼š</strong>æ¯æœˆå¹¾è™Ÿçµå¸³ï¼Œç”¨æ–¼è¨ˆç®—å¸³å–®æœˆä»½ã€‚</p>
                            <p><strong class="text-white">ç¹³æ¬¾é–“éš”ï¼š</strong>çµå¸³å¾Œå¹¾å¤©å…§éœ€è¦ç¹³æ¬¾ã€‚</p>
                            <p><strong class="text-white">åˆå§‹é¤˜é¡ï¼š</strong>ä½¿ç”¨Appå‰å·²å­˜åœ¨çš„æœªç¹³æ¸…å¸³å–®ï¼Œç³»çµ±æœƒæ­£ç¢ºè¿½è¹¤é‚„æ¬¾é€²åº¦ï¼Œä¸æœƒé‡è¤‡è¨ˆç®—ã€‚</p>
                            <p><strong class="text-white">è¨˜éŒ„é‚„æ¬¾ï¼š</strong>é»æ“Šã€Œé‚„æ¬¾ã€æŒ‰éˆ•è¨˜éŒ„é‚„æ¬¾é‡‘é¡ï¼Œç³»çµ±æœƒè‡ªå‹•æ›´æ–°å‰©é¤˜æ¬ æ¬¾ã€‚</p>
                            <p><strong class="text-white">åˆ†æœŸè¨ˆç®—ï¼š</strong>åˆ†æœŸä»˜æ¬¾æœƒè‡ªå‹•åˆ†é…åˆ°å„æœŸå¸³å–®ï¼Œé¤˜æ•¸æ”¾åœ¨æœ€å¾Œä¸€æœŸã€‚</p>
                        </div>
                    </div>

                    <!-- å®šæœŸäº¤æ˜“ -->
                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <h3 class="font-black text-white mb-2 flex items-center gap-2">
                            <i data-lucide="repeat" class="w-4 h-4"></i>
                            å®šæœŸäº¤æ˜“
                        </h3>
                        <div class="space-y-2 text-xs text-white/70">
                            <p><strong class="text-white">åŠŸèƒ½èªªæ˜ï¼š</strong>è¨­å®šå›ºå®šæ”¯å‡ºï¼ˆå¦‚æˆ¿ç§Ÿã€é›»è©±è²»ï¼‰ï¼Œç³»çµ±æœƒåœ¨åˆ°æœŸæ™‚è‡ªå‹•å»ºç«‹äº¤æ˜“ã€‚</p>
                            <p><strong class="text-white">é »ç‡è¨­å®šï¼š</strong>æ”¯æ´æ¯æ—¥ã€æ¯é€±ã€æ¯æœˆã€æ¯å¹´å››ç¨®é »ç‡ã€‚</p>
                            <p><strong class="text-white">æ—¥æœŸè¨­å®šï¼š</strong>è¨­å®šé–‹å§‹æ—¥æœŸå’ŒçµæŸæ—¥æœŸï¼ˆå¯é¸ï¼‰ï¼Œç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆã€‚</p>
                            <p><strong class="text-white">è‡ªå‹•å»ºç«‹ï¼š</strong>æ¯æ¬¡é–‹å•ŸAppæ™‚ï¼Œç³»çµ±æœƒæª¢æŸ¥ä¸¦è‡ªå‹•å»ºç«‹åˆ°æœŸçš„å®šæœŸäº¤æ˜“ã€‚</p>
                            <p><strong class="text-white">æ”¯ä»˜æ–¹å¼ï¼š</strong>å¯è¨­å®šç‚ºç¾é‡‘æˆ–ä¿¡ç”¨å¡æ”¯ä»˜ã€‚</p>
                        </div>
                    </div>

                    <!-- è¨­å®šåŠŸèƒ½ -->
                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <h3 class="font-black text-white mb-2 flex items-center gap-2">
                            <i data-lucide="settings" class="w-4 h-4"></i>
                            è¨­å®šåŠŸèƒ½
                        </h3>
                        <div class="space-y-2 text-xs text-white/70">
                            <p><strong class="text-white">ä¸»é¡Œåˆ‡æ›ï¼š</strong>é¸æ“‡ä¸åŒçš„è¦–è¦ºä¸»é¡Œï¼Œæ”¹è®ŠAppçš„é¡è‰²é¢¨æ ¼ã€‚</p>
                            <p><strong class="text-white">å¹£ç¨®è¨­å®šï¼š</strong>è¨­å®šä¸»è¦é¡¯ç¤ºå¹£ç¨®ï¼Œæ‰€æœ‰é‡‘é¡æœƒè½‰æ›ç‚ºæ­¤å¹£ç¨®é¡¯ç¤ºã€‚</p>
                            <p><strong class="text-white">é ç®—è¨­å®šï¼š</strong>è¨­å®šæ¯æœˆæ¶ˆè²»é ç®—ä¸Šé™ï¼Œç³»çµ±æœƒè¿½è¹¤é ç®—ä½¿ç”¨æƒ…æ³ã€‚</p>
                            <p><strong class="text-white">åˆ†é¡ç®¡ç†ï¼š</strong>æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤äº¤æ˜“åˆ†é¡ï¼Œè‡ªè¨‚åˆ†é¡åœ–ç¤ºå’Œé¡è‰²ã€‚</p>
                            <p><strong class="text-white">é›²ç«¯åŒæ­¥ï¼š</strong>ç™»å…¥å¸³æˆ¶å¾Œå¯åŒæ­¥è³‡æ–™åˆ°é›²ç«¯ï¼Œæ–¹ä¾¿è·¨è£ç½®ä½¿ç”¨ã€‚æœ¬åœ°è³‡æ–™æ°¸ä¹…ä¿ç•™ã€‚</p>
                        </div>
                    </div>

                    <!-- ä½¿ç”¨æŠ€å·§ -->
                    <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-2xl p-4 space-y-2">
                        <h3 class="font-black text-yellow-400 mb-2 flex items-center gap-2">
                            <i data-lucide="lightbulb" class="w-4 h-4"></i>
                            ä½¿ç”¨æŠ€å·§
                        </h3>
                        <div class="space-y-2 text-xs text-yellow-400/80">
                            <p>â€¢ å®šæœŸè¨˜éŒ„äº¤æ˜“ï¼Œä¿æŒè³‡æ–™å®Œæ•´æ€§</p>
                            <p>â€¢ ä½¿ç”¨æœå°‹åŠŸèƒ½å¿«é€Ÿæ‰¾åˆ°ç‰¹å®šäº¤æ˜“</p>
                            <p>â€¢ å®šæœŸæŸ¥çœ‹çµ±è¨ˆåˆ†æï¼Œäº†è§£æ¶ˆè²»æ¨¡å¼</p>
                            <p>â€¢ è¨­å®šå®šæœŸäº¤æ˜“ï¼Œè‡ªå‹•è¨˜éŒ„å›ºå®šæ”¯å‡º</p>
                            <p>â€¢ å–„ç”¨åˆ†é¡åŠŸèƒ½ï¼Œæ–¹ä¾¿æ—¥å¾Œåˆ†æ</p>
                            <p>â€¢ ä¿¡ç”¨å¡åˆ†æœŸæœƒè‡ªå‹•åˆ†é…åˆ°å„æœŸå¸³å–®</p>
                            <p>â€¢ è¨˜éŒ„é‚„æ¬¾å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•æ›´æ–°å‰©é¤˜æ¬ æ¬¾</p>
                        </div>
                    </div>
                </div>
                
                <button onclick="closeHelpModal()" class="w-full py-4 dynamic-accent-bg text-black rounded-2xl font-black mt-4">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>

        <!-- é›²ç«¯èªªæ˜ Modal -->
        <div id="cloudInfoModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-md rounded-[40px] p-8 space-y-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-500/20 flex items-center justify-center">
                        <i data-lucide="cloud" class="w-6 h-6 text-blue-400"></i>
                    </div>
                    <h2 class="text-xl font-black">é›²ç«¯åŒæ­¥èªªæ˜</h2>
                </div>
                
                <div class="space-y-4 text-sm text-white/80">
                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">ğŸ’¾</span>
                            <div>
                                <h3 class="font-black text-white mb-1">æœ¬åœ°å„ªå…ˆå„²å­˜</h3>
                                <p class="text-xs text-white/60">æ‰€æœ‰è³‡æ–™å„ªå…ˆå„²å­˜åœ¨æ‚¨çš„è£ç½®ä¸Šï¼Œå³ä½¿é›¢ç·šä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">â˜ï¸</span>
                            <div>
                                <h3 class="font-black text-white mb-1">é›²ç«¯å‚™ä»½</h3>
                                <p class="text-xs text-white/60">ç™»å…¥å¸³æˆ¶å¾Œï¼Œé»æ“Šã€Œç«‹å³åŒæ­¥åˆ°é›²ç«¯ã€æŒ‰éˆ•å³å¯åŒæ­¥è³‡æ–™ï¼Œæ–¹ä¾¿è·¨è£ç½®ä½¿ç”¨ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-2xl p-4 space-y-2">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">â°</span>
                            <div>
                                <h3 class="font-black text-yellow-400 mb-1">è³‡æ–™ä¿ç•™æœŸé™</h3>
                                <p class="text-xs text-yellow-400/80">é›²ç«¯åƒ…ä¿ç•™æœ€è¿‘ <span class="font-black">365 å¤©</span>çš„äº¤æ˜“è¨˜éŒ„ï¼Œè¶…éä¸€å¹´çš„è³‡æ–™æœƒè‡ªå‹•æ¸…ç†ã€‚</p>
                                <p class="text-xs text-yellow-400/60 mt-2">ğŸ’¡ æ³¨æ„ï¼šæœ¬åœ°è³‡æ–™ä¸å—å½±éŸ¿ï¼Œæ°¸ä¹…ä¿ç•™åœ¨æ‚¨çš„è£ç½®ä¸Šã€‚</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">ğŸ”„</span>
                            <div>
                                <h3 class="font-black text-white mb-1">æ‰‹å‹•åŒæ­¥</h3>
                                <p class="text-xs text-white/60">é»æ“Šã€Œç«‹å³åŒæ­¥åˆ°é›²ç«¯ã€æŒ‰éˆ•ä¾†åŒæ­¥è³‡æ–™ã€‚åŒæ­¥æœƒä¸Šå‚³æœ¬åœ°è³‡æ–™ä¸¦ä¸‹è¼‰é›²ç«¯æœ€æ–°è³‡æ–™ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="closeCloudInfoModal()" class="w-full py-4 dynamic-accent-bg text-black rounded-2xl font-black">
                    æˆ‘çŸ¥é“äº†
                </button>
            </div>
        </div>

        <!-- ç™»å…¥ä»£ç¢¼ Modal -->
        <div id="loginCodeModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-md rounded-[40px] p-8 space-y-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-500/20 flex items-center justify-center">
                        <span class="text-2xl">ğŸ”‘</span>
                    </div>
                    <h2 class="text-xl font-black">æ‚¨çš„ç™»å…¥ä»£ç¢¼</h2>
                </div>
                
                <div class="bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border-2 border-blue-400/30 rounded-3xl p-8 text-center space-y-4">
                    <p class="text-[10px] text-white/40 uppercase tracking-widest font-black">6 ä½æ•¸ç™»å…¥ä»£ç¢¼</p>
                    <div id="displayLoginCode" class="text-5xl font-black text-white tracking-[0.3em] select-all" style="font-family: 'Courier New', monospace;">
                        ------
                    </div>
                    <p class="text-[10px] text-white/40">é»æ“Šä»£ç¢¼å³å¯è¤‡è£½</p>
                </div>

                <div class="bg-white/5 rounded-2xl p-4 space-y-3">
                    <p class="text-[10px] font-black text-white uppercase">ä½¿ç”¨æ–¹å¼ï¼š</p>
                    <ol class="text-[11px] text-white/70 space-y-2 ml-4 list-decimal">
                        <li>é»æ“Šä¸Šæ–¹ä»£ç¢¼é€²è¡Œè¤‡è£½</li>
                        <li>åœ¨å…¶ä»–è£ç½®é–‹å•Ÿæ­¤ App</li>
                        <li>é¸æ“‡ã€ŒğŸ”‘ ç™»å…¥ä»£ç¢¼ã€åˆ†é </li>
                        <li>è²¼ä¸Šä»£ç¢¼å³å¯å®Œæˆç™»å…¥</li>
                    </ol>
                </div>

                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-2xl p-4">
                    <p class="text-[10px] text-yellow-400 flex items-start gap-2">
                        <span>â°</span>
                        <span>æ­¤ä»£ç¢¼æœ‰æ•ˆæœŸç‚º <span class="font-black">10 åˆ†é˜</span>ï¼ŒéæœŸå¾Œéœ€é‡æ–°ç”¢ç”Ÿã€‚</span>
                    </p>
                </div>

                <button onclick="closeLoginCodeModal()" class="w-full py-4 dynamic-accent-bg text-black rounded-2xl font-black">
                    é—œé–‰
                </button>
            </div>
        </div>

        <div id="nav-container" class="nav-dock-container">
            <nav class="nav-dock">
                <button onclick="nav('home')" id="nav-home" class="nav-btn active"><i data-lucide="home"></i></button>
                <button onclick="nav('history')" id="nav-history" class="nav-btn"><i data-lucide="calendar"></i></button>
                <button onclick="prepareAdd()" class="center-add-btn"><i data-lucide="plus" class="text-black"></i></button>
                <button onclick="nav('stats')" id="nav-stats" class="nav-btn"><i data-lucide="pie-chart"></i></button>
                <button onclick="nav('settings')" id="nav-settings" class="nav-btn"><i data-lucide="settings"></i></button>
            </nav>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        const THEME_SCHEMES = [
            { id: 'minimal', color: '#ffffff', rgb: '255, 255, 255', opacity: 0.7, bg: '#0a0a0c' },
            { id: 'cyber', color: '#6366f1', rgb: '99, 102, 241', opacity: 0.5, bg: '#05051e' },
            { id: 'neon', color: '#10b981', rgb: '16, 185, 129', opacity: 0.5, bg: '#020d08' },
            { id: 'gold', color: '#f59e0b', rgb: '245, 158, 11', opacity: 0.6, bg: '#0d0b02' },
            { id: 'crimson', color: '#ef4444', rgb: '239, 68, 68', opacity: 0.5, bg: '#0d0202' },
            { id: 'candy', color: '#ec4899', rgb: '236, 72, 153', opacity: 0.5, bg: '#0d0208' },
            { id: 'royal', color: '#8b5cf6', rgb: '139, 92, 246', opacity: 0.5, bg: '#08020d' },
            { id: 'cyan', color: '#06b6d4', rgb: '6, 182, 212', opacity: 0.5, bg: '#020c0d' },
            { id: 'ocean', color: '#3b82f6', rgb: '59, 130, 246', opacity: 0.5, bg: '#020510' },
            { id: 'emerald', color: '#14b8a6', rgb: '20, 184, 166', opacity: 0.5, bg: '#020d0b' },
            { id: 'amber', color: '#fbbf24', rgb: '251, 191, 36', opacity: 0.6, bg: '#0d0a02' },
            { id: 'rose', color: '#f43f5e', rgb: '244, 63, 94', opacity: 0.5, bg: '#0d0204' },
            { id: 'indigo', color: '#4f46e5', rgb: '79, 70, 229', opacity: 0.5, bg: '#03020d' },
            { id: 'teal', color: '#0d9488', rgb: '13, 148, 136', opacity: 0.5, bg: '#020a09' },
            { id: 'orange', color: '#fb923c', rgb: '251, 146, 60', opacity: 0.6, bg: '#0d0702' },
            { id: 'violet', color: '#a855f7', rgb: '168, 85, 247', opacity: 0.5, bg: '#0a020d' }
        ];

        const CURRENCY_OPTIONS = [
            { id: 'TWD', symbol: 'NT$', name: 'å°å¹£ TWD', flag: 'ğŸ‡¹ğŸ‡¼', rateToUSD: 0.032 },
            { id: 'USD', symbol: '$', name: 'ç¾é‡‘ USD', flag: 'ğŸ‡ºğŸ‡¸', rateToUSD: 1 },
            { id: 'SGD', symbol: 'S$', name: 'æ–°å¹£ SGD', flag: 'ğŸ‡¸ğŸ‡¬', rateToUSD: 0.74 }
        ];

        // æ±‡ç‡æ¢ç®—å‡½æ•°ï¼šå°†é‡‘é¢ä»ä¸€ç§è´§å¸è½¬æ¢ä¸ºå¦ä¸€ç§è´§å¸
        function convertCurrency(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            
            const fromRate = CURRENCY_OPTIONS.find(c => c.id === fromCurrency)?.rateToUSD || 1;
            const toRate = CURRENCY_OPTIONS.find(c => c.id === toCurrency)?.rateToUSD || 1;
            
            // å…ˆè½¬æ¢ä¸ºç¾å…ƒï¼Œå†è½¬æ¢ä¸ºç›®æ ‡è´§å¸
            const amountInUSD = amount * fromRate;
            return amountInUSD / toRate;
        }

        // ç²¾é¸ 130+ å€‹å¯¦ç”¨è¨˜å¸³ Emoji - æ¶µè“‹æ‰€æœ‰ç”Ÿæ´»å ´æ™¯
        // ============================================
        // Supabase é…ç½®
        // ============================================
        const SUPABASE_CONFIG = {
            url: 'https://ndtkurowumazsgdotlxb.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kdGt1cm93dW1henNnZG90bHhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzUwMzUsImV4cCI6MjA4MzgxMTAzNX0.tukEU-T8f8Sne7KRFOPBYgtlhalHWaPMJlZ_Qpa6J6E'
        };

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        let supabaseClient = null;
        let currentUser = null;
        
        if (SUPABASE_CONFIG.url !== 'YOUR_SUPABASE_URL' && SUPABASE_CONFIG.anonKey !== 'YOUR_SUPABASE_ANON_KEY') {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                console.log('âœ… Supabase initialized');
            } catch (error) {
                console.warn('âš ï¸ Supabase initialization failed:', error);
            }
        } else {
            console.warn('âš ï¸ Supabase not configured. Running in local-only mode.');
        }

        // ============================================
        // IndexedDB ç®¡ç†å™¨ï¼ˆæœ¬åœ°ä¼˜å…ˆå­˜å‚¨ï¼‰
        // ============================================
        class LocalDatabase {
            constructor() {
                this.dbName = 'LedgerDB';
                this.version = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('âœ… IndexedDB initialized');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // åˆ›å»º transactions å­˜å‚¨
                        if (!db.objectStoreNames.contains('transactions')) {
                            const txStore = db.createObjectStore('transactions', { keyPath: 'id' });
                            txStore.createIndex('date', 'date', { unique: false });
                            txStore.createIndex('category', 'category', { unique: false });
                            txStore.createIndex('updated_at', 'updated_at', { unique: false });
                        }

                        // åˆ›å»º categories å­˜å‚¨
                        if (!db.objectStoreNames.contains('categories')) {
                            const catStore = db.createObjectStore('categories', { keyPath: 'name' });
                            catStore.createIndex('name', 'name', { unique: true });
                        }

                        // åˆ›å»º settings å­˜å‚¨
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }

                        // åˆ›å»º sync_metadata å­˜å‚¨
                        if (!db.objectStoreNames.contains('sync_metadata')) {
                            db.createObjectStore('sync_metadata', { keyPath: 'key' });
                        }
                    };
                });
            }

            async get(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async put(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async bulkPut(storeName, dataArray) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    let completed = 0;

                    dataArray.forEach(data => {
                        const request = store.put(data);
                        request.onsuccess = () => {
                            completed++;
                            if (completed === dataArray.length) {
                                resolve();
                            }
                        };
                        request.onerror = () => reject(request.error);
                    });
                });
            }
        }

        // åˆå§‹åŒ–æœ¬åœ°è³‡æ–™åº«
        const localDB = new LocalDatabase();

        // ============================================
        // åŒæ­¥ç®¡ç†å™¨ï¼ˆæœ¬åœ° â†” é›²ç«¯ï¼‰
        // ============================================
        class SyncManager {
            constructor(localDB, supabaseClient) {
                this.localDB = localDB;
                this.supabaseClient = supabaseClient;
                this.isSyncing = false;
                this.lastSyncTime = null;
                this.syncError = null;
                this.hasSyncedThisSession = false; // æ ‡è®°æœ¬ä¼šè¯æ˜¯å¦å·²åŒæ­¥
            }

            async getLastSyncTime() {
                const metadata = await this.localDB.get('sync_metadata', 'lastSyncTime');
                return metadata ? new Date(metadata.value) : null;
            }

            async setLastSyncTime(time) {
                await this.localDB.put('sync_metadata', {
                    key: 'lastSyncTime',
                    value: time.toISOString()
                });
            }

            async syncToCloud() {
                if (!this.supabaseClient || !currentUser) {
                    console.warn('âš ï¸ Sync skipped: Supabase not configured or user not logged in');
                    this.syncError = 'offline';
                    return { success: false, error: 'offline' };
                }

                if (this.isSyncing) {
                    console.warn('âš ï¸ Sync already in progress');
                    return { success: false, error: 'already_syncing' };
                }

                this.isSyncing = true;
                this.syncError = null;
                updateSyncUI();

                // è®¾ç½®è¶…æ—¶æœºåˆ¶ï¼ˆ60ç§’ï¼‰
                const syncTimeout = setTimeout(() => {
                    if (this.isSyncing) {
                        console.error('âŒ Sync timeout after 60 seconds');
                        this.isSyncing = false;
                        this.syncError = 'åŒæ­¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                        updateSyncUI();
                    }
                }, 60000);

                try {
                    console.log('ğŸ”„ Starting bidirectional merge sync...');

                    // æ­¥éª¤ Aï¼šè·å–äº‘ç«¯å’Œæœ¬åœ°æ•°æ®
                    console.log('ğŸ“¥ Step A: Fetching cloud and local data...');
                    
                    // è·å–äº‘ç«¯æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ï¼‰
                    const { data: cloudTransactions, error: fetchCloudError } = await this.supabaseClient
                        .from('transactions')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .gte('date', new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
                    
                    if (fetchCloudError) throw fetchCloudError;
                    
                    // è·å–æœ¬åœ°æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ï¼‰
                    const localTransactions = await this.localDB.getAll('transactions');
                    
                    // æ­¥éª¤ Bï¼šæ‰§è¡ŒåŒå‘åˆå¹¶
                    console.log('ğŸ”„ Step B: Executing bidirectional merge...');
                    
                    // æ ‡å‡†åŒ–æ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µå­˜åœ¨
                    const normalizedCloud = (cloudTransactions || []).map(tx => ({
                        ...tx,
                        is_deleted: tx.is_deleted || false,
                        updated_at: tx.updated_at || new Date().toISOString()
                    }));
                    
                    const normalizedLocal = localTransactions.map(tx => ({
                        ...tx,
                        is_deleted: tx.is_deleted || false,
                        updated_at: tx.updated_at || new Date().toISOString()
                    }));
                    
                    // æ‰§è¡ŒåŒå‘åˆå¹¶
                    const mergedTransactions = this.mergeTransactions(normalizedCloud, normalizedLocal);
                    
                    // æ­¥éª¤ Cï¼šæ›´æ–°äº‘ç«¯å’Œæœ¬åœ°
                    console.log('ğŸ’¾ Step C: Writing merged data...');
                    
                    // æ›´æ–°äº‘ç«¯ï¼šä¸Šä¼ å®Œæ•´çš„åˆå¹¶æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„å’Œä¿¡ç”¨å¡å­—æ®µï¼‰
                    if (mergedTransactions.length > 0) {
                        const txData = mergedTransactions.map(tx => ({
                            id: tx.id,
                            user_id: currentUser.id,
                            amount: tx.amount,
                            date: tx.date,
                            note: tx.note || '',
                            category: tx.category,
                            icon: tx.icon,
                            currency: tx.currency || 'TWD',
                            payment_method: tx.paymentMethod || tx.payment_method || 'cash',
                            card_id: tx.cardId || tx.card_id || null,
                            installments: tx.installments || 1,
                            interest_rate: tx.interestRate || tx.interest_rate || 0,
                            billing_month: tx.billingMonth || tx.billing_month || null,
                            updated_at: tx.updated_at,
                            is_deleted: tx.is_deleted || false
                        }));

                        const { error: txError } = await this.supabaseClient
                            .from('transactions')
                            .upsert(txData, { onConflict: 'id' });

                        if (txError) throw txError;
                        console.log(`âœ… Uploaded ${mergedTransactions.length} merged transactions to cloud`);
                    }
                    
                    // æ›´æ–°æœ¬åœ°ï¼šä¿å­˜å®Œæ•´çš„åˆå¹¶æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„å’Œä¿¡ç”¨å¡å­—æ®µï¼Œç”¨äºåŒæ­¥ï¼‰
                    // æ‰¹é‡å¤„ç†ï¼Œé¿å…å¾ªç¯è¿‡æ…¢
                    if (mergedTransactions.length > 0) {
                        const batchSize = 100;
                        for (let i = 0; i < mergedTransactions.length; i += batchSize) {
                            const batch = mergedTransactions.slice(i, i + batchSize);
                            await Promise.all(batch.map(tx => 
                                this.localDB.put('transactions', {
                                    id: tx.id,
                                    amount: parseFloat(tx.amount),
                                    date: tx.date,
                                    note: tx.note || '',
                                    category: tx.category,
                                    icon: tx.icon,
                                    currency: tx.currency || 'TWD',
                                    paymentMethod: tx.payment_method || tx.paymentMethod || 'cash',
                                    cardId: tx.card_id || tx.cardId || null,
                                    installments: tx.installments || 1,
                                    interestRate: tx.interest_rate || tx.interestRate || 0,
                                    billingMonth: tx.billing_month || tx.billingMonth || null,
                                    updated_at: tx.updated_at,
                                    is_deleted: tx.is_deleted || false
                                })
                            ));
                            console.log(`ğŸ’¾ Saved batch ${Math.floor(i / batchSize) + 1}/${Math.ceil(mergedTransactions.length / batchSize)}`);
                        }
                        console.log(`âœ… Saved ${mergedTransactions.length} merged transactions to local`);
                    }

                    // 2. åŒæ­¥åˆ†ç±»
                    const categories = await this.localDB.getAll('categories');
                    const localCatIds = new Set();
                    
                    if (categories.length > 0) {
                        const catData = categories.map(cat => {
                            const catId = cat.id || crypto.randomUUID();
                            localCatIds.add(catId);
                            return {
                                id: catId,
                                user_id: currentUser.id,
                                name: cat.name,
                                icon: cat.icon,
                                color: cat.color,
                                updated_at: cat.updated_at || new Date().toISOString()
                            };
                        });

                        const { error: catError } = await this.supabaseClient
                            .from('categories')
                            .upsert(catData, { onConflict: 'id' });

                        if (catError) throw catError;
                        console.log(`âœ… Synced ${categories.length} categories`);
                    }
                    
                    // 2.1 åˆ é™¤äº‘ç«¯ä¸­æœ¬åœ°ä¸å­˜åœ¨çš„åˆ†ç±»ï¼ˆå®ç°çœŸæ­£çš„åˆ é™¤åŒæ­¥ï¼‰
                    const { data: cloudCategories, error: fetchCatError } = await this.supabaseClient
                        .from('categories')
                        .select('id')
                        .eq('user_id', currentUser.id);
                    
                    if (!fetchCatError && cloudCategories) {
                        const cloudCatIds = new Set(cloudCategories.map(cat => cat.id));
                        const toDelete = Array.from(cloudCatIds).filter(id => !localCatIds.has(id));
                        
                        if (toDelete.length > 0) {
                            const { error: deleteError } = await this.supabaseClient
                                .from('categories')
                                .delete()
                                .in('id', toDelete);
                            
                            if (deleteError) {
                                console.warn('âš ï¸ Failed to delete categories from cloud:', deleteError);
                            } else {
                                console.log(`âœ… Deleted ${toDelete.length} categories from cloud`);
                            }
                        }
                    }

                    // 3. åŒæ­¥ä½¿ç”¨è€…è¨­å®š
                    const budgetSetting = await this.localDB.get('settings', 'budget');
                    const themeSetting = await this.localDB.get('settings', 'themeId');
                    const currencySetting = await this.localDB.get('settings', 'currency');
                    const settingsUpdatedAt = await this.localDB.get('settings', 'settings_updated_at');

                    const now = new Date().toISOString();
                    const settingsData = {
                        user_id: currentUser.id,
                        budget: budgetSetting ? budgetSetting.value : 30000,
                        theme_id: themeSetting ? themeSetting.value : 'minimal',
                        currency: currencySetting ? currencySetting.value : 'TWD',
                        updated_at: settingsUpdatedAt ? settingsUpdatedAt.value : now,
                        last_sync_at: now
                    };

                    const { error: settingsError } = await this.supabaseClient
                        .from('user_settings')
                        .upsert(settingsData, { onConflict: 'user_id' });

                    if (settingsError) throw settingsError;
                    console.log('âœ… Synced user settings');

                    // 3.5. åŒæ­¥ä¿¡ç”¨å¡æ•°æ®
                    if (state.cards && state.cards.length > 0) {
                        const cardData = state.cards.map(card => ({
                            id: card.id,
                            user_id: currentUser.id,
                            name: card.name,
                            closing_day: card.closingDay,
                            due_days_after: card.dueDaysAfter,
                            carrying_balance: card.carryingBalance || 0,
                            initial_balance: card.initialBalance || 0,
                            updated_at: card.updated_at || now,
                            is_deleted: card.is_deleted || false
                        }));

                        const { error: cardError } = await this.supabaseClient
                            .from('credit_cards')
                            .upsert(cardData, { onConflict: 'id' });

                        if (cardError) throw cardError;
                        console.log(`âœ… Synced ${state.cards.length} credit cards`);
                    }

                    // 4. åŸ·è¡Œé›²ç«¯è³‡æ–™æ¸…ç†ï¼ˆåˆªé™¤ 365 å¤©å‰çš„è³‡æ–™ï¼‰
                    const { data: cleanupResult, error: cleanupError } = await this.supabaseClient
                        .rpc('sync_and_cleanup', { target_user_id: currentUser.id });

                    if (cleanupError) {
                        console.warn('âš ï¸ Cleanup failed:', cleanupError);
                    } else {
                        console.log(`âœ… Cleaned up ${cleanupResult.deleted_count} old records from cloud`);
                    }

                    // 5. æ›´æ–°æœ€å¾ŒåŒæ­¥æ™‚é–“
                    this.lastSyncTime = new Date();
                    this.hasSyncedThisSession = true; // æ ‡è®°æœ¬ä¼šè¯å·²åŒæ­¥
                    await this.setLastSyncTime(this.lastSyncTime);

                    clearTimeout(syncTimeout);
                    this.isSyncing = false;
                    updateSyncUI();

                    return { success: true, time: this.lastSyncTime };

                } catch (error) {
                    console.error('âŒ Sync failed:', error);
                    clearTimeout(syncTimeout);
                    this.syncError = error.message || 'æœªçŸ¥é”™è¯¯';
                    this.isSyncing = false;
                    updateSyncUI();

                    // éœé»˜è™•ç†éŒ¯èª¤ï¼Œä¸å½±éŸ¿ä½¿ç”¨è€…é«”é©—
                    return { success: false, error: this.syncError };
                } finally {
                    // ç¡®ä¿çŠ¶æ€æ€»æ˜¯è¢«é‡ç½®
                    clearTimeout(syncTimeout);
                    if (this.isSyncing) {
                        console.warn('âš ï¸ Sync state was not properly reset, forcing reset');
                        this.isSyncing = false;
                        updateSyncUI();
                    }
                }
            }

            // åŒå‘åˆå¹¶ç®—æ³•ï¼šåˆå¹¶äº‘ç«¯å’Œæœ¬åœ°æ•°æ®
            mergeTransactions(cloudData, localData) {
                const mergedMap = new Map();
                
                // 1. å…ˆæ·»åŠ æ‰€æœ‰æœ¬åœ°æ•°æ®
                localData.forEach(tx => {
                    mergedMap.set(tx.id, { ...tx });
                });
                
                // 2. å¤„ç†äº‘ç«¯æ•°æ®
                cloudData.forEach(cloudTx => {
                    const localTx = mergedMap.get(cloudTx.id);
                    
                    if (!localTx) {
                        // ID åªå­˜åœ¨äºäº‘ç«¯ï¼Œç›´æ¥æ·»åŠ 
                        mergedMap.set(cloudTx.id, {
                            ...cloudTx,
                            is_deleted: cloudTx.is_deleted || false
                        });
                    } else {
                        // ID åŒæ—¶å­˜åœ¨äºåŒæ–¹ï¼Œæ¯”è¾ƒ updated_at
                        const cloudUpdatedAt = new Date(cloudTx.updated_at || 0).getTime();
                        const localUpdatedAt = new Date(localTx.updated_at || 0).getTime();
                        
                        if (cloudUpdatedAt > localUpdatedAt) {
                            // äº‘ç«¯æ•°æ®æ›´æ–°ï¼Œä½¿ç”¨äº‘ç«¯æ•°æ®
                            mergedMap.set(cloudTx.id, {
                                ...cloudTx,
                                is_deleted: cloudTx.is_deleted || false
                            });
                        } else {
                            // æœ¬åœ°æ•°æ®æ›´æ–°ï¼Œä¿ç•™æœ¬åœ°æ•°æ®ï¼ˆä½†ç¡®ä¿ is_deleted å­—æ®µå­˜åœ¨ï¼‰
                            mergedMap.set(cloudTx.id, {
                                ...localTx,
                                is_deleted: localTx.is_deleted || false
                            });
                        }
                    }
                });
                
                return Array.from(mergedMap.values());
            }

            async syncFromCloud() {
                if (!this.supabaseClient || !currentUser) {
                    return { success: false, error: 'offline' };
                }

                try {
                    console.log('ğŸ”„ Pulling data from cloud...');

                    // 1. æ‹‰å–äº¤æ˜“è®°å½•ï¼ˆä»…æœ€è¿‘ 365 å¤©ï¼ŒåŒ…æ‹¬å·²åˆ é™¤çš„ï¼‰
                    const { data: cloudTransactions, error: txError } = await this.supabaseClient
                        .from('transactions')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .gte('date', new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])
                        .order('date', { ascending: false });

                    if (txError) throw txError;

                    // 2. æ‹‰å–åˆ†ç±»
                    const { data: categories, error: catError } = await this.supabaseClient
                        .from('categories')
                        .select('*')
                        .eq('user_id', currentUser.id);

                    if (catError) throw catError;

                    // 3. æ‹‰å–ä½¿ç”¨è€…è¨­å®š
                    const { data: settings, error: settingsError } = await this.supabaseClient
                        .from('user_settings')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();

                    if (settingsError && settingsError.code !== 'PGRST116') throw settingsError;

                    // 3.5. æ‹‰å–ä¿¡ç”¨å¡æ•°æ®
                    const { data: creditCards, error: cardError } = await this.supabaseClient
                        .from('credit_cards')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('is_deleted', false);

                    if (cardError && cardError.code !== 'PGRST116') {
                        console.warn('âš ï¸ Failed to fetch credit cards:', cardError);
                    }

                    // 4. æ‰§è¡ŒåŒå‘åˆå¹¶ï¼šè·å–æœ¬åœ°æ•°æ®å¹¶åˆå¹¶
                    const localTransactions = await this.localDB.getAll('transactions');
                    
                    // ç¡®ä¿æ‰€æœ‰è®°å½•éƒ½æœ‰ is_deleted å­—æ®µ
                    const normalizedCloud = (cloudTransactions || []).map(tx => ({
                        ...tx,
                        is_deleted: tx.is_deleted || false,
                        updated_at: tx.updated_at || new Date().toISOString()
                    }));
                    
                    const normalizedLocal = localTransactions.map(tx => ({
                        ...tx,
                        is_deleted: tx.is_deleted || false,
                        updated_at: tx.updated_at || new Date().toISOString()
                    }));
                    
                    // æ‰§è¡ŒåŒå‘åˆå¹¶
                    const mergedTransactions = this.mergeTransactions(normalizedCloud, normalizedLocal);
                    
                    // ä¿å­˜åˆå¹¶åçš„æ•°æ®åˆ°æœ¬åœ°ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„è®°å½•å’Œä¿¡ç”¨å¡å­—æ®µï¼‰
                    let savedCount = 0;
                    for (const tx of mergedTransactions) {
                        await this.localDB.put('transactions', {
                            id: tx.id,
                            amount: parseFloat(tx.amount),
                            date: tx.date,
                            note: tx.note || '',
                            category: tx.category,
                            icon: tx.icon,
                            currency: tx.currency || 'TWD',
                            paymentMethod: tx.payment_method || tx.paymentMethod || 'cash',
                            cardId: tx.card_id || tx.cardId || null,
                            installments: tx.installments || 1,
                            interestRate: tx.interest_rate || tx.interestRate || 0,
                            billingMonth: tx.billing_month || tx.billingMonth || null,
                            updated_at: tx.updated_at,
                            is_deleted: tx.is_deleted || false
                        });
                        savedCount++;
                    }
                    
                    console.log(`âœ… Merged ${mergedTransactions.length} transactions (${savedCount} saved to local)`);

                    if (categories && categories.length > 0) {
                        for (const cat of categories) {
                            await this.localDB.put('categories', {
                                id: cat.id,
                                name: cat.name,
                                icon: cat.icon,
                                color: cat.color,
                                updated_at: cat.updated_at
                            });
                        }
                        console.log(`âœ… Pulled ${categories.length} categories from cloud`);
                    }

                    // å¤„ç†ä¿¡ç”¨å¡æ•°æ®
                    if (creditCards && creditCards.length > 0) {
                        state.cards = creditCards.map(card => ({
                            id: card.id,
                            name: card.name,
                            closingDay: card.closing_day,
                            dueDaysAfter: card.due_days_after,
                            carryingBalance: parseFloat(card.carrying_balance) || 0,
                            initialBalance: parseFloat(card.initial_balance) || 0,
                            updated_at: card.updated_at
                        }));
                        // ä¿å­˜åˆ° localStorage
                        localStorage.setItem('ledger_cards_v13', JSON.stringify(state.cards));
                        console.log(`âœ… Pulled ${creditCards.length} credit cards from cloud`);
                    }

                    if (settings) {
                        // æ£€æŸ¥æœ¬åœ°è®¾ç½®çš„æ›´æ–°æ—¶é—´ï¼Œåªæ›´æ–°è¾ƒæ–°çš„ç‰ˆæœ¬
                        const localSettingsUpdatedAt = await this.localDB.get('settings', 'settings_updated_at');
                        const cloudUpdatedAt = settings.updated_at || settings.last_sync_at;
                        
                        // å¦‚æœäº‘ç«¯æ•°æ®æ›´æ–°ï¼Œæˆ–è€…æœ¬åœ°æ²¡æœ‰æ›´æ–°æ—¶é—´æˆ³ï¼Œåˆ™æ›´æ–°æœ¬åœ°è®¾ç½®
                        if (!localSettingsUpdatedAt || !cloudUpdatedAt || 
                            new Date(cloudUpdatedAt) > new Date(localSettingsUpdatedAt.value)) {
                            await this.localDB.put('settings', { key: 'budget', value: parseFloat(settings.budget) });
                            await this.localDB.put('settings', { key: 'themeId', value: settings.theme_id });
                            await this.localDB.put('settings', { key: 'currency', value: settings.currency });
                            await this.localDB.put('settings', { key: 'settings_updated_at', value: cloudUpdatedAt });
                            
                            // æ›´æ–° state
                            state.budget = parseFloat(settings.budget);
                            state.themeId = settings.theme_id;
                            state.currency = settings.currency;
                            
                            console.log('âœ… Pulled user settings from cloud (updated)');
                        } else {
                            console.log('âœ… Local settings are newer, keeping local version');
                        }
                    }

                    return { success: true };

                } catch (error) {
                    console.error('âŒ Pull failed:', error);
                    return { success: false, error: error.message };
                }
            }
        }

        // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨
        let syncManager = null;

        // ============================================
        // Emoji Pool
        // ============================================
        const EMOJI_POOL = [
            // é¤é£²ç¾é£Ÿ (25å€‹)
            "ğŸš", "ğŸœ", "ğŸ", "ğŸ•", "ğŸ”", "ğŸŸ", "ğŸŒ­", "ğŸ¥ª", "ğŸŒ®", "ğŸŒ¯", "ğŸ±", "ğŸ›", "ğŸ²", "ğŸ³", "ğŸ¥˜", "ğŸ—", "ğŸ–", "ğŸ¥©", "ğŸ¤", "ğŸ£", "ğŸ°", "ğŸ§", "ğŸ©", "ğŸ‚", "ğŸ¥“",
            // é£²å“èŒ¶é£² (15å€‹)
            "â˜•", "ğŸµ", "ğŸ§‹", "ğŸ¥¤", "ğŸ¥›", "ğŸ·", "ğŸº", "ğŸ¥‚", "ğŸ¹", "ğŸ§Š", "ğŸ»", "ğŸ¥ƒ", "ğŸ§‰", "ğŸ§ƒ", "ğŸ¾",
            // äº¤é€šå‡ºè¡Œ (18å€‹)
            "ğŸš—", "ğŸš•", "ğŸš™", "ğŸšŒ", "ğŸš‡", "ğŸš²", "ğŸ›µ", "ğŸï¸", "âœˆï¸", "ğŸš„", "ğŸš¢", "â›½", "ğŸ…¿ï¸", "ğŸ«", "ğŸš‰", "ğŸ§³", "ğŸš‚", "ğŸš",
            // è³¼ç‰©æ¶ˆè²» (20å€‹)
            "ğŸ›’", "ğŸ›ï¸", "ğŸ‘•", "ğŸ‘—", "ğŸ‘–", "ğŸ‘Ÿ", "ğŸ‘ ", "ğŸ‘œ", "ğŸ‘›", "ğŸ’", "ğŸ’„", "ğŸ’", "âŒš", "ğŸ‘“", "ğŸ“¦", "ğŸ", "ğŸ§¥", "ğŸ‘”", "ğŸ©±", "ğŸ§¢",
            // å¨›æ¨‚ä¼‘é–’ (20å€‹)
            "ğŸ®", "ğŸ¬", "ğŸ¤", "ğŸ§", "ğŸ¨", "ğŸ­", "ğŸ¸", "ğŸ¯", "ğŸ²", "ğŸ³", "ğŸŸï¸", "ğŸª", "ğŸ¡", "ğŸ¢", "ğŸ°", "ğŸ¹", "ğŸº", "ğŸ»", "ğŸ·", "ğŸ•¹ï¸",
            // ç¤¾äº¤èšæœƒ (12å€‹)
            "ğŸ»", "ğŸ¥³", "ğŸ‰", "ğŸŠ", "ğŸˆ", "ğŸ€", "ğŸ§¨", "ğŸ†", "ğŸ‡", "ğŸ¾", "ğŸ¥‚", "ğŸ’",
            // é‹å‹•å¥èº« (12å€‹)
            "âš½", "ğŸ€", "ğŸ¾", "ğŸ", "ğŸ‹ï¸", "ğŸ§˜", "ğŸš´", "ğŸƒ", "ğŸŠ", "â›¹ï¸", "ğŸ¥Š", "ğŸ¤¸",
            // é‡‘èç†è²¡ (15å€‹)
            "ğŸ’°", "ğŸ’³", "ğŸ’µ", "ğŸ’´", "ğŸ’¶", "ğŸ’·", "ğŸ¦", "ğŸ’¹", "ğŸ“ˆ", "ğŸª™", "ğŸ’¸", "ğŸ’²", "ğŸ¤‘", "ğŸ“Š", "ğŸ“‰",
            // å¸³å–®è²»ç”¨ (18å€‹)
            "ğŸ§¾", "ğŸ“±", "ğŸ’»", "ğŸ“", "ğŸ“º", "ğŸ”Œ", "ğŸ’¡", "ğŸ”‹", "ğŸ“¶", "ğŸš¿", "ğŸš½", "ğŸ›", "ğŸ§»", "ğŸ§¼", "ğŸ§½", "ğŸ§´", "ğŸ—‘ï¸", "ğŸ“®",
            // ä¿éšªç¨…å‹™ (8å€‹)
            "ğŸ›ï¸", "âš–ï¸", "ğŸ“‹", "ğŸ“‘", "ğŸ—‚ï¸", "ğŸ“‡", "ğŸ”–", "ğŸ’¼",
            // æˆ¿ç§Ÿä½å®… (10å€‹)
            "ğŸ ", "ğŸ¡", "ğŸ¢", "ğŸ¬", "ğŸ¨", "ğŸ©", "ğŸ›ï¸", "ğŸ›‹ï¸", "ğŸšª", "ğŸ”‘",
            // é†«ç™‚ä¿å¥ (10å€‹)
            "ğŸ’Š", "ğŸ’‰", "ğŸ¥", "ğŸ©º", "ğŸ¦·", "ğŸ©¹", "ğŸ§¬", "ğŸ§ª", "âš•ï¸", "ğŸ§‘â€âš•ï¸",
            // æ•™è‚²å­¸ç¿’ (8å€‹)
            "ğŸ“š", "ğŸ“–", "ğŸ“", "âœï¸", "ğŸ–Šï¸", "ğŸ“", "ğŸ«", "ğŸ–ï¸",
            // å¯µç‰©ç…§é¡§ (8å€‹)
            "ğŸ¶", "ğŸ±", "ğŸ°", "ğŸ¹", "ğŸ¾", "ğŸ¦´", "ğŸŸ", "ğŸ¦",
            // å—œå¥½ç¿’æ…£ (6å€‹)
            "ğŸš¬", "ğŸ°", "ğŸ²", "ğŸƒ", "ğŸ€„", "ğŸ§©"
        ];

        let state = {
            budget: 30000,
            themeId: 'minimal',
            customTheme: null, // è‡ªè¨‚ä¸»é¡Œï¼š{ color, rgb, opacity, bg }
            currency: 'TWD',
            transactions: [],
            categories: [
                { name: "ç¾é£Ÿé¤é£²", icon: "ğŸš", color: "#6366f1" },
                { name: "äº¤é€šé‹è¼¸", icon: "ğŸš—", color: "#10b981" },
                { name: "è³¼ç‰©æ¶ˆè²»", icon: "ğŸ›’", color: "#f59e0b" },
                { name: "å¸³å–®é›œé …", icon: "ğŸ§¾", color: "#8b5cf6" },
                { name: "ä¼‘é–’å¨›æ¨‚", icon: "ğŸ®", color: "#ec4899" }
            ],
            cards: [], // ä¿¡ç”¨å¡åˆ—è¡¨ï¼š{ id, name, closingDay, dueDaysAfter, carryingBalance, initialBalance, totalRepaid, creditLimit }
            recurringTransactions: [], // å®šæœŸäº¤æ˜“ï¼š{ id, amount, category, paymentMethod, cardId, frequency, startDate, endDate, lastCreated, note }
            editingId: null,
            tempCat: "ç¾é£Ÿé¤é£²",
            tempCurrency: null,
            tempEmoji: null,
            tempPaymentMethod: 'cash', // æ”¯ä»˜æ–¹å¼ï¼š'cash' æˆ– 'credit'
            tempCardId: null, // é€‰ä¸­çš„ä¿¡ç”¨å¡ ID
            tempInstallments: 1, // åˆ†æœŸæœŸæ•°ï¼Œé»˜è®¤1
            tempInterestRate: 0, // å¹´åˆ©ç‡ï¼ˆ%ï¼‰ï¼Œé»˜è®¤0
            // æœå°‹ç›¸é—œç‹€æ…‹
            searchKeyword: '',
            searchCategory: null,
            searchDateStart: null,
            searchDateEnd: null,
            isOnline: navigator.onLine,
            lastSyncTime: null,
            syncError: null
        };

        // ============================================
        // è³‡æ–™è¼‰å…¥å’Œå„²å­˜ï¼ˆæœ¬åœ°å„ªå…ˆï¼‰
        // ============================================

        // å¾ IndexedDB è¼‰å…¥è³‡æ–™åˆ° state
        async function loadDataFromLocal() {
            try {
                console.log('ğŸ“‚ Loading data from IndexedDB...');

                // åŠ è½½äº¤æ˜“è®°å½•ï¼ˆè¿‡æ»¤æ‰å·²åˆ é™¤çš„è®°å½•ï¼‰
                const allTransactions = await localDB.getAll('transactions');
                console.log(`ğŸ“Š Found ${allTransactions.length} total transactions in IndexedDB`);
                
                // è¿‡æ»¤æ‰å·²åˆ é™¤çš„è®°å½•ï¼ˆis_deleted ä¸º true æˆ– undefined æ—¶ï¼Œ!tx.is_deleted ä¸º trueï¼Œæ‰€ä»¥ä¼šä¿ç•™ï¼‰
                state.transactions = allTransactions
                    .filter(tx => !tx.is_deleted)  // è¿‡æ»¤æ‰å·²åˆ é™¤çš„è®°å½•
                    .sort((a, b) => b.date.localeCompare(a.date));
                
                console.log(`ğŸ“Š After filtering deleted: ${state.transactions.length} active transactions`);

                // åŠ è½½åˆ†ç±»
                const categories = await localDB.getAll('categories');
                if (categories.length > 0) {
                    state.categories = categories;
                }

                // åŠ è½½ä¿¡ç”¨å¡æ•°æ®
                const cardsData = localStorage.getItem('ledger_cards_v13');
                if (cardsData) {
                    try {
                        state.cards = JSON.parse(cardsData);
                    } catch (e) {
                        console.warn('Failed to parse cards data:', e);
                        state.cards = [];
                    }
                }

                // åŠ è½½å®šæœŸäº¤æ˜“æ•°æ®
                const recurringData = localStorage.getItem('ledger_recurring_v1');
                if (recurringData) {
                    try {
                        state.recurringTransactions = JSON.parse(recurringData);
                    } catch (e) {
                        console.warn('Failed to parse recurring transactions data:', e);
                        state.recurringTransactions = [];
                    }
                }

                // è¼‰å…¥è¨­å®š
                const budgetSetting = await localDB.get('settings', 'budget');
                const themeSetting = await localDB.get('settings', 'themeId');
                const currencySetting = await localDB.get('settings', 'currency');
                const customThemeSetting = await localDB.get('settings', 'customTheme');

                if (budgetSetting) state.budget = budgetSetting.value;
                if (themeSetting) state.themeId = themeSetting.value;
                if (currencySetting) state.currency = currencySetting.value;
                if (customThemeSetting) state.customTheme = customThemeSetting.value;
                
                // æ‡‰ç”¨ä¸»é¡Œ
                if (state.customTheme) {
                    document.documentElement.style.setProperty('--accent', state.customTheme.color);
                    document.documentElement.style.setProperty('--accent-rgb', state.customTheme.rgb);
                    document.documentElement.style.setProperty('--bg-deep', state.customTheme.bg);
                    document.documentElement.style.setProperty('--card-bg', `rgba(28, 28, 32, ${state.customTheme.opacity})`);
                } else {
                    applyTheme(state.themeId);
                }

                // åŠ è½½åŒæ­¥å…ƒæ•°æ®
                const lastSync = await localDB.get('sync_metadata', 'lastSyncTime');
                if (lastSync) state.lastSyncTime = new Date(lastSync.value);

                console.log(`âœ… Loaded ${state.transactions.length} transactions, ${state.categories.length} categories`);
                
                // è™•ç†å®šæœŸäº¤æ˜“ï¼ˆè‡ªå‹•å»ºç«‹åˆ°æœŸçš„äº¤æ˜“ï¼‰
                await processRecurringTransactions();
                
                // è¿ç§»æ—§çš„ localStorage æ•°æ®ï¼ˆä»…é¦–æ¬¡ï¼‰
                await migrateFromLocalStorage();

            } catch (error) {
                console.error('âŒ Failed to load from IndexedDB:', error);
                // å›é€€åˆ° localStorage
                loadDataFromLocalStorage();
            }
        }

        // ============================================
        // å®šæœŸäº¤æ˜“è™•ç†
        // ============================================
        
        // åˆ¤æ–·æ˜¯å¦æ‡‰è©²å»ºç«‹å®šæœŸäº¤æ˜“
        function shouldCreateRecurringTransaction(recurring, today) {
            if (!recurring.startDate) return false;
            
            const startDate = new Date(recurring.startDate);
            if (today < startDate) return false;
            
            if (recurring.endDate) {
                const endDate = new Date(recurring.endDate);
                if (today > endDate) return false;
            }
            
            if (!recurring.lastCreated) return true;
            
            const lastCreated = new Date(recurring.lastCreated);
            const daysDiff = Math.floor((today - lastCreated) / (1000 * 60 * 60 * 24));
            
            switch (recurring.frequency) {
                case 'daily': return daysDiff >= 1;
                case 'weekly': return daysDiff >= 7;
                case 'monthly': 
                    return today.getMonth() !== lastCreated.getMonth() || 
                           today.getFullYear() !== lastCreated.getFullYear();
                case 'yearly':
                    return today.getFullYear() !== lastCreated.getFullYear();
                default: return false;
            }
        }
        
        // è™•ç†å®šæœŸäº¤æ˜“ï¼Œè‡ªå‹•å»ºç«‹åˆ°æœŸçš„äº¤æ˜“
        async function processRecurringTransactions() {
            const today = new Date();
            const todayStr = today.toISOString().slice(0, 10);
            let hasNewTransactions = false;
            
            for (const recurring of state.recurringTransactions) {
                if (!shouldCreateRecurringTransaction(recurring, today)) {
                    continue;
                }
                
                // æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²ç¶“å»ºç«‹éé€™ç­†å®šæœŸäº¤æ˜“
                const alreadyCreated = state.transactions.some(t => 
                    t.isRecurring && 
                    t.recurringId === recurring.id && 
                    t.date === todayStr
                );
                
                if (alreadyCreated) {
                    continue;
                }
                
                // å»ºç«‹äº¤æ˜“
                const category = state.categories.find(c => c.name === recurring.category) || state.categories[0];
                const transaction = {
                    id: Date.now() + Math.random(),
                    amount: recurring.amount,
                    note: recurring.note || `${recurring.category} (å®šæœŸ)`,
                    date: todayStr,
                    category: recurring.category,
                    icon: category.icon,
                    color: category.color,
                    currency: state.currency,
                    paymentMethod: recurring.paymentMethod || 'cash',
                    cardId: recurring.cardId || null,
                    installments: 1,
                    interestRate: 0,
                    isRecurring: true,
                    recurringId: recurring.id,
                    createdAt: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                state.transactions.push(transaction);
                await localDB.put('transactions', transaction);
                
                // æ›´æ–°æœ€å¾Œå»ºç«‹æ™‚é–“
                recurring.lastCreated = today.toISOString();
                hasNewTransactions = true;
                
                console.log(`âœ… Created recurring transaction: ${recurring.note || recurring.category}`);
            }
            
            // å¦‚æœæœ‰æ–°äº¤æ˜“ï¼Œæ›´æ–° localStorage
            if (hasNewTransactions) {
                localStorage.setItem('ledger_recurring_v1', JSON.stringify(state.recurringTransactions));
            }
        }
        
        // è¿ç§»æ—§çš„ localStorage æ•°æ®åˆ° IndexedDBï¼ˆä»…é¦–æ¬¡è¿è¡Œï¼‰
        async function migrateFromLocalStorage() {
            const migrated = await localDB.get('sync_metadata', 'localStorage_migrated');
            if (migrated) return; // å·²è¿ç§»è¿‡

            console.log('ğŸ”„ Migrating data from localStorage to IndexedDB...');

            try {
                // è¿ç§»äº¤æ˜“è®°å½•
                const oldTx = JSON.parse(localStorage.getItem('ledger_tx_v13') || '[]');
                if (oldTx.length > 0) {
                    for (const tx of oldTx) {
                        tx.updated_at = tx.updated_at || new Date().toISOString();
                        await localDB.put('transactions', tx);
                    }
                    state.transactions = oldTx.sort((a, b) => b.date.localeCompare(a.date));
                    console.log(`âœ… Migrated ${oldTx.length} transactions`);
                }

                // è¿ç§»åˆ†ç±»
                const oldCats = JSON.parse(localStorage.getItem('ledger_cats_v13') || '[]');
                if (oldCats.length > 0) {
                    for (const cat of oldCats) {
                        cat.id = cat.id || crypto.randomUUID();
                        cat.updated_at = cat.updated_at || new Date().toISOString();
                        await localDB.put('categories', cat);
                    }
                    state.categories = oldCats;
                    console.log(`âœ… Migrated ${oldCats.length} categories`);
                }

                // è¿ç§»è®¾ç½®
                const oldBudget = parseFloat(localStorage.getItem('ledger_budget_v13'));
                const oldTheme = localStorage.getItem('ledger_theme_id_v13');
                const oldCurrency = localStorage.getItem('ledger_currency_v13');

                if (oldBudget) {
                    await localDB.put('settings', { key: 'budget', value: oldBudget });
                    state.budget = oldBudget;
                }
                if (oldTheme) {
                    await localDB.put('settings', { key: 'themeId', value: oldTheme });
                    state.themeId = oldTheme;
                }
                if (oldCurrency) {
                    await localDB.put('settings', { key: 'currency', value: oldCurrency });
                    state.currency = oldCurrency;
                }

                // æ ‡è®°ä¸ºå·²è¿ç§»
                await localDB.put('sync_metadata', { key: 'localStorage_migrated', value: true });
                console.log('âœ… Migration completed');

                // å¯é€‰ï¼šæ¸…ç†æ—§æ•°æ®
                // localStorage.removeItem('ledger_tx_v13');
                // localStorage.removeItem('ledger_cats_v13');
                // localStorage.removeItem('ledger_budget_v13');
                // localStorage.removeItem('ledger_theme_id_v13');
                // localStorage.removeItem('ledger_currency_v13');

            } catch (error) {
                console.error('âŒ Migration failed:', error);
            }
        }

        // å›é€€åˆ° localStorageï¼ˆä»…å½“ IndexedDB å¤±è´¥æ—¶ï¼‰
        function loadDataFromLocalStorage() {
            console.warn('âš ï¸ Falling back to localStorage');
            state.budget = parseFloat(localStorage.getItem('ledger_budget_v13')) || 30000;
            state.themeId = localStorage.getItem('ledger_theme_id_v13') || 'minimal';
            state.currency = localStorage.getItem('ledger_currency_v13') || 'TWD';
            state.transactions = JSON.parse(localStorage.getItem('ledger_tx_v13')) || [];
            state.categories = JSON.parse(localStorage.getItem('ledger_cats_v13')) || state.categories;
            const cardsData = localStorage.getItem('ledger_cards_v13');
            if (cardsData) {
                try {
                    state.cards = JSON.parse(cardsData);
                } catch (e) {
                    state.cards = [];
                }
            }
        }

        // ä¿å­˜æ•°æ®åˆ° IndexedDBï¼ˆæœ¬åœ°ä¼˜å…ˆï¼‰
        async function save() {
            try {
                const now = new Date().toISOString();
                // ä¿å­˜åˆ° IndexedDB
                await localDB.put('settings', { key: 'budget', value: state.budget });
                await localDB.put('settings', { key: 'themeId', value: state.themeId });
                await localDB.put('settings', { key: 'currency', value: state.currency });
                if (state.customTheme) {
                    await localDB.put('settings', { key: 'customTheme', value: state.customTheme });
                }
                // ä¿å­˜è®¾ç½®æ›´æ–°æ—¶é—´æˆ³
                await localDB.put('settings', { key: 'settings_updated_at', value: now });
                
                // ä¿å­˜åˆ†ç±»åˆ° IndexedDB
                for (const cat of state.categories) {
                    await localDB.put('categories', {
                        id: cat.id || crypto.randomUUID(),
                        name: cat.name,
                        icon: cat.icon,
                        color: cat.color,
                        updated_at: cat.updated_at || now
                    });
                }

                // åŒæ—¶ä¿å­˜åˆ° localStorage ä½œä¸ºå¤‡ä»½
                localStorage.setItem('ledger_budget_v13', state.budget);
                localStorage.setItem('ledger_theme_id_v13', state.themeId);
                localStorage.setItem('ledger_currency_v13', state.currency);
                localStorage.setItem('ledger_cats_v13', JSON.stringify(state.categories));
                localStorage.setItem('ledger_cards_v13', JSON.stringify(state.cards));
                localStorage.setItem('ledger_settings_updated_at_v13', now);
                
                // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®

            } catch (error) {
                console.error('âŒ Save failed:', error);
                // å›é€€åˆ° localStorage
                const now = new Date().toISOString();
                localStorage.setItem('ledger_budget_v13', state.budget);
                localStorage.setItem('ledger_theme_id_v13', state.themeId);
                localStorage.setItem('ledger_currency_v13', state.currency);
                localStorage.setItem('ledger_cats_v13', JSON.stringify(state.categories));
                localStorage.setItem('ledger_cards_v13', JSON.stringify(state.cards));
                localStorage.setItem('ledger_settings_updated_at_v13', now);
            }
        }

        let lastPage = 'home';
        let myChart = null;
        let trendChart = null;

        function getCurrencySymbol() {
            const curr = CURRENCY_OPTIONS.find(c => c.id === state.currency);
            return curr ? curr.symbol : 'NT$';
        }

        function updateCurrencySymbols() {
            const symbol = getCurrencySymbol();
            const el1 = document.getElementById('currencySymbolHome');
            const el2 = document.getElementById('currencySymbolHome2');
            const el3 = document.getElementById('currencySymbolAdd');
            if(el1) el1.innerText = symbol;
            if(el2) el2.innerText = symbol;
            if(el3) el3.innerText = symbol;
        }

        // ============================================
        // åŒæ­¥ UI æ›´æ–°å‡½æ•°
        // ============================================
        function updateSyncUI() {
            if (!syncManager) return;

            const statusBadge = document.getElementById('syncStatusBadge');
            const lastSyncDisplay = document.getElementById('lastSyncDisplay');
            const syncErrorMessage = document.getElementById('syncErrorMessage');
            const syncBtnText = document.getElementById('syncBtnText');
            const manualSyncBtn = document.getElementById('manualSyncBtn');
            const localDataCount = document.getElementById('localDataCount');

            // æ›´æ–°æœ¬åœ°è³‡æ–™çµ±è¨ˆ
            if (localDataCount) {
                localDataCount.innerText = `${state.transactions.length} ç­†äº¤æ˜“`;
            }

            // æ›´æ–°åŒæ­¥çŠ¶æ€å¾½ç« 
            if (statusBadge) {
                if (!supabaseClient) {
                    statusBadge.innerHTML = '<span class="bg-gray-500/20 text-gray-400 px-2 py-1 rounded-full">ä»…æœ¬åœ°</span>';
                } else if (!currentUser) {
                    statusBadge.innerHTML = '<span class="bg-orange-500/20 text-orange-400 px-2 py-1 rounded-full">éœ€è¦ç™»å½•</span>';
                } else if (syncManager.isSyncing) {
                    statusBadge.innerHTML = '<span class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">åŒæ­¥ä¸­...</span>';
                } else if (syncManager.syncError) {
                    statusBadge.innerHTML = '<span class="bg-red-500/20 text-red-400 px-2 py-1 rounded-full">åŒæ­¥å¤±æ•—</span>';
                } else if (syncManager.lastSyncTime && syncManager.hasSyncedThisSession) {
                    // åªæœ‰åœ¨æœ¬ä¼šè¯ä¸­æˆåŠŸåŒæ­¥è¿‡æ‰æ˜¾ç¤º"å·²åŒæ­¥"
                    statusBadge.innerHTML = '<span class="bg-green-500/20 text-green-400 px-2 py-1 rounded-full">å·²åŒæ­¥</span>';
                } else {
                    // åº”ç”¨å¯åŠ¨æ—¶æˆ–ä»æœªåŒæ­¥è¿‡ï¼Œæ˜¾ç¤º"æœªåŒæ­¥"
                    statusBadge.innerHTML = '<span class="bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded-full">æœªåŒæ­¥</span>';
                }
            }

            // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
            if (lastSyncDisplay) {
                if (syncManager.lastSyncTime) {
                    const timeDiff = Date.now() - syncManager.lastSyncTime.getTime();
                    const minutes = Math.floor(timeDiff / 60000);
                    const hours = Math.floor(minutes / 60);
                    const days = Math.floor(hours / 24);

                    if (days > 0) {
                        lastSyncDisplay.innerText = `${days} å¤©å‰`;
                    } else if (hours > 0) {
                        lastSyncDisplay.innerText = `${hours} å°æ—¶å‰`;
                    } else if (minutes > 0) {
                        lastSyncDisplay.innerText = `${minutes} åˆ†é’Ÿå‰`;
                    } else {
                        lastSyncDisplay.innerText = 'åˆšåˆš';
                    }
                } else {
                    lastSyncDisplay.innerText = 'å¾æœªåŒæ­¥';
                }
            }

            // æ›´æ–°éŒ¯èª¤è³‡è¨Š
            if (syncErrorMessage) {
                if (!supabaseClient) {
                    syncErrorMessage.innerText = 'âš ï¸ æœªé…ç½®é›²ç«¯ï¼Œç›®å‰åƒ…å„²å­˜æ–¼æœ¬åœ°';
                    syncErrorMessage.classList.remove('hidden');
                } else if (!currentUser) {
                    syncErrorMessage.innerText = 'ğŸ’¡ æç¤ºï¼šè«‹å…ˆç™»å…¥ Supabase å¸³æˆ¶æ‰èƒ½å•Ÿç”¨é›²ç«¯åŒæ­¥åŠŸèƒ½';
                    syncErrorMessage.className = 'text-[9px] text-orange-400 bg-orange-500/10 p-2 rounded-lg';
                    syncErrorMessage.classList.remove('hidden');
                } else if (syncManager.syncError) {
                    if (syncManager.syncError === 'offline') {
                        syncErrorMessage.innerText = 'âš ï¸ ç¶²è·¯é›¢ç·šï¼Œç›®å‰åƒ…å„²å­˜æ–¼æœ¬åœ°';
                    } else {
                        syncErrorMessage.innerText = `âŒ åŒæ­¥å¤±æ•—ï¼š${syncManager.syncError}`;
                    }
                    syncErrorMessage.className = 'text-[9px] text-red-400 bg-red-500/10 p-2 rounded-lg';
                    syncErrorMessage.classList.remove('hidden');
                } else {
                    syncErrorMessage.classList.add('hidden');
                }
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            if (syncBtnText && manualSyncBtn) {
                if (syncManager.isSyncing) {
                    syncBtnText.innerText = 'ğŸ”„ åŒæ­¥ä¸­...';
                    manualSyncBtn.disabled = true;
                    manualSyncBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    // æ˜¾ç¤ºåŒæ­¥è¿›åº¦æç¤º
                    if (lastSyncDisplay) {
                        lastSyncDisplay.innerText = 'åŒæ­¥ä¸­ï¼Œè¯·å‹¿å…³é—­...';
                    }
                } else if (!supabaseClient) {
                    syncBtnText.innerText = 'â˜ï¸ æœªé…ç½®é›²ç«¯';
                    manualSyncBtn.disabled = true;
                    manualSyncBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else if (!currentUser) {
                    syncBtnText.innerText = 'ğŸ” éœ€è¦ç™»å…¥æ‰èƒ½åŒæ­¥';
                    manualSyncBtn.disabled = true;
                    manualSyncBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    syncBtnText.innerText = 'ğŸ”„ ç«‹å³åŒæ­¥åˆ°é›²ç«¯';
                    manualSyncBtn.disabled = false;
                    manualSyncBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // æ‰‹åŠ¨åŒæ­¥æŒ‰é’®ï¼ˆåŒå‘å¢é‡åˆå¹¶ï¼‰
        async function manualSync() {
            if (!syncManager || syncManager.isSyncing) {
                console.warn('âš ï¸ Sync already in progress or syncManager not available');
                return;
            }

            // ä¿å­˜æœ¬åœ°æ•°æ®å¿«ç…§ï¼Œç”¨äºå¤±è´¥æ—¶æ’¤é”€
            let localSnapshot = null;
            try {
                localSnapshot = await localDB.getAll('transactions');
            } catch (e) {
                console.warn('âš ï¸ Failed to create snapshot:', e);
            }

            updateSyncUI();
            
            // è®¾ç½®åŒæ­¥è¶…æ—¶ï¼ˆ90ç§’æ€»è¶…æ—¶ï¼‰
            const manualSyncTimeout = setTimeout(() => {
                if (syncManager && syncManager.isSyncing) {
                    console.error('âŒ Manual sync timeout after 90 seconds');
                    syncManager.isSyncing = false;
                    syncManager.syncError = 'åŒæ­¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                    updateSyncUI();
                    alert('âš ï¸ åŒæ­¥è¶…æ—¶ï¼\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚');
                }
            }, 90000);
            
            try {
                console.log('ğŸ”„ Starting bidirectional merge sync...');
                
                // æ­¥éª¤ Aï¼šè·å–äº‘ç«¯å’Œæœ¬åœ°æ•°æ®
                // æ­¥éª¤ Bï¼šæ‰§è¡ŒåŒå‘åˆå¹¶
                // æ­¥éª¤ Cï¼šæ›´æ–°äº‘ç«¯å’Œæœ¬åœ°
                // è¿™äº›æ­¥éª¤éƒ½åœ¨ syncToCloud() ä¸­å®Œæˆ
                const result = await syncManager.syncToCloud();

                if (result.success) {
                    console.log('âœ… Bidirectional merge sync completed');
                    
                    // åŒæ­¥åˆ†ç±»å’Œè®¾ç½®
                    const categories = await localDB.getAll('categories');
                    if (categories.length > 0) {
                        const catData = categories.map(cat => ({
                            id: cat.id || crypto.randomUUID(),
                            user_id: currentUser.id,
                            name: cat.name,
                            icon: cat.icon,
                            color: cat.color,
                            updated_at: cat.updated_at || new Date().toISOString()
                        }));

                        const { error: catError } = await syncManager.supabaseClient
                            .from('categories')
                            .upsert(catData, { onConflict: 'id' });

                        if (catError) throw catError;
                        console.log('âœ… Synced categories');
                    }
                    
                    // åŒæ­¥è®¾ç½®
                    const budgetSetting = await localDB.get('settings', 'budget');
                    const themeSetting = await localDB.get('settings', 'themeId');
                    const currencySetting = await localDB.get('settings', 'currency');
                    const settingsUpdatedAt = await localDB.get('settings', 'settings_updated_at');

                    const now = new Date().toISOString();
                    const settingsData = {
                        user_id: currentUser.id,
                        budget: budgetSetting ? budgetSetting.value : 30000,
                        theme_id: themeSetting ? themeSetting.value : 'minimal',
                        currency: currencySetting ? currencySetting.value : 'TWD',
                        updated_at: settingsUpdatedAt ? settingsUpdatedAt.value : now,
                        last_sync_at: now
                    };

                    const { error: settingsError } = await syncManager.supabaseClient
                        .from('user_settings')
                        .upsert(settingsData, { onConflict: 'user_id' });

                    if (settingsError) throw settingsError;
                    console.log('âœ… Synced user settings');
                    
                    // è®°å½•æœ€ååŒæ­¥æ—¶é—´
                    await syncManager.setLastSyncTime(new Date());
                    
                    // é‡æ–°åŠ è½½åˆå¹¶åçš„æ•°æ®ï¼ˆè¿‡æ»¤æ‰å·²åˆ é™¤çš„ï¼‰
                    await loadDataFromLocal();
                    console.log('âœ… Reloaded merged data from local storage');
                    
                    // åˆ·æ–°UI
                    renderAll();
                    console.log('âœ… UI refreshed');
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    alert('âœ… åŒæ­¥å®Œæˆï¼æ‰€æœ‰æ›´æ”¹å·²é€éé›™å‘åˆä½µå„²å­˜åˆ°é›²ç«¯ã€‚');
                } else {
                    console.warn('âš ï¸ Manual sync failed:', result.error);
                    
                    // æ’¤é”€ï¼šæ¢å¤å¿«ç…§
                    if (localSnapshot) {
                        try {
                            for (const tx of localSnapshot) {
                                await localDB.put('transactions', tx);
                            }
                            await loadDataFromLocal();
                            renderAll();
                            console.log('âœ… Local changes reverted');
                        } catch (revertError) {
                            console.error('âŒ Failed to revert changes:', revertError);
                        }
                    }
                    
                    alert('âš ï¸ åŒæ­¥å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤') + '\n\næœ¬åœ°æ›´æ”¹å·²æ’¤éŠ·ã€‚');
                }
            } catch (error) {
                console.error('âŒ Manual sync error:', error);
                
                // æ’¤é”€ï¼šæ¢å¤å¿«ç…§
                if (localSnapshot) {
                    try {
                        for (const tx of localSnapshot) {
                            await localDB.put('transactions', tx);
                        }
                        await loadDataFromLocal();
                        renderAll();
                        console.log('âœ… Local changes reverted after error');
                    } catch (revertError) {
                        console.error('âŒ Failed to revert changes:', revertError);
                    }
                }
                
                alert('âŒ åŒæ­¥å‡ºéŒ¯ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤') + '\n\næœ¬åœ°æ›´æ”¹å·²æ’¤éŠ·ã€‚');
            } finally {
                clearTimeout(manualSyncTimeout);
                // ç¡®ä¿åŒæ­¥çŠ¶æ€è¢«é‡ç½®
                if (syncManager && syncManager.isSyncing) {
                    console.warn('âš ï¸ Forcing sync state reset in finally block');
                    syncManager.isSyncing = false;
                }
                updateSyncUI();
            }
        }

        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
        window.addEventListener('online', () => {
            console.log('ğŸŒ Network online');
            state.isOnline = true;
            updateSyncUI();
            // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®
        });

        window.addEventListener('offline', () => {
            console.log('ğŸ“¡ Network offline');
            state.isOnline = false;
            updateSyncUI();
        });

        // ============================================
        // PWA æ”¯æŒ - å…¨å±æ¨¡å¼
        // ============================================
        // é˜²æ­¢ iOS Safari çš„æ©¡çš®ç­‹æ•ˆæœï¼ˆä½†å…è®¸æ­£å¸¸æ»šåŠ¨ï¼‰
        document.addEventListener('touchmove', function(e) {
            // æ£€æŸ¥ç›®æ ‡å…ƒç´ åŠå…¶çˆ¶å…ƒç´ æ˜¯å¦å¯ä»¥æ»šåŠ¨
            let element = e.target;
            let canScroll = false;
            
            // å‘ä¸Šéå† DOM æ ‘ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¯æ»šåŠ¨çš„çˆ¶å…ƒç´ 
            while (element && element !== document.body) {
                const style = window.getComputedStyle(element);
                const overflowY = style.overflowY;
                const overflow = style.overflow;
                
                // æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯ä»¥å‚ç›´æ»šåŠ¨
                if (overflowY === 'auto' || overflowY === 'scroll' || 
                    overflow === 'auto' || overflow === 'scroll') {
                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦çœŸçš„å¯ä»¥æ»šåŠ¨ï¼ˆå†…å®¹é«˜åº¦ > å®¹å™¨é«˜åº¦ï¼‰
                    if (element.scrollHeight > element.clientHeight) {
                        canScroll = true;
                        break;
                    }
                }
                
                element = element.parentElement;
            }
            
            // å¦‚æœæ‰¾åˆ°å¯æ»šåŠ¨å…ƒç´ ï¼Œå…è®¸æ»šåŠ¨
            if (canScroll) {
                return;
            }
            
            // æ£€æŸ¥ä¸»å®¹å™¨æ˜¯å¦å¯ä»¥æ»šåŠ¨
            const mainContainer = document.getElementById('mainContainer');
            if (mainContainer && mainContainer.scrollHeight > mainContainer.clientHeight) {
                // å¦‚æœè§¦æ‘¸ç‚¹åœ¨ä¸»å®¹å™¨å†…ï¼Œå…è®¸æ»šåŠ¨
                if (mainContainer.contains(e.target)) {
                    return;
                }
            }
            
            // å¦åˆ™é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆé˜²æ­¢æ©¡çš®ç­‹æ•ˆæœï¼‰
            e.preventDefault();
        }, { passive: false });

        // éšè—åœ°å€æ ï¼ˆiOS Safariï¼‰- åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
        let addressBarHidden = false;
        window.addEventListener('load', function() {
            if (!addressBarHidden) {
                setTimeout(function() {
                    window.scrollTo(0, 1);
                    addressBarHidden = true;
                }, 0);
            }
        });

        // é˜²æ­¢åŒå‡»ç¼©æ”¾ - åªåœ¨éäº¤äº’å…ƒç´ ä¸Š
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            // å…è®¸åœ¨æŒ‰é’®ã€è¾“å…¥æ¡†ç­‰äº¤äº’å…ƒç´ ä¸ŠåŒå‡»
            if (e.target.tagName === 'BUTTON' || 
                e.target.tagName === 'INPUT' || 
                e.target.tagName === 'TEXTAREA' ||
                e.target.closest('button') ||
                e.target.closest('input') ||
                e.target.closest('textarea')) {
                return;
            }
            
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // ============================================
        // åº”ç”¨åˆå§‹åŒ–
        // ============================================
        window.onload = async () => {
            console.log('ğŸš€ Initializing Ledger App...');
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±æ¨¡å¼ï¼ˆæ·»åŠ åˆ°ä¸»å±å¹•åï¼‰
            if (window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
                console.log('âœ… Running in standalone mode (added to home screen)');
                document.body.classList.add('standalone');
            }

            try {
                // 1. åˆå§‹åŒ– IndexedDB
                await localDB.init();

                // 2. åŠ è½½æœ¬åœ°æ•°æ®
                await loadDataFromLocal();

                // 3. åˆå§‹åŒ– Supabase å¹¶å¤„ç† Magic Link
                if (supabaseClient) {
                    // è®¾ç½® auth çŠ¶æ€å˜åŒ–ç›‘å¬å™¨
                    // æ ‡è®°æ˜¯å¦æ­£åœ¨å¤„ç† Magic Link å›è°ƒ
                    let isProcessingMagicLink = false;
                    
                    supabaseClient.auth.onAuthStateChange(async (event, session) => {
                        console.log('ğŸ” Auth state changed:', event, session?.user?.email || 'no user');
                        
                        if (event === 'SIGNED_IN' && session) {
                            currentUser = session.user;
                            state.isLoggedIn = true;
                            state.userId = currentUser.id;
                            console.log('âœ… User signed in:', currentUser.email);
                            
                            // æ¸…é™¤ URL ä¸­çš„ hash
                            if (window.location.hash) {
                                window.history.replaceState(null, '', window.location.pathname);
                            }
                            
                            // å¦‚æœæ˜¯ Magic Link å›è°ƒï¼Œæ ‡è®°ä¸ºæ­£åœ¨å¤„ç†
                            if (window.location.hash.includes('access_token')) {
                                isProcessingMagicLink = true;
                            }
                            
                            // é¡¯ç¤ºä¸»æ‡‰ç”¨å¹¶åŒæ­¥æ•°æ®
                            showMainApp();
                            
                            // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                            if (!syncManager) {
                                syncManager = new SyncManager(localDB, supabaseClient);
                            }
                            
                            // ç™»å½•åæ‰§è¡Œé¦–æ¬¡åŒæ­¥ï¼šå¦‚æœäº‘ç«¯ä¸ºç©ºï¼Œå…ˆä¸Šä¼ æœ¬åœ°æ•°æ®ï¼›å¦åˆ™æ‰§è¡ŒåŒå‘åˆå¹¶
                            console.log('ğŸ”„ Checking cloud data after login...');
                            try {
                                // ç¡®ä¿æœ¬åœ°æ•°æ®å·²åŠ è½½åˆ° state
                                await loadDataFromLocal();
                                
                                // å…ˆæ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰æ•°æ®
                                const { data: cloudCheck, error: checkError } = await supabaseClient
                                    .from('transactions')
                                    .select('id')
                                    .eq('user_id', currentUser.id)
                                    .limit(1);
                                
                                const hasCloudData = !checkError && cloudCheck && cloudCheck.length > 0;
                                // ç›´æ¥ä» IndexedDB æ£€æŸ¥æœ¬åœ°æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®ï¼‰
                                const localDataCheck = await localDB.getAll('transactions');
                                const hasLocalData = localDataCheck && localDataCheck.length > 0;
                                
                                console.log(`ğŸ“Š Cloud data: ${hasCloudData ? 'exists' : 'empty'}, Local data: ${hasLocalData ? 'exists' : 'empty'}`);
                                
                                if (!hasCloudData && hasLocalData) {
                                    // é¦–æ¬¡ç™»å½•ï¼šäº‘ç«¯ä¸ºç©ºï¼Œæœ¬åœ°æœ‰æ•°æ®
                                    // å…ˆæ˜¾ç¤ºæœ¬åœ°æ•°æ®ï¼Œç„¶åå†ä¸Šä¼ 
                                    console.log('ğŸ“¤ First-time login: Local data detected, will upload to cloud...');
                                    
                                    // å…ˆç¡®ä¿æœ¬åœ°æ•°æ®å·²æ˜¾ç¤º
                                    await loadDataFromLocal();
                                    renderAll();
                                    
                                    // ç„¶åä¸Šä¼ æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
                                    console.log('ğŸ“¤ Uploading local data to cloud...');
                                    const uploadResult = await syncManager.syncToCloud();
                                    if (uploadResult.success) {
                                        console.log('âœ… Local data uploaded to cloud');
                                        // ä¸Šä¼ åé‡æ–°åŠ è½½ï¼ˆè™½ç„¶æ•°æ®åº”è¯¥ä¸€æ ·ï¼Œä½†ç¡®ä¿ä¸€è‡´æ€§ï¼‰
                                        await loadDataFromLocal();
                                    } else {
                                        console.warn('âš ï¸ Failed to upload local data:', uploadResult.error);
                                        // å³ä½¿ä¸Šä¼ å¤±è´¥ï¼Œä¹Ÿç¡®ä¿æ˜¾ç¤ºæœ¬åœ°æ•°æ®
                                        await loadDataFromLocal();
                                    }
                                } else if (!hasCloudData && !hasLocalData) {
                                    // é¦–æ¬¡ç™»å½•ä¸”æœ¬åœ°å’Œäº‘ç«¯éƒ½ä¸ºç©ºï¼šå¯èƒ½æ˜¯æ–°æµè§ˆå™¨ï¼Œæç¤ºç”¨æˆ·
                                    console.log('â„¹ï¸ First-time login: Both cloud and local are empty');
                                    await loadDataFromLocal();
                                    renderAll();
                                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                                    setTimeout(() => {
                                        alert('ğŸ’¡ æç¤ºï¼š\n\nè¿™æ˜¯é¦–æ¬¡ç™»å½•ï¼Œç›®å‰æ²¡æœ‰æ•°æ®ã€‚\n\nå¦‚æœæ‚¨åœ¨å…¶ä»–æµè§ˆå™¨ï¼ˆå¦‚ Safariï¼‰ä¸­æœ‰æ•°æ®ï¼Œè¯·ï¼š\n1. åœ¨é‚£ä¸ªæµè§ˆå™¨ä¸­æ‰“å¼€æ­¤åº”ç”¨\n2. ç™»å½•åç‚¹å‡»ã€Œç«‹å³åŒæ­¥åˆ°äº‘ç«¯ã€\n3. ç„¶åå†å›åˆ°æ­¤æµè§ˆå™¨ï¼Œæ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥');
                                    }, 1000);
                                } else {
                                    // å·²æœ‰äº‘ç«¯æ•°æ®æˆ–æœ¬åœ°ä¸ºç©ºï¼šæ‰§è¡ŒåŒå‘åˆå¹¶
                                    console.log('ğŸ”„ Pulling data from cloud and merging...');
                                    await syncManager.syncFromCloud();
                                    // é‡æ–°åŠ è½½åˆå¹¶åçš„æ•°æ®
                                    await loadDataFromLocal();
                                }
                                
                                console.log(`âœ… Data synchronized. Showing ${state.transactions.length} transactions.`);
                            } catch (error) {
                                console.warn('âš ï¸ Failed to sync data:', error);
                                // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿç¡®ä¿åŠ è½½æœ¬åœ°æ•°æ®
                                await loadDataFromLocal();
                                console.log(`âš ï¸ After error, showing ${state.transactions.length} transactions.`);
                            }
                            
                            // åˆ·æ–°UIï¼ˆç¡®ä¿æ•°æ®å·²æ˜¾ç¤ºï¼‰
                            renderAll();
                            updateAuthUI();
                            console.log('âœ… UI refreshed after login');
                            
                            // é‡ç½® Magic Link å¤„ç†æ ‡è®°
                            isProcessingMagicLink = false;
                            
                            console.log('âœ… Login completed!');
                        } else if (event === 'SIGNED_OUT') {
                            currentUser = null;
                            state.isLoggedIn = false;
                            state.userId = null;
                            console.log('âš ï¸ User signed out');
                            updateAuthUI();
                        }
                    });

                    // å…ˆæ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰ Magic Link çš„ tokenï¼ˆhash fragmentï¼‰
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const hasAuthToken = hashParams.has('access_token') || hashParams.has('error');
                    
                    if (hasAuthToken) {
                        console.log('ğŸ”— Detected Magic Link callback in URL');
                        // Supabase SDK ä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ª hash å¹¶è§¦å‘ onAuthStateChange
                        // ç­‰å¾… onAuthStateChange å¤„ç†å®Œæˆï¼ˆæœ€å¤šç­‰å¾… 3 ç§’ï¼‰
                        let waitCount = 0;
                        while (waitCount < 30 && !state.isLoggedIn) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            waitCount++;
                        }
                        
                        // å¦‚æœç­‰å¾…åä»ç„¶æ²¡æœ‰ç™»å½•ï¼Œæ‰‹åŠ¨æ£€æŸ¥ session
                        if (!state.isLoggedIn) {
                            const { data: { session } } = await supabaseClient.auth.getSession();
                            if (session) {
                                currentUser = session.user;
                                state.isLoggedIn = true;
                                state.userId = currentUser.id;
                                console.log('âœ… Magic Link session found after wait:', currentUser.email);
                                
                                // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨
                                if (!syncManager) {
                                    syncManager = new SyncManager(localDB, supabaseClient);
                                }
                                
                                // æ£€æŸ¥å¹¶åŒæ­¥æ•°æ®ï¼ˆé¦–æ¬¡ç™»å½•æ—¶ä¸Šä¼ æœ¬åœ°æ•°æ®ï¼‰
                                try {
                                    // ç¡®ä¿æœ¬åœ°æ•°æ®å·²åŠ è½½
                                    await loadDataFromLocal();
                                    
                                    // å…ˆæ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰æ•°æ®
                                    const { data: cloudCheck, error: checkError } = await supabaseClient
                                        .from('transactions')
                                        .select('id')
                                        .eq('user_id', currentUser.id)
                                        .limit(1);
                                    
                                    const hasCloudData = !checkError && cloudCheck && cloudCheck.length > 0;
                                    const localData = await localDB.getAll('transactions');
                                    const hasLocalData = localData && localData.length > 0;
                                    
                                    console.log(`ğŸ“Š Cloud data: ${hasCloudData ? 'exists' : 'empty'}, Local data: ${hasLocalData ? 'exists' : 'empty'}`);
                                    
                                    if (!hasCloudData && hasLocalData) {
                                        // é¦–æ¬¡ç™»å½•ï¼šäº‘ç«¯ä¸ºç©ºï¼Œæœ¬åœ°æœ‰æ•°æ®
                                        // å…ˆæ˜¾ç¤ºæœ¬åœ°æ•°æ®ï¼Œç„¶åå†ä¸Šä¼ 
                                        console.log('ğŸ“¤ First-time login: Local data detected, will upload to cloud...');
                                        
                                        // å…ˆç¡®ä¿æœ¬åœ°æ•°æ®å·²æ˜¾ç¤º
                                        await loadDataFromLocal();
                                        renderAll();
                                        
                                        // ç„¶åä¸Šä¼ æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
                                        console.log('ğŸ“¤ Uploading local data to cloud...');
                                        const uploadResult = await syncManager.syncToCloud();
                                        if (uploadResult.success) {
                                            console.log('âœ… Local data uploaded to cloud');
                                            // ä¸Šä¼ åé‡æ–°åŠ è½½ï¼ˆè™½ç„¶æ•°æ®åº”è¯¥ä¸€æ ·ï¼Œä½†ç¡®ä¿ä¸€è‡´æ€§ï¼‰
                                            await loadDataFromLocal();
                                        } else {
                                            console.warn('âš ï¸ Failed to upload local data:', uploadResult.error);
                                            // å³ä½¿ä¸Šä¼ å¤±è´¥ï¼Œä¹Ÿç¡®ä¿æ˜¾ç¤ºæœ¬åœ°æ•°æ®
                                            await loadDataFromLocal();
                                        }
                                    } else if (!hasCloudData && !hasLocalData) {
                                        // é¦–æ¬¡ç™»å½•ä¸”æœ¬åœ°å’Œäº‘ç«¯éƒ½ä¸ºç©ºï¼šå¯èƒ½æ˜¯æ–°æµè§ˆå™¨ï¼Œæç¤ºç”¨æˆ·
                                        console.log('â„¹ï¸ First-time login: Both cloud and local are empty');
                                        await loadDataFromLocal();
                                        renderAll();
                                        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                                        setTimeout(() => {
                                            alert('ğŸ’¡ æç¤ºï¼š\n\nè¿™æ˜¯é¦–æ¬¡ç™»å½•ï¼Œç›®å‰æ²¡æœ‰æ•°æ®ã€‚\n\nå¦‚æœæ‚¨åœ¨å…¶ä»–æµè§ˆå™¨ï¼ˆå¦‚ Safariï¼‰ä¸­æœ‰æ•°æ®ï¼Œè¯·ï¼š\n1. åœ¨é‚£ä¸ªæµè§ˆå™¨ä¸­æ‰“å¼€æ­¤åº”ç”¨\n2. ç™»å½•åç‚¹å‡»ã€Œç«‹å³åŒæ­¥åˆ°äº‘ç«¯ã€\n3. ç„¶åå†å›åˆ°æ­¤æµè§ˆå™¨ï¼Œæ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥');
                                        }, 1000);
                                    } else {
                                        // å·²æœ‰äº‘ç«¯æ•°æ®æˆ–æœ¬åœ°ä¸ºç©ºï¼šæ‰§è¡ŒåŒå‘åˆå¹¶
                                        console.log('ğŸ”„ Pulling data from cloud and merging...');
                                        await syncManager.syncFromCloud();
                                        // é‡æ–°åŠ è½½åˆå¹¶åçš„æ•°æ®
                                        await loadDataFromLocal();
                                    }
                                    
                                    console.log(`âœ… Data synchronized. Showing ${state.transactions.length} transactions.`);
                                } catch (error) {
                                    console.warn('âš ï¸ Failed to sync data:', error);
                                    // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿç¡®ä¿åŠ è½½æœ¬åœ°æ•°æ®
                                    await loadDataFromLocal();
                                    console.log(`âš ï¸ After error, showing ${state.transactions.length} transactions.`);
                                }
                                
                                showMainApp();
                                renderAll();
                                updateAuthUI();
                            }
                        }
                        
                        // æ¸…é™¤ URL hash
                        if (window.location.hash) {
                            window.history.replaceState(null, '', window.location.pathname);
                        }
                    }

                    // æ£€æŸ¥ç°æœ‰ä¼šè¯
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) {
                        currentUser = session.user;
                        state.isLoggedIn = true;
                        state.userId = currentUser.id;
                        console.log('âœ… Existing session found:', currentUser.email);
                    } else {
                        console.log('âš ï¸ No user session found');
                        state.isLoggedIn = false;
                        state.userId = null;
                    }

                    // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨
                    syncManager = new SyncManager(localDB, supabaseClient);
                    
                    // è·å–æœ€ååŒæ­¥æ—¶é—´
                    syncManager.lastSyncTime = await syncManager.getLastSyncTime();

                    // å¦‚æœå·²ç™»å½•ï¼Œæ£€æŸ¥å¹¶åŒæ­¥æ•°æ®ï¼ˆé¦–æ¬¡ç™»å½•æ—¶ä¸Šä¼ æœ¬åœ°æ•°æ®ï¼‰
                    if (state.isLoggedIn && currentUser) {
                        console.log('ğŸ”„ Checking cloud data on startup...');
                        try {
                            // ç¡®ä¿æœ¬åœ°æ•°æ®å·²åŠ è½½
                            await loadDataFromLocal();
                            
                            // å…ˆæ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰æ•°æ®
                            const { data: cloudCheck, error: checkError } = await supabaseClient
                                .from('transactions')
                                .select('id')
                                .eq('user_id', currentUser.id)
                                .limit(1);
                            
                            const hasCloudData = !checkError && cloudCheck && cloudCheck.length > 0;
                            // ç›´æ¥ä» IndexedDB æ£€æŸ¥æœ¬åœ°æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®ï¼‰
                            const localDataCheck = await localDB.getAll('transactions');
                            const hasLocalData = localDataCheck && localDataCheck.length > 0;
                            
                            console.log(`ğŸ“Š Cloud data: ${hasCloudData ? 'exists' : 'empty'}, Local data: ${hasLocalData ? 'exists' : 'empty'}`);
                            
                            if (!hasCloudData && hasLocalData) {
                                // é¦–æ¬¡ç™»å½•ï¼šäº‘ç«¯ä¸ºç©ºï¼Œæœ¬åœ°æœ‰æ•°æ®
                                // å…ˆæ˜¾ç¤ºæœ¬åœ°æ•°æ®ï¼Œç„¶åå†ä¸Šä¼ 
                                console.log('ğŸ“¤ First-time login: Local data detected, will upload to cloud...');
                                
                                // å…ˆç¡®ä¿æœ¬åœ°æ•°æ®å·²æ˜¾ç¤º
                                await loadDataFromLocal();
                                renderAll();
                                
                                // ç„¶åä¸Šä¼ æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
                                console.log('ğŸ“¤ Uploading local data to cloud...');
                                const uploadResult = await syncManager.syncToCloud();
                                if (uploadResult.success) {
                                    console.log('âœ… Local data uploaded to cloud');
                                    // ä¸Šä¼ åé‡æ–°åŠ è½½ï¼ˆè™½ç„¶æ•°æ®åº”è¯¥ä¸€æ ·ï¼Œä½†ç¡®ä¿ä¸€è‡´æ€§ï¼‰
                                    await loadDataFromLocal();
                                    renderAll();
                                } else {
                                    console.warn('âš ï¸ Failed to upload local data:', uploadResult.error);
                                    // å³ä½¿ä¸Šä¼ å¤±è´¥ï¼Œä¹Ÿç¡®ä¿æ˜¾ç¤ºæœ¬åœ°æ•°æ®
                                    await loadDataFromLocal();
                                    renderAll();
                                }
                            } else if (!hasCloudData && !hasLocalData) {
                                // é¦–æ¬¡ç™»å½•ä¸”æœ¬åœ°å’Œäº‘ç«¯éƒ½ä¸ºç©ºï¼šå¯èƒ½æ˜¯æ–°æµè§ˆå™¨ï¼Œæç¤ºç”¨æˆ·
                                console.log('â„¹ï¸ First-time login: Both cloud and local are empty');
                                await loadDataFromLocal();
                                renderAll();
                                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                                setTimeout(() => {
                                    alert('ğŸ’¡ æç¤ºï¼š\n\nè¿™æ˜¯é¦–æ¬¡ç™»å½•ï¼Œç›®å‰æ²¡æœ‰æ•°æ®ã€‚\n\nå¦‚æœæ‚¨åœ¨å…¶ä»–æµè§ˆå™¨ï¼ˆå¦‚ Safariï¼‰ä¸­æœ‰æ•°æ®ï¼Œè¯·ï¼š\n1. åœ¨é‚£ä¸ªæµè§ˆå™¨ä¸­æ‰“å¼€æ­¤åº”ç”¨\n2. ç™»å½•åç‚¹å‡»ã€Œç«‹å³åŒæ­¥åˆ°äº‘ç«¯ã€\n3. ç„¶åå†å›åˆ°æ­¤æµè§ˆå™¨ï¼Œæ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥');
                                }, 1000);
                            } else {
                                // å·²æœ‰äº‘ç«¯æ•°æ®æˆ–æœ¬åœ°ä¸ºç©ºï¼šæ‰§è¡ŒåŒå‘åˆå¹¶
                                console.log('ğŸ”„ Pulling data from cloud and merging...');
                                await syncManager.syncFromCloud();
                                // é‡æ–°åŠ è½½åˆå¹¶åçš„æ•°æ®
                                await loadDataFromLocal();
                                renderAll();
                            }
                            
                            console.log(`âœ… Data synchronized. Showing ${state.transactions.length} transactions.`);
                        } catch (error) {
                            console.warn('âš ï¸ Failed to sync data:', error);
                            // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿç¡®ä¿åŠ è½½æœ¬åœ°æ•°æ®å¹¶åˆ·æ–°UI
                            await loadDataFromLocal();
                            renderAll();
                            console.log(`âš ï¸ After error, showing ${state.transactions.length} transactions.`);
                        }
                    }
                } else {
                    console.log('â„¹ï¸ Running in local-only mode (Supabase not configured)');
                    syncManager = new SyncManager(localDB, null);
                    state.isLoggedIn = false;
                    state.userId = null;
                }

                // 4. åº”ç”¨ä¸»é¢˜
                applyTheme(state.themeId);

                // 5. åˆå§‹åŒ– UI
                lucide.createIcons();
                updateHUDDate();
                updateCurrencySymbols();
                initCardSelectListener(); // åˆå§‹åŒ–ä¿¡ç”¨å¡é€‰æ‹©ç›‘å¬å™¨
                initInstallmentsListener(); // åˆå§‹åŒ–åˆ†æœŸæœŸæ•°ç›‘å¬å™¨
                const currentMonth = new Date().toISOString().slice(0, 7);
                document.getElementById('statsMonth').value = currentMonth;
                document.getElementById('histMonth').value = currentMonth;

                // 6. å†³å®šæ˜¾ç¤ºå“ªä¸ªé¡µé¢
                // æ‰€æœ‰ç”¨æˆ¶ï¼ˆåŒ…æ‹¬æ–°ç”¨æˆ¶ï¼‰éƒ½ç›´æ¥é€²å…¥ä¸»æ‡‰ç”¨ï¼Œé¼“å‹µä½¿ç”¨æœ¬åœ°æ¨¡å¼
                // å¦‚æœéœ€è¦é›²ç«¯åŒæ­¥ï¼Œå¯ä»¥åœ¨è¨­å®šé é¢æ‰‹å‹•ç™»å…¥
                showMainApp();

                // 7. æ›´æ–°åŒæ­¥ UI
                updateSyncUI();

                console.log('âœ… App initialized successfully');

            } catch (error) {
                console.error('âŒ App initialization failed:', error);
                
                // å›é€€åˆ°çº¯ localStorage æ¨¡å¼
                loadDataFromLocalStorage();
                applyTheme(state.themeId);
                lucide.createIcons();
                updateHUDDate();
                updateCurrencySymbols();
                const currentMonth = new Date().toISOString().slice(0, 7);
                document.getElementById('statsMonth').value = currentMonth;
                document.getElementById('histMonth').value = currentMonth;
                renderAll();
            }
        };

        async function applyTheme(themeId) {
            const scheme = THEME_SCHEMES.find(s => s.id === themeId) || THEME_SCHEMES[0];
            state.themeId = themeId;
            state.customTheme = null; // æ¸…é™¤è‡ªè¨‚ä¸»é¡Œ
            document.documentElement.style.setProperty('--accent', scheme.color);
            document.documentElement.style.setProperty('--accent-rgb', scheme.rgb);
            document.documentElement.style.setProperty('--bg-deep', scheme.bg);
            document.documentElement.style.setProperty('--card-bg', `rgba(28, 28, 32, ${scheme.opacity})`);
            await save();
            if (myChart) renderStats();
        }

        // æ—§çš„ save() å‡½æ•°å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨ async save() å‡½æ•°

        function updateHUDDate() {
            const d = new Date();
            document.getElementById('hudDate').innerText = d.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // ============================================
        // Authentication Functions
        // ============================================

        function switchAuthTab(tab) {
            const magicLinkForm = document.getElementById('formMagicLink');
            const codeForm = document.getElementById('formCode');
            const magicLinkTab = document.getElementById('tabMagicLink');
            const codeTab = document.getElementById('tabCode');
            
            // Hide all forms
            magicLinkForm.classList.add('hidden');
            codeForm.classList.add('hidden');
            
            // Reset all tabs to inactive
            magicLinkTab.className = 'auth-tab-inactive flex-1 py-3 rounded-[24px] text-sm font-black transition-all';
            codeTab.className = 'auth-tab-inactive flex-1 py-3 rounded-[24px] text-sm font-black transition-all';
            
            // Show selected form and activate tab
            if (tab === 'code') {
                codeForm.classList.remove('hidden');
                codeTab.className = 'auth-tab-active flex-1 py-3 rounded-[24px] text-sm font-black transition-all';
            } else {
                // Default to magic link
                magicLinkForm.classList.remove('hidden');
                magicLinkTab.className = 'auth-tab-active flex-1 py-3 rounded-[24px] text-sm font-black transition-all';
            }
        }

        async function handleMagicLink() {
            if (!supabaseClient) {
                showAuthMessage('âš ï¸ Supabase æœªé…ç½®ï¼Œç„¡æ³•ä½¿ç”¨é›²ç«¯åŠŸèƒ½', 'error');
                return;
            }

            const email = document.getElementById('emailMagicLink').value.trim();

            if (!email || !email.includes('@')) {
                showAuthMessage('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€', 'error');
                return;
            }

            const btnText = document.getElementById('btnMagicLinkText');
            const originalText = btnText.innerText;
            btnText.innerText = 'ğŸ”„ æº–å‚™ä¸­...';

            try {
                const { data, error } = await supabaseClient.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.location.href
                    }
                });

                if (error) throw error;

                // æª¢æ¸¬æ˜¯å¦åœ¨ iOS Standalone æ¨¡å¼
                const isIOSStandalone = window.navigator.standalone === true || 
                                        (window.matchMedia('(display-mode: standalone)').matches && 
                                         /iPhone|iPad|iPod/.test(navigator.userAgent));
                
                if (isIOSStandalone) {
                    showAuthMessage(`âœ… Magic Link å·²ç™¼é€è‡³ ${email}<br><br>
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 mt-3 text-left">
                            <p class="text-[10px] font-black text-yellow-400 uppercase mb-2">âš ï¸ iOS ä¸»ç•«é¢ App æç¤º</p>
                            <p class="text-[10px] text-yellow-400/80 mb-3">è«‹åœ¨ Safari ç€è¦½å™¨ä¸­é–‹å•Ÿä¿¡ç®±é€£çµå®Œæˆç™»å…¥ã€‚</p>
                            <p class="text-[10px] text-white/60 mb-3">ç™»å…¥å¾Œå¯ç”¢ç”Ÿã€Œç™»å…¥ä»£ç¢¼ã€ï¼Œå†å›åˆ°æ­¤ App ä½¿ç”¨ä»£ç¢¼ç™»å…¥ã€‚</p>
                            <p class="text-[10px] text-white/60">æˆ–é¸æ“‡ä¸‹æ–¹ã€Œåƒ…ä½¿ç”¨æœ¬åœ°æ¨¡å¼ã€è·³éç™»å…¥ã€‚</p>
                        </div>`, 'success');
                } else {
                    showAuthMessage(`âœ… Magic Link å·²ç™¼é€è‡³ ${email}<br>è«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ä¸¦é»æ“Šé€£çµå®Œæˆè¨»å†Š/ç™»å…¥`, 'success');
                }
                
                // Clear email input
                document.getElementById('emailMagicLink').value = '';

            } catch (error) {
                console.error('Magic link error:', error);
                showAuthMessage(`âŒ ç™¼é€å¤±æ•—ï¼š${error.message}`, 'error');
            } finally {
                btnText.innerText = originalText;
            }
        }

        function showAuthMessage(message, type = 'info') {
            const msgContainer = document.getElementById('authMessage');
            const msgText = document.getElementById('authMessageText');
            
            msgText.innerHTML = message;
            msgContainer.classList.remove('hidden');
            
            if (type === 'success') {
                msgContainer.className = 'glass-panel p-6 rounded-[24px] text-center border border-green-500/20 bg-green-500/5';
            } else if (type === 'error') {
                msgContainer.className = 'glass-panel p-6 rounded-[24px] text-center border border-red-500/20 bg-red-500/5';
            } else {
                msgContainer.className = 'glass-panel p-6 rounded-[24px] text-center';
            }
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                msgContainer.classList.add('hidden');
            }, 5000);
        }

        function skipLogin() {
            console.log('âš ï¸ User skipped login - using local mode only');
            state.isLoggedIn = false;
            state.userId = null;
            showMainApp();
        }

        async function handleSignOut() {
            if (!supabaseClient) return;
            
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                console.log('âœ… Signed out successfully');
                state.isLoggedIn = false;
                state.userId = null;
                currentUser = null;
                
                // Show auth page
                showAuthPage();
                
            } catch (error) {
                console.error('âŒ Sign out error:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼š' + error.message);
            }
        }

        function showAuthPage() {
            document.getElementById('page-auth').classList.remove('hidden-page');
            document.getElementById('page-home').classList.add('hidden-page');
            document.getElementById('page-history').classList.add('hidden-page');
            document.getElementById('page-stats').classList.add('hidden-page');
            document.getElementById('page-settings').classList.add('hidden-page');
            document.getElementById('page-add').classList.add('hidden-page');
            document.getElementById('header-ui').classList.add('hidden');
            document.getElementById('nav-container').classList.add('hidden');
            
            // æª¢æ¸¬æ˜¯å¦åœ¨ iOS Standalone æ¨¡å¼ï¼ˆå¾ä¸»ç•«é¢é–‹å•Ÿï¼‰
            const isIOSStandalone = window.navigator.standalone === true || 
                                    (window.matchMedia('(display-mode: standalone)').matches && 
                                     /iPhone|iPad|iPod/.test(navigator.userAgent));
            
            const warningEl = document.getElementById('iosStandaloneWarning');
            if (isIOSStandalone && warningEl) {
                warningEl.classList.remove('hidden');
            } else if (warningEl) {
                warningEl.classList.add('hidden');
            }
            
            lucide.createIcons();
        }

        function showMainApp() {
            document.getElementById('page-auth').classList.add('hidden-page');
            document.getElementById('header-ui').classList.remove('hidden');
            document.getElementById('nav-container').classList.remove('hidden');
            nav('home');
        }

        // ============================================
        // Navigation
        // ============================================

        function nav(pageId) {
            const sections = ['home', 'history', 'stats', 'settings', 'add'];
            sections.forEach(s => document.getElementById(`page-${s}`).classList.add('hidden-page'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden-page');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${pageId}`)?.classList.add('active');

            if(pageId === 'add') {
                document.getElementById('header-ui').classList.add('hidden');
                document.getElementById('nav-container').classList.add('hidden');
            } else {
                document.getElementById('header-ui').classList.remove('hidden');
                document.getElementById('nav-container').classList.remove('hidden');
                lastPage = pageId;
            }

            if(pageId === 'home') renderHome();
            if(pageId === 'history') renderHistory();
            if(pageId === 'stats') renderStats();
            if(pageId === 'settings') renderSettings();
            lucide.createIcons();
        }

        function renderAll() { renderHome(); }

        // è®¡ç®—ä¿¡ç”¨å¡ç¼´è´¹æ—¥
        function calculateCreditCardDueDate(transactionDate, card) {
            if (!card) return null;
            
            const txDate = new Date(transactionDate);
            const txYear = txDate.getFullYear();
            const txMonth = txDate.getMonth(); // 0-11
            const txDay = txDate.getDate();
            
            const closingDay = card.closingDay;
            const dueDaysAfter = card.dueDaysAfter;
            
            // åˆ¤æ–­è¿™ç¬”äº¤æ˜“å±äºå“ªä¸€æœŸè´¦å•
            // å¦‚æœäº¤æ˜“æ—¥æœŸåœ¨ç»“è´¦æ—¥ä¹‹å‰ï¼Œå±äºå½“æœˆè´¦å•ï¼›å¦åˆ™å±äºä¸‹æœˆè´¦å•
            let billMonth, billYear;
            if (txDay <= closingDay) {
                // å±äºå½“æœˆè´¦å•
                billMonth = txMonth;
                billYear = txYear;
            } else {
                // å±äºä¸‹æœˆè´¦å•
                billMonth = txMonth + 1;
                billYear = txYear;
                if (billMonth > 11) {
                    billMonth = 0;
                    billYear += 1;
                }
            }
            
            // å¤„ç†æœˆåº•è¾¹ç•Œé—®é¢˜ï¼šå¦‚æœè´¦å•æœˆçš„ç»“è´¦æ—¥ä¸å­˜åœ¨ï¼ˆå¦‚2æœˆ31å·ï¼‰ï¼Œåˆ™å–è¯¥æœˆæœ€åä¸€å¤©
            const lastDayOfBillMonth = new Date(billYear, billMonth + 1, 0).getDate();
            const actualClosingDay = Math.min(closingDay, lastDayOfBillMonth);
            
            // è®¡ç®—ç¼´è´¹æ—¥ = è´¦å•æœˆçš„å®é™…ç»“è´¦æ—¥ + dueDaysAfter
            let dueDate = new Date(billYear, billMonth, actualClosingDay);
            dueDate.setDate(dueDate.getDate() + dueDaysAfter);
            
            return dueDate;
        }
        
        // è®¡ç®—é¦–æœŸç¼´æ¬¾æœˆä»½ï¼ˆYYYY-MMæ ¼å¼ï¼‰
        function calculateFirstBillingMonth(transactionDate, card) {
            if (!card) return null;
            
            const txDate = new Date(transactionDate);
            const txYear = txDate.getFullYear();
            const txMonth = txDate.getMonth(); // 0-11
            const txDay = txDate.getDate();
            
            const closingDay = card.closingDay;
            
            // åˆ¤æ–­è¿™ç¬”äº¤æ˜“å±äºå“ªä¸€æœŸè´¦å•
            let billMonth, billYear;
            if (txDay <= closingDay) {
                // å±äºå½“æœˆè´¦å•
                billMonth = txMonth;
                billYear = txYear;
            } else {
                // å±äºä¸‹æœˆè´¦å•
                billMonth = txMonth + 1;
                billYear = txYear;
                if (billMonth > 11) {
                    billMonth = 0;
                    billYear += 1;
                }
            }
            
            // è¿”å› YYYY-MM æ ¼å¼
            return `${billYear}-${String(billMonth + 1).padStart(2, '0')}`;
        }
        
        // è®¡ç®—åˆ†æœŸå„æœŸçš„è´¦å•æœˆä»½
        function calculateInstallmentBillingMonths(firstBillingMonth, installments) {
            if (!firstBillingMonth || installments <= 1) {
                return [firstBillingMonth];
            }
            
            const [year, month] = firstBillingMonth.split('-').map(Number);
            const billingMonths = [];
            
            for (let i = 0; i < installments; i++) {
                let currentYear = year;
                let currentMonth = month + i;
                
                // å¤„ç†è·¨å¹´
                while (currentMonth > 12) {
                    currentMonth -= 12;
                    currentYear += 1;
                }
                
                billingMonths.push(`${currentYear}-${String(currentMonth).padStart(2, '0')}`);
            }
            
            return billingMonths;
        }
        
        // è®¡ç®—åˆ†æœŸæ¯æœŸé‡‘é¢
        function calculateInstallmentAmounts(totalAmount, installments) {
            if (installments <= 1) {
                return [totalAmount];
            }
            
            const perPeriodAmount = Math.floor(totalAmount / installments);
            const remainder = totalAmount - (perPeriodAmount * installments);
            
            const amounts = [];
            for (let i = 0; i < installments; i++) {
                // é¤˜æ•¸æ”¾åœ¨æœ€å¾Œä¸€æœŸï¼ˆç¬¦åˆå¯¦éš›éŠ€è¡Œåšæ³•ï¼‰
                amounts.push(i === installments - 1 ? perPeriodAmount + remainder : perPeriodAmount);
            }
            
            return amounts;
        }
        
        // è®¡ç®—ä¿¡ç”¨å¡åˆ†æœŸè¯¦æƒ…ï¼ˆåŒ…å«åˆ©æ¯ï¼‰
        function calculateCreditDetails(principal, installments, annualInterestRate) {
            if (installments <= 1) {
                return {
                    principal: principal,
                    interest: 0,
                    total: principal,
                    perPeriodPrincipal: [principal],
                    perPeriodInterest: 0,
                    perPeriodTotal: principal
                };
            }
            
            // æœˆåˆ©ç‡ = å¹´åˆ©ç‡ / 12 / 100
            const monthlyRate = annualInterestRate / 12 / 100;
            
            // æ¯æœŸæœ¬é‡‘æ‘Šæ = åŸå§‹æœ¬é‡‘ / æ€»æœŸæ•°
            const perPeriodPrincipalBase = Math.floor(principal / installments);
            const principalRemainder = principal - (perPeriodPrincipalBase * installments);
            
            // æ¯æœŸåˆ©æ¯ = åŸå§‹æœ¬é‡‘ * æœˆåˆ©ç‡ï¼ˆç®€å•åˆ©æ¯è®¡ç®—ï¼‰
            const perPeriodInterest = principal * monthlyRate;
            
            // å¤„ç†é™¤ä¸å°½é‡‘é¢ï¼šå°†æ€»æœ¬é‡‘ä¸è®¡ç®—åçš„å„æœŸæœ¬é‡‘å·®é¢ï¼Œå¹¶å…¥æœ€å¾Œä¸€æœŸï¼ˆç¬¦åˆå¯¦éš›éŠ€è¡Œåšæ³•ï¼‰
            const perPeriodPrincipal = [];
            for (let i = 0; i < installments; i++) {
                if (i === installments - 1) {
                    perPeriodPrincipal.push(perPeriodPrincipalBase + principalRemainder);
                } else {
                    perPeriodPrincipal.push(perPeriodPrincipalBase);
                }
            }
            
            // æ¯æœŸæ€»é‡‘é¢ = æ¯æœŸæœ¬é‡‘ + æ¯æœŸåˆ©æ¯
            const perPeriodTotal = perPeriodPrincipal[0] + perPeriodInterest;
            
            // æ€»åˆ©æ¯ = æ¯æœŸåˆ©æ¯ * æœŸæ•°
            const totalInterest = perPeriodInterest * installments;
            
            // æ€»é‡‘é¢ = æœ¬é‡‘ + æ€»åˆ©æ¯
            const totalAmount = principal + totalInterest;
            
            return {
                principal: principal,
                interest: totalInterest,
                total: totalAmount,
                perPeriodPrincipal: perPeriodPrincipal,
                perPeriodInterest: perPeriodInterest,
                perPeriodTotal: perPeriodTotal,
                monthlyRate: monthlyRate
            };
        }
        
        // åˆ¤æ–­ä¿¡ç”¨å¡äº¤æ˜“æ˜¯å¦å±äºå½“æœˆçš„ç¼´è´¹
        function isCreditCardDueThisMonth(transaction, card) {
            if (!transaction.paymentMethod || transaction.paymentMethod !== 'credit' || !card) {
                return false;
            }
            
            const dueDate = calculateCreditCardDueDate(transaction.date, card);
            if (!dueDate) return false;
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            return dueDate.getFullYear() === currentYear && dueDate.getMonth() === currentMonth;
        }
        
        // åˆ¤æ–­åˆ†æœŸäº¤æ˜“çš„æœ¬æœŸé‡‘é¢æ˜¯å¦å±äºå½“æœˆ
        function isInstallmentDueThisMonth(transaction, card) {
            if (!transaction.paymentMethod || transaction.paymentMethod !== 'credit' || !card) {
                return false;
            }
            
            // å¦‚æœæ²¡æœ‰ billingMonthï¼Œä½¿ç”¨æ—§é€»è¾‘
            if (!transaction.billingMonth) {
                return isCreditCardDueThisMonth(transaction, card);
            }
            
            const now = new Date();
            const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            // æ£€æŸ¥å½“å‰æœˆä»½æ˜¯å¦åœ¨åˆ†æœŸè´¦å•æœˆä»½åˆ—è¡¨ä¸­
            const installments = transaction.installments || 1;
            const firstBillingMonth = transaction.billingMonth;
            const billingMonths = calculateInstallmentBillingMonths(firstBillingMonth, installments);
            
            return billingMonths.includes(currentMonthStr);
        }
        
        // è®¡ç®—åˆ†æœŸäº¤æ˜“åœ¨æœ¬æœˆçš„åº”ç¼´é‡‘é¢ï¼ˆè¿”å›æœ¬é‡‘å’Œåˆ©æ¯ï¼‰
        function getInstallmentAmountThisMonth(transaction) {
            if (!transaction.billingMonth || !transaction.installments || transaction.installments <= 1) {
                // ä¸æ˜¯åˆ†æœŸæˆ–æ—§æ•°æ®ï¼Œè¿”å›å…¨é¢ï¼ˆæœ¬é‡‘ï¼‰ï¼Œåˆ©æ¯ä¸º0
                return {
                    principal: transaction.amount,
                    interest: 0,
                    total: transaction.amount
                };
            }
            
            const now = new Date();
            const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            const firstBillingMonth = transaction.billingMonth;
            const billingMonths = calculateInstallmentBillingMonths(firstBillingMonth, transaction.installments);
            const installmentIndex = billingMonths.indexOf(currentMonthStr);
            
            if (installmentIndex === -1) {
                // æœ¬æœˆä¸åœ¨åˆ†æœŸåˆ—è¡¨ä¸­
                return {
                    principal: 0,
                    interest: 0,
                    total: 0
                };
            }
            
            // è®¡ç®—åˆ†æœŸè¯¦æƒ…ï¼ˆåŒ…å«åˆ©æ¯ï¼‰
            const interestRate = transaction.interestRate || 0;
            const details = calculateCreditDetails(transaction.amount, transaction.installments, interestRate);
            
            return {
                principal: details.perPeriodPrincipal[installmentIndex],
                interest: details.perPeriodInterest,
                total: details.perPeriodTotal
            };
        }
        
        // è®¡ç®—åˆ†æœŸäº¤æ˜“åœ¨æŒ‡å®šæœˆä»½çš„åº”ç¼´é‡‘é¢ï¼ˆç”¨äºç»Ÿè®¡é¡µé¢ï¼‰
        function getInstallmentAmountForMonth(transaction, targetMonthStr) {
            if (!transaction.billingMonth || !transaction.installments || transaction.installments <= 1) {
                return {
                    principal: transaction.amount,
                    interest: 0,
                    total: transaction.amount
                };
            }
            
            const firstBillingMonth = transaction.billingMonth;
            const billingMonths = calculateInstallmentBillingMonths(firstBillingMonth, transaction.installments);
            const installmentIndex = billingMonths.indexOf(targetMonthStr);
            
            if (installmentIndex === -1) {
                return {
                    principal: 0,
                    interest: 0,
                    total: 0
                };
            }
            
            const interestRate = transaction.interestRate || 0;
            const details = calculateCreditDetails(transaction.amount, transaction.installments, interestRate);
            
            return {
                principal: details.perPeriodPrincipal[installmentIndex],
                interest: details.perPeriodInterest,
                total: details.perPeriodTotal
            };
        }
        
        // è®¡ç®—æœ¬æœˆåº”ç¼´ä¿¡ç”¨å¡è´¦å•æ€»é¢ï¼ˆåŒ…å«åˆ†æœŸå’Œç»“è½¬ä½™é¢ï¼‰
        function calculateCreditCardBillThisMonth() {
            const now = new Date();
            const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            let totalBill = 0;
            const cardBills = {}; // æŒ‰å¡ç‰‡åˆ†ç»„
            
            // éå†æ‰€æœ‰ä¿¡ç”¨å¡äº¤æ˜“
            state.transactions.forEach(tx => {
                if (tx.paymentMethod === 'credit' && tx.cardId) {
                    const card = state.cards.find(c => c.id === tx.cardId);
                    if (!card) return;
                    
                    // è®¡ç®—æœ¬æœŸåº”ç¼´é‡‘é¢ï¼ˆè€ƒè™‘åˆ†æœŸå’Œåˆ©æ¯ï¼‰
                    let principalThisMonth = 0;
                    let interestThisMonth = 0;
                    
                    if (tx.billingMonth && tx.installments && tx.installments > 1) {
                        // åˆ†æœŸäº¤æ˜“ï¼šè®¡ç®—æœ¬æœŸé‡‘é¢ï¼ˆåŒ…å«æœ¬é‡‘å’Œåˆ©æ¯ï¼‰
                        const installmentDetails = getInstallmentAmountThisMonth(tx);
                        principalThisMonth = installmentDetails.principal;
                        interestThisMonth = installmentDetails.interest;
                    } else {
                        // éåˆ†æœŸäº¤æ˜“ï¼šä½¿ç”¨æ—§é€»è¾‘åˆ¤æ–­æ˜¯å¦æœ¬æœˆåˆ°æœŸ
                        if (isCreditCardDueThisMonth(tx, card)) {
                            principalThisMonth = tx.amount;
                            interestThisMonth = 0;
                        }
                    }
                    
                    if (principalThisMonth > 0 || interestThisMonth > 0) {
                        const txCurrency = tx.currency || state.currency;
                        const convertedPrincipal = convertCurrency(principalThisMonth, txCurrency, state.currency);
                        const convertedInterest = convertCurrency(interestThisMonth, txCurrency, state.currency);
                        const totalAmount = convertedPrincipal + convertedInterest;
                        
                        if (!cardBills[tx.cardId]) {
                            cardBills[tx.cardId] = {
                                card: card,
                                amount: 0,
                                principal: 0,
                                interest: 0
                            };
                        }
                        cardBills[tx.cardId].amount += totalAmount;
                        cardBills[tx.cardId].principal += convertedPrincipal;
                        cardBills[tx.cardId].interest += convertedInterest;
                    }
                }
            });
            
            // åŠ ä¸Šç»“è½¬ä½™é¢å’Œåˆå§‹æ¬ æ¬¾ï¼ˆä¿®å¾©ï¼šåˆå§‹é¤˜é¡æ‰£é™¤å·²é‚„æ¬¾ï¼‰
            state.cards.forEach(card => {
                const carryingBalance = card.carryingBalance || 0;
                const initialBalance = card.initialBalance || 0;
                const totalRepaid = card.totalRepaid || 0;
                
                // åˆå§‹æ¬ æ¬¾ï¼šæ‰£é™¤å·²é‚„æ¬¾é‡‘é¡ï¼ˆä¿®å¾©é‡è¤‡è¨ˆç®— BUGï¼‰
                const remainingInitialBalance = Math.max(0, initialBalance - totalRepaid);
                if (remainingInitialBalance > 0) {
                    if (!cardBills[card.id]) {
                        cardBills[card.id] = {
                            card: card,
                            amount: 0,
                            principal: 0,
                            interest: 0
                        };
                    }
                    // åˆå§‹æ¬ æ¬¾è®¡å…¥åº”ç¼´æ€»é¢å’Œåˆ©æ¯ç±»åˆ«
                    cardBills[card.id].amount += remainingInitialBalance;
                    cardBills[card.id].interest += remainingInitialBalance;
                }
                
                // åŠ ä¸Šç»“è½¬ä½™é¢
                if (carryingBalance > 0) {
                    if (!cardBills[card.id]) {
                        cardBills[card.id] = {
                            card: card,
                            amount: 0,
                            principal: 0,
                            interest: 0
                        };
                    }
                    cardBills[card.id].amount += carryingBalance;
                    // ç»“è½¬ä½™é¢è®¡å…¥åˆ©æ¯ç±»åˆ«
                    cardBills[card.id].interest += carryingBalance;
                }
            });
            
            // è®¡ç®—æ€»é¢
            Object.values(cardBills).forEach(bill => {
                totalBill += bill.amount;
            });
            
            return { total: totalBill, byCard: cardBills };
        }

        function renderHome() {
            const now = new Date();
            const currentMonthStr = now.toISOString().slice(0, 7);
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-11
            
            // è®¡ç®—å½“æœˆç°é‡‘æ¶ˆè´¹
            const cashTransactions = state.transactions.filter(t => {
                const paymentMethod = t.paymentMethod || 'cash'; // ç›¸å®¹èˆŠè³‡æ–™ï¼Œé è¨­ç¾é‡‘
                return paymentMethod === 'cash' && t.date.startsWith(currentMonthStr);
            });
            
            const cashSpent = cashTransactions.reduce((acc, curr) => {
                const txCurrency = curr.currency || state.currency;
                const convertedAmount = convertCurrency(curr.amount, txCurrency, state.currency);
                return acc + convertedAmount;
            }, 0);
            
            // è®¡ç®—æœ¬æœˆåº”ç¼´ä¿¡ç”¨å¡è´¦å•ï¼ˆåŒ…å«åˆ†æœŸå’Œç»“è½¬ä½™é¢ï¼‰
            const creditCardBill = calculateCreditCardBillThisMonth();
            const creditCardDueThisMonth = creditCardBill.total;
            
            // å½“æœˆæ€»æ”¯å‡º = ç°é‡‘æ¶ˆè´¹ + å½“æœˆåˆ°æœŸçš„ä¿¡ç”¨å¡è´¦å•ï¼ˆåŒ…å«åˆ†æœŸæœ¬æœŸé‡‘é¢å’Œç»“è½¬ä½™é¢ï¼‰
            const totalSpent = cashSpent + creditCardDueThisMonth;
            
            const remaining = Math.max(0, state.budget - totalSpent);
            const percent = state.budget > 0 ? (remaining / state.budget) * 100 : 0;
            
            const symbol = getCurrencySymbol();
            // æ˜¾ç¤ºå‰©ä½™é¢„ç®—ï¼ˆå¤§å­—ï¼‰
            document.getElementById('displayRemaining').innerHTML = `${symbol}${Math.round(remaining).toLocaleString()}`;
            // æ˜¾ç¤ºå·²èŠ±è´¹
            document.getElementById('displaySpent').innerHTML = `${symbol}${Math.round(totalSpent).toLocaleString()}`;
            // æ˜¾ç¤ºæ€»é¢„ç®—
            document.getElementById('displayBudgetLimit').innerHTML = `${symbol}${state.budget.toLocaleString()}`;
            
            // æ˜¾ç¤ºæœ¬æœˆå¾…ç¼´ä¿¡ç”¨å¡è´¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const creditCardDueEl = document.getElementById('creditCardDueDisplay');
            if (creditCardDueEl) {
                if (creditCardDueThisMonth > 0) {
                    // æ£€æŸ¥æ˜¯å¦å¯ç”¨ç°é‡‘å°äºåº”ç¼´æ€»é¢ï¼ˆè­¦ç¤ºï¼‰
                    const availableCash = state.budget - cashSpent;
                    const isWarning = availableCash < creditCardDueThisMonth;
                    
                    creditCardDueEl.innerHTML = `
                        <div class="text-center mt-4 p-4 ${isWarning ? 'bg-red-500/10 border-red-500/30' : 'bg-yellow-500/10 border-yellow-500/30'} border rounded-2xl">
                            <div class="text-[9px] font-bold ${isWarning ? 'text-red-400/80' : 'text-yellow-400/80'} uppercase tracking-wider mb-1">æœ¬æœˆå¾…ç¹³ä¿¡ç”¨å¡è²»</div>
                            <div class="text-lg font-black ${isWarning ? 'text-red-400' : 'text-yellow-400'}">${symbol}${Math.round(creditCardDueThisMonth).toLocaleString()}</div>
                            ${isWarning ? `<div class="text-[8px] text-red-400/60 mt-1">âš ï¸ å¯ç”¨ç¾é‡‘ä¸è¶³</div>` : ''}
                        </div>
                    `;
                } else {
                    creditCardDueEl.innerHTML = '';
                }
            }
            
            // è¨ˆç®—ä»Šæ—¥æ¶ˆè²»
            const todayStr = now.toISOString().slice(0, 10);
            const todayTransactions = state.transactions.filter(t => t.date === todayStr);
            const todaySpent = todayTransactions
                .filter(t => {
                    const paymentMethod = t.paymentMethod || 'cash';
                    return paymentMethod === 'cash';
                })
                .reduce((acc, curr) => {
                    const txCurrency = curr.currency || state.currency;
                    return acc + convertCurrency(curr.amount, txCurrency, state.currency);
                }, 0);
            
            // é¡¯ç¤ºä»Šæ—¥æ¶ˆè²»
            const todaySpentEl = document.getElementById('todaySpentDisplay');
            if (todaySpentEl) {
                if (todaySpent > 0) {
                    todaySpentEl.innerHTML = `
                        <div class="glass-panel p-4 rounded-2xl mb-4">
                            <div class="text-[9px] font-bold text-white/40 uppercase tracking-wider mb-1">ä»Šæ—¥æ¶ˆè²»</div>
                            <div class="text-lg font-black text-white">${symbol}${Math.round(todaySpent).toLocaleString()}</div>
                            <div class="text-[8px] text-white/30 mt-1">${todayTransactions.filter(t => (t.paymentMethod || 'cash') === 'cash').length} ç­†äº¤æ˜“</div>
                        </div>
                    `;
                } else {
                    todaySpentEl.innerHTML = '';
                }
            }
            
            const liquidEl = document.getElementById('liquidLevel');
            liquidEl.style.height = percent + '%';
            
            // æ ¹æ“šé ç®—ç‹€æ…‹å‹•æ…‹æ”¹è®Šæ¶²é«”é¡è‰²å’Œç‹€æ…‹æ–‡å­—
            let colorDark, colorMid, colorLight, statusText, statusColor;
            if(percent > 60) {
                // å¥åº·ç‹€æ…‹ - ç¶ è‰²
                colorDark = '#059669';
                colorMid = '#10b981';
                colorLight = '#34d399';
                statusText = "Status: Healthy";
                statusColor = '#10b981';
            } else if(percent > 40) {
                // OK ç‹€æ…‹ - è—ç¶ è‰²
                colorDark = '#0891b2';
                colorMid = '#06b6d4';
                colorLight = '#22d3ee';
                statusText = "Status: OK";
                statusColor = '#06b6d4';
            } else if(percent > 20) {
                // è­¦å‘Šç‹€æ…‹ - æ©™è‰²
                colorDark = '#c2410c';
                colorMid = '#ea580c';
                colorLight = '#fb923c';
                statusText = "Status: Warning";
                statusColor = '#ea580c';
            } else if(percent > 0) {
                // å±éšªç‹€æ…‹ - ç´…è‰²
                colorDark = '#b91c1c';
                colorMid = '#dc2626';
                colorLight = '#f87171';
                statusText = "Status: Warning";
                statusColor = '#dc2626';
            } else {
                // è€—ç›¡ç‹€æ…‹ - æ·±ç´…è‰²
                colorDark = '#7f1d1d';
                colorMid = '#991b1b';
                colorLight = '#b91c1c';
                statusText = "Status: Depleted";
                statusColor = '#991b1b';
            }
            
            document.documentElement.style.setProperty('--liquid-color-dark', colorDark);
            document.documentElement.style.setProperty('--liquid-color-mid', colorMid);
            document.documentElement.style.setProperty('--liquid-color-light', colorLight);
            
            const msgEl = document.getElementById('budgetMessage');
            msgEl.innerText = statusText;
            msgEl.style.color = statusColor;

            const recent = state.transactions.slice(0, 5);
            document.getElementById('recentList').innerHTML = recent.length ? recent.map(t => {
                const txCurrency = t.currency || state.currency;
                const txSymbol = CURRENCY_OPTIONS.find(c => c.id === txCurrency)?.symbol || symbol;
                // è·å–ä¿¡ç”¨å¡åç§°å’Œåˆ†æœŸä¿¡æ¯ï¼ˆå¦‚æœæ˜¯ä¿¡ç”¨å¡æ¶ˆè´¹ï¼‰
                let cardName = '';
                let installmentLabel = '';
                let interestLabel = '';
                if (t.paymentMethod === 'credit' && t.cardId) {
                    const card = state.cards.find(c => c.id === t.cardId);
                    if (card) {
                        cardName = ` ğŸ’³ ${card.name}`;
                        // æ˜¾ç¤ºåˆ†æœŸæ ‡ç­¾
                        if (t.installments && t.installments > 1) {
                            // è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ æœŸ
                            const now = new Date();
                            const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                            if (t.billingMonth) {
                                const billingMonths = calculateInstallmentBillingMonths(t.billingMonth, t.installments);
                                const currentIndex = billingMonths.indexOf(currentMonthStr);
                                if (currentIndex !== -1) {
                                    installmentLabel = ` (${currentIndex + 1}/${t.installments} æœŸ)`;
                                    
                                    // æ˜¾ç¤ºåˆ©æ¯æ ‡æ³¨
                                    if (t.interestRate && t.interestRate > 0) {
                                        const details = calculateCreditDetails(t.amount, t.installments, t.interestRate);
                                        interestLabel = ` ğŸ’°${txSymbol}${Math.round(details.perPeriodInterest).toLocaleString()}`;
                                    }
                                } else {
                                    installmentLabel = ` (${t.installments} æœŸ)`;
                                }
                            }
                        }
                    }
                }
                return `
                <div onclick="editTx(${t.id})" class="glass-panel p-4 flex justify-between items-center rounded-2xl active:scale-95 transition-transform cursor-pointer">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${t.icon}</span>
                        <div>
                            <div class="text-[11px] font-bold text-white">${t.note || t.category}${cardName}${installmentLabel}${interestLabel}</div>
                            <div class="text-[8px] font-black text-white/20 uppercase">${t.date}</div>
                        </div>
                    </div>
                    <div class="text-xs font-black">-${txSymbol}${t.amount.toLocaleString()}</div>
                </div>
                `;
            }).join('') : '<div class="text-center py-4 text-white/10 text-xs uppercase tracking-widest">No activities</div>';
            
            // æ˜¾ç¤ºæœªæ¥é¢„å®šæ”¯å‡ºé¢„è§ˆ
            renderFutureExpensesPreview();
        }
        
        // æ¸²æŸ“æœªæ¥é¢„å®šæ”¯å‡ºé¢„è§ˆ
        function renderFutureExpensesPreview() {
            const now = new Date();
            const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const futureMonths = [];
            
            // è®¡ç®—æœªæ¥3ä¸ªæœˆ
            for (let i = 1; i <= 3; i++) {
                let year = now.getFullYear();
                let month = now.getMonth() + i;
                while (month > 12) {
                    month -= 12;
                    year += 1;
                }
                futureMonths.push(`${year}-${String(month).padStart(2, '0')}`);
            }
            
            // è®¡ç®—æ¯ä¸ªæœˆçš„ä¿¡ç”¨å¡åº”ç¼´é‡‘é¢ï¼ˆåŒ…å«åˆ†æœŸå’Œå•ç¬”ï¼‰
            const futureExpenses = {};
            futureMonths.forEach(monthStr => {
                futureExpenses[monthStr] = 0;
            });
            
            state.transactions.forEach(tx => {
                if (tx.paymentMethod === 'credit' && tx.cardId) {
                    const card = state.cards.find(c => c.id === tx.cardId);
                    if (!card) return;
                    
                    if (tx.billingMonth && tx.installments && tx.installments > 1) {
                        // åˆ†æœŸäº¤æ˜“ï¼šè®¡ç®—æ¯æœŸé‡‘é¢ï¼ˆå«åˆ©æ¯ï¼‰
                        const billingMonths = calculateInstallmentBillingMonths(tx.billingMonth, tx.installments);
                        const details = calculateCreditDetails(tx.amount, tx.installments, tx.interestRate || 0);
                        
                        billingMonths.forEach((billMonth, index) => {
                            if (futureExpenses.hasOwnProperty(billMonth)) {
                                const txCurrency = tx.currency || state.currency;
                                const principalAmount = details.perPeriodPrincipal[index];
                                const interestAmount = details.perPeriodInterest;
                                const totalAmount = principalAmount + interestAmount;
                                const convertedAmount = convertCurrency(totalAmount, txCurrency, state.currency);
                                futureExpenses[billMonth] += convertedAmount;
                            }
                        });
                    } else {
                        // å•ç¬”äº¤æ˜“ï¼šè®¡ç®—ç¼´æ¬¾æœˆä»½
                        const dueDate = calculateCreditCardDueDate(tx.date, card);
                        if (dueDate) {
                            const dueYear = dueDate.getFullYear();
                            const dueMonth = dueDate.getMonth() + 1;
                            const dueMonthStr = `${dueYear}-${String(dueMonth).padStart(2, '0')}`;
                            
                            if (futureExpenses.hasOwnProperty(dueMonthStr)) {
                                const txCurrency = tx.currency || state.currency;
                                const convertedAmount = convertCurrency(tx.amount, txCurrency, state.currency);
                                futureExpenses[dueMonthStr] += convertedAmount;
                            }
                        }
                    }
                }
            });
            
            // æ¸²æŸ“UI
            const previewEl = document.getElementById('futureExpensesPreview');
            if (previewEl) {
                const hasFutureExpenses = Object.values(futureExpenses).some(amount => amount > 0);
                
                if (hasFutureExpenses) {
                    const symbol = getCurrencySymbol();
                    previewEl.innerHTML = `
                        <div class="glass-panel p-4 rounded-2xl mt-6">
                            <h3 class="text-[10px] font-black uppercase text-white/30 tracking-widest mb-3">æœªä¾†é å®šæ”¯å‡º</h3>
                            <div class="space-y-2">
                                ${futureMonths.map(monthStr => {
                                    const amount = futureExpenses[monthStr];
                                    if (amount <= 0) return '';
                                    const [year, month] = monthStr.split('-');
                                    const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
                                    return `
                                        <div class="flex justify-between items-center text-[10px]">
                                            <span class="text-white/60">${year}å¹´${monthNames[parseInt(month) - 1]}</span>
                                            <span class="text-white font-bold">${symbol}${Math.round(amount).toLocaleString()}</span>
                                        </div>
                                    `;
                                }).filter(html => html).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    previewEl.innerHTML = '';
                }
            }
        }

        function renderHistory(filterCategory = null) {
            const symbol = getCurrencySymbol();
            const month = document.getElementById('histMonth').value;
            let filtered = state.transactions.filter(t => t.date.startsWith(month));
            if(filterCategory) filtered = filtered.filter(t => t.category === filterCategory);
            
            // æœå°‹åŠŸèƒ½
            const searchKeyword = document.getElementById('searchKeyword')?.value.trim().toLowerCase() || '';
            if (searchKeyword) {
                filtered = filtered.filter(t => {
                    const note = (t.note || '').toLowerCase();
                    const category = (t.category || '').toLowerCase();
                    return note.includes(searchKeyword) || category.includes(searchKeyword);
                });
            }

            const groups = {};
            filtered.forEach(t => {
                if(!groups[t.date]) groups[t.date] = { total: 0, items: [] };
                // è½¬æ¢ä¸ºé¢„è®¾å¸ç§ç´¯è®¡
                const txCurrency = t.currency || state.currency;
                const convertedAmount = convertCurrency(t.amount, txCurrency, state.currency);
                groups[t.date].total += convertedAmount;
                groups[t.date].items.push(t);
            });

            const sortedDates = Object.keys(groups).sort((a,b) => b.localeCompare(a));
            const container = document.getElementById('historyAccordion');
            
            if(sortedDates.length === 0) {
                container.innerHTML = `<div class="text-center py-20 opacity-20 text-[10px] font-black tracking-widest uppercase">No data found</div>`;
                return;
            }

            container.innerHTML = sortedDates.map(date => {
                const dayData = groups[date];
                const dayObj = new Date(date);
                const weekDay = dayObj.toLocaleDateString('zh-TW', { weekday: 'short' });
                const dayNum = dayObj.getDate();
                const isOpen = filterCategory ? 'open' : '';
                return `
                    <div class="day-card glass-panel rounded-[24px] p-4 ${isOpen}" onclick="toggleAccordion(this)">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-white/5 flex flex-col items-center justify-center border border-white/5">
                                    <span class="text-[8px] font-black text-white/40 uppercase">${weekDay}</span>
                                    <span class="text-sm font-black text-white">${dayNum}</span>
                                </div>
                                <div><div class="text-[10px] font-black text-white/40 uppercase tracking-tighter">${date}</div><div class="text-xs font-bold text-white/80">${dayData.items.length} ç­†</div></div>
                            </div>
                            <div class="flex items-center gap-3"><span class="text-sm font-black text-white">${symbol}${Math.round(dayData.total).toLocaleString()}</span><i data-lucide="chevron-down" class="chevron-icon w-4 h-4 text-white/20 transition-transform"></i></div>
                        </div>
                        <div class="day-items-container space-y-2">
                            ${dayData.items.map(t => {
                                const txCurrency = t.currency || state.currency;
                                const txSymbol = CURRENCY_OPTIONS.find(c => c.id === txCurrency)?.symbol || symbol;
                                return `
                                <div onclick="event.stopPropagation(); editTx(${t.id})" class="history-item-row flex justify-between items-center p-3 bg-white/[0.03] rounded-xl cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <span class="text-base">${t.icon}</span>
                                        <span class="text-[11px] font-bold text-white/70">
                                            ${t.note || t.category}${t.paymentMethod === 'credit' && t.cardId ? (() => { 
                                                const card = state.cards.find(c => c.id === t.cardId); 
                                                if (!card) return '';
                                                let label = ` ğŸ’³ ${card.name}`;
                                                if (t.installments && t.installments > 1) {
                                                    const now = new Date();
                                                    const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                                                    if (t.billingMonth) {
                                                        const billingMonths = calculateInstallmentBillingMonths(t.billingMonth, t.installments);
                                                        const currentIndex = billingMonths.indexOf(currentMonthStr);
                                                        if (currentIndex !== -1) {
                                                            label += ` (${currentIndex + 1}/${t.installments} æœŸ)`;
                                                        } else {
                                                            label += ` (${t.installments} æœŸ)`;
                                                        }
                                                    }
                                                }
                                                return label;
                                            })() : ''}
                                        </span>
                                    </div>
                                    <span class="text-xs font-bold text-white">-${txSymbol}${t.amount.toLocaleString()}</span>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function toggleAccordion(card) { card.classList.toggle('open'); }
        
        function clearSearch() {
            document.getElementById('searchKeyword').value = '';
            renderHistory();
        }

        function renderStats() {
            const month = document.getElementById('statsMonth').value;
            const [year, monthNum] = month.split('-').map(Number);
            const currentMonthStr = `${year}-${String(monthNum).padStart(2, '0')}`;
            const dataMap = {};
            let total = 0;
            
            // 1. ç»Ÿè®¡ç°é‡‘æ¶ˆè´¹ï¼ˆåŸç±»åˆ«ï¼‰
            state.transactions.filter(t => {
                const paymentMethod = t.paymentMethod || 'cash';
                return paymentMethod === 'cash' && t.date.startsWith(month);
            }).forEach(t => {
                const txCurrency = t.currency || state.currency;
                const convertedAmount = convertCurrency(t.amount, txCurrency, state.currency);
                dataMap[t.category] = (dataMap[t.category] || 0) + convertedAmount;
                total += convertedAmount;
            });
            
            // 2. ç»Ÿè®¡ä¿¡ç”¨å¡å½“æœˆåº”æ‘Šæä¹‹æœ¬é‡‘ï¼ˆåŸç±»åˆ«ï¼‰
            state.transactions.forEach(tx => {
                if (tx.paymentMethod === 'credit' && tx.cardId) {
                    const card = state.cards.find(c => c.id === tx.cardId);
                    if (!card) return;
                    
                    let principalThisMonth = 0;
                    
                    if (tx.billingMonth && tx.installments && tx.installments > 1) {
                        // åˆ†æœŸäº¤æ˜“ï¼šè®¡ç®—æŒ‡å®šæœˆä»½çš„æœ¬æœŸæœ¬é‡‘
                        const installmentDetails = getInstallmentAmountForMonth(tx, currentMonthStr);
                        principalThisMonth = installmentDetails.principal;
                    } else {
                        // éåˆ†æœŸäº¤æ˜“ï¼šåˆ¤æ–­æ˜¯å¦åœ¨æŒ‡å®šæœˆä»½åˆ°æœŸ
                        const dueDate = calculateCreditCardDueDate(tx.date, card);
                        if (dueDate) {
                            const dueYear = dueDate.getFullYear();
                            const dueMonth = dueDate.getMonth() + 1;
                            const dueMonthStr = `${dueYear}-${String(dueMonth).padStart(2, '0')}`;
                            if (dueMonthStr === currentMonthStr) {
                                principalThisMonth = tx.amount;
                            }
                        }
                    }
                    
                    if (principalThisMonth > 0) {
                        const txCurrency = tx.currency || state.currency;
                        const convertedAmount = convertCurrency(principalThisMonth, txCurrency, state.currency);
                        // æœ¬é‡‘è®¡å…¥åŸç±»åˆ«
                        dataMap[tx.category] = (dataMap[tx.category] || 0) + convertedAmount;
                        total += convertedAmount;
                    }
                }
            });
            
            // 3. ç»Ÿè®¡ä¿¡ç”¨å¡åˆ©æ¯ä¸ç»“è½¬ä½™é¢ï¼ˆæ–°å¢ç±»åˆ«ï¼š'åˆ©æ¯ä¸æ¬ æ¬¾'ï¼‰
            let interestAndCarryOver = 0;
            
            // 3.1 ç»Ÿè®¡åˆ†æœŸåˆ©æ¯
            state.transactions.forEach(tx => {
                if (tx.paymentMethod === 'credit' && tx.cardId && tx.billingMonth && tx.installments && tx.installments > 1) {
                    const installmentDetails = getInstallmentAmountForMonth(tx, currentMonthStr);
                    if (installmentDetails.interest > 0) {
                        const txCurrency = tx.currency || state.currency;
                        const convertedInterest = convertCurrency(installmentDetails.interest, txCurrency, state.currency);
                        interestAndCarryOver += convertedInterest;
                    }
                }
            });
            
            // 3.2 ç»Ÿè®¡ç»“è½¬ä½™é¢å’Œåˆå§‹æ¬ æ¬¾
            // åˆå§‹æ¬ æ¬¾ï¼šå§‹ç»ˆè®¡å…¥å½“å‰æœˆï¼ˆå› ä¸ºå®ƒæ˜¯å·²å­˜åœ¨çš„æ¬ æ¬¾ï¼‰
            // ç»“è½¬ä½™é¢ï¼šåªåœ¨æŸ¥çœ‹å½“å‰æœˆæ—¶è®¡å…¥
            const isCurrentMonth = month === new Date().toISOString().slice(0, 7);
            
            state.cards.forEach(card => {
                const initialBalance = card.initialBalance || 0;
                const carryingBalance = card.carryingBalance || 0;
                
                // åˆå§‹æ¬ æ¬¾ï¼šå§‹ç»ˆè®¡å…¥ç»Ÿè®¡æœˆä»½
                if (isCurrentMonth && initialBalance > 0) {
                    interestAndCarryOver += initialBalance;
                }
                
                // ç»“è½¬ä½™é¢ï¼šåªåœ¨æŸ¥çœ‹å½“å‰æœˆæ—¶è®¡å…¥
                if (isCurrentMonth && carryingBalance > 0) {
                    interestAndCarryOver += carryingBalance;
                }
            });
            
            if (interestAndCarryOver > 0) {
                dataMap['åˆ©æ¯ä¸æ¬ æ¬¾'] = (dataMap['åˆ©æ¯ä¸æ¬ æ¬¾'] || 0) + interestAndCarryOver;
                total += interestAndCarryOver;
            }
            const labels = Object.keys(dataMap);
            const values = Object.values(dataMap);
            const colors = labels.map(l => {
                if (l === 'åˆ©æ¯ä¸æ¬ æ¬¾') {
                    return '#ef4444'; // çº¢è‰²è¡¨ç¤ºåˆ©æ¯ä¸æ¬ æ¬¾
                }
                return state.categories.find(c => c.name === l)?.color || '#555';
            });
            const chartEl = document.getElementById('mainChart');
            const noDataEl = document.getElementById('noDataStats');
            if(total === 0) {
                chartEl.classList.add('hidden'); noDataEl.classList.remove('hidden');
                document.getElementById('statsLegend').innerHTML = "";
                if(myChart) myChart.destroy(); return;
            }
            chartEl.classList.remove('hidden'); noDataEl.classList.add('hidden');
            const ctx = chartEl.getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        data: values, 
                        backgroundColor: colors, 
                        borderWidth: 2,
                        borderColor: 'rgba(255, 255, 255, 0.15)',
                        hoverBorderWidth: 3,
                        hoverBorderColor: 'rgba(255, 255, 255, 0.5)',
                        borderRadius: 8,
                        spacing: 2,
                        hoverOffset: 8
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1200,
                        easing: 'easeInOutCubic'
                    },
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            padding: 16,
                            displayColors: true,
                            boxPadding: 8,
                            callbacks: {
                                label: (context) => {
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${symbol}${context.parsed.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: { 
                            color: '#ffffff',
                            font: { weight: '900', size: 10, family: 'monospace' },
                            formatter: (v, context) => {
                                const percentage = ((v/total)*100);
                                const label = context.chart.data.labels[context.dataIndex];
                                // æ˜¾ç¤ºåç§°å’Œç™¾åˆ†æ¯”ï¼ˆæ‰€æœ‰é¡¹ç›®éƒ½æ˜¾ç¤ºï¼‰
                                if(percentage < 5) {
                                    return `${percentage.toFixed(0)}%`; // å°äº5%åªæ˜¾ç¤ºç™¾åˆ†æ¯”
                                }
                                return `${label}\n${percentage.toFixed(1)}%`;
                            },
                            textAlign: 'center',
                            anchor: 'end',
                            align: 'start',
                            offset: 8,
                            textStrokeColor: 'rgba(0, 0, 0, 0.8)',
                            textStrokeWidth: 3,
                            padding: 4
                        } 
                    }, 
                    cutout: '55%',
                    radius: '90%'
                }
            });
            const symbol = getCurrencySymbol();
            document.getElementById('statsLegend').innerHTML = Object.entries(dataMap).sort((a,b)=>b[1]-a[1]).map(([name, val]) => {
                // ä¸º"åˆ©æ¯ä¸æ¬ æ¬¾"ç±»åˆ«ä½¿ç”¨ç‰¹æ®Šå›¾æ ‡
                const icon = name === 'åˆ©æ¯ä¸æ¬ æ¬¾' ? 'ğŸ’°' : (state.categories.find(c => c.name === name)?.icon || 'â“');
                return `<div class="stats-item-card glass-panel p-4 rounded-2xl flex justify-between items-center" onclick="nav('history'); document.getElementById('histMonth').value='${month}'; renderHistory('${name}')">
                    <div class="flex items-center gap-3"><span>${icon}</span><span class="text-xs font-bold">${name}</span></div>
                    <span class="text-xs font-black">${symbol}${Math.round(val).toLocaleString()}</span>
                </div>`;
            }).join('');
            
            // æ¸²æŸ“è¶¨å‹¢åœ–è¡¨ï¼ˆæœ€è¿‘6å€‹æœˆï¼‰
            renderTrendChart();
        }
        
        // æ¸²æŸ“æ¶ˆè²»è¶¨å‹¢åœ–è¡¨
        function renderTrendChart() {
            const trendChartEl = document.getElementById('trendChart');
            const noTrendDataEl = document.getElementById('noTrendData');
            
            // è¨ˆç®—æœ€è¿‘6å€‹æœˆçš„æ¶ˆè²»
            const now = new Date();
            const months = [];
            const spending = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.push(`${date.getFullYear()}/${date.getMonth() + 1}`);
                
                // è¨ˆç®—è©²æœˆçš„ç¸½æ”¯å‡º
                let monthTotal = 0;
                
                // ç¾é‡‘æ¶ˆè²»
                state.transactions.filter(t => {
                    const paymentMethod = t.paymentMethod || 'cash';
                    return paymentMethod === 'cash' && t.date.startsWith(monthStr);
                }).forEach(t => {
                    const txCurrency = t.currency || state.currency;
                    monthTotal += convertCurrency(t.amount, txCurrency, state.currency);
                });
                
                // ä¿¡ç”¨å¡ç•¶æœˆæ‡‰ç¹³
                const creditCardBill = calculateCreditCardBillForMonth(monthStr);
                monthTotal += creditCardBill.total;
                
                spending.push(Math.round(monthTotal));
            }
            
            if (spending.every(s => s === 0)) {
                trendChartEl.classList.add('hidden');
                noTrendDataEl.classList.remove('hidden');
                if (trendChart) trendChart.destroy();
                return;
            }
            
            trendChartEl.classList.remove('hidden');
            noTrendDataEl.classList.add('hidden');
            
            const ctx = trendChartEl.getContext('2d');
            if (trendChart) trendChart.destroy();
            
            const symbol = getCurrencySymbol();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: spending,
                        borderColor: 'rgba(255, 255, 255, 0.8)',
                        backgroundColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(255, 255, 255, 0.9)',
                        pointBorderColor: 'rgba(255, 255, 255, 1)',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${symbol}${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)',
                                font: { size: 10 },
                                callback: function(value) {
                                    return symbol + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)',
                                font: { size: 10 }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        // è¨ˆç®—æŒ‡å®šæœˆä»½çš„ä¿¡ç”¨å¡å¸³å–®
        function calculateCreditCardBillForMonth(monthStr) {
            const [year, month] = monthStr.split('-').map(Number);
            const result = { total: 0, byCard: {} };
            
            state.cards.forEach(card => {
                let cardTotal = 0;
                let cardPrincipal = 0;
                let cardInterest = 0;
                
                // è™•ç†åˆ†æœŸäº¤æ˜“
                state.transactions.forEach(tx => {
                    if (tx.paymentMethod === 'credit' && tx.cardId === card.id && tx.billingMonth && tx.installments && tx.installments > 1) {
                        const installmentDetails = getInstallmentAmountForMonth(tx, monthStr);
                        if (installmentDetails.total > 0) {
                            cardTotal += installmentDetails.total;
                            cardPrincipal += installmentDetails.principal;
                            cardInterest += installmentDetails.interest;
                        }
                    } else if (tx.paymentMethod === 'credit' && tx.cardId === card.id) {
                        const dueDate = calculateCreditCardDueDate(tx.date, card);
                        if (dueDate) {
                            const dueYear = dueDate.getFullYear();
                            const dueMonth = dueDate.getMonth() + 1;
                            const dueMonthStr = `${dueYear}-${String(dueMonth).padStart(2, '0')}`;
                            if (dueMonthStr === monthStr) {
                                const txCurrency = tx.currency || state.currency;
                                const convertedAmount = convertCurrency(tx.amount, txCurrency, state.currency);
                                cardTotal += convertedAmount;
                                cardPrincipal += convertedAmount;
                            }
                        }
                    }
                });
                
                // è™•ç†åˆå§‹é¤˜é¡å’Œçµè½‰é¤˜é¡ï¼ˆåƒ…ç•¶æœˆï¼‰
                const isCurrentMonth = monthStr === new Date().toISOString().slice(0, 7);
                if (isCurrentMonth) {
                    const initialBalance = card.initialBalance || 0;
                    const totalRepaid = card.totalRepaid || 0;
                    const remainingInitialBalance = Math.max(0, initialBalance - totalRepaid);
                    if (remainingInitialBalance > 0) {
                        cardTotal += remainingInitialBalance;
                        cardInterest += remainingInitialBalance;
                    }
                    
                    const carryingBalance = card.carryingBalance || 0;
                    if (carryingBalance > 0) {
                        cardTotal += carryingBalance;
                        cardInterest += carryingBalance;
                    }
                }
                
                if (cardTotal > 0) {
                    result.byCard[card.id] = {
                        card: card,
                        amount: cardTotal,
                        principal: cardPrincipal,
                        interest: cardInterest
                    };
                    result.total += cardTotal;
                }
            });
            
            return result;
        }

        function prepareAdd() {
            state.editingId = null; 
            state.tempCat = state.categories[0].name;
            state.tempCurrency = state.currency; // é è¨­ä½¿ç”¨ä½¿ç”¨è€…è¨­å®šçš„å¹£ç¨®
            state.tempPaymentMethod = 'cash'; // é è¨­ç¾é‡‘
            state.tempCardId = null;
            state.tempInstallments = 1; // é è¨­1æœŸ
            state.tempInterestRate = 0; // é è¨­0%åˆ©ç‡
            document.getElementById('formAmount').value = ""; 
            document.getElementById('formNote').value = "";
            document.getElementById('formDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('formInstallments').value = "1";
            document.getElementById('formInterestRate').value = "0"; // é‡ç½®å¹´åˆ©ç‡ç‚º0
            document.getElementById('deleteBtn').classList.add('hidden');
            // éš±è—åˆ†æœŸè©¦ç®—é è¦½
            const previewEl = document.getElementById('installmentPreview');
            if (previewEl) previewEl.classList.add('hidden');
            renderFormCurrencyGrid();
            renderFormCatGrid();
            renderPaymentMethod();
            nav('add');
        }

        function editTx(id) {
            const tx = state.transactions.find(t => t.id === id);
            if(!tx) return;
            state.editingId = id; 
            state.tempCat = tx.category;
            state.tempCurrency = tx.currency || state.currency; // ç›¸å®¹èˆŠè³‡æ–™
            state.tempPaymentMethod = tx.paymentMethod || 'cash'; // ç›¸å®¹èˆŠè³‡æ–™ï¼Œé è¨­ç¾é‡‘
            state.tempCardId = tx.cardId || null;
            state.tempInstallments = tx.installments || 1; // ç›¸å®¹èˆŠè³‡æ–™ï¼Œé è¨­1æœŸ
            state.tempInterestRate = tx.interestRate || 0; // ç›¸å®¹èˆŠè³‡æ–™ï¼Œé è¨­0%åˆ©ç‡
            document.getElementById('formAmount').value = tx.amount;
            document.getElementById('formNote').value = tx.note;
            document.getElementById('formDate').value = tx.date;
            document.getElementById('formInstallments').value = state.tempInstallments;
            document.getElementById('formInterestRate').value = state.tempInterestRate; // è¨­å®šå¹´åˆ©ç‡
            document.getElementById('deleteBtn').classList.remove('hidden');
            // éš±è—åˆ†æœŸè©¦ç®—é è¦½ï¼ˆæœƒåœ¨ renderPaymentMethod å¾Œé‡æ–°è¨ˆç®—ï¼‰
            const previewEl = document.getElementById('installmentPreview');
            if (previewEl) previewEl.classList.add('hidden');
            renderFormCurrencyGrid();
            renderFormCatGrid();
            renderPaymentMethod();
            nav('add');
        }
        
        function renderPaymentMethod() {
            // æ›´æ–°æ”¯ä»˜æ–¹å¼æŒ‰é’®çŠ¶æ€
            const cashBtn = document.getElementById('paymentCashBtn');
            const creditBtn = document.getElementById('paymentCreditBtn');
            const cardSelectContainer = document.getElementById('cardSelectContainer');
            const cardSelect = document.getElementById('cardSelect');
            
            if (state.tempPaymentMethod === 'cash') {
                cashBtn.className = 'flex-1 py-4 dynamic-accent-bg text-black rounded-2xl font-black';
                creditBtn.className = 'flex-1 py-4 glass-panel rounded-2xl font-bold text-white/50';
                cardSelectContainer.classList.add('hidden');
            } else {
                cashBtn.className = 'flex-1 py-4 glass-panel rounded-2xl font-bold text-white/50';
                creditBtn.className = 'flex-1 py-4 dynamic-accent-bg text-black rounded-2xl font-black';
                
                // å¦‚æœæ²¡æœ‰ä¿¡ç”¨å¡ï¼Œæç¤ºç”¨æˆ·å…ˆæ·»åŠ 
                if (state.cards.length === 0) {
                    cardSelectContainer.classList.remove('hidden');
                    cardSelect.innerHTML = '<option value="">è«‹å…ˆåœ¨è¨­å®šä¸­æ–°å¢ä¿¡ç”¨å¡</option>';
                    cardSelect.disabled = true;
                } else {
                    cardSelectContainer.classList.remove('hidden');
                    cardSelect.disabled = false;
                    // æ›´æ–°ä¿¡ç”¨å¡ä¸‹æ‹‰èœå•
                    cardSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä¿¡ç”¨å¡</option>' + 
                        state.cards.map(card => 
                            `<option value="${card.id}" ${state.tempCardId === card.id ? 'selected' : ''}>${card.name}</option>`
                        ).join('');
                    
                    // æ›´æ–°åˆ†æœŸæœŸæ•°è¾“å…¥æ¡†
                    const installmentsInput = document.getElementById('formInstallments');
                    if (installmentsInput) {
                        installmentsInput.value = state.tempInstallments || 1;
                    }
                }
            }
        }
        
        // ç›‘å¬åˆ†æœŸæœŸæ•°å’Œåˆ©ç‡å˜åŒ–ï¼Œå³æ—¶è¯•ç®—
        function initInstallmentsListener() {
            const installmentsInput = document.getElementById('formInstallments');
            const interestRateInput = document.getElementById('formInterestRate');
            const amountInput = document.getElementById('formAmount');
            
            const updateInstallmentPreview = () => {
                const amount = parseFloat(amountInput.value) || 0;
                const installments = parseInt(installmentsInput.value) || 1;
                const interestRate = parseFloat(interestRateInput.value) || 0;
                
                if (amount > 0 && installments > 1 && state.tempPaymentMethod === 'credit') {
                    const details = calculateCreditDetails(amount, installments, interestRate);
                    const symbol = getCurrencySymbol();
                    const previewEl = document.getElementById('installmentPreview');
                    const displayEl = document.getElementById('installmentAmountDisplay');
                    
                    if (previewEl && displayEl) {
                        previewEl.classList.remove('hidden');
                        displayEl.innerHTML = `
                            <div class="text-xs mb-1">æ¯æœŸï¼š${symbol}${Math.round(details.perPeriodTotal).toLocaleString()}</div>
                            <div class="text-[9px] text-blue-400/60">æœ¬é‡‘ï¼š${symbol}${Math.round(details.perPeriodPrincipal[0]).toLocaleString()} | åˆ©æ¯ï¼š${symbol}${Math.round(details.perPeriodInterest).toLocaleString()}</div>
                            <div class="text-[9px] text-blue-400/60 mt-1">ç¸½è¨ˆï¼š${symbol}${Math.round(details.total).toLocaleString()}ï¼ˆå«åˆ©æ¯ ${symbol}${Math.round(details.interest).toLocaleString()}ï¼‰</div>
                        `;
                    }
                } else {
                    const previewEl = document.getElementById('installmentPreview');
                    if (previewEl) {
                        previewEl.classList.add('hidden');
                    }
                }
            };
            
            if (installmentsInput) {
                installmentsInput.addEventListener('change', (e) => {
                    const value = parseInt(e.target.value) || 1;
                    state.tempInstallments = Math.max(1, Math.min(24, value));
                    e.target.value = state.tempInstallments;
                    updateInstallmentPreview();
                });
            }
            
            if (interestRateInput) {
                interestRateInput.addEventListener('change', (e) => {
                    const value = parseFloat(e.target.value) || 0;
                    state.tempInterestRate = Math.max(0, Math.min(100, value));
                    e.target.value = state.tempInterestRate;
                    updateInstallmentPreview();
                });
            }
            
            if (amountInput) {
                amountInput.addEventListener('input', updateInstallmentPreview);
            }
        }
        
        function selectPaymentMethod(method) {
            if (method === 'credit' && state.cards.length === 0) {
                alert('è«‹å…ˆåœ¨è¨­å®šä¸­æ–°å¢ä¿¡ç”¨å¡');
                return;
            }
            state.tempPaymentMethod = method;
            if (method === 'cash') {
                state.tempCardId = null;
            }
            renderPaymentMethod();
        }
        
        // åˆå§‹åŒ–ä¿¡ç”¨å¡é€‰æ‹©ä¸‹æ‹‰èœå•äº‹ä»¶ç›‘å¬ï¼ˆåœ¨ window.onload ä¸­è°ƒç”¨ï¼‰
        function initCardSelectListener() {
            const cardSelect = document.getElementById('cardSelect');
            if (cardSelect) {
                // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const newCardSelect = cardSelect.cloneNode(true);
                cardSelect.parentNode.replaceChild(newCardSelect, cardSelect);
                // æ·»åŠ æ–°çš„ç›‘å¬å™¨
                document.getElementById('cardSelect').addEventListener('change', (e) => {
                    state.tempCardId = e.target.value || null;
                });
            }
        }

        function renderFormCurrencyGrid() {
            document.getElementById('formCurrencyGrid').innerHTML = CURRENCY_OPTIONS.map(c => `
                <button onclick="selectFormCurrency('${c.id}')" class="flex flex-col items-center p-3 rounded-xl transition-all ${state.tempCurrency === c.id ? 'dynamic-accent-bg text-black' : 'bg-white/5 text-white/30'}">
                    <span class="text-xl mb-1">${c.flag}</span>
                    <span class="text-[8px] font-black">${c.id}</span>
                </button>
            `).join('');
        }

        function selectFormCurrency(currencyId) {
            state.tempCurrency = currencyId;
            const currObj = CURRENCY_OPTIONS.find(c => c.id === currencyId);
            if(currObj) {
                document.getElementById('currencySymbolAdd').innerText = currObj.symbol;
            }
            renderFormCurrencyGrid();
        }

        function renderFormCatGrid() {
            document.getElementById('formCatGrid').innerHTML = state.categories.map(c => `
                <button onclick="state.tempCat='${c.name}'; renderFormCatGrid()" class="flex flex-col items-center p-3 rounded-2xl ${state.tempCat === c.name ? 'dynamic-accent-bg text-black' : 'bg-white/5 text-white/30'}">
                    <span class="text-xl">${c.icon}</span><span class="text-[8px] font-black uppercase truncate w-full">${c.name}</span>
                </button>
            `).join('');
        }

        async function saveTransaction() {
            const amt = parseFloat(document.getElementById('formAmount').value);
            const date = document.getElementById('formDate').value;
            if(!amt || !date) return;
            const catObj = state.categories.find(c => c.name === state.tempCat);
            
            // è·å–åˆ†æœŸæœŸæ•°å’Œå¹´åˆ©ç‡
            const installments = parseInt(document.getElementById('formInstallments').value) || 1;
            const installmentsValue = Math.max(1, Math.min(24, installments));
            const interestRate = parseFloat(document.getElementById('formInterestRate').value) || 0;
            const interestRateValue = Math.max(0, Math.min(100, interestRate));
            
            // è®¡ç®—é¦–æœŸè´¦å•æœˆä»½ï¼ˆå¦‚æœæ˜¯ä¿¡ç”¨å¡æ¶ˆè´¹ï¼‰
            let billingMonth = null;
            if (state.tempPaymentMethod === 'credit' && state.tempCardId) {
                const card = state.cards.find(c => c.id === state.tempCardId);
                if (card) {
                    billingMonth = calculateFirstBillingMonth(date, card);
                }
            }
            
            const data = { 
                id: state.editingId || Date.now(), 
                amount: amt, 
                currency: state.tempCurrency || state.currency,
                date: date, 
                note: document.getElementById('formNote').value, 
                category: state.tempCat, 
                icon: catObj.icon,
                paymentMethod: state.tempPaymentMethod || 'cash', // æ”¯ä»˜æ–¹å¼ï¼Œé è¨­ç¾é‡‘ï¼ˆç›¸å®¹èˆŠè³‡æ–™ï¼‰
                cardId: state.tempPaymentMethod === 'credit' ? state.tempCardId : null, // ä¿¡ç”¨å¡ ID
                installments: installmentsValue, // åˆ†æœŸæœŸæ•°ï¼Œé è¨­1ï¼ˆç›¸å®¹èˆŠè³‡æ–™ï¼‰
                interestRate: interestRateValue, // å¹´åˆ©ç‡ï¼ˆ%ï¼‰ï¼Œé è¨­0ï¼ˆç›¸å®¹èˆŠè³‡æ–™ï¼‰
                billingMonth: billingMonth, // é¦–æœŸè´¦å•æœˆä»½ï¼ˆYYYY-MMï¼‰
                updated_at: new Date().toISOString(),
                is_deleted: false  // ç¡®ä¿æ–°è®°å½•æ ‡è®°ä¸ºæœªåˆ é™¤
            };
            
            // ä¿å­˜åˆ°æœ¬åœ° IndexedDB
            try {
                await localDB.put('transactions', data);
                
                // æ›´æ–° state
                if(state.editingId) {
                    const idx = state.transactions.findIndex(t => t.id === state.editingId);
                    state.transactions[idx] = data;
                } else {
                    state.transactions.unshift(data);
                }
                state.transactions.sort((a,b) => b.date.localeCompare(a.date));
                
                // å¤‡ä»½åˆ° localStorage
                localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
                
                // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®
                
            } catch (error) {
                console.error('âŒ Failed to save transaction:', error);
                // å›é€€åˆ° localStorage
                if(state.editingId) {
                    const idx = state.transactions.findIndex(t => t.id === state.editingId);
                    state.transactions[idx] = data;
                } else {
                    state.transactions.unshift(data);
                }
                state.transactions.sort((a,b) => b.date.localeCompare(a.date));
                localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
            }
            
            await save();
            nav('home');
        }

        async function deleteCurrentTx() {
            if (!state.editingId) return;
            
            try {
                // è½¯åˆ é™¤ï¼šæ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œè€Œä¸æ˜¯çœŸæ­£åˆ é™¤
                const tx = await localDB.get('transactions', state.editingId);
                if (tx) {
                    tx.is_deleted = true;
                    tx.updated_at = new Date().toISOString();
                    await localDB.put('transactions', tx);
                    
                    // æ›´æ–° stateï¼ˆä»æ˜¾ç¤ºä¸­ç§»é™¤ï¼Œä½†ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼‰
                    state.transactions = state.transactions.filter(t => t.id !== state.editingId);
                    
                    // å¤‡ä»½åˆ° localStorageï¼ˆè¿‡æ»¤æ‰å·²åˆ é™¤çš„ï¼‰
                    localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
                } else {
                    // å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œç›´æ¥ä» state ä¸­ç§»é™¤
                    state.transactions = state.transactions.filter(t => t.id !== state.editingId);
                    localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
                }
                
                // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®
                
            } catch (error) {
                console.error('âŒ Failed to delete transaction:', error);
                // å›é€€åˆ° localStorage
                state.transactions = state.transactions.filter(t => t.id !== state.editingId);
                localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
            }
            
            await save();
            nav('home');
        }

        function renderSettings() {
            document.getElementById('budgetInput').value = state.budget;
            
            // ç¹ªè£½åœ“å½¢è‰²éšé¸æ“‡å™¨
            drawColorWheel();
            
            document.getElementById('currencyPicker').innerHTML = CURRENCY_OPTIONS.map(c => `
                <button onclick="changeCurrency('${c.id}')" class="flex flex-col items-center p-4 rounded-2xl transition-all ${state.currency === c.id ? 'dynamic-accent-bg text-black' : 'bg-white/5 text-white/50 hover:bg-white/10'}" type="button">
                    <span class="text-2xl mb-1">${c.flag}</span>
                    <span class="text-[9px] font-black">${c.id}</span>
                </button>
            `).join('');
            document.getElementById('settingsCatList').innerHTML = state.categories.map(c => `<div class="flex justify-between p-3 bg-white/5 rounded-xl"><span>${c.icon} ${c.name}</span><button onclick="deleteCat('${c.name}')"><i data-lucide="trash-2" class="w-3 h-3 text-white/20"></i></button></div>`).join('');
            
            // æ¸²æŸ“ä¿¡ç”¨å¡åˆ—è¡¨
            const creditCardBill = calculateCreditCardBillThisMonth();
            document.getElementById('settingsCardList').innerHTML = state.cards.length > 0 
                ? state.cards.map(card => {
                    const cardBill = creditCardBill.byCard[card.id];
                    const billAmount = cardBill ? cardBill.amount : 0;
                    const carryingBalance = card.carryingBalance || 0;
                    const initialBalance = card.initialBalance || 0;
                    const symbol = getCurrencySymbol();
                    
                    // æ£€æŸ¥è¯¥å¡ç‰‡åœ¨å½“å‰æœˆæ˜¯å¦æœ‰åº”ç¼´çš„äº¤æ˜“
                    const hasTransactionsThisMonth = state.transactions.some(tx => {
                        if (tx.paymentMethod === 'credit' && tx.cardId === card.id) {
                            if (tx.billingMonth && tx.installments && tx.installments > 1) {
                                const installmentDetails = getInstallmentAmountThisMonth(tx);
                                return installmentDetails.total > 0;
                            } else {
                                return isCreditCardDueThisMonth(tx, card);
                            }
                        }
                        return false;
                    });
                    
                    return `
                    <div class="p-3 bg-white/5 rounded-xl space-y-2">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="text-[11px] font-bold text-white">ğŸ’³ ${card.name}</div>
                                <div class="text-[9px] text-white/40">çµå¸³æ—¥ï¼šæ¯æœˆ ${card.closingDay} è™Ÿ | ç¹³æ¬¾æ—¥ï¼šçµå¸³å¾Œ ${card.dueDaysAfter} å¤©</div>
                                ${initialBalance > 0 && !hasTransactionsThisMonth ? `<div class="text-[9px] text-orange-400 mt-1">åˆå§‹æ¬ æ¬¾ï¼š${symbol}${Math.round(initialBalance).toLocaleString()}</div>` : ''}
                                ${carryingBalance > 0 ? `<div class="text-[9px] text-yellow-400 mt-1">ä¸ŠæœŸçµè½‰ï¼š${symbol}${Math.round(carryingBalance).toLocaleString()}</div>` : ''}
                                ${billAmount > 0 ? `<div class="text-[9px] text-yellow-400 mt-1">æœ¬æœˆæ‡‰ç¹³ï¼š${symbol}${Math.round(billAmount).toLocaleString()}</div>` : ''}
                            </div>
                            <div class="flex gap-2">
                                ${billAmount > 0 ? `<button onclick="openPaymentModal('${card.id}')" class="px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-lg text-[9px] font-bold">é‚„æ¬¾</button>` : ''}
                                <button onclick="editCard('${card.id}')" class="p-2 bg-white/10 rounded-lg">
                                    <i data-lucide="edit" class="w-3 h-3 text-white/60"></i>
                                </button>
                                <button onclick="deleteCard('${card.id}')" class="p-2 bg-white/10 rounded-lg">
                                    <i data-lucide="trash-2" class="w-3 h-3 text-white/20"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('')
                : '<div class="text-center py-4 text-white/20 text-xs">å°šæœªæ–°å¢ä¿¡ç”¨å¡</div>';
            
            // æ¸²æŸ“å®šæœŸäº¤æ˜“åˆ—è¡¨
            const frequencyMap = { daily: 'æ¯æ—¥', weekly: 'æ¯é€±', monthly: 'æ¯æœˆ', yearly: 'æ¯å¹´' };
            document.getElementById('settingsRecurringList').innerHTML = state.recurringTransactions.length > 0
                ? state.recurringTransactions.map(recurring => {
                    const symbol = getCurrencySymbol();
                    const category = state.categories.find(c => c.name === recurring.category) || state.categories[0];
                    const nextDate = recurring.lastCreated ? new Date(recurring.lastCreated) : new Date(recurring.startDate);
                    if (recurring.frequency === 'monthly') {
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    } else if (recurring.frequency === 'weekly') {
                        nextDate.setDate(nextDate.getDate() + 7);
                    } else if (recurring.frequency === 'daily') {
                        nextDate.setDate(nextDate.getDate() + 1);
                    } else if (recurring.frequency === 'yearly') {
                        nextDate.setFullYear(nextDate.getFullYear() + 1);
                    }
                    
                    return `
                    <div class="p-3 bg-white/5 rounded-xl space-y-2">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="text-[11px] font-bold text-white">${category.icon} ${recurring.note || recurring.category}</div>
                                <div class="text-[9px] text-white/40">${symbol}${Math.round(recurring.amount).toLocaleString()} Â· ${frequencyMap[recurring.frequency]}</div>
                                <div class="text-[9px] text-white/40">ä¸‹æ¬¡ï¼š${nextDate.toISOString().slice(0, 10)}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="deleteRecurring('${recurring.id}')" class="p-2 bg-white/10 rounded-lg">
                                    <i data-lucide="trash-2" class="w-3 h-3 text-white/20"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('')
                : '<div class="text-center py-4 text-white/20 text-xs">å°šæœªæ–°å¢å®šæœŸäº¤æ˜“</div>';
            
            // æ›´æ–°ç™»å…¥ç‹€æ…‹æ˜¾ç¤º
            updateAuthUI();
            
            // æ›´æ–°åŒæ­¥çŠ¶æ€
            updateSyncUI();
            
            lucide.createIcons();
        }
        
        // ç¯€æµå‡½æ•¸ - é™åˆ¶å‡½æ•¸åŸ·è¡Œé »ç‡
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        // ä½¿ç”¨ requestAnimationFrame å„ªåŒ–çš„ç¯€æµ
        function rafThrottle(func) {
            let rafId = null;
            let lastArgs = null;
            
            return function(...args) {
                lastArgs = args;
                if (rafId === null) {
                    rafId = requestAnimationFrame(() => {
                        func.apply(this, lastArgs);
                        rafId = null;
                        lastArgs = null;
                    });
                }
            };
        }
        
        // ç¹ªè£½åœ“å½¢è‰²éšé¸æ“‡å™¨
        function drawColorWheel() {
            const canvas = document.getElementById('themeColorWheel');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const size = 280;
            canvas.width = size;
            canvas.height = size;
            
            const centerX = size / 2;
            const centerY = size / 2;
            const outerRadius = size / 2 - 10;
            const innerRadius = outerRadius * 0.4;
            
            // ç¹ªè£½è‰²è¼ªï¼ˆå¾å¤–åœˆåˆ°å…§åœˆï¼‰
            const imageData = ctx.createImageData(size, size);
            const data = imageData.data;
            
            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const dx = x - centerX;
                    const dy = y - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const index = (y * size + x) * 4;
                    
                    if (distance > outerRadius) {
                        // å¤–åœˆä¹‹å¤–ï¼šé€æ˜
                        data[index + 3] = 0;
                    } else if (distance < innerRadius) {
                        // å…§åœˆï¼šç°è‰²æ¼¸è®Šï¼ˆäº®åº¦é¸æ“‡ï¼‰
                        const ratio = distance / innerRadius;
                        const gray = Math.round(255 * (1 - ratio));
                        data[index] = gray;
                        data[index + 1] = gray;
                        data[index + 2] = gray;
                        data[index + 3] = 255;
                    } else {
                        // å¤–åœˆï¼šè‰²ç›¸å’Œé£½å’Œåº¦
                        let angle = Math.atan2(dy, dx);
                        if (angle < 0) angle += Math.PI * 2;
                        const hue = (angle / (Math.PI * 2)) * 360;
                        
                        const normalizedDist = (distance - innerRadius) / (outerRadius - innerRadius);
                        const sat = 100 - normalizedDist * 20; // å¤–åœˆé£½å’Œåº¦è¼ƒé«˜
                        const light = 50 + normalizedDist * 20; // å¾50%åˆ°70%
                        
                        const rgb = hslToRgb(hue / 360, sat / 100, light / 100);
                        data[index] = rgb[0];
                        data[index + 1] = rgb[1];
                        data[index + 2] = rgb[2];
                        data[index + 3] = 255;
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            // ç·©å­˜æœ€å¾Œçš„é¡è‰²å€¼ï¼Œé¿å…é‡è¤‡è¨ˆç®—
            let lastHex = null;
            let lastRgb = null;
            
            // è™•ç†é¡è‰²é¸æ“‡ï¼ˆé»æ“Šæˆ–æ‹–å‹•ï¼‰- ä½¿ç”¨ç¯€æµå„ªåŒ–
            const handleColorSelection = (e) => {
                const rect = canvas.getBoundingClientRect();
                let x, y;
                
                // æ”¯æ´æ»‘é¼ å’Œè§¸æ§
                if (e.touches && e.touches.length > 0) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // å¦‚æœç§»å‡ºè‰²è¼ªï¼Œéš±è—æŒ‡ç¤ºå™¨ä¸¦è¿”å›
                if (distance > outerRadius) {
                    updateColorIndicator(x, y, null, false);
                    return;
                }
                
                // è¨ˆç®—è§’åº¦
                let angle = Math.atan2(dy, dx);
                if (angle < 0) angle += Math.PI * 2;
                const hue = (angle / (Math.PI * 2)) * 360;
                
                // è¨ˆç®—é£½å’Œåº¦å’Œäº®åº¦
                let sat, light;
                if (distance < innerRadius) {
                    // ä¸­å¿ƒå€åŸŸï¼šç°è‰²ï¼ˆèª¿æ•´äº®åº¦ï¼‰
                    sat = 0;
                    light = 100 - (distance / innerRadius) * 100;
                } else {
                    // å¤–åœˆï¼šå½©è‰²ï¼ˆèª¿æ•´é£½å’Œåº¦ï¼‰
                    const normalizedDist = (distance - innerRadius) / (outerRadius - innerRadius);
                    sat = 100 - normalizedDist * 20;
                    light = 50 + normalizedDist * 20;
                }
                
                // è½‰æ›ç‚º RGB
                const rgb = hslToRgb(hue / 360, sat / 100, light / 100);
                const hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
                
                // åªæœ‰é¡è‰²æ”¹è®Šæ™‚æ‰æ›´æ–°ï¼ˆé¿å…é‡è¤‡è¨ˆç®—ï¼‰
                if (hex !== lastHex) {
                    lastHex = hex;
                    lastRgb = rgb;
                    
                    // å³æ™‚æ‡‰ç”¨ä¸»é¡Œï¼ˆæ‹–å‹•æ™‚ï¼‰- ä½¿ç”¨ç¯€æµ
                    throttledApplyColorTheme(hex, rgb, true);
                }
                
                // æŒ‡ç¤ºå™¨ä½ç½®å§‹çµ‚æ›´æ–°ï¼ˆæ›´æµæš¢ï¼‰- åªåœ¨è‰²è¼ªå…§é¡¯ç¤º
                updateColorIndicator(x, y, hex, true);
            };
            
            // ä½¿ç”¨ requestAnimationFrame ç¯€æµçš„ä¸»é¡Œæ‡‰ç”¨å‡½æ•¸
            const throttledApplyColorTheme = rafThrottle((hex, rgb, isPreview) => {
                applyColorTheme(hex, rgb, isPreview);
            });
            
            // é»æ“Šäº‹ä»¶ï¼ˆæœ€çµ‚ç¢ºå®šé¸æ“‡ï¼‰
            canvas.onclick = (e) => {
                handleColorSelection(e);
                // æœ€çµ‚ä¿å­˜
                const rect = canvas.getBoundingClientRect();
                let x, y;
                if (e.touches && e.touches.length > 0) {
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                } else {
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                }
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance > outerRadius) return;
                
                let angle = Math.atan2(dy, dx);
                if (angle < 0) angle += Math.PI * 2;
                const hue = (angle / (Math.PI * 2)) * 360;
                
                let sat, light;
                if (distance < innerRadius) {
                    sat = 0;
                    light = 100 - (distance / innerRadius) * 100;
                } else {
                    const normalizedDist = (distance - innerRadius) / (outerRadius - innerRadius);
                    sat = 100 - normalizedDist * 20;
                    light = 50 + normalizedDist * 20;
                }
                
                const rgb = hslToRgb(hue / 360, sat / 100, light / 100);
                const hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
                
                // æœ€çµ‚ä¿å­˜
                applyColorTheme(hex, rgb, false);
            };
            
            // æ»‘é¼ ç§»å‹•äº‹ä»¶ï¼ˆæ‹–å‹•æ™‚å³æ™‚åæ‡‰ï¼‰
            let isDragging = false;
            canvas.onmousedown = (e) => {
                isDragging = true;
                handleColorSelection(e);
            };
            
            canvas.onmousemove = (e) => {
                if (isDragging) {
                    handleColorSelection(e);
                } else {
                    // æ»‘é¼ ç§»å‹•ä½†æœªæŒ‰ä¸‹æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦åœ¨è‰²è¼ªå…§
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const dx = x - centerX;
                    const dy = y - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance > outerRadius) {
                        updateColorIndicator(x, y, null, false);
                    }
                }
            };
            
            canvas.onmouseup = () => {
                isDragging = false;
            };
            
            canvas.onmouseleave = () => {
                isDragging = false;
                updateColorIndicator(0, 0, null, false);
            };
            
            // è§¸æ§äº‹ä»¶ï¼ˆç§»å‹•è¨­å‚™ï¼‰
            canvas.ontouchstart = (e) => {
                e.preventDefault();
                handleColorSelection(e);
            };
            
            canvas.ontouchmove = (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                if (e.touches && e.touches.length > 0) {
                    const x = e.touches[0].clientX - rect.left;
                    const y = e.touches[0].clientY - rect.top;
                    const dx = x - centerX;
                    const dy = y - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance <= outerRadius) {
                        // åœ¨è‰²è¼ªå…§ï¼Œè™•ç†é¡è‰²é¸æ“‡
                        handleColorSelection(e);
                    } else {
                        // ç§»å‡ºè‰²è¼ªï¼Œéš±è—æŒ‡ç¤ºå™¨
                        updateColorIndicator(x, y, null, false);
                    }
                }
            };
            
            canvas.ontouchend = (e) => {
                e.preventDefault();
                // æœ€çµ‚ä¿å­˜
                const rect = canvas.getBoundingClientRect();
                if (e.changedTouches && e.changedTouches.length > 0) {
                    const x = e.changedTouches[0].clientX - rect.left;
                    const y = e.changedTouches[0].clientY - rect.top;
                    const dx = x - centerX;
                    const dy = y - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance <= outerRadius) {
                        let angle = Math.atan2(dy, dx);
                        if (angle < 0) angle += Math.PI * 2;
                        const hue = (angle / (Math.PI * 2)) * 360;
                        
                        let sat, light;
                        if (distance < innerRadius) {
                            sat = 0;
                            light = 100 - (distance / innerRadius) * 100;
                        } else {
                            const normalizedDist = (distance - innerRadius) / (outerRadius - innerRadius);
                            sat = 100 - normalizedDist * 20;
                            light = 50 + normalizedDist * 20;
                        }
                        
                        const rgb = hslToRgb(hue / 360, sat / 100, light / 100);
                        const hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
                        applyColorTheme(hex, rgb, false);
                    } else {
                        // ç§»å‡ºè‰²è¼ªï¼Œéš±è—æŒ‡ç¤ºå™¨
                        updateColorIndicator(x, y, null, false);
                    }
                }
            };
            
            // æ›´æ–°ç•¶å‰ä¸»é¡Œçš„æŒ‡ç¤ºå™¨ä½ç½®
            updateCurrentThemeIndicator();
        }
        
        // HSL è½‰ RGB
        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }
        
        // RGB è½‰ Hex
        function rgbToHex(r, g, b) {
            return "#" + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join("");
        }
        
        // æ‡‰ç”¨é¡è‰²ä¸»é¡Œï¼ˆå„ªåŒ–ç‰ˆæœ¬ï¼‰
        async function applyColorTheme(hex, rgb, isPreview = false) {
            const [r, g, b] = rgb;
            const rgbStr = `${r}, ${g}, ${b}`;
            
            // è¨ˆç®—èƒŒæ™¯è‰²ï¼ˆè¼ƒæš—çš„ç‰ˆæœ¬ï¼‰
            const bgR = Math.max(0, Math.min(15, Math.floor(r * 0.05)));
            const bgG = Math.max(0, Math.min(15, Math.floor(g * 0.05)));
            const bgB = Math.max(0, Math.min(15, Math.floor(b * 0.05)));
            const bg = `#${bgR.toString(16).padStart(2, '0')}${bgG.toString(16).padStart(2, '0')}${bgB.toString(16).padStart(2, '0')}`;
            
            // è¨ˆç®—é€æ˜åº¦
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            const opacity = brightness > 128 ? 0.7 : 0.5;
            
            // ä½¿ç”¨ requestAnimationFrame æ‰¹é‡æ›´æ–° DOMï¼ˆæ€§èƒ½å„ªåŒ–ï¼‰
            requestAnimationFrame(() => {
                // å³æ™‚æ‡‰ç”¨ä¸»é¡Œï¼ˆæ‹–å‹•æ™‚å³æ™‚åæ‡‰ï¼‰
                document.documentElement.style.setProperty('--accent', hex);
                document.documentElement.style.setProperty('--accent-rgb', rgbStr);
                document.documentElement.style.setProperty('--bg-deep', bg);
                document.documentElement.style.setProperty('--card-bg', `rgba(28, 28, 32, ${opacity})`);
                
                // æ›´æ–°é è¦½
                const preview = document.getElementById('selectedThemePreview');
                if (preview) {
                    preview.style.backgroundColor = hex;
                    preview.style.color = brightness > 128 ? '#000' : '#fff';
                    preview.textContent = `å·²é¸æ“‡ï¼š${hex.toUpperCase()}`;
                }
            });
            
            // å¦‚æœæ˜¯é è¦½æ¨¡å¼ï¼ˆæ‹–å‹•ä¸­ï¼‰ï¼Œä¸ä¿å­˜ï¼Œä¸æ›´æ–°åœ–è¡¨ï¼ˆæ€§èƒ½å„ªåŒ–ï¼‰
            if (isPreview) {
                return; // é è¦½æ¨¡å¼ä¸‹ä¸æ›´æ–°åœ–è¡¨ï¼Œé¿å…å¡é “
            }
            
            // æœ€çµ‚ç¢ºå®šæ™‚æ‰ä¿å­˜å’Œæ›´æ–°åœ–è¡¨
            state.themeId = 'custom';
            state.customTheme = { color: hex, rgb: rgbStr, opacity, bg };
            
            // å„²å­˜åˆ° IndexedDBï¼ˆç•°æ­¥ï¼Œä¸é˜»å¡ï¼‰
            localDB.put('settings', { key: 'themeId', value: 'custom' }).catch(console.error);
            localDB.put('settings', { key: 'customTheme', value: state.customTheme }).catch(console.error);
            
            // åªåœ¨æœ€çµ‚ç¢ºå®šæ™‚æ›´æ–°åœ–è¡¨
            if (myChart) {
                requestAnimationFrame(() => {
                    renderStats();
                });
            }
        }
        
        // æ›´æ–°é¡è‰²æŒ‡ç¤ºå™¨ä½ç½®ï¼ˆå„ªåŒ–ç‰ˆæœ¬ï¼‰
        function updateColorIndicator(x, y, color, isVisible = true) {
            const indicator = document.getElementById('themeColorIndicator');
            if (!indicator) return;
            
            if (!isVisible) {
                // éš±è—æŒ‡ç¤ºå™¨
                indicator.style.opacity = '0';
                return;
            }
            
            // é¡¯ç¤ºæŒ‡ç¤ºå™¨ä¸¦æ›´æ–°ä½ç½®
            indicator.style.opacity = '1';
            indicator.style.left = x + 'px';
            indicator.style.top = y + 'px';
            indicator.style.borderColor = color;
            indicator.style.boxShadow = `0 0 10px rgba(0, 0, 0, 0.8), 0 0 20px ${color}, 0 0 30px ${color}`;
        }
        
        // æ›´æ–°ç•¶å‰ä¸»é¡Œçš„æŒ‡ç¤ºå™¨ä½ç½®
        function updateCurrentThemeIndicator() {
            const currentScheme = THEME_SCHEMES.find(s => s.id === state.themeId);
            if (currentScheme && !state.customTheme) {
                // å¦‚æœæœ‰é è¨­ä¸»é¡Œï¼Œå¯ä»¥é¡¯ç¤ºåœ¨è‰²è¼ªä¸Š
                // é€™è£¡æš«æ™‚ä¸é¡¯ç¤ºï¼Œå› ç‚ºè‰²è¼ªæ˜¯é€£çºŒçš„è‰²éš
            }
        }
        
        // æ‘ºç–Š/å±•é–‹åŠŸèƒ½
        function toggleThemeSection() {
            const section = document.getElementById('themeSection');
            const chevron = document.getElementById('themeChevron');
            if (!section || !chevron) return;
            
            const isExpanded = section.classList.contains('expanded');
            if (isExpanded) {
                section.classList.remove('expanded');
                chevron.style.transform = 'rotate(0deg)';
            } else {
                section.classList.add('expanded');
                chevron.style.transform = 'rotate(180deg)';
                // å±•é–‹æ™‚é‡æ–°ç¹ªè£½è‰²è¼ªï¼ˆç­‰å¾…å‹•ç•«å®Œæˆï¼‰
                setTimeout(() => {
                    const canvas = document.getElementById('themeColorWheel');
                    if (canvas) {
                        drawColorWheel();
                    }
                }, 350);
            }
            lucide.createIcons();
        }
        
        function toggleCurrencySection() {
            const section = document.getElementById('currencySection');
            const chevron = document.getElementById('currencyChevron');
            if (!section || !chevron) return;
            
            const isExpanded = section.classList.contains('expanded');
            if (isExpanded) {
                section.classList.remove('expanded');
                chevron.style.transform = 'rotate(0deg)';
            } else {
                section.classList.add('expanded');
                chevron.style.transform = 'rotate(180deg)';
            }
            lucide.createIcons();
        }

        function updateAuthUI() {
            const authStatusText = document.getElementById('authStatusText');
            const authActionBtn = document.getElementById('authActionBtn');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const userEmailEl = document.getElementById('userEmail');
            const syncInfoPanel = document.getElementById('syncInfoPanel');
            const localDataCount = document.getElementById('localDataCount');

            // æ›´æ–°æœ¬åœ°è³‡æ–™çµ±è¨ˆ
            if (localDataCount) {
                localDataCount.innerText = `${state.transactions.length} ç­†äº¤æ˜“`;
            }

            if (state.isLoggedIn && currentUser) {
                // å·²ç™»å…¥ç‹€æ…‹
                authStatusText.innerText = 'âœ… å·²ç™»å…¥';
                authStatusText.className = 'text-green-400 font-black';
                userEmailDisplay.classList.remove('hidden');
                userEmailEl.innerText = currentUser.email || 'Unknown';
                syncInfoPanel.classList.remove('hidden');
                authActionBtn.innerHTML = 'ğŸšª ç™»å‡ºå¸³æˆ¶';
                authActionBtn.onclick = handleSignOut;
            } else {
                // æœªç™»å…¥ç‹€æ…‹
                authStatusText.innerText = 'æœ¬åœ°æ¨¡å¼';
                authStatusText.className = 'text-white/60 font-black';
                userEmailDisplay.classList.add('hidden');
                syncInfoPanel.classList.add('hidden');
                authActionBtn.innerHTML = 'ğŸ” ç™»å…¥é›²ç«¯å¸³æˆ¶';
                authActionBtn.onclick = showAuthPage;
            }
        }

        async function changeCurrency(currencyId) {
            state.currency = currencyId;
            await save();
            updateCurrencySymbols();
            renderSettings();
            renderHome();
        }

        async function saveSettings(event) {
            const budgetInput = document.getElementById('budgetInput');
            const newBudget = parseFloat(budgetInput.value);
            
            if (!newBudget || newBudget <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é ç®—é‡‘é¡');
                return;
            }
            
            state.budget = newBudget;
            await save();
            
            // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®
            // ä¸è·³å›ä¸»ç•«é¢ï¼Œä¿æŒåœ¨è¨­å®šé é¢
            
            // é¡¯ç¤ºæˆåŠŸå›é¥‹
            const btn = event?.target || document.querySelector('button[onclick*="saveSettings"]');
            if (btn) {
                const originalText = btn.innerText;
                const originalClass = btn.className;
                
                // æ›´æ–°æŒ‰éˆ•æ¨£å¼
                btn.innerText = 'âœ“ å·²å„²å­˜';
                btn.className = originalClass.replace('dynamic-accent-bg', 'bg-green-500');
                btn.style.transform = 'scale(0.95)';
                
                // æ·»åŠ æˆåŠŸå‹•ç•«
                setTimeout(() => {
                    btn.style.transform = 'scale(1)';
                }, 100);
                
                // 2ç§’å¾Œæ¢å¾©
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.className = originalClass;
                    btn.style.transform = '';
                }, 2000);
            }
            
            // æ›´æ–°é¦–é é¡¯ç¤ºï¼ˆå¦‚æœéœ€è¦çš„è©±ï¼‰
            renderHome();
        }
        
        function openCatModal() { 
            document.getElementById('catModal').classList.remove('hidden'); 
            state.tempEmoji = null;
            updateCatConfirmBtn();
            document.getElementById('emojiPicker').innerHTML = EMOJI_POOL.map(e => `
                <button onclick="selectEmoji(this, '${e}')" class="emoji-item">${e}</button>
            `).join(''); 
        }

        function selectEmoji(el, emoji) {
            document.querySelectorAll('.emoji-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            state.tempEmoji = emoji;
            updateCatConfirmBtn();
        }

        function updateCatConfirmBtn() {
            const btn = document.getElementById('confirmCatBtn');
            if(state.tempEmoji) {
                btn.classList.remove('opacity-30', 'pointer-events-none');
                btn.innerText = "å„²å­˜";
                btn.onclick = confirmAddCategory;
            } else {
                btn.classList.add('opacity-30', 'pointer-events-none');
                btn.innerText = "è«‹é¸æ“‡åœ–ç¤º";
            }
        }

        function closeCatModal() { document.getElementById('catModal').classList.add('hidden'); }
        
        // ä¿¡ç”¨å¡ç®¡ç†å‡½æ•°
        let editingCardId = null;
        
        function openCardModal(cardId = null) {
            editingCardId = cardId;
            const modal = document.getElementById('cardModal');
            const title = document.getElementById('cardModalTitle');
            const nameInput = document.getElementById('cardName');
            const closingDayInput = document.getElementById('cardClosingDay');
            const dueDaysInput = document.getElementById('cardDueDays');
            const initialBalanceInput = document.getElementById('cardInitialBalance');
            
            if (cardId) {
                // ç¼–è¾‘æ¨¡å¼
                const card = state.cards.find(c => c.id === cardId);
                if (card) {
                    title.innerText = 'ç·¨è¼¯ä¿¡ç”¨å¡';
                    nameInput.value = card.name;
                    closingDayInput.value = card.closingDay;
                    dueDaysInput.value = card.dueDaysAfter;
                    initialBalanceInput.value = card.initialBalance || 0;
                }
            } else {
                // æ–°å¢æ¨¡å¼
                title.innerText = 'æ–°å¢ä¿¡ç”¨å¡';
                nameInput.value = '';
                closingDayInput.value = '';
                dueDaysInput.value = '';
                initialBalanceInput.value = '';
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeCardModal() {
            document.getElementById('cardModal').classList.add('hidden');
            editingCardId = null;
        }
        
        async function confirmAddCard() {
            const name = document.getElementById('cardName').value.trim();
            const closingDay = parseInt(document.getElementById('cardClosingDay').value);
            const dueDays = parseInt(document.getElementById('cardDueDays').value);
            const initialBalance = parseFloat(document.getElementById('cardInitialBalance').value) || 0;
            
            if (!name || !closingDay || !dueDays) {
                alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                return;
            }
            
            if (closingDay < 1 || closingDay > 31) {
                alert('çµå¸³æ—¥å¿…é ˆåœ¨ 1-31 ä¹‹é–“');
                return;
            }
            
            if (dueDays < 1 || dueDays > 60) {
                alert('ç¹³æ¬¾å¤©æ•¸å¿…é ˆåœ¨ 1-60 ä¹‹é–“');
                return;
            }
            
            if (initialBalance < 0) {
                alert('åˆå§‹æœªç¹³æ¸…é¤˜é¡ä¸èƒ½ç‚ºè² æ•¸');
                return;
            }
            
            if (editingCardId) {
                // ç¼–è¾‘ï¼ˆä¿ç•™åŸæœ‰çš„ carryingBalanceï¼‰
                const idx = state.cards.findIndex(c => c.id === editingCardId);
                if (idx !== -1) {
                    const existingCard = state.cards[idx];
                    state.cards[idx] = {
                        id: editingCardId,
                        name,
                        closingDay,
                        dueDaysAfter: dueDays,
                        carryingBalance: existingCard.carryingBalance || 0, // ä¿ç•™ç»“è½¬ä½™é¢
                        initialBalance: initialBalance // æ›´æ–°åˆå§‹æ¬ æ¬¾
                    };
                }
            } else {
                // æ–°å¢
                const newCard = {
                    id: Date.now().toString(),
                    name,
                    closingDay,
                    dueDaysAfter: dueDays,
                    carryingBalance: 0, // åˆå§‹ç»“è½¬ä½™é¢ä¸º0
                    initialBalance: initialBalance // åˆå§‹æœªç¹³æ¸…é¤˜é¡
                };
                state.cards.push(newCard);
            }
            
            await save();
            renderSettings();
            renderHome(); // é‡æ–°æ¸²æŸ“é¦–é¡µä»¥æ›´æ–°é¢„ç®—è®¡ç®—
            closeCardModal();
        }
        
        function editCard(cardId) {
            openCardModal(cardId);
        }
        
        async function deleteCard(cardId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä¿¡ç”¨å¡å—ï¼Ÿ')) return;
            
            state.cards = state.cards.filter(c => c.id !== cardId);
            await save();
            renderSettings();
        }
        
        // ============================================
        // å®šæœŸäº¤æ˜“ç®¡ç†
        // ============================================
        
        let editingRecurringId = null;
        
        function openRecurringModal(recurringId = null) {
            editingRecurringId = recurringId;
            const modal = document.getElementById('recurringModal');
            const title = document.getElementById('recurringModalTitle');
            const noteInput = document.getElementById('recurringNote');
            const amountInput = document.getElementById('recurringAmount');
            const categorySelect = document.getElementById('recurringCategory');
            const frequencySelect = document.getElementById('recurringFrequency');
            const startDateInput = document.getElementById('recurringStartDate');
            const endDateInput = document.getElementById('recurringEndDate');
            const paymentMethodSelect = document.getElementById('recurringPaymentMethod');
            const cardSelectContainer = document.getElementById('recurringCardSelectContainer');
            const cardSelect = document.getElementById('recurringCardSelect');
            
            if (recurringId) {
                const recurring = state.recurringTransactions.find(r => r.id === recurringId);
                if (recurring) {
                    title.innerText = 'ç·¨è¼¯å®šæœŸäº¤æ˜“';
                    noteInput.value = recurring.note || '';
                    amountInput.value = recurring.amount;
                    categorySelect.value = recurring.category;
                    frequencySelect.value = recurring.frequency;
                    startDateInput.value = recurring.startDate;
                    endDateInput.value = recurring.endDate || '';
                    paymentMethodSelect.value = recurring.paymentMethod || 'cash';
                }
            } else {
                title.innerText = 'æ–°å¢å®šæœŸäº¤æ˜“';
                noteInput.value = '';
                amountInput.value = '';
                categorySelect.value = state.categories[0].name;
                frequencySelect.value = 'monthly';
                startDateInput.value = new Date().toISOString().slice(0, 10);
                endDateInput.value = '';
                paymentMethodSelect.value = 'cash';
            }
            
            // å¡«å……åˆ†é¡é¸å–®
            categorySelect.innerHTML = state.categories.map(c => 
                `<option value="${c.name}">${c.icon} ${c.name}</option>`
            ).join('');
            
            // å¡«å……ä¿¡ç”¨å¡é¸å–®
            if (state.cards.length > 0) {
                cardSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä¿¡ç”¨å¡</option>' + 
                    state.cards.map(card => `<option value="${card.id}">${card.name}</option>`).join('');
            } else {
                cardSelect.innerHTML = '<option value="">è«‹å…ˆåœ¨è¨­å®šä¸­æ–°å¢ä¿¡ç”¨å¡</option>';
            }
            
            // é¡¯ç¤º/éš±è—ä¿¡ç”¨å¡é¸æ“‡
            if (paymentMethodSelect.value === 'credit') {
                cardSelectContainer.classList.remove('hidden');
            } else {
                cardSelectContainer.classList.add('hidden');
            }
            
            // ç›£è½æ”¯ä»˜æ–¹å¼è®ŠåŒ–
            paymentMethodSelect.onchange = () => {
                if (paymentMethodSelect.value === 'credit') {
                    cardSelectContainer.classList.remove('hidden');
                } else {
                    cardSelectContainer.classList.add('hidden');
                }
            };
            
            modal.classList.remove('hidden');
        }
        
        function closeRecurringModal() {
            document.getElementById('recurringModal').classList.add('hidden');
            editingRecurringId = null;
        }
        
        async function confirmAddRecurring() {
            const note = document.getElementById('recurringNote').value.trim();
            const amount = parseFloat(document.getElementById('recurringAmount').value);
            const category = document.getElementById('recurringCategory').value;
            const frequency = document.getElementById('recurringFrequency').value;
            const startDate = document.getElementById('recurringStartDate').value;
            const endDate = document.getElementById('recurringEndDate').value || null;
            const paymentMethod = document.getElementById('recurringPaymentMethod').value;
            const cardId = paymentMethod === 'credit' ? (document.getElementById('recurringCardSelect').value || null) : null;
            
            if (!note) {
                alert('è«‹è¼¸å…¥å‚™è¨»');
                return;
            }
            if (!amount || amount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
                return;
            }
            if (!startDate) {
                alert('è«‹é¸æ“‡é–‹å§‹æ—¥æœŸ');
                return;
            }
            
            if (editingRecurringId) {
                const index = state.recurringTransactions.findIndex(r => r.id === editingRecurringId);
                if (index !== -1) {
                    state.recurringTransactions[index] = {
                        ...state.recurringTransactions[index],
                        note,
                        amount,
                        category,
                        frequency,
                        startDate,
                        endDate,
                        paymentMethod,
                        cardId
                    };
                }
            } else {
                const recurring = {
                    id: Date.now(),
                    note,
                    amount,
                    category,
                    frequency,
                    startDate,
                    endDate,
                    paymentMethod,
                    cardId,
                    lastCreated: null
                };
                state.recurringTransactions.push(recurring);
            }
            
            localStorage.setItem('ledger_recurring_v1', JSON.stringify(state.recurringTransactions));
            await processRecurringTransactions();
            renderSettings();
            renderHome();
            closeRecurringModal();
        }
        
        async function deleteRecurring(recurringId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å®šæœŸäº¤æ˜“å—ï¼Ÿ')) return;
            
            state.recurringTransactions = state.recurringTransactions.filter(r => r.id !== recurringId);
            localStorage.setItem('ledger_recurring_v1', JSON.stringify(state.recurringTransactions));
            renderSettings();
        }
        
        // è¿˜æ¬¾åŠŸèƒ½
        let paymentCardId = null;
        
        function openPaymentModal(cardId) {
            paymentCardId = cardId;
            const card = state.cards.find(c => c.id === cardId);
            if (!card) return;
            
            const creditCardBill = calculateCreditCardBillThisMonth();
            const cardBill = creditCardBill.byCard[cardId];
            const billAmount = cardBill ? cardBill.amount : 0;
            const symbol = getCurrencySymbol();
            
            document.getElementById('paymentModalTitle').innerText = `è¨˜éŒ„é‚„æ¬¾ - ${card.name}`;
            document.getElementById('paymentCardInfo').innerHTML = `ğŸ’³ ${card.name}`;
            document.getElementById('paymentTotalAmount').innerText = `${symbol}${Math.round(billAmount).toLocaleString()}`;
            document.getElementById('paymentAmount').value = '';
            
            document.getElementById('paymentModal').classList.remove('hidden');
        }
        
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            paymentCardId = null;
        }
        
        async function confirmPayment() {
            if (!paymentCardId) return;
            
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            if (!paymentAmount || paymentAmount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‚„æ¬¾é‡‘é¡');
                return;
            }
            
            const card = state.cards.find(c => c.id === paymentCardId);
            if (!card) return;
            
            const creditCardBill = calculateCreditCardBillThisMonth();
            const cardBill = creditCardBill.byCard[paymentCardId];
            const billAmount = cardBill ? cardBill.amount : 0;
            
            // è®¡ç®—å‰©ä½™æœªç¼´é‡‘é¢
            const remaining = billAmount - paymentAmount;
            
            const cardIndex = state.cards.findIndex(c => c.id === paymentCardId);
            if (cardIndex !== -1) {
                // æ›´æ–°å·²é‚„æ¬¾ç¸½é¡ï¼ˆä¿®å¾©åˆå§‹é¤˜é¡é‡è¤‡è¨ˆç®— BUGï¼‰
                const currentRepaid = state.cards[cardIndex].totalRepaid || 0;
                state.cards[cardIndex].totalRepaid = currentRepaid + paymentAmount;
                
                if (remaining > 0) {
                    // æœ‰å‰©ä½™ï¼Œæ›´æ–°ç»“è½¬ä½™é¢ï¼ˆç´¯åŠ åˆ°ä¸‹æœˆï¼‰
                    state.cards[cardIndex].carryingBalance = remaining;
                } else {
                    // å·²ç¼´æ¸…ï¼Œæ¸…é›¶ç»“è½¬ä½™é¢
                    state.cards[cardIndex].carryingBalance = 0;
                }
            }
            
            await save();
            renderSettings();
            renderHome();
            closePaymentModal();
            
            if (remaining > 0) {
                alert(`å·²é‚„æ¬¾ ${paymentAmount.toLocaleString()}ï¼Œå‰©é¤˜ ${remaining.toLocaleString()} å°‡çµè½‰è‡³ä¸‹æœˆ`);
            } else {
                alert('å·²é‚„æ¬¾å®Œæˆï¼');
            }
        }
        
        function showCloudInfoModal() {
            document.getElementById('cloudInfoModal').classList.remove('hidden'); 
            lucide.createIcons(); // é‡æ–°æ¸²æŸ“åœ–ç¤º
        }
        
        function closeCloudInfoModal() {
            document.getElementById('cloudInfoModal').classList.add('hidden'); 
        }
        
        // å¹«åŠ©èªªæ˜ Modal
        function showHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
            lucide.createIcons();
        }
        
        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
        }

        // ============================================
        // Login Code Functions
        // ============================================
        
        function generateLoginCode() {
            // ç”Ÿæˆ 6 ä½æ•¸å¤§å¯«å­—æ¯+æ•¸å­—ä»£ç¢¼
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // æ’é™¤å®¹æ˜“æ··æ·†çš„å­—ç¬¦ (0,O,1,I)
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function showLoginCodeModal() {
            if (!currentUser || !state.isLoggedIn) {
                alert('è«‹å…ˆç™»å…¥å¸³æˆ¶');
                return;
            }

            if (!supabaseClient) {
                alert('âš ï¸ Supabase æœªé…ç½®ï¼Œç„¡æ³•ä½¿ç”¨æ­¤åŠŸèƒ½');
                return;
            }

            const modal = document.getElementById('loginCodeModal');
            const codeDisplay = document.getElementById('displayLoginCode');
            
            try {
                codeDisplay.innerText = 'ç”Ÿæˆä¸­...';
                
                // ç²å–ç•¶å‰ session
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError || !session) {
                    throw new Error('ç„¡æ³•ç²å–ç™»å…¥ session');
                }
                
                // ç”Ÿæˆæ–°ä»£ç¢¼
                const loginCode = generateLoginCode();
                const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 åˆ†é˜å¾ŒéæœŸ
                
                // å„²å­˜åˆ° Supabase
                const { error: insertError } = await supabaseClient
                    .from('login_codes')
                    .insert({
                        code: loginCode,
                        user_id: currentUser.id,
                        email: currentUser.email,
                        access_token: session.access_token,
                        refresh_token: session.refresh_token,
                        expires_at: expiresAt.toISOString()
                    });
                
                if (insertError) {
                    console.error('Insert code error:', insertError);
                    throw new Error('å„²å­˜ç™»å…¥ä»£ç¢¼å¤±æ•—ï¼š' + insertError.message);
                }
                
                // é¡¯ç¤ºä»£ç¢¼
                codeDisplay.innerText = loginCode;
                
                // é»æ“Šä»£ç¢¼è¤‡è£½
                codeDisplay.onclick = () => {
                    navigator.clipboard.writeText(loginCode).then(() => {
                        const originalText = codeDisplay.innerText;
                        codeDisplay.innerText = 'âœ… å·²è¤‡è£½';
                        setTimeout(() => {
                            codeDisplay.innerText = originalText;
                        }, 1500);
                    }).catch(err => {
                        // Fallback: æ‰‹å‹•é¸å–
                        const range = document.createRange();
                        range.selectNodeContents(codeDisplay);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        alert('å·²é¸å–ä»£ç¢¼ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼ˆCtrl+C æˆ– Cmd+Cï¼‰');
                    });
                };
                
                modal.classList.remove('hidden');
                lucide.createIcons();
                
            } catch (error) {
                console.error('Generate code error:', error);
                alert('ç”¢ç”Ÿç™»å…¥ä»£ç¢¼å¤±æ•—ï¼š' + error.message);
                codeDisplay.innerText = '------';
            }
        }

        function closeLoginCodeModal() {
            document.getElementById('loginCodeModal').classList.add('hidden');
        }

        async function verifyLoginCode() {
            if (!supabaseClient) {
                showAuthMessage('âš ï¸ Supabase æœªé…ç½®ï¼Œç„¡æ³•ä½¿ç”¨æ­¤åŠŸèƒ½', 'error');
                return;
            }

            const codeInput = document.getElementById('loginCode').value.trim().toUpperCase();
            
            if (!codeInput || codeInput.length !== 6) {
                showAuthMessage('âŒ è«‹è¼¸å…¥ 6 ä½æ•¸ä»£ç¢¼', 'error');
                return;
            }

            const btnText = document.getElementById('btnVerifyCode');
            const originalText = btnText.innerText;
            btnText.innerText = 'ğŸ”„ é©—è­‰ä¸­...';

            try {
                // å¾ Supabase æŸ¥è©¢ä»£ç¢¼
                const { data: codeData, error: fetchError } = await supabaseClient
                    .from('login_codes')
                    .select('*')
                    .eq('code', codeInput)
                    .is('used_at', null)
                    .gt('expires_at', new Date().toISOString())
                    .single();
                
                if (fetchError || !codeData) {
                    console.error('Fetch code error:', fetchError);
                    throw new Error('ç™»å…¥ä»£ç¢¼ç„¡æ•ˆæˆ–å·²éæœŸã€‚è«‹ç¢ºèªä»£ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–é‡æ–°ç”¢ç”Ÿã€‚');
                }

                // ä»£ç¢¼æ­£ç¢ºï¼ä½¿ç”¨ access_token å’Œ refresh_token ä¾†è¨­å®š session
                showAuthMessage('âœ… ä»£ç¢¼é©—è­‰æˆåŠŸï¼æ­£åœ¨ç™»å…¥...', 'success');
                
                // ä½¿ç”¨ setSession æ–¹æ³•ä¾†ç™»å…¥
                const { data: sessionData, error: sessionError } = await supabaseClient.auth.setSession({
                    access_token: codeData.access_token,
                    refresh_token: codeData.refresh_token
                });

                if (sessionError) throw sessionError;

                // æ¨™è¨˜ä»£ç¢¼ç‚ºå·²ä½¿ç”¨
                await supabaseClient
                    .from('login_codes')
                    .update({ used_at: new Date().toISOString() })
                    .eq('code', codeInput);

                // ç™»å…¥æˆåŠŸ
                currentUser = sessionData.user;
                state.isLoggedIn = true;
                state.userId = currentUser.id;
                
                showAuthMessage(`âœ… ç™»å…¥æˆåŠŸï¼<br><br>
                    <div class="text-left bg-green-500/10 border border-green-500/30 rounded-xl p-4 mt-3">
                        <p class="text-[10px] font-black text-green-400 uppercase mb-2">ğŸ‰ æ­¡è¿å›ä¾†</p>
                        <p class="text-[11px] text-white mb-2">Email: ${codeData.email}</p>
                    </div>`, 'success');
                
                // æ¸…ç©ºè¼¸å…¥
                document.getElementById('loginCode').value = '';
                
                // è·³è½‰åˆ°ä¸»é é¢ï¼ˆä»äº‘ç«¯æ‹‰å–æ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰è®¾å¤‡æ•°æ®ä¸€è‡´ï¼‰
                setTimeout(async () => {
                    if (syncManager) {
                        // ä»äº‘ç«¯æ‹‰å–æ•°æ®ï¼ˆç¡®ä¿æ‰€æœ‰è®¾å¤‡æ•°æ®ä¸€è‡´ï¼Œä½†ä¸è‡ªåŠ¨ä¸Šä¼ ï¼‰
                        try {
                            console.log('ğŸ”„ Pulling data from cloud after code login to ensure consistency...');
                            await syncManager.syncFromCloud();
                            await loadDataFromLocal();
                            console.log('âœ… Data pulled from cloud. All devices will show the same data.');
                        } catch (error) {
                            console.warn('âš ï¸ Failed to pull data from cloud:', error);
                            await loadDataFromLocal();
                        }
                    }
                    showMainApp();
                    renderAll();
                    updateAuthStatusInSettings();
                }, 1500);

            } catch (error) {
                console.error('Code verification error:', error);
                showAuthMessage(`âŒ ${error.message}`, 'error');
            } finally {
                btnText.innerText = originalText;
            }
        }
        
        async function confirmAddCategory() { 
            const name = document.getElementById('newCatName').value.trim(); 
            if(!name || !state.tempEmoji) return; 
            const newCategory = { 
                name, 
                icon: state.tempEmoji, 
                color: '#'+Math.floor(Math.random()*16777215).toString(16),
                updated_at: new Date().toISOString()
            };
            state.categories.push(newCategory);
            
            // ä¿å­˜åˆ° IndexedDB
            try {
                const catId = crypto.randomUUID();
                await localDB.put('categories', {
                    id: catId,
                    name: newCategory.name,
                    icon: newCategory.icon,
                    color: newCategory.color,
                    updated_at: newCategory.updated_at
                });
            } catch (error) {
                console.error('Failed to save category:', error);
            }
            
            await save(); 
            renderSettings(); 
            closeCatModal(); 
            document.getElementById('newCatName').value = "";
        }

        async function deleteCat(name) { 
            if(state.categories.length > 1) { 
                // å…ˆæ‰¾åˆ°è¦åˆ é™¤çš„åˆ†ç±»ï¼ˆåœ¨è¿‡æ»¤ä¹‹å‰ï¼‰
                const catToDelete = state.categories.find(c => c.name === name);
                
                // ä» state ä¸­åˆ é™¤åˆ†ç±»
                state.categories = state.categories.filter(c => c.name !== name); 
                
                // ä» IndexedDB åˆ é™¤åˆ†ç±»
                if (catToDelete && catToDelete.id) {
                    try {
                        await localDB.delete('categories', catToDelete.id);
                    } catch (error) {
                        console.warn('Failed to delete category from IndexedDB:', error);
                    }
                }
                
                await save(); 
                renderSettings(); 
            } 
        }
        function clearAllData() { if(confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰æ•¸æ“šï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
