<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="å€‹äººè²¡å‹™è¨˜å¸³æ‡‰ç”¨ç¨‹å¼">
    <meta name="theme-color" content="#0a0a0c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ledger">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Ledger - Personal Finance</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%230a0a0c'/%3E%3Cpath fill='%23ffffff' d='M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zm80 256h64c44.2 0 80 35.8 80 80c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16c0-44.2 35.8-80 80-80zm-32-96a64 64 0 1 1 128 0 64 64 0 1 1 -128 0zm256-32H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16zm0 64H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16zm0 64H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16z'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%230a0a0c'/%3E%3Cpath fill='%23ffffff' d='M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zm80 256h64c44.2 0 80 35.8 80 80c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16c0-44.2 35.8-80 80-80zm-32-96a64 64 0 1 1 128 0 64 64 0 1 1 -128 0zm256-32H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16zm0 64H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16zm0 64H304c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16s-7.2-16-16-16z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');

        :root {
            --primary: #ffffff;
            --accent: #ffffff;
            --accent-rgb: 255, 255, 255;
            --bg-deep: #0a0a0c;
            --card-bg: rgba(28, 28, 32, 0.7);
            --glow: 0 0 20px rgba(255, 255, 255, 0.1);
            --flask-water: #3b82f6;
        }

        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: #ffffff;
            height: 100vh;
            height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡ */
            margin: 0;
            padding: 0;
            overflow: hidden;
            transition: background-color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
            /* æ”¯æŒå…¨å±æ¨¡å¼ */
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }
        
        /* æ”¯æŒ iOS Safari å…¨å±æ¨¡å¼ */
        @supports (-webkit-touch-callout: none) {
            body {
                height: -webkit-fill-available;
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle at 50% 0%, rgba(var(--accent-rgb), 0.08) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            transition: background 0.5s ease;
        }

        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: var(--glow);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .page-transition {
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .hidden-page { display: none !important; }

        /* Auth Page Styles */
        .auth-tab-active {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            color: white;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .auth-tab-inactive {
            background: transparent;
            color: rgba(255, 255, 255, 0.3);
            border: 1px solid transparent;
        }

        .auth-tab-inactive:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .nav-dock-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 50;
        }

        .nav-dock {
            background: rgba(15, 15, 18, 0.85);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(var(--accent-rgb), 0.15);
            border-radius: 40px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .nav-btn { color: rgba(255, 255, 255, 0.2); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-btn.active { color: var(--accent); transform: scale(1.15); filter: drop-shadow(0 0 8px var(--accent)); }

        .center-add-btn {
            width: 60px;
            height: 60px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-20px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5), 0 0 20px rgba(var(--accent-rgb), 0.4);
            transition: all 0.3s ease;
        }

        .brand-title {
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.15em;
            background: linear-gradient(to bottom, #fff 40%, rgba(var(--accent-rgb), 0.4));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .by-owen {
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.3em;
            font-size: 7px;
            text-transform: uppercase;
            opacity: 0.4;
        }

        .dynamic-accent-bg { background-color: var(--accent); transition: all 0.3s ease; }
        .dynamic-accent-text { color: var(--accent); transition: all 0.3s ease; }
        
        .flask-container {
            position: relative;
            width: 150px;
            height: 200px;
            margin: 0 auto;
              animation: flask-sway 7s cubic-bezier(0.45, 0.05, 0.55, 0.95) infinite;
            filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.4));
        }

        .flask {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 160px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.02) 0%,
                rgba(255, 255, 255, 0.005) 50%,
                rgba(255, 255, 255, 0.02) 100%);
            border-radius: 18% 18% 45% 45%;
            border: 2.5px solid rgba(255, 255, 255, 0.3);
            border-left-color: rgba(255, 255, 255, 0.4);
            border-right-color: rgba(255, 255, 255, 0.15);
            overflow: hidden;
            backdrop-filter: blur(12px);
            z-index: 2;
            box-shadow: 
                inset -20px 0 35px rgba(0, 0, 0, 0.25),
                inset 20px 0 35px rgba(255, 255, 255, 0.08),
                inset 0 -15px 25px rgba(0, 0, 0, 0.15);
        }

        .flask::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.03) 25%,
                transparent 50%,
                rgba(0, 0, 0, 0.05) 75%,
                transparent 100%);
            pointer-events: none;
        }

        .flask-neck {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 45px;
            height: 60px;
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.03) 0%,
                rgba(255, 255, 255, 0.01) 100%);
            border: 2.5px solid rgba(255, 255, 255, 0.3);
            border-left-color: rgba(255, 255, 255, 0.4);
            border-right-color: rgba(255, 255, 255, 0.15);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            z-index: 1;
            backdrop-filter: blur(12px);
            box-shadow: 
                inset -10px 0 20px rgba(0, 0, 0, 0.2),
                inset 10px 0 20px rgba(255, 255, 255, 0.08);
        }

        .flask-neck::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px 10px 0 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .flask-measurements {
            position: absolute;
            right: 8px;
            top: 20%;
            height: 60%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 3;
            opacity: 0.3;
        }

        .measurement-line {
            width: 12px;
            height: 1px;
            background: rgba(255, 255, 255, 0.4);
        }

        .measurement-line.major {
            width: 18px;
            height: 1.5px;
            background: rgba(255, 255, 255, 0.6);
        }

        .liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 0%;
            background: transparent;
            transition: height 2s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible;
        }

        .liquid-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 30% 40%, 
                    var(--liquid-color-light, #60a5fa) 0%,
                    transparent 60%),
                radial-gradient(ellipse at 70% 60%, 
                    var(--liquid-color-mid, #2563eb) 0%,
                    transparent 50%),
                linear-gradient(to top, 
                    var(--liquid-color-dark, #1d4ed8) 0%,
                    var(--liquid-color-mid, #2563eb) 50%,
                    var(--liquid-color-light, #60a5fa) 100%);
            transition: background 1.2s ease;
            box-shadow: 
                inset 0 20px 30px rgba(255,255,255,0.2),
                inset 0 -10px 25px rgba(0,0,0,0.3),
                inset -15px 0 25px rgba(0,0,0,0.15),
                inset 15px 0 20px rgba(255,255,255,0.12);
            animation: liquid-shimmer 4s ease-in-out infinite;
        }

        .liquid-surface {
            position: absolute;
            top: -25px;
            left: -10%;
            width: 120%;
            height: 50px;
            background: transparent;
            z-index: 10;
        }

        .wave-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: 
                radial-gradient(ellipse 100% 50% at 25% 50%, 
                    var(--liquid-color-light, #60a5fa) 0%,
                    var(--liquid-color-mid, #2563eb) 40%,
                    transparent 70%);
            filter: url('#liquid-filter');
        }

        .wave-layer:nth-child(1) {
            animation: wave-flow-1 4s ease-in-out infinite;
            opacity: 0.9;
        }

        .wave-layer:nth-child(2) {
            animation: wave-flow-2 5s ease-in-out infinite reverse;
            opacity: 0.7;
        }

        .wave-layer:nth-child(3) {
            animation: wave-flow-3 6s ease-in-out infinite;
            opacity: 0.5;
        }

        @keyframes liquid-shimmer {
            0% {
                filter: brightness(1) saturate(1) contrast(1);
                transform: translateX(0) scale(1);
            }
            25% {
                filter: brightness(1.08) saturate(1.12) contrast(1.05);
                transform: translateX(2px) scale(1.005);
            }
            50% {
                filter: brightness(1.15) saturate(1.2) contrast(1.08);
                transform: translateX(0) scale(1.01);
            }
            75% {
                filter: brightness(1.08) saturate(1.12) contrast(1.05);
                transform: translateX(-2px) scale(1.005);
            }
            100% {
                filter: brightness(1) saturate(1) contrast(1);
                transform: translateX(0) scale(1);
            }
        }

        @keyframes wave-flow-1 {
            0% { 
                transform: translateX(0) translateY(0) rotate(0deg) scaleX(1);
            }
            20% { 
                transform: translateX(-8%) translateY(-5px) rotate(2deg) scaleX(1.05);
            }
            40% { 
                transform: translateX(-16%) translateY(2px) rotate(-1deg) scaleX(0.98);
            }
            60% { 
                transform: translateX(-24%) translateY(-4px) rotate(1deg) scaleX(1.03);
            }
            80% { 
                transform: translateX(-32%) translateY(1px) rotate(-2deg) scaleX(1.02);
            }
            100% { 
                transform: translateX(-40%) translateY(0) rotate(0deg) scaleX(1);
            }
        }

        @keyframes wave-flow-2 {
            0% { 
                transform: translateX(0) translateY(0) scaleY(1) scaleX(1);
            }
            25% { 
                transform: translateX(-10%) translateY(-6px) scaleY(1.2) scaleX(1.08);
            }
            50% { 
                transform: translateX(-20%) translateY(3px) scaleY(0.85) scaleX(0.95);
            }
            75% { 
                transform: translateX(-30%) translateY(-5px) scaleY(1.15) scaleX(1.05);
            }
            100% { 
                transform: translateX(-40%) translateY(0) scaleY(1) scaleX(1);
            }
        }

        @keyframes wave-flow-3 {
            0% { 
                transform: translateX(0) translateY(0) rotate(0deg);
            }
            33% { 
                transform: translateX(-13%) translateY(-3px) rotate(-1.5deg);
            }
            66% { 
                transform: translateX(-26%) translateY(2px) rotate(1deg);
            }
            100% { 
                transform: translateX(-40%) translateY(0) rotate(0deg);
            }
        }

        .bubble {
            position: absolute;
            bottom: 0;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, 
                rgba(255, 255, 255, 0.9), 
                rgba(255, 255, 255, 0.5) 30%,
                rgba(255, 255, 255, 0.1) 60%,
                transparent);
            box-shadow: 
                inset -1px -1px 3px rgba(0, 0, 0, 0.15),
                inset 1px 1px 2px rgba(255, 255, 255, 0.6),
                0 2px 8px rgba(255, 255, 255, 0.2);
            animation: bubble-rise linear infinite;
            opacity: 0;
            z-index: 5;
        }

        .bubble:nth-child(1) {
            left: 15%;
            width: 6px;
            height: 6px;
            animation-duration: 5s;
            animation-delay: 0s;
        }

        .bubble:nth-child(2) {
            left: 40%;
            width: 4px;
            height: 4px;
            animation-duration: 6s;
            animation-delay: 1.2s;
        }

        .bubble:nth-child(3) {
            left: 65%;
            width: 8px;
            height: 8px;
            animation-duration: 7s;
            animation-delay: 2.5s;
        }

        .bubble:nth-child(4) {
            left: 28%;
            width: 5px;
            height: 5px;
            animation-duration: 5.5s;
            animation-delay: 0.8s;
        }

        .bubble:nth-child(5) {
            left: 55%;
            width: 7px;
            height: 7px;
            animation-duration: 6.5s;
            animation-delay: 1.8s;
        }

        .flask-glare {
            position: absolute;
            top: 10%;
            left: 15%;
            width: 25%;
            height: 70%;
            background: linear-gradient(145deg, 
                rgba(255,255,255,0.5) 0%,
                rgba(255,255,255,0.25) 30%,
                rgba(255,255,255,0.08) 60%,
                transparent 100%);
            border-radius: 50% 30% 70% 40%;
            pointer-events: none;
            z-index: 4;
            filter: blur(2px);
            animation: glare-pulse 3s ease-in-out infinite;
        }

        .flask-glare::before {
            content: "";
            position: absolute;
            top: 8%;
            left: 15%;
            width: 35%;
            height: 12%;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            filter: blur(4px);
        }

        .flask-glare::after {
            content: "";
            position: absolute;
            top: 30%;
            left: 10%;
            width: 25%;
            height: 8%;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            filter: blur(3px);
        }

        @keyframes glare-pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.85;
            }
        }

        .flask-shadow {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 20px;
            background: radial-gradient(ellipse at center, 
                rgba(0, 0, 0, 0.3) 0%,
                transparent 70%);
            filter: blur(8px);
            z-index: 0;
            animation: shadow-pulse 6s ease-in-out infinite;
        }

        @keyframes flask-sway {
            0% { transform: rotate(-10deg) translateY(0) translateX(0) scale(1); }
            12.5% { transform: rotate(-7deg) translateY(-6px) translateX(3px) scale(1.008); }
            25% { transform: rotate(-2deg) translateY(-10px) translateX(5px) scale(1.015); }
            37.5% { transform: rotate(4deg) translateY(-12px) translateX(4px) scale(1.02); }
            50% { transform: rotate(10deg) translateY(-14px) translateX(0) scale(1.025); }
            62.5% { transform: rotate(7deg) translateY(-12px) translateX(-4px) scale(1.02); }
            75% { transform: rotate(2deg) translateY(-8px) translateX(-5px) scale(1.015); }
            87.5% { transform: rotate(-4deg) translateY(-4px) translateX(-3px) scale(1.008); }
            100% { transform: rotate(-10deg) translateY(0) translateX(0) scale(1); }
        }

        @keyframes wave-motion-primary {
            0%, 100% { 
                transform: translateX(0) translateY(0) scaleY(1);
            }
            25% { 
                transform: translateX(-12%) translateY(-2px) scaleY(1.1);
            }
            50% { 
                transform: translateX(-25%) translateY(0) scaleY(1);
            }
            75% { 
                transform: translateX(-37%) translateY(-2px) scaleY(1.1);
            }
        }

        @keyframes wave-motion-secondary {
            0%, 100% { 
                transform: translateX(0) translateY(0) rotate(0deg);
            }
            33% { 
                transform: translateX(-15%) translateY(-3px) rotate(1deg);
            }
            66% { 
                transform: translateX(-30%) translateY(0) rotate(-1deg);
            }
        }

        @keyframes bubble-rise {
            0% {
                bottom: 0%;
                opacity: 0;
                transform: translateX(0) translateY(0) scale(0.5);
            }
            5% {
                opacity: 0.8;
                transform: translateX(2px) translateY(0) scale(1);
            }
            25% {
                transform: translateX(8px) translateY(0) scale(1.05);
            }
            50% {
                transform: translateX(-5px) translateY(0) scale(1.1);
            }
            75% {
                transform: translateX(6px) translateY(0) scale(0.95);
                opacity: 0.9;
            }
            95% {
                opacity: 0.3;
            }
            100% {
                bottom: 105%;
                opacity: 0;
                transform: translateX(-3px) translateY(0) scale(0.7);
            }
        }

        @keyframes shadow-pulse {
            0%, 100% { 
                transform: translateX(-50%) scale(1);
                opacity: 0.3;
            }
            50% { 
                transform: translateX(-50%) scale(1.1);
                opacity: 0.5;
            }
        }

        .day-card { transition: all 0.3s ease; cursor: pointer; }
        .day-card.open .day-items-container { max-height: 1000px; opacity: 1; margin-top: 12px; }
        .day-card.open .chevron-icon { transform: rotate(180deg); color: var(--accent); }
        .day-items-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            opacity: 0;
        }
        .theme-dot {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.05);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .theme-dot.active { border-color: white; transform: scale(1.1) rotate(45deg); box-shadow: 0 0 15px currentColor; }
        
        #currencyPicker button {
            position: relative;
            overflow: hidden;
        }
        
        #currencyPicker button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        #currencyPicker button:hover::before {
            left: 100%;
        }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; max-height: 300px; overflow-y: auto; padding: 10px; }
        .emoji-item { font-size: 1.5rem; padding: 12px; border-radius: 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; cursor: pointer; text-align: center; }
        .emoji-item.selected { background: rgba(var(--accent-rgb), 0.2); border-color: var(--accent); transform: scale(1.1); }
        .chart-selector { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 8px 16px; border-radius: 20px; outline: none; font-weight: 800; font-size: 12px; appearance: none; text-align: center; }
        .history-item-row:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.1); }
        .stats-item-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .stats-item-card:active { transform: scale(0.96); background: rgba(255, 255, 255, 0.1); }
        
        /* è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨æ ·å¼ - ç¬¦åˆä¸»é¢˜çš„æ¯›ç»ç’ƒé£æ ¼ */
        input[type="date"], input[type="month"] {
            position: relative;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            padding: 12px 18px;
            border-radius: 16px;
            outline: none;
            font-weight: 800;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        input[type="date"]:hover, input[type="month"]:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        input[type="date"]:focus, input[type="month"]:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(var(--accent-rgb), 0.2), 0 8px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        
        input[type="date"]:active, input[type="month"]:active {
            transform: translateY(0px);
        }
        
        /* è‡ªå®šä¹‰æ—¥æœŸé€‰æ‹©å™¨å›¾æ ‡ - æ›´æ˜æ˜¾çš„æ ·å¼ */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.2);
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
            width: 18px;
            height: 18px;
            padding: 2px;
            border-radius: 4px;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator:hover,
        input[type="month"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        
        /* æ—¥æœŸå­—æ®µæ ·å¼ - æ›´å¥½çš„å¯è¯»æ€§ */
        input[type="date"]::-webkit-datetime-edit,
        input[type="month"]::-webkit-datetime-edit {
            color: white;
            font-weight: 800;
        }
        
        input[type="date"]::-webkit-datetime-edit-fields-wrapper,
        input[type="month"]::-webkit-datetime-edit-fields-wrapper {
            padding: 0;
        }
        
        input[type="date"]::-webkit-datetime-edit-text,
        input[type="month"]::-webkit-datetime-edit-text {
            color: rgba(255, 255, 255, 0.5);
            padding: 0 3px;
            font-weight: 600;
        }
        
        input[type="date"]::-webkit-datetime-edit-month-field,
        input[type="date"]::-webkit-datetime-edit-day-field,
        input[type="date"]::-webkit-datetime-edit-year-field,
        input[type="month"]::-webkit-datetime-edit-month-field,
        input[type="month"]::-webkit-datetime-edit-year-field {
            color: white;
            padding: 3px 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        input[type="date"]::-webkit-datetime-edit-month-field:hover,
        input[type="date"]::-webkit-datetime-edit-day-field:hover,
        input[type="date"]::-webkit-datetime-edit-year-field:hover,
        input[type="month"]::-webkit-datetime-edit-month-field:hover,
        input[type="month"]::-webkit-datetime-edit-year-field:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        input[type="date"]::-webkit-datetime-edit-month-field:focus,
        input[type="date"]::-webkit-datetime-edit-day-field:focus,
        input[type="date"]::-webkit-datetime-edit-year-field:focus,
        input[type="month"]::-webkit-datetime-edit-month-field:focus,
        input[type="month"]::-webkit-datetime-edit-year-field:focus {
            background: rgba(var(--accent-rgb), 0.4);
            border-radius: 6px;
            color: white;
            outline: none;
            font-weight: 900;
        }
    </style>
</head>
<body>
    <svg style="position: fixed; width: 0; height: 0;">
        <filter id="liquid-filter">
            <feTurbulence type="fractalNoise" baseFrequency="0.015 0.03" numOctaves="3" result="noise" />
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="10" />
        </filter>
    </svg>

    <div id="app" class="max-w-md mx-auto h-screen flex flex-col relative overflow-hidden">
        
        <header id="header-ui" class="pt-12 px-8 pb-4 flex justify-between items-start z-20">
            <div class="flex flex-col">
                <h1 class="brand-title text-3xl font-[900]">LEDGER<span class="text-[14px] font-normal align-top ml-0.5">â„¢</span></h1>
                <div class="by-owen font-bold mt-1 text-[10px] tracking-wider">DESIGNED BY OWEN  |  V2.0</div>
            </div>
            <button onclick="nav('settings')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center mt-1 border border-white/10 hover:border-white/30 transition-colors">
                <i data-lucide="user" class="w-5 h-5"></i>
            </button>
        </header>

        <main id="mainContainer" class="flex-1 overflow-y-auto px-6 no-scrollbar pb-32">
            
            <!-- Login Page -->
            <section id="page-auth" class="page-transition hidden-page min-h-screen flex items-center justify-center px-6 -mx-6 -mt-4">
                <div class="w-full max-w-md space-y-8">
                    <!-- Logo & Title -->
                    <div class="text-center space-y-3">
                        <div class="flex justify-center mb-6">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-white/20 to-white/5 backdrop-blur-xl border border-white/20 flex items-center justify-center">
                                <i data-lucide="sparkles" class="w-10 h-10 text-white"></i>
                            </div>
                        </div>
                        <h1 class="text-4xl font-black text-white">LEDGER<span class="text-sm font-normal align-top ml-1">â„¢</span></h1>
                        <p class="text-sm text-white/40 font-bold uppercase tracking-wider">Personal Finance Tracker</p>
                    </div>

                    <!-- Auth Tabs -->
                    <div class="glass-panel p-2 rounded-[32px] flex gap-2">
                        <button id="tabMagicLink" onclick="switchAuthTab('magiclink')" class="auth-tab-active flex-1 py-3 rounded-[24px] text-sm font-black transition-all">
                            âœ¨ Magic Link
                        </button>
                        <button id="tabCode" onclick="switchAuthTab('code')" class="auth-tab-inactive flex-1 py-3 rounded-[24px] text-sm font-black transition-all">
                            ğŸ”‘ ç™»å…¥ä»£ç¢¼
                        </button>
                    </div>

                    <!-- Magic Link Form -->
                    <div id="formMagicLink" class="space-y-6">
                        <div class="glass-panel p-8 rounded-[32px] space-y-6">
                            <div class="text-center space-y-2 mb-4">
                                <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center">
                                    <span class="text-3xl">âœ¨</span>
                                </div>
                                <h3 class="text-sm font-black text-white">è¨»å†Š / ç™»å…¥</h3>
                                <p class="text-[10px] text-white/40">è¼¸å…¥ Email å³å¯é–‹å§‹ä½¿ç”¨</p>
                            </div>
                            <div>
                                <label class="block text-[10px] font-black text-white/40 uppercase tracking-widest mb-3">Email</label>
                                <input type="email" id="emailMagicLink" placeholder="your@email.com" 
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white placeholder-white/30 outline-none focus:border-white/30 transition-colors font-bold">
                            </div>
                            <button onclick="handleMagicLink()" 
                                class="w-full bg-gradient-to-r from-white/20 to-white/10 backdrop-blur-xl border border-white/20 text-white py-4 rounded-2xl font-black uppercase tracking-wider active:scale-95 transition-all hover:border-white/40">
                                <span id="btnMagicLinkText">âœ¨ ç™¼é€ Magic Link</span>
                            </button>
                        </div>
                        <p class="text-center text-[10px] text-white/30 leading-relaxed px-6">
                            æˆ‘å€‘æœƒå°‡ç™»å…¥é€£çµå¯„åˆ°æ‚¨çš„ä¿¡ç®±<br>
                            é»æ“Šé€£çµå³å¯å®Œæˆè¨»å†Šæˆ–ç™»å…¥ï¼Œç„¡éœ€å¯†ç¢¼<br>
                            <span class="text-white/20 text-[9px]">é©ç”¨æ–¼åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨</span>
                        </p>
                    </div>

                    <!-- Login Code Form -->
                    <div id="formCode" class="space-y-6 hidden">
                        <div class="glass-panel p-8 rounded-[32px] space-y-6">
                            <div class="text-center space-y-2 mb-4">
                                <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-500/20 flex items-center justify-center">
                                    <span class="text-3xl">ğŸ”‘</span>
                                </div>
                                <h3 class="text-sm font-black text-white">è·¨è£ç½®ç™»å…¥</h3>
                                <p class="text-[10px] text-white/40">è«‹è¼¸å…¥å¾å…¶ä»–è£ç½®ç²å¾—çš„ 6 ä½æ•¸ç™»å…¥ä»£ç¢¼</p>
                            </div>
                            <div>
                                <input type="text" id="loginCode" placeholder="è¼¸å…¥ 6 ä½æ•¸ä»£ç¢¼" maxlength="6"
                                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-white placeholder-white/30 outline-none focus:border-white/30 transition-colors font-bold text-center text-2xl tracking-[0.5em]"
                                    oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                            </div>
                            <button onclick="verifyLoginCode()" 
                                class="w-full bg-gradient-to-r from-white/20 to-white/10 backdrop-blur-xl border border-white/20 text-white py-4 rounded-2xl font-black uppercase tracking-wider active:scale-95 transition-all hover:border-white/40">
                                <span id="btnVerifyCode">âœ… é©—è­‰ä»£ç¢¼</span>
                            </button>
                        </div>
                        <div class="bg-white/5 rounded-2xl p-4 mx-4">
                            <p class="text-[10px] font-black text-white/40 uppercase mb-2">ğŸ’¡ å¦‚ä½•å–å¾—ä»£ç¢¼ï¼Ÿ</p>
                            <ol class="text-[10px] text-white/60 space-y-1 ml-4 list-decimal">
                                <li>åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨ Magic Link ç™»å…¥</li>
                                <li>å‰å¾€ã€Œè¨­å®šã€é é¢</li>
                                <li>é»æ“Šã€Œé¡¯ç¤ºæˆ‘çš„ç™»å…¥ä»£ç¢¼ã€</li>
                                <li>è¤‡è£½ä»£ç¢¼ä¸¦åœ¨æ­¤è™•è¼¸å…¥</li>
                            </ol>
                        </div>
                        <p class="text-center text-[10px] text-white/30 leading-relaxed px-6">
                            ä»£ç¢¼æœ‰æ•ˆæœŸç‚º 10 åˆ†é˜<br>
                            <span class="text-white/20 text-[9px]">é©ç”¨æ–¼ iOS ä¸»ç•«é¢ App æˆ–å…¶ä»–è£ç½®</span>
                        </p>
                    </div>

                    <!-- Status Messages -->
                    <div id="authMessage" class="hidden glass-panel p-6 rounded-[24px] text-center">
                        <p id="authMessageText" class="text-sm font-bold text-white"></p>
                    </div>

                    <!-- iOS Standalone Mode Warning -->
                    <div id="iosStandaloneWarning" class="hidden bg-yellow-500/10 border border-yellow-500/30 rounded-[24px] p-6 space-y-3">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">âš ï¸</span>
                            <h3 class="text-sm font-black text-yellow-400">iOS ä¸»ç•«é¢ App ä½¿ç”¨æç¤º</h3>
                        </div>
                        <p class="text-[11px] text-yellow-400/80 leading-relaxed">
                            å¦‚æœæ‚¨æ˜¯å¾ iOS ä¸»ç•«é¢é–‹å•Ÿæ­¤ Appï¼ŒMagic Link ç™»å…¥å¯èƒ½æœƒåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿè€Œç„¡æ³•å›åˆ°æ­¤è™•ã€‚
                        </p>
                        <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                            <p class="text-[10px] font-black text-white uppercase">å»ºè­°ä½œæ³•ï¼š</p>
                            <ol class="text-[10px] text-white/70 space-y-1 text-left ml-4 list-decimal">
                                <li>åœ¨ Safari ä¸­é–‹å•Ÿæ­¤ç¶²ç«™ä¸¦å®Œæˆç™»å…¥</li>
                                <li>ç™»å…¥å¾Œå†å›åˆ°ä¸»ç•«é¢ App ä½¿ç”¨</li>
                                <li>æˆ–é¸æ“‡ã€Œåƒ…ä½¿ç”¨æœ¬åœ°æ¨¡å¼ã€è·³éç™»å…¥</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Skip Login (Local Mode) -->
                    <div class="text-center">
                        <button onclick="skipLogin()" class="text-[10px] text-white/20 hover:text-white/40 font-bold uppercase tracking-widest transition-colors">
                            è·³éï¼Œåƒ…ä½¿ç”¨æœ¬åœ°æ¨¡å¼
                        </button>
                    </div>
                </div>
            </section>

            <section id="page-home" class="page-transition space-y-8 mt-4">
                <div class="glass-panel p-8 rounded-[40px] flex flex-col items-center relative overflow-hidden">
                    <div class="w-full flex justify-between items-start mb-4">
                        <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Budget Remaining</p>
                        <p id="hudDate" class="text-[9px] font-bold text-white/30 uppercase"></p>
                    </div>

                    <div class="flask-container mb-6">
                        <div class="flask-shadow"></div>
                        <div class="flask-neck"></div>
                        <div class="flask">
                            <div class="flask-measurements">
                                <div class="measurement-line major"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line major"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line major"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line"></div>
                                <div class="measurement-line major"></div>
                            </div>
                            <div class="flask-glare"></div>
                            <div id="liquidLevel" class="liquid" style="height: 0%;">
                                <div class="liquid-fill">
                                    <div class="bubble"></div>
                                    <div class="bubble"></div>
                                    <div class="bubble"></div>
                                    <div class="bubble"></div>
                                    <div class="bubble"></div>
                                </div>
                                <div class="liquid-surface">
                                    <div class="wave-layer"></div>
                                    <div class="wave-layer"></div>
                                    <div class="wave-layer"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <div class="flex items-baseline justify-center gap-1 mb-1">
                            <span class="text-4xl font-black text-white" id="displayRemaining"></span>
                        </div>
                        <div class="flex justify-center gap-6 mb-2">
                            <div class="text-center">
                                <div class="text-[9px] font-bold text-white/30 uppercase tracking-wider mb-1">Spent</div>
                                <div class="text-sm font-black text-white/60" id="displaySpent"></div>
                            </div>
                            <div class="w-px bg-white/10"></div>
                            <div class="text-center">
                                <div class="text-[9px] font-bold text-white/30 uppercase tracking-wider mb-1">Budget</div>
                                <div class="text-sm font-black text-white/60" id="displayBudgetLimit"></div>
                            </div>
                        </div>
                        <p id="budgetMessage" class="text-[10px] font-bold uppercase tracking-widest transition-colors duration-300"></p>
                    </div>
                </div>

                <div>
                    <h3 class="text-[10px] font-black uppercase text-white/30 tracking-widest mb-4 ml-2">Recent Activities</h3>
                    <div id="recentList" class="space-y-3"></div>
                </div>
            </section>

            <section id="page-history" class="page-transition hidden-page space-y-4">
                <div class="flex items-center gap-3 bg-white/5 border border-white/10 rounded-2xl p-4 mb-6">
                    <i data-lucide="calendar" class="w-5 h-5 text-white/40"></i>
                    <input type="month" id="histMonth" onchange="renderHistory()" class="bg-transparent flex-1 text-white outline-none font-bold">
                </div>
                <div id="historyAccordion" class="space-y-3"></div>
            </section>

            <section id="page-stats" class="page-transition hidden-page space-y-6">
                <div class="flex justify-between items-center px-2">
                    <h3 class="text-[10px] font-black uppercase text-white/40 tracking-widest">Monthly Analysis</h3>
                    <input type="month" id="statsMonth" onchange="renderStats()" class="chart-selector">
                </div>
                <div class="glass-panel p-6 rounded-[40px] flex flex-col items-center">
                    <div id="chartContainer" class="relative w-full aspect-square max-w-[280px]">
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div id="noDataStats" class="hidden py-20 text-center opacity-30">
                        <i data-lucide="bar-chart-2" class="w-12 h-12 mx-auto mb-4"></i>
                        <p class="text-[10px] font-black uppercase tracking-widest">No Data This Month</p>
                    </div>
                </div>
                <div id="statsLegend" class="grid grid-cols-1 gap-3"></div>
            </section>

            <section id="page-settings" class="page-transition hidden-page space-y-6">
                <div class="glass-panel p-6 rounded-3xl space-y-6">
                    <div>
                        <h3 class="text-xs font-black uppercase text-white/40 tracking-widest mb-4">Theme Essence</h3>
                        <div id="themePicker" class="grid grid-cols-4 gap-4"></div>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-3xl space-y-4">
                    <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Currency Setting</h3>
                    <div class="space-y-2">
                        <p class="text-[10px] text-white/40 font-bold ml-1">é¸æ“‡é¡¯ç¤ºçš„å¹£å€¼ï¼š</p>
                        <div id="currencyPicker" class="grid grid-cols-3 gap-3"></div>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-3xl space-y-4">
                    <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Budget Setting</h3>
                    <div class="space-y-1">
                        <p class="text-[10px] text-white/40 font-bold ml-1">åœ¨æ­¤è¨­å®šæ‚¨çš„æ¯æœˆæ¶ˆè²»é ç®—ä¸Šé™ï¼š</p>
                        <input type="number" id="budgetInput" placeholder="è¼¸å…¥æ¯æœˆé ç®—é‡‘é¡" class="w-full bg-white/5 p-4 rounded-2xl outline-none text-white font-bold border border-white/5 focus:border-white/20">
                    </div>
                    <button onclick="saveSettings()" class="w-full py-4 dynamic-accent-bg text-black rounded-2xl font-black shadow-lg">å„²å­˜é ç®—è®Šæ›´</button>
                </div>

                <!-- å¸³æˆ¶èˆ‡é›²ç«¯åŒæ­¥ç‹€æ…‹ -->
                <div class="glass-panel p-6 rounded-3xl space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Account & Sync</h3>
                        <div id="syncStatusBadge" class="text-[8px] px-2 py-1 rounded-full font-black">
                            <!-- å‹•æ…‹æ›´æ–° -->
                        </div>
                    </div>
                    
                    <!-- ç™»å…¥ç‹€æ…‹é¡¯ç¤º -->
                    <div id="authStatusPanel" class="space-y-3">
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="text-white/40 font-bold">ç™»å…¥ç‹€æ…‹ï¼š</span>
                            <span id="authStatusText" class="text-white font-black">æœ¬åœ°æ¨¡å¼</span>
                        </div>
                        <div id="userEmailDisplay" class="hidden flex items-center justify-between text-[10px] bg-white/5 rounded-xl p-3">
                            <span class="text-white/40 font-bold">å¸³æˆ¶ï¼š</span>
                            <span id="userEmail" class="text-white/80 font-bold truncate ml-2"></span>
                        </div>
                        <div class="flex gap-2">
                            <button id="authActionBtn" onclick="showAuthPage()" class="flex-1 py-3 bg-gradient-to-r from-white/20 to-white/10 border border-white/20 text-white rounded-2xl font-black text-xs transition-all hover:border-white/40">
                                ğŸ” ç™»å…¥é›²ç«¯å¸³æˆ¶
                            </button>
                            <button onclick="showCloudInfoModal()" class="w-12 h-12 bg-white/10 border border-white/20 text-white rounded-2xl font-black text-xs transition-all hover:border-white/40 flex items-center justify-center">
                                <i data-lucide="info" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- åŒæ­¥è³‡è¨Šï¼ˆåƒ…åœ¨ç™»å…¥å¾Œé¡¯ç¤ºï¼‰ -->
                    <div id="syncInfoPanel" class="hidden space-y-3 pt-3 border-t border-white/5">
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="text-white/40 font-bold">æœ¬åœ°è³‡æ–™ï¼š</span>
                            <span id="localDataCount" class="text-white font-black">0 ç­†äº¤æ˜“</span>
                        </div>
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="text-white/40 font-bold">æœ€å¾ŒåŒæ­¥ï¼š</span>
                            <span id="lastSyncDisplay" class="text-white font-black">å¾æœªåŒæ­¥</span>
                        </div>
                        <div id="syncErrorMessage" class="hidden text-[9px] text-red-400 bg-red-500/10 p-2 rounded-lg">
                            <!-- éŒ¯èª¤è³‡è¨Š -->
                        </div>
                        
                        <!-- ç™»å…¥ä»£ç¢¼é¡¯ç¤ºæŒ‰éˆ• -->
                        <button onclick="showLoginCodeModal()" class="w-full py-3 bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border border-blue-500/30 text-blue-300 rounded-2xl font-black text-xs transition-all hover:border-blue-400/50">
                            ğŸ”‘ é¡¯ç¤ºæˆ‘çš„ç™»å…¥ä»£ç¢¼
                        </button>
                        
                        <button id="manualSyncBtn" onclick="manualSync()" class="w-full py-3 bg-white/10 hover:bg-white/15 text-white rounded-2xl font-black text-xs transition-all">
                            <span id="syncBtnText">ğŸ”„ ç«‹å³åŒæ­¥åˆ°é›²ç«¯</span>
                        </button>
                        <p class="text-[9px] text-white/30 text-center">
                            ğŸ’¡ æç¤ºï¼šè«‹é»æ“Šã€Œç«‹å³åŒæ­¥åˆ°é›²ç«¯ã€æŒ‰éˆ•ä¾†åŒæ­¥è³‡æ–™ã€‚é›²ç«¯åƒ…ä¿ç•™æœ€è¿‘ 365 å¤©çš„è³‡æ–™ï¼Œæœ¬åœ°è³‡æ–™æ°¸ä¹…ä¿ç•™ã€‚
                        </p>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-3xl space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-black uppercase text-white/40 tracking-widest">Categories</h3>
                        <button onclick="openCatModal()" class="text-[10px] bg-white/10 px-3 py-1 rounded-full">+ æ–°å¢</button>
                    </div>
                    <div id="settingsCatList" class="grid grid-cols-2 gap-2"></div>
                </div>
            </section>

            <section id="page-add" class="page-transition hidden-page space-y-8">
                <div class="text-center pt-6">
                    <div class="flex items-center justify-center">
                         <span id="currencySymbolAdd" class="text-xl font-black text-white/20 mr-2">NT$</span>
                         <input type="number" id="formAmount" placeholder="0" class="w-full max-w-[200px] bg-transparent text-6xl font-black text-center text-white outline-none">
                    </div>
                </div>
                <div>
                    <p class="text-[9px] font-black text-white/20 uppercase tracking-widest mb-3 text-center">äº¤æ˜“å¹£ç¨®</p>
                    <div id="formCurrencyGrid" class="grid grid-cols-3 gap-3 mb-4"></div>
                </div>
                <div id="formCatGrid" class="grid grid-cols-4 gap-3"></div>
                <div class="glass-panel p-6 rounded-[32px] space-y-4">
                    <div class="flex gap-4 items-center">
                        <div class="flex-1 min-w-[180px]">
                            <input type="date" id="formDate" class="w-full text-white font-bold outline-none">
                        </div>
                        <input type="text" id="formNote" placeholder="è¼¸å…¥å‚™è¨»..." class="bg-transparent flex-[2] text-white font-bold outline-none text-right">
                    </div>
                </div>
                <div class="flex gap-4">
                    <button onclick="nav(lastPage)" class="flex-1 py-5 glass-panel rounded-3xl font-bold text-white/50">å–æ¶ˆ</button>
                    <button id="saveBtn" onclick="saveTransaction()" class="flex-[2] py-5 dynamic-accent-bg text-black rounded-3xl font-black">å®Œæˆ</button>
                </div>
                <button id="deleteBtn" onclick="deleteCurrentTx()" class="w-full py-4 text-red-500 font-bold hidden">åˆªé™¤æ­¤ç­†äº¤æ˜“</button>
            </section>

        </main>

        <div id="catModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-sm rounded-[40px] p-8 space-y-6">
                <h2 class="text-xl font-black">æ–°å¢åˆ†é¡</h2>
                <input type="text" id="newCatName" placeholder="åˆ†é¡åç¨±" class="w-full bg-white/5 p-4 rounded-2xl outline-none font-bold border border-white/5">
                <div>
                    <p class="text-[10px] font-bold text-white/40 uppercase mb-3">æŒ‘é¸åœ–ç¤º (130+ é¸é …)</p>
                    <div id="emojiPicker" class="emoji-grid no-scrollbar"></div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeCatModal()" class="flex-1 py-4 glass-panel rounded-2xl font-bold">å–æ¶ˆ</button>
                    <button id="confirmCatBtn" class="flex-1 py-4 dynamic-accent-bg text-black rounded-2xl font-black opacity-30 pointer-events-none">è«‹é¸æ“‡åœ–ç¤º</button>
                </div>
            </div>
        </div>

        <!-- é›²ç«¯èªªæ˜ Modal -->
        <div id="cloudInfoModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-md rounded-[40px] p-8 space-y-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-500/20 flex items-center justify-center">
                        <i data-lucide="cloud" class="w-6 h-6 text-blue-400"></i>
                    </div>
                    <h2 class="text-xl font-black">é›²ç«¯åŒæ­¥èªªæ˜</h2>
                </div>
                
                <div class="space-y-4 text-sm text-white/80">
                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">ğŸ’¾</span>
                            <div>
                                <h3 class="font-black text-white mb-1">æœ¬åœ°å„ªå…ˆå„²å­˜</h3>
                                <p class="text-xs text-white/60">æ‰€æœ‰è³‡æ–™å„ªå…ˆå„²å­˜åœ¨æ‚¨çš„è£ç½®ä¸Šï¼Œå³ä½¿é›¢ç·šä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">â˜ï¸</span>
                            <div>
                                <h3 class="font-black text-white mb-1">é›²ç«¯å‚™ä»½</h3>
                                <p class="text-xs text-white/60">ç™»å…¥å¸³æˆ¶å¾Œï¼Œé»æ“Šã€Œç«‹å³åŒæ­¥åˆ°é›²ç«¯ã€æŒ‰éˆ•å³å¯åŒæ­¥è³‡æ–™ï¼Œæ–¹ä¾¿è·¨è£ç½®ä½¿ç”¨ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-2xl p-4 space-y-2">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">â°</span>
                            <div>
                                <h3 class="font-black text-yellow-400 mb-1">è³‡æ–™ä¿ç•™æœŸé™</h3>
                                <p class="text-xs text-yellow-400/80">é›²ç«¯åƒ…ä¿ç•™æœ€è¿‘ <span class="font-black">365 å¤©</span>çš„äº¤æ˜“è¨˜éŒ„ï¼Œè¶…éä¸€å¹´çš„è³‡æ–™æœƒè‡ªå‹•æ¸…ç†ã€‚</p>
                                <p class="text-xs text-yellow-400/60 mt-2">ğŸ’¡ æ³¨æ„ï¼šæœ¬åœ°è³‡æ–™ä¸å—å½±éŸ¿ï¼Œæ°¸ä¹…ä¿ç•™åœ¨æ‚¨çš„è£ç½®ä¸Šã€‚</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/5 rounded-2xl p-4 space-y-2">
                        <div class="flex items-start gap-3">
                            <span class="text-lg">ğŸ”„</span>
                            <div>
                                <h3 class="font-black text-white mb-1">æ‰‹å‹•åŒæ­¥</h3>
                                <p class="text-xs text-white/60">é»æ“Šã€Œç«‹å³åŒæ­¥åˆ°é›²ç«¯ã€æŒ‰éˆ•ä¾†åŒæ­¥è³‡æ–™ã€‚åŒæ­¥æœƒä¸Šå‚³æœ¬åœ°è³‡æ–™ä¸¦ä¸‹è¼‰é›²ç«¯æœ€æ–°è³‡æ–™ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="closeCloudInfoModal()" class="w-full py-4 dynamic-accent-bg text-black rounded-2xl font-black">
                    æˆ‘çŸ¥é“äº†
                </button>
            </div>
        </div>

        <!-- ç™»å…¥ä»£ç¢¼ Modal -->
        <div id="loginCodeModal" class="fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-6 hidden">
            <div class="glass-panel w-full max-w-md rounded-[40px] p-8 space-y-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500/20 to-cyan-500/20 flex items-center justify-center">
                        <span class="text-2xl">ğŸ”‘</span>
                    </div>
                    <h2 class="text-xl font-black">æ‚¨çš„ç™»å…¥ä»£ç¢¼</h2>
                </div>
                
                <div class="bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border-2 border-blue-400/30 rounded-3xl p-8 text-center space-y-4">
                    <p class="text-[10px] text-white/40 uppercase tracking-widest font-black">6 ä½æ•¸ç™»å…¥ä»£ç¢¼</p>
                    <div id="displayLoginCode" class="text-5xl font-black text-white tracking-[0.3em] select-all" style="font-family: 'Courier New', monospace;">
                        ------
                    </div>
                    <p class="text-[10px] text-white/40">é»æ“Šä»£ç¢¼å³å¯è¤‡è£½</p>
                </div>

                <div class="bg-white/5 rounded-2xl p-4 space-y-3">
                    <p class="text-[10px] font-black text-white uppercase">ä½¿ç”¨æ–¹å¼ï¼š</p>
                    <ol class="text-[11px] text-white/70 space-y-2 ml-4 list-decimal">
                        <li>é»æ“Šä¸Šæ–¹ä»£ç¢¼é€²è¡Œè¤‡è£½</li>
                        <li>åœ¨å…¶ä»–è£ç½®é–‹å•Ÿæ­¤ App</li>
                        <li>é¸æ“‡ã€ŒğŸ”‘ ç™»å…¥ä»£ç¢¼ã€åˆ†é </li>
                        <li>è²¼ä¸Šä»£ç¢¼å³å¯å®Œæˆç™»å…¥</li>
                    </ol>
                </div>

                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-2xl p-4">
                    <p class="text-[10px] text-yellow-400 flex items-start gap-2">
                        <span>â°</span>
                        <span>æ­¤ä»£ç¢¼æœ‰æ•ˆæœŸç‚º <span class="font-black">10 åˆ†é˜</span>ï¼ŒéæœŸå¾Œéœ€é‡æ–°ç”¢ç”Ÿã€‚</span>
                    </p>
                </div>

                <button onclick="closeLoginCodeModal()" class="w-full py-4 dynamic-accent-bg text-black rounded-2xl font-black">
                    é—œé–‰
                </button>
            </div>
        </div>

        <div id="nav-container" class="nav-dock-container">
            <nav class="nav-dock">
                <button onclick="nav('home')" id="nav-home" class="nav-btn active"><i data-lucide="home"></i></button>
                <button onclick="nav('history')" id="nav-history" class="nav-btn"><i data-lucide="calendar"></i></button>
                <button onclick="prepareAdd()" class="center-add-btn"><i data-lucide="plus" class="text-black"></i></button>
                <button onclick="nav('stats')" id="nav-stats" class="nav-btn"><i data-lucide="pie-chart"></i></button>
                <button onclick="nav('settings')" id="nav-settings" class="nav-btn"><i data-lucide="settings"></i></button>
            </nav>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        const THEME_SCHEMES = [
            { id: 'minimal', color: '#ffffff', rgb: '255, 255, 255', opacity: 0.7, bg: '#0a0a0c' },
            { id: 'cyber', color: '#6366f1', rgb: '99, 102, 241', opacity: 0.5, bg: '#05051e' },
            { id: 'neon', color: '#10b981', rgb: '16, 185, 129', opacity: 0.5, bg: '#020d08' },
            { id: 'gold', color: '#f59e0b', rgb: '245, 158, 11', opacity: 0.6, bg: '#0d0b02' },
            { id: 'crimson', color: '#ef4444', rgb: '239, 68, 68', opacity: 0.5, bg: '#0d0202' },
            { id: 'candy', color: '#ec4899', rgb: '236, 72, 153', opacity: 0.5, bg: '#0d0208' },
            { id: 'royal', color: '#8b5cf6', rgb: '139, 92, 246', opacity: 0.5, bg: '#08020d' },
            { id: 'cyan', color: '#06b6d4', rgb: '6, 182, 212', opacity: 0.5, bg: '#020c0d' }
        ];

        const CURRENCY_OPTIONS = [
            { id: 'TWD', symbol: 'NT$', name: 'å°å¹£ TWD', flag: 'ğŸ‡¹ğŸ‡¼', rateToUSD: 0.032 },
            { id: 'USD', symbol: '$', name: 'ç¾é‡‘ USD', flag: 'ğŸ‡ºğŸ‡¸', rateToUSD: 1 },
            { id: 'SGD', symbol: 'S$', name: 'æ–°å¹£ SGD', flag: 'ğŸ‡¸ğŸ‡¬', rateToUSD: 0.74 }
        ];

        // æ±‡ç‡æ¢ç®—å‡½æ•°ï¼šå°†é‡‘é¢ä»ä¸€ç§è´§å¸è½¬æ¢ä¸ºå¦ä¸€ç§è´§å¸
        function convertCurrency(amount, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) return amount;
            
            const fromRate = CURRENCY_OPTIONS.find(c => c.id === fromCurrency)?.rateToUSD || 1;
            const toRate = CURRENCY_OPTIONS.find(c => c.id === toCurrency)?.rateToUSD || 1;
            
            // å…ˆè½¬æ¢ä¸ºç¾å…ƒï¼Œå†è½¬æ¢ä¸ºç›®æ ‡è´§å¸
            const amountInUSD = amount * fromRate;
            return amountInUSD / toRate;
        }

        // ç²¾é¸ 130+ å€‹å¯¦ç”¨è¨˜å¸³ Emoji - æ¶µè“‹æ‰€æœ‰ç”Ÿæ´»å ´æ™¯
        // ============================================
        // Supabase é…ç½®
        // ============================================
        const SUPABASE_CONFIG = {
            url: 'https://ndtkurowumazsgdotlxb.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kdGt1cm93dW1henNnZG90bHhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzUwMzUsImV4cCI6MjA4MzgxMTAzNX0.tukEU-T8f8Sne7KRFOPBYgtlhalHWaPMJlZ_Qpa6J6E'
        };

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        let supabaseClient = null;
        let currentUser = null;
        
        if (SUPABASE_CONFIG.url !== 'YOUR_SUPABASE_URL' && SUPABASE_CONFIG.anonKey !== 'YOUR_SUPABASE_ANON_KEY') {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                console.log('âœ… Supabase initialized');
            } catch (error) {
                console.warn('âš ï¸ Supabase initialization failed:', error);
            }
        } else {
            console.warn('âš ï¸ Supabase not configured. Running in local-only mode.');
        }

        // ============================================
        // IndexedDB ç®¡ç†å™¨ï¼ˆæœ¬åœ°ä¼˜å…ˆå­˜å‚¨ï¼‰
        // ============================================
        class LocalDatabase {
            constructor() {
                this.dbName = 'LedgerDB';
                this.version = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('âœ… IndexedDB initialized');
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // åˆ›å»º transactions å­˜å‚¨
                        if (!db.objectStoreNames.contains('transactions')) {
                            const txStore = db.createObjectStore('transactions', { keyPath: 'id' });
                            txStore.createIndex('date', 'date', { unique: false });
                            txStore.createIndex('category', 'category', { unique: false });
                            txStore.createIndex('updated_at', 'updated_at', { unique: false });
                        }

                        // åˆ›å»º categories å­˜å‚¨
                        if (!db.objectStoreNames.contains('categories')) {
                            const catStore = db.createObjectStore('categories', { keyPath: 'name' });
                            catStore.createIndex('name', 'name', { unique: true });
                        }

                        // åˆ›å»º settings å­˜å‚¨
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }

                        // åˆ›å»º sync_metadata å­˜å‚¨
                        if (!db.objectStoreNames.contains('sync_metadata')) {
                            db.createObjectStore('sync_metadata', { keyPath: 'key' });
                        }
                    };
                });
            }

            async get(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAll(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async put(storeName, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async delete(storeName, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async clear(storeName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }

            async bulkPut(storeName, dataArray) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    let completed = 0;

                    dataArray.forEach(data => {
                        const request = store.put(data);
                        request.onsuccess = () => {
                            completed++;
                            if (completed === dataArray.length) {
                                resolve();
                            }
                        };
                        request.onerror = () => reject(request.error);
                    });
                });
            }
        }

        // åˆå§‹åŒ–æœ¬åœ°è³‡æ–™åº«
        const localDB = new LocalDatabase();

        // ============================================
        // åŒæ­¥ç®¡ç†å™¨ï¼ˆæœ¬åœ° â†” é›²ç«¯ï¼‰
        // ============================================
        class SyncManager {
            constructor(localDB, supabaseClient) {
                this.localDB = localDB;
                this.supabaseClient = supabaseClient;
                this.isSyncing = false;
                this.lastSyncTime = null;
                this.syncError = null;
                this.hasSyncedThisSession = false; // æ ‡è®°æœ¬ä¼šè¯æ˜¯å¦å·²åŒæ­¥
            }

            async getLastSyncTime() {
                const metadata = await this.localDB.get('sync_metadata', 'lastSyncTime');
                return metadata ? new Date(metadata.value) : null;
            }

            async setLastSyncTime(time) {
                await this.localDB.put('sync_metadata', {
                    key: 'lastSyncTime',
                    value: time.toISOString()
                });
            }

            async syncToCloud() {
                if (!this.supabaseClient || !currentUser) {
                    console.warn('âš ï¸ Sync skipped: Supabase not configured or user not logged in');
                    this.syncError = 'offline';
                    return { success: false, error: 'offline' };
                }

                if (this.isSyncing) {
                    console.warn('âš ï¸ Sync already in progress');
                    return { success: false, error: 'already_syncing' };
                }

                this.isSyncing = true;
                this.syncError = null;
                updateSyncUI();

                try {
                    console.log('ğŸ”„ Starting bidirectional merge sync...');

                    // æ­¥éª¤ Aï¼šè·å–äº‘ç«¯å’Œæœ¬åœ°æ•°æ®
                    console.log('ğŸ“¥ Step A: Fetching cloud and local data...');
                    
                    // è·å–äº‘ç«¯æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ï¼‰
                    const { data: cloudTransactions, error: fetchCloudError } = await this.supabaseClient
                        .from('transactions')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .gte('date', new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
                    
                    if (fetchCloudError) throw fetchCloudError;
                    
                    // è·å–æœ¬åœ°æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ï¼‰
                    const localTransactions = await this.localDB.getAll('transactions');
                    
                    // æ­¥éª¤ Bï¼šæ‰§è¡ŒåŒå‘åˆå¹¶
                    console.log('ğŸ”„ Step B: Executing bidirectional merge...');
                    
                    // æ ‡å‡†åŒ–æ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µå­˜åœ¨
                    const normalizedCloud = (cloudTransactions || []).map(tx => ({
                        ...tx,
                        is_deleted: tx.is_deleted || false,
                        updated_at: tx.updated_at || new Date().toISOString()
                    }));
                    
                    const normalizedLocal = localTransactions.map(tx => ({
                        ...tx,
                        is_deleted: tx.is_deleted || false,
                        updated_at: tx.updated_at || new Date().toISOString()
                    }));
                    
                    // æ‰§è¡ŒåŒå‘åˆå¹¶
                    const mergedTransactions = this.mergeTransactions(normalizedCloud, normalizedLocal);
                    
                    // æ­¥éª¤ Cï¼šæ›´æ–°äº‘ç«¯å’Œæœ¬åœ°
                    console.log('ğŸ’¾ Step C: Writing merged data...');
                    
                    // æ›´æ–°äº‘ç«¯ï¼šä¸Šä¼ å®Œæ•´çš„åˆå¹¶æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ï¼‰
                    if (mergedTransactions.length > 0) {
                        const txData = mergedTransactions.map(tx => ({
                            id: tx.id,
                            user_id: currentUser.id,
                            amount: tx.amount,
                            date: tx.date,
                            note: tx.note || '',
                            category: tx.category,
                            icon: tx.icon,
                            currency: tx.currency || 'TWD',
                            updated_at: tx.updated_at,
                            is_deleted: tx.is_deleted || false
                        }));

                        const { error: txError } = await this.supabaseClient
                            .from('transactions')
                            .upsert(txData, { onConflict: 'id' });

                        if (txError) throw txError;
                        console.log(`âœ… Uploaded ${mergedTransactions.length} merged transactions to cloud`);
                    }
                    
                    // æ›´æ–°æœ¬åœ°ï¼šä¿å­˜å®Œæ•´çš„åˆå¹¶æ•°æ®ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ï¼Œç”¨äºåŒæ­¥ï¼‰
                    for (const tx of mergedTransactions) {
                        await this.localDB.put('transactions', {
                            id: tx.id,
                            amount: parseFloat(tx.amount),
                            date: tx.date,
                            note: tx.note || '',
                            category: tx.category,
                            icon: tx.icon,
                            currency: tx.currency || 'TWD',
                            updated_at: tx.updated_at,
                            is_deleted: tx.is_deleted || false
                        });
                    }
                    console.log(`âœ… Saved ${mergedTransactions.length} merged transactions to local`);

                    // 2. åŒæ­¥åˆ†ç±»
                    const categories = await this.localDB.getAll('categories');
                    const localCatIds = new Set();
                    
                    if (categories.length > 0) {
                        const catData = categories.map(cat => {
                            const catId = cat.id || crypto.randomUUID();
                            localCatIds.add(catId);
                            return {
                                id: catId,
                                user_id: currentUser.id,
                                name: cat.name,
                                icon: cat.icon,
                                color: cat.color,
                                updated_at: cat.updated_at || new Date().toISOString()
                            };
                        });

                        const { error: catError } = await this.supabaseClient
                            .from('categories')
                            .upsert(catData, { onConflict: 'id' });

                        if (catError) throw catError;
                        console.log(`âœ… Synced ${categories.length} categories`);
                    }
                    
                    // 2.1 åˆ é™¤äº‘ç«¯ä¸­æœ¬åœ°ä¸å­˜åœ¨çš„åˆ†ç±»ï¼ˆå®ç°çœŸæ­£çš„åˆ é™¤åŒæ­¥ï¼‰
                    const { data: cloudCategories, error: fetchCatError } = await this.supabaseClient
                        .from('categories')
                        .select('id')
                        .eq('user_id', currentUser.id);
                    
                    if (!fetchCatError && cloudCategories) {
                        const cloudCatIds = new Set(cloudCategories.map(cat => cat.id));
                        const toDelete = Array.from(cloudCatIds).filter(id => !localCatIds.has(id));
                        
                        if (toDelete.length > 0) {
                            const { error: deleteError } = await this.supabaseClient
                                .from('categories')
                                .delete()
                                .in('id', toDelete);
                            
                            if (deleteError) {
                                console.warn('âš ï¸ Failed to delete categories from cloud:', deleteError);
                            } else {
                                console.log(`âœ… Deleted ${toDelete.length} categories from cloud`);
                            }
                        }
                    }

                    // 3. åŒæ­¥ä½¿ç”¨è€…è¨­å®š
                    const budgetSetting = await this.localDB.get('settings', 'budget');
                    const themeSetting = await this.localDB.get('settings', 'themeId');
                    const currencySetting = await this.localDB.get('settings', 'currency');
                    const settingsUpdatedAt = await this.localDB.get('settings', 'settings_updated_at');

                    const now = new Date().toISOString();
                    const settingsData = {
                        user_id: currentUser.id,
                        budget: budgetSetting ? budgetSetting.value : 30000,
                        theme_id: themeSetting ? themeSetting.value : 'minimal',
                        currency: currencySetting ? currencySetting.value : 'TWD',
                        updated_at: settingsUpdatedAt ? settingsUpdatedAt.value : now,
                        last_sync_at: now
                    };

                    const { error: settingsError } = await this.supabaseClient
                        .from('user_settings')
                        .upsert(settingsData, { onConflict: 'user_id' });

                    if (settingsError) throw settingsError;
                    console.log('âœ… Synced user settings');

                    // 4. åŸ·è¡Œé›²ç«¯è³‡æ–™æ¸…ç†ï¼ˆåˆªé™¤ 365 å¤©å‰çš„è³‡æ–™ï¼‰
                    const { data: cleanupResult, error: cleanupError } = await this.supabaseClient
                        .rpc('sync_and_cleanup', { target_user_id: currentUser.id });

                    if (cleanupError) {
                        console.warn('âš ï¸ Cleanup failed:', cleanupError);
                    } else {
                        console.log(`âœ… Cleaned up ${cleanupResult.deleted_count} old records from cloud`);
                    }

                    // 5. æ›´æ–°æœ€å¾ŒåŒæ­¥æ™‚é–“
                    this.lastSyncTime = new Date();
                    this.hasSyncedThisSession = true; // æ ‡è®°æœ¬ä¼šè¯å·²åŒæ­¥
                    await this.setLastSyncTime(this.lastSyncTime);

                    this.isSyncing = false;
                    updateSyncUI();

                    return { success: true, time: this.lastSyncTime };

                } catch (error) {
                    console.error('âŒ Sync failed:', error);
                    this.syncError = error.message;
                    this.isSyncing = false;
                    updateSyncUI();

                    // éœé»˜è™•ç†éŒ¯èª¤ï¼Œä¸å½±éŸ¿ä½¿ç”¨è€…é«”é©—
                    return { success: false, error: error.message };
                }
            }

            // åŒå‘åˆå¹¶ç®—æ³•ï¼šåˆå¹¶äº‘ç«¯å’Œæœ¬åœ°æ•°æ®
            mergeTransactions(cloudData, localData) {
                const mergedMap = new Map();
                
                // 1. å…ˆæ·»åŠ æ‰€æœ‰æœ¬åœ°æ•°æ®
                localData.forEach(tx => {
                    mergedMap.set(tx.id, { ...tx });
                });
                
                // 2. å¤„ç†äº‘ç«¯æ•°æ®
                cloudData.forEach(cloudTx => {
                    const localTx = mergedMap.get(cloudTx.id);
                    
                    if (!localTx) {
                        // ID åªå­˜åœ¨äºäº‘ç«¯ï¼Œç›´æ¥æ·»åŠ 
                        mergedMap.set(cloudTx.id, {
                            ...cloudTx,
                            is_deleted: cloudTx.is_deleted || false
                        });
                    } else {
                        // ID åŒæ—¶å­˜åœ¨äºåŒæ–¹ï¼Œæ¯”è¾ƒ updated_at
                        const cloudUpdatedAt = new Date(cloudTx.updated_at || 0).getTime();
                        const localUpdatedAt = new Date(localTx.updated_at || 0).getTime();
                        
                        if (cloudUpdatedAt > localUpdatedAt) {
                            // äº‘ç«¯æ•°æ®æ›´æ–°ï¼Œä½¿ç”¨äº‘ç«¯æ•°æ®
                            mergedMap.set(cloudTx.id, {
                                ...cloudTx,
                                is_deleted: cloudTx.is_deleted || false
                            });
                        } else {
                            // æœ¬åœ°æ•°æ®æ›´æ–°ï¼Œä¿ç•™æœ¬åœ°æ•°æ®ï¼ˆä½†ç¡®ä¿ is_deleted å­—æ®µå­˜åœ¨ï¼‰
                            mergedMap.set(cloudTx.id, {
                                ...localTx,
                                is_deleted: localTx.is_deleted || false
                            });
                        }
                    }
                });
                
                return Array.from(mergedMap.values());
            }

            async syncFromCloud() {
                if (!this.supabaseClient || !currentUser) {
                    return { success: false, error: 'offline' };
                }

                try {
                    console.log('ğŸ”„ Pulling data from cloud...');

                    // 1. æ‹‰å–äº¤æ˜“è®°å½•ï¼ˆä»…æœ€è¿‘ 365 å¤©ï¼ŒåŒ…æ‹¬å·²åˆ é™¤çš„ï¼‰
                    const { data: cloudTransactions, error: txError } = await this.supabaseClient
                        .from('transactions')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .gte('date', new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0])
                        .order('date', { ascending: false });

                    if (txError) throw txError;

                    // 2. æ‹‰å–åˆ†ç±»
                    const { data: categories, error: catError } = await this.supabaseClient
                        .from('categories')
                        .select('*')
                        .eq('user_id', currentUser.id);

                    if (catError) throw catError;

                    // 3. æ‹‰å–ä½¿ç”¨è€…è¨­å®š
                    const { data: settings, error: settingsError } = await this.supabaseClient
                        .from('user_settings')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();

                    if (settingsError && settingsError.code !== 'PGRST116') throw settingsError;

                    // 4. æ‰§è¡ŒåŒå‘åˆå¹¶ï¼šè·å–æœ¬åœ°æ•°æ®å¹¶åˆå¹¶
                    const localTransactions = await this.localDB.getAll('transactions');
                    
                    // ç¡®ä¿æ‰€æœ‰è®°å½•éƒ½æœ‰ is_deleted å­—æ®µ
                    const normalizedCloud = (cloudTransactions || []).map(tx => ({
                        ...tx,
                        is_deleted: tx.is_deleted || false,
                        updated_at: tx.updated_at || new Date().toISOString()
                    }));
                    
                    const normalizedLocal = localTransactions.map(tx => ({
                        ...tx,
                        is_deleted: tx.is_deleted || false,
                        updated_at: tx.updated_at || new Date().toISOString()
                    }));
                    
                    // æ‰§è¡ŒåŒå‘åˆå¹¶
                    const mergedTransactions = this.mergeTransactions(normalizedCloud, normalizedLocal);
                    
                    // ä¿å­˜åˆå¹¶åçš„æ•°æ®åˆ°æœ¬åœ°ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„è®°å½•ï¼Œç”¨äºåŒæ­¥ï¼‰
                    let savedCount = 0;
                    for (const tx of mergedTransactions) {
                        await this.localDB.put('transactions', {
                            id: tx.id,
                            amount: parseFloat(tx.amount),
                            date: tx.date,
                            note: tx.note || '',
                            category: tx.category,
                            icon: tx.icon,
                            currency: tx.currency || 'TWD',
                            updated_at: tx.updated_at,
                            is_deleted: tx.is_deleted || false
                        });
                        savedCount++;
                    }
                    
                    console.log(`âœ… Merged ${mergedTransactions.length} transactions (${savedCount} saved to local)`);

                    if (categories && categories.length > 0) {
                        for (const cat of categories) {
                            await this.localDB.put('categories', {
                                id: cat.id,
                                name: cat.name,
                                icon: cat.icon,
                                color: cat.color,
                                updated_at: cat.updated_at
                            });
                        }
                        console.log(`âœ… Pulled ${categories.length} categories from cloud`);
                    }

                    if (settings) {
                        // æ£€æŸ¥æœ¬åœ°è®¾ç½®çš„æ›´æ–°æ—¶é—´ï¼Œåªæ›´æ–°è¾ƒæ–°çš„ç‰ˆæœ¬
                        const localSettingsUpdatedAt = await this.localDB.get('settings', 'settings_updated_at');
                        const cloudUpdatedAt = settings.updated_at || settings.last_sync_at;
                        
                        // å¦‚æœäº‘ç«¯æ•°æ®æ›´æ–°ï¼Œæˆ–è€…æœ¬åœ°æ²¡æœ‰æ›´æ–°æ—¶é—´æˆ³ï¼Œåˆ™æ›´æ–°æœ¬åœ°è®¾ç½®
                        if (!localSettingsUpdatedAt || !cloudUpdatedAt || 
                            new Date(cloudUpdatedAt) > new Date(localSettingsUpdatedAt.value)) {
                            await this.localDB.put('settings', { key: 'budget', value: parseFloat(settings.budget) });
                            await this.localDB.put('settings', { key: 'themeId', value: settings.theme_id });
                            await this.localDB.put('settings', { key: 'currency', value: settings.currency });
                            await this.localDB.put('settings', { key: 'settings_updated_at', value: cloudUpdatedAt });
                            
                            // æ›´æ–° state
                            state.budget = parseFloat(settings.budget);
                            state.themeId = settings.theme_id;
                            state.currency = settings.currency;
                            
                            console.log('âœ… Pulled user settings from cloud (updated)');
                        } else {
                            console.log('âœ… Local settings are newer, keeping local version');
                        }
                    }

                    return { success: true };

                } catch (error) {
                    console.error('âŒ Pull failed:', error);
                    return { success: false, error: error.message };
                }
            }
        }

        // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨
        let syncManager = null;

        // ============================================
        // Emoji Pool
        // ============================================
        const EMOJI_POOL = [
            // é¤é£²ç¾é£Ÿ (25å€‹)
            "ğŸš", "ğŸœ", "ğŸ", "ğŸ•", "ğŸ”", "ğŸŸ", "ğŸŒ­", "ğŸ¥ª", "ğŸŒ®", "ğŸŒ¯", "ğŸ±", "ğŸ›", "ğŸ²", "ğŸ³", "ğŸ¥˜", "ğŸ—", "ğŸ–", "ğŸ¥©", "ğŸ¤", "ğŸ£", "ğŸ°", "ğŸ§", "ğŸ©", "ğŸ‚", "ğŸ¥“",
            // é£²å“èŒ¶é£² (15å€‹)
            "â˜•", "ğŸµ", "ğŸ§‹", "ğŸ¥¤", "ğŸ¥›", "ğŸ·", "ğŸº", "ğŸ¥‚", "ğŸ¹", "ğŸ§Š", "ğŸ»", "ğŸ¥ƒ", "ğŸ§‰", "ğŸ§ƒ", "ğŸ¾",
            // äº¤é€šå‡ºè¡Œ (18å€‹)
            "ğŸš—", "ğŸš•", "ğŸš™", "ğŸšŒ", "ğŸš‡", "ğŸš²", "ğŸ›µ", "ğŸï¸", "âœˆï¸", "ğŸš„", "ğŸš¢", "â›½", "ğŸ…¿ï¸", "ğŸ«", "ğŸš‰", "ğŸ§³", "ğŸš‚", "ğŸš",
            // è³¼ç‰©æ¶ˆè²» (20å€‹)
            "ğŸ›’", "ğŸ›ï¸", "ğŸ‘•", "ğŸ‘—", "ğŸ‘–", "ğŸ‘Ÿ", "ğŸ‘ ", "ğŸ‘œ", "ğŸ‘›", "ğŸ’", "ğŸ’„", "ğŸ’", "âŒš", "ğŸ‘“", "ğŸ“¦", "ğŸ", "ğŸ§¥", "ğŸ‘”", "ğŸ©±", "ğŸ§¢",
            // å¨›æ¨‚ä¼‘é–’ (20å€‹)
            "ğŸ®", "ğŸ¬", "ğŸ¤", "ğŸ§", "ğŸ¨", "ğŸ­", "ğŸ¸", "ğŸ¯", "ğŸ²", "ğŸ³", "ğŸŸï¸", "ğŸª", "ğŸ¡", "ğŸ¢", "ğŸ°", "ğŸ¹", "ğŸº", "ğŸ»", "ğŸ·", "ğŸ•¹ï¸",
            // ç¤¾äº¤èšæœƒ (12å€‹)
            "ğŸ»", "ğŸ¥³", "ğŸ‰", "ğŸŠ", "ğŸˆ", "ğŸ€", "ğŸ§¨", "ğŸ†", "ğŸ‡", "ğŸ¾", "ğŸ¥‚", "ğŸ’",
            // é‹å‹•å¥èº« (12å€‹)
            "âš½", "ğŸ€", "ğŸ¾", "ğŸ", "ğŸ‹ï¸", "ğŸ§˜", "ğŸš´", "ğŸƒ", "ğŸŠ", "â›¹ï¸", "ğŸ¥Š", "ğŸ¤¸",
            // é‡‘èç†è²¡ (15å€‹)
            "ğŸ’°", "ğŸ’³", "ğŸ’µ", "ğŸ’´", "ğŸ’¶", "ğŸ’·", "ğŸ¦", "ğŸ’¹", "ğŸ“ˆ", "ğŸª™", "ğŸ’¸", "ğŸ’²", "ğŸ¤‘", "ğŸ“Š", "ğŸ“‰",
            // å¸³å–®è²»ç”¨ (18å€‹)
            "ğŸ§¾", "ğŸ“±", "ğŸ’»", "ğŸ“", "ğŸ“º", "ğŸ”Œ", "ğŸ’¡", "ğŸ”‹", "ğŸ“¶", "ğŸš¿", "ğŸš½", "ğŸ›", "ğŸ§»", "ğŸ§¼", "ğŸ§½", "ğŸ§´", "ğŸ—‘ï¸", "ğŸ“®",
            // ä¿éšªç¨…å‹™ (8å€‹)
            "ğŸ›ï¸", "âš–ï¸", "ğŸ“‹", "ğŸ“‘", "ğŸ—‚ï¸", "ğŸ“‡", "ğŸ”–", "ğŸ’¼",
            // æˆ¿ç§Ÿä½å®… (10å€‹)
            "ğŸ ", "ğŸ¡", "ğŸ¢", "ğŸ¬", "ğŸ¨", "ğŸ©", "ğŸ›ï¸", "ğŸ›‹ï¸", "ğŸšª", "ğŸ”‘",
            // é†«ç™‚ä¿å¥ (10å€‹)
            "ğŸ’Š", "ğŸ’‰", "ğŸ¥", "ğŸ©º", "ğŸ¦·", "ğŸ©¹", "ğŸ§¬", "ğŸ§ª", "âš•ï¸", "ğŸ§‘â€âš•ï¸",
            // æ•™è‚²å­¸ç¿’ (8å€‹)
            "ğŸ“š", "ğŸ“–", "ğŸ“", "âœï¸", "ğŸ–Šï¸", "ğŸ“", "ğŸ«", "ğŸ–ï¸",
            // å¯µç‰©ç…§é¡§ (8å€‹)
            "ğŸ¶", "ğŸ±", "ğŸ°", "ğŸ¹", "ğŸ¾", "ğŸ¦´", "ğŸŸ", "ğŸ¦",
            // å—œå¥½ç¿’æ…£ (6å€‹)
            "ğŸš¬", "ğŸ°", "ğŸ²", "ğŸƒ", "ğŸ€„", "ğŸ§©"
        ];

        let state = {
            budget: 30000,
            themeId: 'minimal',
            currency: 'TWD',
            transactions: [],
            categories: [
                { name: "ç¾é£Ÿé¤é£²", icon: "ğŸš", color: "#6366f1" },
                { name: "äº¤é€šé‹è¼¸", icon: "ğŸš—", color: "#10b981" },
                { name: "è³¼ç‰©æ¶ˆè²»", icon: "ğŸ›’", color: "#f59e0b" },
                { name: "å¸³å–®é›œé …", icon: "ğŸ§¾", color: "#8b5cf6" },
                { name: "ä¼‘é–’å¨›æ¨‚", icon: "ğŸ®", color: "#ec4899" }
            ],
            editingId: null,
            tempCat: "ç¾é£Ÿé¤é£²",
            tempCurrency: null,
            tempEmoji: null,
            isOnline: navigator.onLine,
            lastSyncTime: null,
            syncError: null
        };

        // ============================================
        // è³‡æ–™è¼‰å…¥å’Œå„²å­˜ï¼ˆæœ¬åœ°å„ªå…ˆï¼‰
        // ============================================

        // å¾ IndexedDB è¼‰å…¥è³‡æ–™åˆ° state
        async function loadDataFromLocal() {
            try {
                console.log('ğŸ“‚ Loading data from IndexedDB...');

                // åŠ è½½äº¤æ˜“è®°å½•ï¼ˆè¿‡æ»¤æ‰å·²åˆ é™¤çš„è®°å½•ï¼‰
                const allTransactions = await localDB.getAll('transactions');
                state.transactions = allTransactions
                    .filter(tx => !tx.is_deleted)  // è¿‡æ»¤æ‰å·²åˆ é™¤çš„è®°å½•
                    .sort((a, b) => b.date.localeCompare(a.date));

                // åŠ è½½åˆ†ç±»
                const categories = await localDB.getAll('categories');
                if (categories.length > 0) {
                    state.categories = categories;
                }

                // è¼‰å…¥è¨­å®š
                const budgetSetting = await localDB.get('settings', 'budget');
                const themeSetting = await localDB.get('settings', 'themeId');
                const currencySetting = await localDB.get('settings', 'currency');

                if (budgetSetting) state.budget = budgetSetting.value;
                if (themeSetting) state.themeId = themeSetting.value;
                if (currencySetting) state.currency = currencySetting.value;

                // åŠ è½½åŒæ­¥å…ƒæ•°æ®
                const lastSync = await localDB.get('sync_metadata', 'lastSyncTime');
                if (lastSync) state.lastSyncTime = new Date(lastSync.value);

                console.log(`âœ… Loaded ${state.transactions.length} transactions, ${state.categories.length} categories`);
                
                // è¿ç§»æ—§çš„ localStorage æ•°æ®ï¼ˆä»…é¦–æ¬¡ï¼‰
                await migrateFromLocalStorage();

            } catch (error) {
                console.error('âŒ Failed to load from IndexedDB:', error);
                // å›é€€åˆ° localStorage
                loadDataFromLocalStorage();
            }
        }

        // è¿ç§»æ—§çš„ localStorage æ•°æ®åˆ° IndexedDBï¼ˆä»…é¦–æ¬¡è¿è¡Œï¼‰
        async function migrateFromLocalStorage() {
            const migrated = await localDB.get('sync_metadata', 'localStorage_migrated');
            if (migrated) return; // å·²è¿ç§»è¿‡

            console.log('ğŸ”„ Migrating data from localStorage to IndexedDB...');

            try {
                // è¿ç§»äº¤æ˜“è®°å½•
                const oldTx = JSON.parse(localStorage.getItem('ledger_tx_v13') || '[]');
                if (oldTx.length > 0) {
                    for (const tx of oldTx) {
                        tx.updated_at = tx.updated_at || new Date().toISOString();
                        await localDB.put('transactions', tx);
                    }
                    state.transactions = oldTx.sort((a, b) => b.date.localeCompare(a.date));
                    console.log(`âœ… Migrated ${oldTx.length} transactions`);
                }

                // è¿ç§»åˆ†ç±»
                const oldCats = JSON.parse(localStorage.getItem('ledger_cats_v13') || '[]');
                if (oldCats.length > 0) {
                    for (const cat of oldCats) {
                        cat.id = cat.id || crypto.randomUUID();
                        cat.updated_at = cat.updated_at || new Date().toISOString();
                        await localDB.put('categories', cat);
                    }
                    state.categories = oldCats;
                    console.log(`âœ… Migrated ${oldCats.length} categories`);
                }

                // è¿ç§»è®¾ç½®
                const oldBudget = parseFloat(localStorage.getItem('ledger_budget_v13'));
                const oldTheme = localStorage.getItem('ledger_theme_id_v13');
                const oldCurrency = localStorage.getItem('ledger_currency_v13');

                if (oldBudget) {
                    await localDB.put('settings', { key: 'budget', value: oldBudget });
                    state.budget = oldBudget;
                }
                if (oldTheme) {
                    await localDB.put('settings', { key: 'themeId', value: oldTheme });
                    state.themeId = oldTheme;
                }
                if (oldCurrency) {
                    await localDB.put('settings', { key: 'currency', value: oldCurrency });
                    state.currency = oldCurrency;
                }

                // æ ‡è®°ä¸ºå·²è¿ç§»
                await localDB.put('sync_metadata', { key: 'localStorage_migrated', value: true });
                console.log('âœ… Migration completed');

                // å¯é€‰ï¼šæ¸…ç†æ—§æ•°æ®
                // localStorage.removeItem('ledger_tx_v13');
                // localStorage.removeItem('ledger_cats_v13');
                // localStorage.removeItem('ledger_budget_v13');
                // localStorage.removeItem('ledger_theme_id_v13');
                // localStorage.removeItem('ledger_currency_v13');

            } catch (error) {
                console.error('âŒ Migration failed:', error);
            }
        }

        // å›é€€åˆ° localStorageï¼ˆä»…å½“ IndexedDB å¤±è´¥æ—¶ï¼‰
        function loadDataFromLocalStorage() {
            console.warn('âš ï¸ Falling back to localStorage');
            state.budget = parseFloat(localStorage.getItem('ledger_budget_v13')) || 30000;
            state.themeId = localStorage.getItem('ledger_theme_id_v13') || 'minimal';
            state.currency = localStorage.getItem('ledger_currency_v13') || 'TWD';
            state.transactions = JSON.parse(localStorage.getItem('ledger_tx_v13')) || [];
            state.categories = JSON.parse(localStorage.getItem('ledger_cats_v13')) || state.categories;
        }

        // ä¿å­˜æ•°æ®åˆ° IndexedDBï¼ˆæœ¬åœ°ä¼˜å…ˆï¼‰
        async function save() {
            try {
                const now = new Date().toISOString();
                // ä¿å­˜åˆ° IndexedDB
                await localDB.put('settings', { key: 'budget', value: state.budget });
                await localDB.put('settings', { key: 'themeId', value: state.themeId });
                await localDB.put('settings', { key: 'currency', value: state.currency });
                // ä¿å­˜è®¾ç½®æ›´æ–°æ—¶é—´æˆ³
                await localDB.put('settings', { key: 'settings_updated_at', value: now });
                
                // ä¿å­˜åˆ†ç±»åˆ° IndexedDB
                for (const cat of state.categories) {
                    await localDB.put('categories', {
                        id: cat.id || crypto.randomUUID(),
                        name: cat.name,
                        icon: cat.icon,
                        color: cat.color,
                        updated_at: cat.updated_at || now
                    });
                }

                // åŒæ—¶ä¿å­˜åˆ° localStorage ä½œä¸ºå¤‡ä»½
                localStorage.setItem('ledger_budget_v13', state.budget);
                localStorage.setItem('ledger_theme_id_v13', state.themeId);
                localStorage.setItem('ledger_currency_v13', state.currency);
                localStorage.setItem('ledger_cats_v13', JSON.stringify(state.categories));
                localStorage.setItem('ledger_settings_updated_at_v13', now);
                
                // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®

            } catch (error) {
                console.error('âŒ Save failed:', error);
                // å›é€€åˆ° localStorage
                const now = new Date().toISOString();
                localStorage.setItem('ledger_budget_v13', state.budget);
                localStorage.setItem('ledger_theme_id_v13', state.themeId);
                localStorage.setItem('ledger_currency_v13', state.currency);
                localStorage.setItem('ledger_cats_v13', JSON.stringify(state.categories));
                localStorage.setItem('ledger_settings_updated_at_v13', now);
            }
        }

        let lastPage = 'home';
        let myChart = null;

        function getCurrencySymbol() {
            const curr = CURRENCY_OPTIONS.find(c => c.id === state.currency);
            return curr ? curr.symbol : 'NT$';
        }

        function updateCurrencySymbols() {
            const symbol = getCurrencySymbol();
            const el1 = document.getElementById('currencySymbolHome');
            const el2 = document.getElementById('currencySymbolHome2');
            const el3 = document.getElementById('currencySymbolAdd');
            if(el1) el1.innerText = symbol;
            if(el2) el2.innerText = symbol;
            if(el3) el3.innerText = symbol;
        }

        // ============================================
        // åŒæ­¥ UI æ›´æ–°å‡½æ•°
        // ============================================
        function updateSyncUI() {
            if (!syncManager) return;

            const statusBadge = document.getElementById('syncStatusBadge');
            const lastSyncDisplay = document.getElementById('lastSyncDisplay');
            const syncErrorMessage = document.getElementById('syncErrorMessage');
            const syncBtnText = document.getElementById('syncBtnText');
            const manualSyncBtn = document.getElementById('manualSyncBtn');
            const localDataCount = document.getElementById('localDataCount');

            // æ›´æ–°æœ¬åœ°è³‡æ–™çµ±è¨ˆ
            if (localDataCount) {
                localDataCount.innerText = `${state.transactions.length} ç­†äº¤æ˜“`;
            }

            // æ›´æ–°åŒæ­¥çŠ¶æ€å¾½ç« 
            if (statusBadge) {
                if (!supabaseClient) {
                    statusBadge.innerHTML = '<span class="bg-gray-500/20 text-gray-400 px-2 py-1 rounded-full">ä»…æœ¬åœ°</span>';
                } else if (!currentUser) {
                    statusBadge.innerHTML = '<span class="bg-orange-500/20 text-orange-400 px-2 py-1 rounded-full">éœ€è¦ç™»å½•</span>';
                } else if (syncManager.isSyncing) {
                    statusBadge.innerHTML = '<span class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">åŒæ­¥ä¸­...</span>';
                } else if (syncManager.syncError) {
                    statusBadge.innerHTML = '<span class="bg-red-500/20 text-red-400 px-2 py-1 rounded-full">åŒæ­¥å¤±è´¥</span>';
                } else if (syncManager.lastSyncTime && syncManager.hasSyncedThisSession) {
                    // åªæœ‰åœ¨æœ¬ä¼šè¯ä¸­æˆåŠŸåŒæ­¥è¿‡æ‰æ˜¾ç¤º"å·²åŒæ­¥"
                    statusBadge.innerHTML = '<span class="bg-green-500/20 text-green-400 px-2 py-1 rounded-full">å·²åŒæ­¥</span>';
                } else {
                    // åº”ç”¨å¯åŠ¨æ—¶æˆ–ä»æœªåŒæ­¥è¿‡ï¼Œæ˜¾ç¤º"æœªåŒæ­¥"
                    statusBadge.innerHTML = '<span class="bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded-full">æœªåŒæ­¥</span>';
                }
            }

            // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
            if (lastSyncDisplay) {
                if (syncManager.lastSyncTime) {
                    const timeDiff = Date.now() - syncManager.lastSyncTime.getTime();
                    const minutes = Math.floor(timeDiff / 60000);
                    const hours = Math.floor(minutes / 60);
                    const days = Math.floor(hours / 24);

                    if (days > 0) {
                        lastSyncDisplay.innerText = `${days} å¤©å‰`;
                    } else if (hours > 0) {
                        lastSyncDisplay.innerText = `${hours} å°æ—¶å‰`;
                    } else if (minutes > 0) {
                        lastSyncDisplay.innerText = `${minutes} åˆ†é’Ÿå‰`;
                    } else {
                        lastSyncDisplay.innerText = 'åˆšåˆš';
                    }
                } else {
                    lastSyncDisplay.innerText = 'å¾æœªåŒæ­¥';
                }
            }

            // æ›´æ–°éŒ¯èª¤è³‡è¨Š
            if (syncErrorMessage) {
                if (!supabaseClient) {
                    syncErrorMessage.innerText = 'âš ï¸ æœªé…ç½®é›²ç«¯ï¼Œç›®å‰åƒ…å„²å­˜æ–¼æœ¬åœ°';
                    syncErrorMessage.classList.remove('hidden');
                } else if (!currentUser) {
                    syncErrorMessage.innerText = 'ğŸ’¡ æç¤ºï¼šè«‹å…ˆç™»å…¥ Supabase å¸³æˆ¶æ‰èƒ½å•Ÿç”¨é›²ç«¯åŒæ­¥åŠŸèƒ½';
                    syncErrorMessage.className = 'text-[9px] text-orange-400 bg-orange-500/10 p-2 rounded-lg';
                    syncErrorMessage.classList.remove('hidden');
                } else if (syncManager.syncError) {
                    if (syncManager.syncError === 'offline') {
                        syncErrorMessage.innerText = 'âš ï¸ ç¶²è·¯é›¢ç·šï¼Œç›®å‰åƒ…å„²å­˜æ–¼æœ¬åœ°';
                    } else {
                        syncErrorMessage.innerText = `âŒ åŒæ­¥å¤±æ•—ï¼š${syncManager.syncError}`;
                    }
                    syncErrorMessage.className = 'text-[9px] text-red-400 bg-red-500/10 p-2 rounded-lg';
                    syncErrorMessage.classList.remove('hidden');
                } else {
                    syncErrorMessage.classList.add('hidden');
                }
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            if (syncBtnText && manualSyncBtn) {
                if (syncManager.isSyncing) {
                    syncBtnText.innerText = 'ğŸ”„ åŒæ­¥ä¸­...';
                    manualSyncBtn.disabled = true;
                    manualSyncBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    // æ˜¾ç¤ºåŒæ­¥è¿›åº¦æç¤º
                    if (lastSyncDisplay) {
                        lastSyncDisplay.innerText = 'åŒæ­¥ä¸­ï¼Œè¯·å‹¿å…³é—­...';
                    }
                } else if (!supabaseClient) {
                    syncBtnText.innerText = 'â˜ï¸ æœªé…ç½®é›²ç«¯';
                    manualSyncBtn.disabled = true;
                    manualSyncBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else if (!currentUser) {
                    syncBtnText.innerText = 'ğŸ” éœ€è¦ç™»å…¥æ‰èƒ½åŒæ­¥';
                    manualSyncBtn.disabled = true;
                    manualSyncBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    syncBtnText.innerText = 'ğŸ”„ ç«‹å³åŒæ­¥åˆ°é›²ç«¯';
                    manualSyncBtn.disabled = false;
                    manualSyncBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // æ‰‹åŠ¨åŒæ­¥æŒ‰é’®ï¼ˆåŒå‘å¢é‡åˆå¹¶ï¼‰
        async function manualSync() {
            if (!syncManager || syncManager.isSyncing) return;

            // ä¿å­˜æœ¬åœ°æ•°æ®å¿«ç…§ï¼Œç”¨äºå¤±è´¥æ—¶æ’¤é”€
            let localSnapshot = null;
            try {
                localSnapshot = await localDB.getAll('transactions');
            } catch (e) {
                console.warn('âš ï¸ Failed to create snapshot:', e);
            }

            updateSyncUI();
            
            try {
                console.log('ğŸ”„ Starting bidirectional merge sync...');
                
                // æ­¥éª¤ Aï¼šè·å–äº‘ç«¯å’Œæœ¬åœ°æ•°æ®
                // æ­¥éª¤ Bï¼šæ‰§è¡ŒåŒå‘åˆå¹¶
                // æ­¥éª¤ Cï¼šæ›´æ–°äº‘ç«¯å’Œæœ¬åœ°
                // è¿™äº›æ­¥éª¤éƒ½åœ¨ syncToCloud() ä¸­å®Œæˆ
                const result = await syncManager.syncToCloud();

                if (result.success) {
                    console.log('âœ… Bidirectional merge sync completed');
                    
                    // åŒæ­¥åˆ†ç±»å’Œè®¾ç½®
                    const categories = await localDB.getAll('categories');
                    if (categories.length > 0) {
                        const catData = categories.map(cat => ({
                            id: cat.id || crypto.randomUUID(),
                            user_id: currentUser.id,
                            name: cat.name,
                            icon: cat.icon,
                            color: cat.color,
                            updated_at: cat.updated_at || new Date().toISOString()
                        }));

                        const { error: catError } = await syncManager.supabaseClient
                            .from('categories')
                            .upsert(catData, { onConflict: 'id' });

                        if (catError) throw catError;
                        console.log('âœ… Synced categories');
                    }
                    
                    // åŒæ­¥è®¾ç½®
                    const budgetSetting = await localDB.get('settings', 'budget');
                    const themeSetting = await localDB.get('settings', 'themeId');
                    const currencySetting = await localDB.get('settings', 'currency');
                    const settingsUpdatedAt = await localDB.get('settings', 'settings_updated_at');

                    const now = new Date().toISOString();
                    const settingsData = {
                        user_id: currentUser.id,
                        budget: budgetSetting ? budgetSetting.value : 30000,
                        theme_id: themeSetting ? themeSetting.value : 'minimal',
                        currency: currencySetting ? currencySetting.value : 'TWD',
                        updated_at: settingsUpdatedAt ? settingsUpdatedAt.value : now,
                        last_sync_at: now
                    };

                    const { error: settingsError } = await syncManager.supabaseClient
                        .from('user_settings')
                        .upsert(settingsData, { onConflict: 'user_id' });

                    if (settingsError) throw settingsError;
                    console.log('âœ… Synced user settings');
                    
                    // è®°å½•æœ€ååŒæ­¥æ—¶é—´
                    await syncManager.setLastSyncTime(new Date());
                    
                    // é‡æ–°åŠ è½½åˆå¹¶åçš„æ•°æ®ï¼ˆè¿‡æ»¤æ‰å·²åˆ é™¤çš„ï¼‰
                    await loadDataFromLocal();
                    console.log('âœ… Reloaded merged data from local storage');
                    
                    // åˆ·æ–°UI
                    renderAll();
                    console.log('âœ… UI refreshed');
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    alert('âœ… åŒæ­¥å®Œæˆï¼æ‰€æœ‰æ›´æ”¹å·²é€šè¿‡åŒå‘åˆå¹¶ä¿å­˜åˆ°äº‘ç«¯ã€‚');
                } else {
                    console.warn('âš ï¸ Manual sync failed:', result.error);
                    
                    // æ’¤é”€ï¼šæ¢å¤å¿«ç…§
                    if (localSnapshot) {
                        try {
                            for (const tx of localSnapshot) {
                                await localDB.put('transactions', tx);
                            }
                            await loadDataFromLocal();
                            renderAll();
                            console.log('âœ… Local changes reverted');
                        } catch (revertError) {
                            console.error('âŒ Failed to revert changes:', revertError);
                        }
                    }
                    
                    alert('âš ï¸ åŒæ­¥å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯') + '\n\næœ¬åœ°æ›´æ”¹å·²æ’¤é”€ã€‚');
                }
            } catch (error) {
                console.error('âŒ Manual sync error:', error);
                
                // æ’¤é”€ï¼šæ¢å¤å¿«ç…§
                if (localSnapshot) {
                    try {
                        for (const tx of localSnapshot) {
                            await localDB.put('transactions', tx);
                        }
                        await loadDataFromLocal();
                        renderAll();
                        console.log('âœ… Local changes reverted after error');
                    } catch (revertError) {
                        console.error('âŒ Failed to revert changes:', revertError);
                    }
                }
                
                alert('âŒ åŒæ­¥å‡ºé”™ï¼š' + error.message + '\n\næœ¬åœ°æ›´æ”¹å·²æ’¤é”€ã€‚');
            } finally {
                updateSyncUI();
            }
        }

        // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
        window.addEventListener('online', () => {
            console.log('ğŸŒ Network online');
            state.isOnline = true;
            updateSyncUI();
            // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®
        });

        window.addEventListener('offline', () => {
            console.log('ğŸ“¡ Network offline');
            state.isOnline = false;
            updateSyncUI();
        });

        // ============================================
        // PWA æ”¯æŒ - å…¨å±æ¨¡å¼
        // ============================================
        // é˜²æ­¢ iOS Safari çš„æ©¡çš®ç­‹æ•ˆæœï¼ˆä½†å…è®¸æ­£å¸¸æ»šåŠ¨ï¼‰
        document.addEventListener('touchmove', function(e) {
            // æ£€æŸ¥ç›®æ ‡å…ƒç´ åŠå…¶çˆ¶å…ƒç´ æ˜¯å¦å¯ä»¥æ»šåŠ¨
            let element = e.target;
            let canScroll = false;
            
            // å‘ä¸Šéå† DOM æ ‘ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¯æ»šåŠ¨çš„çˆ¶å…ƒç´ 
            while (element && element !== document.body) {
                const style = window.getComputedStyle(element);
                const overflowY = style.overflowY;
                const overflow = style.overflow;
                
                // æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯ä»¥å‚ç›´æ»šåŠ¨
                if (overflowY === 'auto' || overflowY === 'scroll' || 
                    overflow === 'auto' || overflow === 'scroll') {
                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦çœŸçš„å¯ä»¥æ»šåŠ¨ï¼ˆå†…å®¹é«˜åº¦ > å®¹å™¨é«˜åº¦ï¼‰
                    if (element.scrollHeight > element.clientHeight) {
                        canScroll = true;
                        break;
                    }
                }
                
                element = element.parentElement;
            }
            
            // å¦‚æœæ‰¾åˆ°å¯æ»šåŠ¨å…ƒç´ ï¼Œå…è®¸æ»šåŠ¨
            if (canScroll) {
                return;
            }
            
            // æ£€æŸ¥ä¸»å®¹å™¨æ˜¯å¦å¯ä»¥æ»šåŠ¨
            const mainContainer = document.getElementById('mainContainer');
            if (mainContainer && mainContainer.scrollHeight > mainContainer.clientHeight) {
                // å¦‚æœè§¦æ‘¸ç‚¹åœ¨ä¸»å®¹å™¨å†…ï¼Œå…è®¸æ»šåŠ¨
                if (mainContainer.contains(e.target)) {
                    return;
                }
            }
            
            // å¦åˆ™é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆé˜²æ­¢æ©¡çš®ç­‹æ•ˆæœï¼‰
            e.preventDefault();
        }, { passive: false });

        // éšè—åœ°å€æ ï¼ˆiOS Safariï¼‰- åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡
        let addressBarHidden = false;
        window.addEventListener('load', function() {
            if (!addressBarHidden) {
                setTimeout(function() {
                    window.scrollTo(0, 1);
                    addressBarHidden = true;
                }, 0);
            }
        });

        // é˜²æ­¢åŒå‡»ç¼©æ”¾ - åªåœ¨éäº¤äº’å…ƒç´ ä¸Š
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            // å…è®¸åœ¨æŒ‰é’®ã€è¾“å…¥æ¡†ç­‰äº¤äº’å…ƒç´ ä¸ŠåŒå‡»
            if (e.target.tagName === 'BUTTON' || 
                e.target.tagName === 'INPUT' || 
                e.target.tagName === 'TEXTAREA' ||
                e.target.closest('button') ||
                e.target.closest('input') ||
                e.target.closest('textarea')) {
                return;
            }
            
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // ============================================
        // åº”ç”¨åˆå§‹åŒ–
        // ============================================
        window.onload = async () => {
            console.log('ğŸš€ Initializing Ledger App...');
            
            // æ£€æŸ¥æ˜¯å¦åœ¨å…¨å±æ¨¡å¼ï¼ˆæ·»åŠ åˆ°ä¸»å±å¹•åï¼‰
            if (window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
                console.log('âœ… Running in standalone mode (added to home screen)');
                document.body.classList.add('standalone');
            }

            try {
                // 1. åˆå§‹åŒ– IndexedDB
                await localDB.init();

                // 2. åŠ è½½æœ¬åœ°æ•°æ®
                await loadDataFromLocal();

                // 3. åˆå§‹åŒ– Supabase å¹¶å¤„ç† Magic Link
                if (supabaseClient) {
                    // è®¾ç½® auth çŠ¶æ€å˜åŒ–ç›‘å¬å™¨
                    // æ ‡è®°æ˜¯å¦æ­£åœ¨å¤„ç† Magic Link å›è°ƒ
                    let isProcessingMagicLink = false;
                    
                    supabaseClient.auth.onAuthStateChange(async (event, session) => {
                        console.log('ğŸ” Auth state changed:', event, session?.user?.email || 'no user');
                        
                        if (event === 'SIGNED_IN' && session) {
                            currentUser = session.user;
                            state.isLoggedIn = true;
                            state.userId = currentUser.id;
                            console.log('âœ… User signed in:', currentUser.email);
                            
                            // æ¸…é™¤ URL ä¸­çš„ hash
                            if (window.location.hash) {
                                window.history.replaceState(null, '', window.location.pathname);
                            }
                            
                            // å¦‚æœæ˜¯ Magic Link å›è°ƒï¼Œæ ‡è®°ä¸ºæ­£åœ¨å¤„ç†
                            if (window.location.hash.includes('access_token')) {
                                isProcessingMagicLink = true;
                            }
                            
                            // é¡¯ç¤ºä¸»æ‡‰ç”¨å¹¶åŒæ­¥æ•°æ®
                            showMainApp();
                            
                            // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
                            if (!syncManager) {
                                syncManager = new SyncManager(localDB, supabaseClient);
                            }
                            
                            // ç™»å½•åä»äº‘ç«¯æ‹‰å–æ•°æ®ï¼ˆç¡®ä¿æ‰€æœ‰è®¾å¤‡æ•°æ®ä¸€è‡´ï¼Œä½†ä¸è‡ªåŠ¨ä¸Šä¼ ï¼‰
                            console.log('ğŸ”„ Pulling data from cloud after login to ensure consistency...');
                            try {
                                await syncManager.syncFromCloud();
                                await loadDataFromLocal(); // é‡æ–°åŠ è½½åˆå¹¶åçš„æ•°æ®
                                console.log('âœ… Data pulled from cloud. All devices will show the same data.');
                            } catch (error) {
                                console.warn('âš ï¸ Failed to pull data from cloud:', error);
                            }
                            
                            // åˆ·æ–°UI
                            renderAll();
                            updateAuthUI();
                            
                            // é‡ç½® Magic Link å¤„ç†æ ‡è®°
                            isProcessingMagicLink = false;
                            
                            console.log('âœ… Login completed!');
                        } else if (event === 'SIGNED_OUT') {
                            currentUser = null;
                            state.isLoggedIn = false;
                            state.userId = null;
                            console.log('âš ï¸ User signed out');
                            updateAuthUI();
                        }
                    });

                    // å…ˆæ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰ Magic Link çš„ tokenï¼ˆhash fragmentï¼‰
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const hasAuthToken = hashParams.has('access_token') || hashParams.has('error');
                    
                    if (hasAuthToken) {
                        console.log('ğŸ”— Detected Magic Link callback in URL');
                        // Supabase SDK ä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸ª hash å¹¶è§¦å‘ onAuthStateChange
                        // ç­‰å¾… onAuthStateChange å¤„ç†å®Œæˆï¼ˆæœ€å¤šç­‰å¾… 3 ç§’ï¼‰
                        let waitCount = 0;
                        while (waitCount < 30 && !state.isLoggedIn) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            waitCount++;
                        }
                        
                        // å¦‚æœç­‰å¾…åä»ç„¶æ²¡æœ‰ç™»å½•ï¼Œæ‰‹åŠ¨æ£€æŸ¥ session
                        if (!state.isLoggedIn) {
                            const { data: { session } } = await supabaseClient.auth.getSession();
                            if (session) {
                                currentUser = session.user;
                                state.isLoggedIn = true;
                                state.userId = currentUser.id;
                                console.log('âœ… Magic Link session found after wait:', currentUser.email);
                                
                                // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨
                                if (!syncManager) {
                                    syncManager = new SyncManager(localDB, supabaseClient);
                                }
                                
                                // ä»äº‘ç«¯æ‹‰å–æ•°æ®
                                try {
                                    await syncManager.syncFromCloud();
                                    await loadDataFromLocal();
                                } catch (error) {
                                    console.warn('âš ï¸ Failed to pull data from cloud:', error);
                                }
                                
                                showMainApp();
                                renderAll();
                                updateAuthUI();
                            }
                        }
                        
                        // æ¸…é™¤ URL hash
                        if (window.location.hash) {
                            window.history.replaceState(null, '', window.location.pathname);
                        }
                    }

                    // æ£€æŸ¥ç°æœ‰ä¼šè¯
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) {
                        currentUser = session.user;
                        state.isLoggedIn = true;
                        state.userId = currentUser.id;
                        console.log('âœ… Existing session found:', currentUser.email);
                    } else {
                        console.log('âš ï¸ No user session found');
                        state.isLoggedIn = false;
                        state.userId = null;
                    }

                    // åˆå§‹åŒ–åŒæ­¥ç®¡ç†å™¨
                    syncManager = new SyncManager(localDB, supabaseClient);
                    
                    // è·å–æœ€ååŒæ­¥æ—¶é—´
                    syncManager.lastSyncTime = await syncManager.getLastSyncTime();

                    // å¦‚æœå·²ç™»å½•ï¼Œä»äº‘ç«¯æ‹‰å–æ•°æ®ï¼ˆç¡®ä¿æ‰€æœ‰è®¾å¤‡æ•°æ®ä¸€è‡´ï¼Œä½†ä¸è‡ªåŠ¨ä¸Šä¼ ï¼‰
                    if (state.isLoggedIn && currentUser) {
                        console.log('ğŸ”„ Pulling data from cloud on startup to ensure consistency...');
                        try {
                            await syncManager.syncFromCloud();
                            await loadDataFromLocal(); // é‡æ–°åŠ è½½åˆå¹¶åçš„æ•°æ®
                            renderAll(); // åˆ·æ–°UI
                            console.log('âœ… Data pulled from cloud. All devices will show the same data.');
                        } catch (error) {
                            console.warn('âš ï¸ Failed to pull data from cloud:', error);
                        }
                    }
                } else {
                    console.log('â„¹ï¸ Running in local-only mode (Supabase not configured)');
                    syncManager = new SyncManager(localDB, null);
                    state.isLoggedIn = false;
                    state.userId = null;
                }

                // 4. åº”ç”¨ä¸»é¢˜
                applyTheme(state.themeId);

                // 5. åˆå§‹åŒ– UI
                lucide.createIcons();
                updateHUDDate();
                updateCurrencySymbols();
                const currentMonth = new Date().toISOString().slice(0, 7);
                document.getElementById('statsMonth').value = currentMonth;
                document.getElementById('histMonth').value = currentMonth;

                // 6. å†³å®šæ˜¾ç¤ºå“ªä¸ªé¡µé¢
                // æ‰€æœ‰ç”¨æˆ¶ï¼ˆåŒ…æ‹¬æ–°ç”¨æˆ¶ï¼‰éƒ½ç›´æ¥é€²å…¥ä¸»æ‡‰ç”¨ï¼Œé¼“å‹µä½¿ç”¨æœ¬åœ°æ¨¡å¼
                // å¦‚æœéœ€è¦é›²ç«¯åŒæ­¥ï¼Œå¯ä»¥åœ¨è¨­å®šé é¢æ‰‹å‹•ç™»å…¥
                showMainApp();

                // 7. æ›´æ–°åŒæ­¥ UI
                updateSyncUI();

                console.log('âœ… App initialized successfully');

            } catch (error) {
                console.error('âŒ App initialization failed:', error);
                
                // å›é€€åˆ°çº¯ localStorage æ¨¡å¼
                loadDataFromLocalStorage();
                applyTheme(state.themeId);
                lucide.createIcons();
                updateHUDDate();
                updateCurrencySymbols();
                const currentMonth = new Date().toISOString().slice(0, 7);
                document.getElementById('statsMonth').value = currentMonth;
                document.getElementById('histMonth').value = currentMonth;
                renderAll();
            }
        };

        async function applyTheme(themeId) {
            const scheme = THEME_SCHEMES.find(s => s.id === themeId) || THEME_SCHEMES[0];
            state.themeId = themeId;
            document.documentElement.style.setProperty('--accent', scheme.color);
            document.documentElement.style.setProperty('--accent-rgb', scheme.rgb);
            document.documentElement.style.setProperty('--bg-deep', scheme.bg);
            document.documentElement.style.setProperty('--card-bg', `rgba(28, 28, 32, ${scheme.opacity})`);
            await save();
            if (myChart) renderStats();
        }

        // æ—§çš„ save() å‡½æ•°å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨ async save() å‡½æ•°

        function updateHUDDate() {
            const d = new Date();
            document.getElementById('hudDate').innerText = d.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // ============================================
        // Authentication Functions
        // ============================================

        function switchAuthTab(tab) {
            const magicLinkForm = document.getElementById('formMagicLink');
            const codeForm = document.getElementById('formCode');
            const magicLinkTab = document.getElementById('tabMagicLink');
            const codeTab = document.getElementById('tabCode');
            
            // Hide all forms
            magicLinkForm.classList.add('hidden');
            codeForm.classList.add('hidden');
            
            // Reset all tabs to inactive
            magicLinkTab.className = 'auth-tab-inactive flex-1 py-3 rounded-[24px] text-sm font-black transition-all';
            codeTab.className = 'auth-tab-inactive flex-1 py-3 rounded-[24px] text-sm font-black transition-all';
            
            // Show selected form and activate tab
            if (tab === 'code') {
                codeForm.classList.remove('hidden');
                codeTab.className = 'auth-tab-active flex-1 py-3 rounded-[24px] text-sm font-black transition-all';
            } else {
                // Default to magic link
                magicLinkForm.classList.remove('hidden');
                magicLinkTab.className = 'auth-tab-active flex-1 py-3 rounded-[24px] text-sm font-black transition-all';
            }
        }

        async function handleMagicLink() {
            if (!supabaseClient) {
                showAuthMessage('âš ï¸ Supabase æœªé…ç½®ï¼Œç„¡æ³•ä½¿ç”¨é›²ç«¯åŠŸèƒ½', 'error');
                return;
            }

            const email = document.getElementById('emailMagicLink').value.trim();

            if (!email || !email.includes('@')) {
                showAuthMessage('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€', 'error');
                return;
            }

            const btnText = document.getElementById('btnMagicLinkText');
            const originalText = btnText.innerText;
            btnText.innerText = 'ğŸ”„ ç™¼é€ä¸­...';

            try {
                const { data, error } = await supabaseClient.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.location.href
                    }
                });

                if (error) throw error;

                // æª¢æ¸¬æ˜¯å¦åœ¨ iOS Standalone æ¨¡å¼
                const isIOSStandalone = window.navigator.standalone === true || 
                                        (window.matchMedia('(display-mode: standalone)').matches && 
                                         /iPhone|iPad|iPod/.test(navigator.userAgent));
                
                if (isIOSStandalone) {
                    showAuthMessage(`âœ… Magic Link å·²ç™¼é€è‡³ ${email}<br><br>
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 mt-3 text-left">
                            <p class="text-[10px] font-black text-yellow-400 uppercase mb-2">âš ï¸ iOS ä¸»ç•«é¢ App æç¤º</p>
                            <p class="text-[10px] text-yellow-400/80 mb-3">è«‹åœ¨ Safari ç€è¦½å™¨ä¸­é–‹å•Ÿä¿¡ç®±é€£çµå®Œæˆç™»å…¥ã€‚</p>
                            <p class="text-[10px] text-white/60 mb-3">ç™»å…¥å¾Œå¯ç”¢ç”Ÿã€Œç™»å…¥ä»£ç¢¼ã€ï¼Œå†å›åˆ°æ­¤ App ä½¿ç”¨ä»£ç¢¼ç™»å…¥ã€‚</p>
                            <p class="text-[10px] text-white/60">æˆ–é¸æ“‡ä¸‹æ–¹ã€Œåƒ…ä½¿ç”¨æœ¬åœ°æ¨¡å¼ã€è·³éç™»å…¥ã€‚</p>
                        </div>`, 'success');
                } else {
                    showAuthMessage(`âœ… Magic Link å·²ç™¼é€è‡³ ${email}<br>è«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±ä¸¦é»æ“Šé€£çµå®Œæˆè¨»å†Š/ç™»å…¥`, 'success');
                }
                
                // Clear email input
                document.getElementById('emailMagicLink').value = '';

            } catch (error) {
                console.error('Magic link error:', error);
                showAuthMessage(`âŒ ç™¼é€å¤±æ•—ï¼š${error.message}`, 'error');
            } finally {
                btnText.innerText = originalText;
            }
        }

        function showAuthMessage(message, type = 'info') {
            const msgContainer = document.getElementById('authMessage');
            const msgText = document.getElementById('authMessageText');
            
            msgText.innerHTML = message;
            msgContainer.classList.remove('hidden');
            
            if (type === 'success') {
                msgContainer.className = 'glass-panel p-6 rounded-[24px] text-center border border-green-500/20 bg-green-500/5';
            } else if (type === 'error') {
                msgContainer.className = 'glass-panel p-6 rounded-[24px] text-center border border-red-500/20 bg-red-500/5';
            } else {
                msgContainer.className = 'glass-panel p-6 rounded-[24px] text-center';
            }
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                msgContainer.classList.add('hidden');
            }, 5000);
        }

        function skipLogin() {
            console.log('âš ï¸ User skipped login - using local mode only');
            state.isLoggedIn = false;
            state.userId = null;
            showMainApp();
        }

        async function handleSignOut() {
            if (!supabaseClient) return;
            
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                console.log('âœ… Signed out successfully');
                state.isLoggedIn = false;
                state.userId = null;
                currentUser = null;
                
                // Show auth page
                showAuthPage();
                
            } catch (error) {
                console.error('âŒ Sign out error:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼š' + error.message);
            }
        }

        function showAuthPage() {
            document.getElementById('page-auth').classList.remove('hidden-page');
            document.getElementById('page-home').classList.add('hidden-page');
            document.getElementById('page-history').classList.add('hidden-page');
            document.getElementById('page-stats').classList.add('hidden-page');
            document.getElementById('page-settings').classList.add('hidden-page');
            document.getElementById('page-add').classList.add('hidden-page');
            document.getElementById('header-ui').classList.add('hidden');
            document.getElementById('nav-container').classList.add('hidden');
            
            // æª¢æ¸¬æ˜¯å¦åœ¨ iOS Standalone æ¨¡å¼ï¼ˆå¾ä¸»ç•«é¢é–‹å•Ÿï¼‰
            const isIOSStandalone = window.navigator.standalone === true || 
                                    (window.matchMedia('(display-mode: standalone)').matches && 
                                     /iPhone|iPad|iPod/.test(navigator.userAgent));
            
            const warningEl = document.getElementById('iosStandaloneWarning');
            if (isIOSStandalone && warningEl) {
                warningEl.classList.remove('hidden');
            } else if (warningEl) {
                warningEl.classList.add('hidden');
            }
            
            lucide.createIcons();
        }

        function showMainApp() {
            document.getElementById('page-auth').classList.add('hidden-page');
            document.getElementById('header-ui').classList.remove('hidden');
            document.getElementById('nav-container').classList.remove('hidden');
            nav('home');
        }

        // ============================================
        // Navigation
        // ============================================

        function nav(pageId) {
            const sections = ['home', 'history', 'stats', 'settings', 'add'];
            sections.forEach(s => document.getElementById(`page-${s}`).classList.add('hidden-page'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden-page');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${pageId}`)?.classList.add('active');

            if(pageId === 'add') {
                document.getElementById('header-ui').classList.add('hidden');
                document.getElementById('nav-container').classList.add('hidden');
            } else {
                document.getElementById('header-ui').classList.remove('hidden');
                document.getElementById('nav-container').classList.remove('hidden');
                lastPage = pageId;
            }

            if(pageId === 'home') renderHome();
            if(pageId === 'history') renderHistory();
            if(pageId === 'stats') renderStats();
            if(pageId === 'settings') renderSettings();
            lucide.createIcons();
        }

        function renderAll() { renderHome(); }

        function renderHome() {
            const now = new Date();
            const currentMonthStr = now.toISOString().slice(0, 7);
            const monthFiltered = state.transactions.filter(t => t.date.startsWith(currentMonthStr));
            
            // å°†æ‰€æœ‰äº¤æ˜“è½¬æ¢ä¸ºé¢„è®¾å¸ç§åè®¡ç®—æ€»æ”¯å‡º
            const totalSpent = monthFiltered.reduce((acc, curr) => {
                const txCurrency = curr.currency || state.currency; // ç›¸å®¹èˆŠè³‡æ–™
                const convertedAmount = convertCurrency(curr.amount, txCurrency, state.currency);
                return acc + convertedAmount;
            }, 0);
            
            const remaining = Math.max(0, state.budget - totalSpent);
            const percent = state.budget > 0 ? (remaining / state.budget) * 100 : 0;
            
            const symbol = getCurrencySymbol();
            // æ˜¾ç¤ºå‰©ä½™é¢„ç®—ï¼ˆå¤§å­—ï¼‰
            document.getElementById('displayRemaining').innerHTML = `${symbol}${Math.round(remaining).toLocaleString()}`;
            // æ˜¾ç¤ºå·²èŠ±è´¹
            document.getElementById('displaySpent').innerHTML = `${symbol}${Math.round(totalSpent).toLocaleString()}`;
            // æ˜¾ç¤ºæ€»é¢„ç®—
            document.getElementById('displayBudgetLimit').innerHTML = `${symbol}${state.budget.toLocaleString()}`;
            
            const liquidEl = document.getElementById('liquidLevel');
            liquidEl.style.height = percent + '%';
            
            // æ ¹æ“šé ç®—ç‹€æ…‹å‹•æ…‹æ”¹è®Šæ¶²é«”é¡è‰²å’Œç‹€æ…‹æ–‡å­—
            let colorDark, colorMid, colorLight, statusText, statusColor;
            if(percent > 60) {
                // å¥åº·ç‹€æ…‹ - ç¶ è‰²
                colorDark = '#059669';
                colorMid = '#10b981';
                colorLight = '#34d399';
                statusText = "Status: Healthy";
                statusColor = '#10b981';
            } else if(percent > 40) {
                // OK ç‹€æ…‹ - è—ç¶ è‰²
                colorDark = '#0891b2';
                colorMid = '#06b6d4';
                colorLight = '#22d3ee';
                statusText = "Status: OK";
                statusColor = '#06b6d4';
            } else if(percent > 20) {
                // è­¦å‘Šç‹€æ…‹ - æ©™è‰²
                colorDark = '#c2410c';
                colorMid = '#ea580c';
                colorLight = '#fb923c';
                statusText = "Status: Warning";
                statusColor = '#ea580c';
            } else if(percent > 0) {
                // å±éšªç‹€æ…‹ - ç´…è‰²
                colorDark = '#b91c1c';
                colorMid = '#dc2626';
                colorLight = '#f87171';
                statusText = "Status: Warning";
                statusColor = '#dc2626';
            } else {
                // è€—ç›¡ç‹€æ…‹ - æ·±ç´…è‰²
                colorDark = '#7f1d1d';
                colorMid = '#991b1b';
                colorLight = '#b91c1c';
                statusText = "Status: Depleted";
                statusColor = '#991b1b';
            }
            
            document.documentElement.style.setProperty('--liquid-color-dark', colorDark);
            document.documentElement.style.setProperty('--liquid-color-mid', colorMid);
            document.documentElement.style.setProperty('--liquid-color-light', colorLight);
            
            const msgEl = document.getElementById('budgetMessage');
            msgEl.innerText = statusText;
            msgEl.style.color = statusColor;

            const recent = state.transactions.slice(0, 5);
            document.getElementById('recentList').innerHTML = recent.length ? recent.map(t => {
                const txCurrency = t.currency || state.currency;
                const txSymbol = CURRENCY_OPTIONS.find(c => c.id === txCurrency)?.symbol || symbol;
                return `
                <div onclick="editTx(${t.id})" class="glass-panel p-4 flex justify-between items-center rounded-2xl active:scale-95 transition-transform cursor-pointer">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${t.icon}</span>
                        <div>
                            <div class="text-[11px] font-bold text-white">${t.note || t.category}</div>
                            <div class="text-[8px] font-black text-white/20 uppercase">${t.date}</div>
                        </div>
                    </div>
                    <div class="text-xs font-black">-${txSymbol}${t.amount.toLocaleString()}</div>
                </div>
                `;
            }).join('') : '<div class="text-center py-4 text-white/10 text-xs uppercase tracking-widest">No activities</div>';
        }

        function renderHistory(filterCategory = null) {
            const symbol = getCurrencySymbol();
            const month = document.getElementById('histMonth').value;
            let filtered = state.transactions.filter(t => t.date.startsWith(month));
            if(filterCategory) filtered = filtered.filter(t => t.category === filterCategory);

            const groups = {};
            filtered.forEach(t => {
                if(!groups[t.date]) groups[t.date] = { total: 0, items: [] };
                // è½¬æ¢ä¸ºé¢„è®¾å¸ç§ç´¯è®¡
                const txCurrency = t.currency || state.currency;
                const convertedAmount = convertCurrency(t.amount, txCurrency, state.currency);
                groups[t.date].total += convertedAmount;
                groups[t.date].items.push(t);
            });

            const sortedDates = Object.keys(groups).sort((a,b) => b.localeCompare(a));
            const container = document.getElementById('historyAccordion');
            
            if(sortedDates.length === 0) {
                container.innerHTML = `<div class="text-center py-20 opacity-20 text-[10px] font-black tracking-widest uppercase">No data found</div>`;
                return;
            }

            container.innerHTML = sortedDates.map(date => {
                const dayData = groups[date];
                const dayObj = new Date(date);
                const weekDay = dayObj.toLocaleDateString('zh-TW', { weekday: 'short' });
                const dayNum = dayObj.getDate();
                const isOpen = filterCategory ? 'open' : '';
                return `
                    <div class="day-card glass-panel rounded-[24px] p-4 ${isOpen}" onclick="toggleAccordion(this)">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-white/5 flex flex-col items-center justify-center border border-white/5">
                                    <span class="text-[8px] font-black text-white/40 uppercase">${weekDay}</span>
                                    <span class="text-sm font-black text-white">${dayNum}</span>
                                </div>
                                <div><div class="text-[10px] font-black text-white/40 uppercase tracking-tighter">${date}</div><div class="text-xs font-bold text-white/80">${dayData.items.length} ç­†</div></div>
                            </div>
                            <div class="flex items-center gap-3"><span class="text-sm font-black text-white">${symbol}${Math.round(dayData.total).toLocaleString()}</span><i data-lucide="chevron-down" class="chevron-icon w-4 h-4 text-white/20 transition-transform"></i></div>
                        </div>
                        <div class="day-items-container space-y-2">
                            ${dayData.items.map(t => {
                                const txCurrency = t.currency || state.currency;
                                const txSymbol = CURRENCY_OPTIONS.find(c => c.id === txCurrency)?.symbol || symbol;
                                return `
                                <div onclick="event.stopPropagation(); editTx(${t.id})" class="history-item-row flex justify-between items-center p-3 bg-white/[0.03] rounded-xl cursor-pointer">
                                    <div class="flex items-center gap-3"><span class="text-base">${t.icon}</span><span class="text-[11px] font-bold text-white/70">${t.note || t.category}</span></div>
                                    <span class="text-xs font-bold text-white">-${txSymbol}${t.amount.toLocaleString()}</span>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function toggleAccordion(card) { card.classList.toggle('open'); }

        function renderStats() {
            const month = document.getElementById('statsMonth').value;
            const dataMap = {};
            let total = 0;
            state.transactions.filter(t => t.date.startsWith(month)).forEach(t => {
                // è½¬æ¢ä¸ºé¢„è®¾å¸ç§åç»Ÿè®¡
                const txCurrency = t.currency || state.currency;
                const convertedAmount = convertCurrency(t.amount, txCurrency, state.currency);
                dataMap[t.category] = (dataMap[t.category] || 0) + convertedAmount;
                total += convertedAmount;
            });
            const labels = Object.keys(dataMap);
            const values = Object.values(dataMap);
            const colors = labels.map(l => state.categories.find(c => c.name === l)?.color || '#555');
            const chartEl = document.getElementById('mainChart');
            const noDataEl = document.getElementById('noDataStats');
            if(total === 0) {
                chartEl.classList.add('hidden'); noDataEl.classList.remove('hidden');
                document.getElementById('statsLegend').innerHTML = "";
                if(myChart) myChart.destroy(); return;
            }
            chartEl.classList.remove('hidden'); noDataEl.classList.add('hidden');
            const ctx = chartEl.getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        data: values, 
                        backgroundColor: colors, 
                        borderWidth: 2,
                        borderColor: 'rgba(255, 255, 255, 0.15)',
                        hoverBorderWidth: 3,
                        hoverBorderColor: 'rgba(255, 255, 255, 0.5)',
                        borderRadius: 8,
                        spacing: 2,
                        hoverOffset: 8
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1200,
                        easing: 'easeInOutCubic'
                    },
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            padding: 16,
                            displayColors: true,
                            boxPadding: 8,
                            callbacks: {
                                label: (context) => {
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${symbol}${context.parsed.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: { 
                            color: '#ffffff',
                            font: { weight: '900', size: 10, family: 'monospace' },
                            formatter: (v, context) => {
                                const percentage = ((v/total)*100);
                                const label = context.chart.data.labels[context.dataIndex];
                                // æ˜¾ç¤ºåç§°å’Œç™¾åˆ†æ¯”ï¼ˆæ‰€æœ‰é¡¹ç›®éƒ½æ˜¾ç¤ºï¼‰
                                if(percentage < 5) {
                                    return `${percentage.toFixed(0)}%`; // å°äº5%åªæ˜¾ç¤ºç™¾åˆ†æ¯”
                                }
                                return `${label}\n${percentage.toFixed(1)}%`;
                            },
                            textAlign: 'center',
                            anchor: 'end',
                            align: 'start',
                            offset: 8,
                            textStrokeColor: 'rgba(0, 0, 0, 0.8)',
                            textStrokeWidth: 3,
                            padding: 4
                        } 
                    }, 
                    cutout: '55%',
                    radius: '90%'
                }
            });
            const symbol = getCurrencySymbol();
            document.getElementById('statsLegend').innerHTML = Object.entries(dataMap).sort((a,b)=>b[1]-a[1]).map(([name, val]) => {
                const cat = state.categories.find(c => c.name === name);
                return `<div class="stats-item-card glass-panel p-4 rounded-2xl flex justify-between items-center" onclick="nav('history'); document.getElementById('histMonth').value='${month}'; renderHistory('${name}')">
                    <div class="flex items-center gap-3"><span>${cat?.icon || 'â“'}</span><span class="text-xs font-bold">${name}</span></div>
                    <span class="text-xs font-black">${symbol}${Math.round(val).toLocaleString()}</span>
                </div>`;
            }).join('');
        }

        function prepareAdd() {
            state.editingId = null; 
            state.tempCat = state.categories[0].name;
            state.tempCurrency = state.currency; // é è¨­ä½¿ç”¨ä½¿ç”¨è€…è¨­å®šçš„å¹£ç¨®
            document.getElementById('formAmount').value = ""; 
            document.getElementById('formNote').value = "";
            document.getElementById('formDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('deleteBtn').classList.add('hidden');
            renderFormCurrencyGrid();
            renderFormCatGrid(); 
            nav('add');
        }

        function editTx(id) {
            const tx = state.transactions.find(t => t.id === id);
            if(!tx) return;
            state.editingId = id; 
            state.tempCat = tx.category;
            state.tempCurrency = tx.currency || state.currency; // ç›¸å®¹èˆŠè³‡æ–™
            document.getElementById('formAmount').value = tx.amount;
            document.getElementById('formNote').value = tx.note;
            document.getElementById('formDate').value = tx.date;
            document.getElementById('deleteBtn').classList.remove('hidden');
            renderFormCurrencyGrid();
            renderFormCatGrid(); 
            nav('add');
        }

        function renderFormCurrencyGrid() {
            document.getElementById('formCurrencyGrid').innerHTML = CURRENCY_OPTIONS.map(c => `
                <button onclick="selectFormCurrency('${c.id}')" class="flex flex-col items-center p-3 rounded-xl transition-all ${state.tempCurrency === c.id ? 'dynamic-accent-bg text-black' : 'bg-white/5 text-white/30'}">
                    <span class="text-xl mb-1">${c.flag}</span>
                    <span class="text-[8px] font-black">${c.id}</span>
                </button>
            `).join('');
        }

        function selectFormCurrency(currencyId) {
            state.tempCurrency = currencyId;
            const currObj = CURRENCY_OPTIONS.find(c => c.id === currencyId);
            if(currObj) {
                document.getElementById('currencySymbolAdd').innerText = currObj.symbol;
            }
            renderFormCurrencyGrid();
        }

        function renderFormCatGrid() {
            document.getElementById('formCatGrid').innerHTML = state.categories.map(c => `
                <button onclick="state.tempCat='${c.name}'; renderFormCatGrid()" class="flex flex-col items-center p-3 rounded-2xl ${state.tempCat === c.name ? 'dynamic-accent-bg text-black' : 'bg-white/5 text-white/30'}">
                    <span class="text-xl">${c.icon}</span><span class="text-[8px] font-black uppercase truncate w-full">${c.name}</span>
                </button>
            `).join('');
        }

        async function saveTransaction() {
            const amt = parseFloat(document.getElementById('formAmount').value);
            const date = document.getElementById('formDate').value;
            if(!amt || !date) return;
            const catObj = state.categories.find(c => c.name === state.tempCat);
            const data = { 
                id: state.editingId || Date.now(), 
                amount: amt, 
                currency: state.tempCurrency || state.currency,
                date: date, 
                note: document.getElementById('formNote').value, 
                category: state.tempCat, 
                icon: catObj.icon,
                updated_at: new Date().toISOString(),
                is_deleted: false  // ç¡®ä¿æ–°è®°å½•æ ‡è®°ä¸ºæœªåˆ é™¤
            };
            
            // ä¿å­˜åˆ°æœ¬åœ° IndexedDB
            try {
                await localDB.put('transactions', data);
                
                // æ›´æ–° state
                if(state.editingId) {
                    const idx = state.transactions.findIndex(t => t.id === state.editingId);
                    state.transactions[idx] = data;
                } else {
                    state.transactions.unshift(data);
                }
                state.transactions.sort((a,b) => b.date.localeCompare(a.date));
                
                // å¤‡ä»½åˆ° localStorage
                localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
                
                // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®
                
            } catch (error) {
                console.error('âŒ Failed to save transaction:', error);
                // å›é€€åˆ° localStorage
                if(state.editingId) {
                    const idx = state.transactions.findIndex(t => t.id === state.editingId);
                    state.transactions[idx] = data;
                } else {
                    state.transactions.unshift(data);
                }
                state.transactions.sort((a,b) => b.date.localeCompare(a.date));
                localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
            }
            
            await save();
            nav('home');
        }

        async function deleteCurrentTx() {
            if (!state.editingId) return;
            
            try {
                // è½¯åˆ é™¤ï¼šæ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œè€Œä¸æ˜¯çœŸæ­£åˆ é™¤
                const tx = await localDB.get('transactions', state.editingId);
                if (tx) {
                    tx.is_deleted = true;
                    tx.updated_at = new Date().toISOString();
                    await localDB.put('transactions', tx);
                    
                    // æ›´æ–° stateï¼ˆä»æ˜¾ç¤ºä¸­ç§»é™¤ï¼Œä½†ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼‰
                    state.transactions = state.transactions.filter(t => t.id !== state.editingId);
                    
                    // å¤‡ä»½åˆ° localStorageï¼ˆè¿‡æ»¤æ‰å·²åˆ é™¤çš„ï¼‰
                    localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
                } else {
                    // å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œç›´æ¥ä» state ä¸­ç§»é™¤
                    state.transactions = state.transactions.filter(t => t.id !== state.editingId);
                    localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
                }
                
                // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®
                
            } catch (error) {
                console.error('âŒ Failed to delete transaction:', error);
                // å›é€€åˆ° localStorage
                state.transactions = state.transactions.filter(t => t.id !== state.editingId);
                localStorage.setItem('ledger_tx_v13', JSON.stringify(state.transactions));
            }
            
            await save();
            nav('home');
        }

        function renderSettings() {
            document.getElementById('budgetInput').value = state.budget;
            document.getElementById('themePicker').innerHTML = THEME_SCHEMES.map(s => `<div onclick="applyTheme('${s.id}').then(() => renderSettings())" class="theme-dot ${state.themeId === s.id ? 'active' : ''}" style="background-color: ${s.color}; color: ${s.color}"></div>`).join('');
            document.getElementById('currencyPicker').innerHTML = CURRENCY_OPTIONS.map(c => `
                <button onclick="changeCurrency('${c.id}')" class="flex flex-col items-center p-4 rounded-2xl transition-all ${state.currency === c.id ? 'dynamic-accent-bg text-black' : 'bg-white/5 text-white/50 hover:bg-white/10'}" type="button">
                    <span class="text-2xl mb-1">${c.flag}</span>
                    <span class="text-[9px] font-black">${c.id}</span>
                </button>
            `).join('');
            document.getElementById('settingsCatList').innerHTML = state.categories.map(c => `<div class="flex justify-between p-3 bg-white/5 rounded-xl"><span>${c.icon} ${c.name}</span><button onclick="deleteCat('${c.name}')"><i data-lucide="trash-2" class="w-3 h-3 text-white/20"></i></button></div>`).join('');
            
            // æ›´æ–°ç™»å…¥ç‹€æ…‹æ˜¾ç¤º
            updateAuthUI();
            
            // æ›´æ–°åŒæ­¥çŠ¶æ€
            updateSyncUI();
            
            lucide.createIcons();
        }

        function updateAuthUI() {
            const authStatusText = document.getElementById('authStatusText');
            const authActionBtn = document.getElementById('authActionBtn');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const userEmailEl = document.getElementById('userEmail');
            const syncInfoPanel = document.getElementById('syncInfoPanel');
            const localDataCount = document.getElementById('localDataCount');

            // æ›´æ–°æœ¬åœ°è³‡æ–™çµ±è¨ˆ
            if (localDataCount) {
                localDataCount.innerText = `${state.transactions.length} ç­†äº¤æ˜“`;
            }

            if (state.isLoggedIn && currentUser) {
                // å·²ç™»å…¥ç‹€æ…‹
                authStatusText.innerText = 'âœ… å·²ç™»å…¥';
                authStatusText.className = 'text-green-400 font-black';
                userEmailDisplay.classList.remove('hidden');
                userEmailEl.innerText = currentUser.email || 'Unknown';
                syncInfoPanel.classList.remove('hidden');
                authActionBtn.innerHTML = 'ğŸšª ç™»å‡ºå¸³æˆ¶';
                authActionBtn.onclick = handleSignOut;
            } else {
                // æœªç™»å…¥ç‹€æ…‹
                authStatusText.innerText = 'æœ¬åœ°æ¨¡å¼';
                authStatusText.className = 'text-white/60 font-black';
                userEmailDisplay.classList.add('hidden');
                syncInfoPanel.classList.add('hidden');
                authActionBtn.innerHTML = 'ğŸ” ç™»å…¥é›²ç«¯å¸³æˆ¶';
                authActionBtn.onclick = showAuthPage;
            }
        }

        async function changeCurrency(currencyId) {
            state.currency = currencyId;
            await save();
            updateCurrencySymbols();
            renderSettings();
            renderHome();
        }

        async function saveSettings() {
            state.budget = parseFloat(document.getElementById('budgetInput').value) || state.budget;
            await save();
            
            // ä¸å†è‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥æŒ‰é’®
            
            nav('home');
        }
        
        function openCatModal() { 
            document.getElementById('catModal').classList.remove('hidden'); 
            state.tempEmoji = null;
            updateCatConfirmBtn();
            document.getElementById('emojiPicker').innerHTML = EMOJI_POOL.map(e => `
                <button onclick="selectEmoji(this, '${e}')" class="emoji-item">${e}</button>
            `).join(''); 
        }

        function selectEmoji(el, emoji) {
            document.querySelectorAll('.emoji-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            state.tempEmoji = emoji;
            updateCatConfirmBtn();
        }

        function updateCatConfirmBtn() {
            const btn = document.getElementById('confirmCatBtn');
            if(state.tempEmoji) {
                btn.classList.remove('opacity-30', 'pointer-events-none');
                btn.innerText = "å„²å­˜";
                btn.onclick = confirmAddCategory;
            } else {
                btn.classList.add('opacity-30', 'pointer-events-none');
                btn.innerText = "è«‹é¸æ“‡åœ–ç¤º";
            }
        }

        function closeCatModal() { document.getElementById('catModal').classList.add('hidden'); }
        
        function showCloudInfoModal() { 
            document.getElementById('cloudInfoModal').classList.remove('hidden'); 
            lucide.createIcons(); // é‡æ–°æ¸²æŸ“åœ–ç¤º
        }
        
        function closeCloudInfoModal() { 
            document.getElementById('cloudInfoModal').classList.add('hidden'); 
        }

        // ============================================
        // Login Code Functions
        // ============================================
        
        function generateLoginCode() {
            // ç”Ÿæˆ 6 ä½æ•¸å¤§å¯«å­—æ¯+æ•¸å­—ä»£ç¢¼
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // æ’é™¤å®¹æ˜“æ··æ·†çš„å­—ç¬¦ (0,O,1,I)
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function showLoginCodeModal() {
            if (!currentUser || !state.isLoggedIn) {
                alert('è«‹å…ˆç™»å…¥å¸³æˆ¶');
                return;
            }

            if (!supabaseClient) {
                alert('âš ï¸ Supabase æœªé…ç½®ï¼Œç„¡æ³•ä½¿ç”¨æ­¤åŠŸèƒ½');
                return;
            }

            const modal = document.getElementById('loginCodeModal');
            const codeDisplay = document.getElementById('displayLoginCode');
            
            try {
                codeDisplay.innerText = 'ç”Ÿæˆä¸­...';
                
                // ç²å–ç•¶å‰ session
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError || !session) {
                    throw new Error('ç„¡æ³•ç²å–ç™»å…¥ session');
                }
                
                // ç”Ÿæˆæ–°ä»£ç¢¼
                const loginCode = generateLoginCode();
                const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10 åˆ†é˜å¾ŒéæœŸ
                
                // å„²å­˜åˆ° Supabase
                const { error: insertError } = await supabaseClient
                    .from('login_codes')
                    .insert({
                        code: loginCode,
                        user_id: currentUser.id,
                        email: currentUser.email,
                        access_token: session.access_token,
                        refresh_token: session.refresh_token,
                        expires_at: expiresAt.toISOString()
                    });
                
                if (insertError) {
                    console.error('Insert code error:', insertError);
                    throw new Error('å„²å­˜ç™»å…¥ä»£ç¢¼å¤±æ•—ï¼š' + insertError.message);
                }
                
                // é¡¯ç¤ºä»£ç¢¼
                codeDisplay.innerText = loginCode;
                
                // é»æ“Šä»£ç¢¼è¤‡è£½
                codeDisplay.onclick = () => {
                    navigator.clipboard.writeText(loginCode).then(() => {
                        const originalText = codeDisplay.innerText;
                        codeDisplay.innerText = 'âœ… å·²è¤‡è£½';
                        setTimeout(() => {
                            codeDisplay.innerText = originalText;
                        }, 1500);
                    }).catch(err => {
                        // Fallback: æ‰‹å‹•é¸å–
                        const range = document.createRange();
                        range.selectNodeContents(codeDisplay);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        alert('å·²é¸å–ä»£ç¢¼ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼ˆCtrl+C æˆ– Cmd+Cï¼‰');
                    });
                };
                
                modal.classList.remove('hidden');
                lucide.createIcons();
                
            } catch (error) {
                console.error('Generate code error:', error);
                alert('ç”¢ç”Ÿç™»å…¥ä»£ç¢¼å¤±æ•—ï¼š' + error.message);
                codeDisplay.innerText = '------';
            }
        }

        function closeLoginCodeModal() {
            document.getElementById('loginCodeModal').classList.add('hidden');
        }

        async function verifyLoginCode() {
            if (!supabaseClient) {
                showAuthMessage('âš ï¸ Supabase æœªé…ç½®ï¼Œç„¡æ³•ä½¿ç”¨æ­¤åŠŸèƒ½', 'error');
                return;
            }

            const codeInput = document.getElementById('loginCode').value.trim().toUpperCase();
            
            if (!codeInput || codeInput.length !== 6) {
                showAuthMessage('âŒ è«‹è¼¸å…¥ 6 ä½æ•¸ä»£ç¢¼', 'error');
                return;
            }

            const btnText = document.getElementById('btnVerifyCode');
            const originalText = btnText.innerText;
            btnText.innerText = 'ğŸ”„ é©—è­‰ä¸­...';

            try {
                // å¾ Supabase æŸ¥è©¢ä»£ç¢¼
                const { data: codeData, error: fetchError } = await supabaseClient
                    .from('login_codes')
                    .select('*')
                    .eq('code', codeInput)
                    .is('used_at', null)
                    .gt('expires_at', new Date().toISOString())
                    .single();
                
                if (fetchError || !codeData) {
                    console.error('Fetch code error:', fetchError);
                    throw new Error('ç™»å…¥ä»£ç¢¼ç„¡æ•ˆæˆ–å·²éæœŸã€‚è«‹ç¢ºèªä»£ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–é‡æ–°ç”¢ç”Ÿã€‚');
                }

                // ä»£ç¢¼æ­£ç¢ºï¼ä½¿ç”¨ access_token å’Œ refresh_token ä¾†è¨­å®š session
                showAuthMessage('âœ… ä»£ç¢¼é©—è­‰æˆåŠŸï¼æ­£åœ¨ç™»å…¥...', 'success');
                
                // ä½¿ç”¨ setSession æ–¹æ³•ä¾†ç™»å…¥
                const { data: sessionData, error: sessionError } = await supabaseClient.auth.setSession({
                    access_token: codeData.access_token,
                    refresh_token: codeData.refresh_token
                });

                if (sessionError) throw sessionError;

                // æ¨™è¨˜ä»£ç¢¼ç‚ºå·²ä½¿ç”¨
                await supabaseClient
                    .from('login_codes')
                    .update({ used_at: new Date().toISOString() })
                    .eq('code', codeInput);

                // ç™»å…¥æˆåŠŸ
                currentUser = sessionData.user;
                state.isLoggedIn = true;
                state.userId = currentUser.id;
                
                showAuthMessage(`âœ… ç™»å…¥æˆåŠŸï¼<br><br>
                    <div class="text-left bg-green-500/10 border border-green-500/30 rounded-xl p-4 mt-3">
                        <p class="text-[10px] font-black text-green-400 uppercase mb-2">ğŸ‰ æ­¡è¿å›ä¾†</p>
                        <p class="text-[11px] text-white mb-2">Email: ${codeData.email}</p>
                    </div>`, 'success');
                
                // æ¸…ç©ºè¼¸å…¥
                document.getElementById('loginCode').value = '';
                
                // è·³è½‰åˆ°ä¸»é é¢ï¼ˆä»äº‘ç«¯æ‹‰å–æ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰è®¾å¤‡æ•°æ®ä¸€è‡´ï¼‰
                setTimeout(async () => {
                    if (syncManager) {
                        // ä»äº‘ç«¯æ‹‰å–æ•°æ®ï¼ˆç¡®ä¿æ‰€æœ‰è®¾å¤‡æ•°æ®ä¸€è‡´ï¼Œä½†ä¸è‡ªåŠ¨ä¸Šä¼ ï¼‰
                        try {
                            console.log('ğŸ”„ Pulling data from cloud after code login to ensure consistency...');
                            await syncManager.syncFromCloud();
                            await loadDataFromLocal();
                            console.log('âœ… Data pulled from cloud. All devices will show the same data.');
                        } catch (error) {
                            console.warn('âš ï¸ Failed to pull data from cloud:', error);
                            await loadDataFromLocal();
                        }
                    }
                    showMainApp();
                    renderAll();
                    updateAuthStatusInSettings();
                }, 1500);

            } catch (error) {
                console.error('Code verification error:', error);
                showAuthMessage(`âŒ ${error.message}`, 'error');
            } finally {
                btnText.innerText = originalText;
            }
        }
        
        async function confirmAddCategory() { 
            const name = document.getElementById('newCatName').value.trim(); 
            if(!name || !state.tempEmoji) return; 
            const newCategory = { 
                name, 
                icon: state.tempEmoji, 
                color: '#'+Math.floor(Math.random()*16777215).toString(16),
                updated_at: new Date().toISOString()
            };
            state.categories.push(newCategory);
            
            // ä¿å­˜åˆ° IndexedDB
            try {
                const catId = crypto.randomUUID();
                await localDB.put('categories', {
                    id: catId,
                    name: newCategory.name,
                    icon: newCategory.icon,
                    color: newCategory.color,
                    updated_at: newCategory.updated_at
                });
            } catch (error) {
                console.error('Failed to save category:', error);
            }
            
            await save(); 
            renderSettings(); 
            closeCatModal(); 
            document.getElementById('newCatName').value = "";
        }

        async function deleteCat(name) { 
            if(state.categories.length > 1) { 
                // å…ˆæ‰¾åˆ°è¦åˆ é™¤çš„åˆ†ç±»ï¼ˆåœ¨è¿‡æ»¤ä¹‹å‰ï¼‰
                const catToDelete = state.categories.find(c => c.name === name);
                
                // ä» state ä¸­åˆ é™¤åˆ†ç±»
                state.categories = state.categories.filter(c => c.name !== name); 
                
                // ä» IndexedDB åˆ é™¤åˆ†ç±»
                if (catToDelete && catToDelete.id) {
                    try {
                        await localDB.delete('categories', catToDelete.id);
                    } catch (error) {
                        console.warn('Failed to delete category from IndexedDB:', error);
                    }
                }
                
                await save(); 
                renderSettings(); 
            } 
        }
        function clearAllData() { if(confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰æ•¸æ“šï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
