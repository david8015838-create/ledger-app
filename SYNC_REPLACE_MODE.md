# 🔄 同步模式变更：完全替换模式

## 📋 变更说明

### 之前的模式：双向合并
- 从云端拉取数据时，会合并本地和云端的数据
- 如果同一笔交易在本地和云端都有，会比较 `updated_at`，保留较新的
- 结果：B手机 = B手机原有数据 + A手机数据（合并）

### 现在的模式：完全替换
- 从云端拉取数据时，**完全清除本地数据**，然后用云端数据替换
- 结果：B手机 = A手机的数据（完全一致）

## ✅ 修改内容

### 1. `syncFromCloud()` 函数

#### 交易记录 (Transactions)
- **之前**: 使用 `mergeTransactions()` 合并本地和云端数据
- **现在**: 
  1. 先清除本地所有交易记录：`await this.localDB.clear('transactions')`
  2. 然后用云端数据完全替换

#### 分类 (Categories)
- **之前**: 只添加/更新分类，不删除本地不存在的分类
- **现在**: 
  1. 先清除本地所有分类：`await this.localDB.clear('categories')`
  2. 然后用云端分类完全替换
  3. 如果云端没有分类，清除本地分类

#### 信用卡 (Credit Cards)
- **之前**: 只更新/添加信用卡
- **现在**: 
  1. 完全替换为云端信用卡数据
  2. 如果云端没有信用卡，清除本地信用卡

#### 每月固定消费 (Recurring Transactions)
- **之前**: 只更新/添加
- **现在**: 
  1. 完全替换为云端数据
  2. 如果云端没有，清除本地数据

#### 用户设置 (User Settings)
- **之前**: 检查更新时间，只更新较新的版本
- **现在**: 
  1. 完全替换为云端设置（不检查更新时间）
  2. 如果云端没有设置，使用默认值

## 🎯 同步流程

### 场景：A手机同步到B手机

1. **A手机操作**：
   - 添加/修改数据
   - 点击"立即同步到云端"
   - 数据上传到 Supabase

2. **B手机操作**：
   - 登录账号
   - 点击"立即同步到云端"（或等待自动同步）
   - `syncFromCloud()` 执行：
     - 清除B手机的所有本地数据
     - 用A手机的数据（从云端拉取）完全替换
   - 结果：B手机的数据和A手机完全一致

## ⚠️ 重要提示

### 数据安全
- **上传时（syncToCloud）**：仍然使用双向合并，确保不丢失数据
- **下载时（syncFromCloud）**：完全替换，确保所有设备数据一致

### 注意事项
1. **B手机原有的本地数据会被清除**
   - 如果B手机有未同步的数据，这些数据会丢失
   - 建议：在同步前，确保所有设备都已同步到云端

2. **云端是唯一数据源**
   - 所有设备的数据都来自云端
   - 最后同步的设备数据会覆盖其他设备

3. **删除操作会同步**
   - 如果A手机删除了某笔交易，B手机同步后也会删除
   - 因为同步时会拉取 `is_deleted: true` 的记录

## 📝 技术细节

### 修改的函数
- `syncFromCloud()` - 完全替换模式
- `syncToCloud()` - 保持双向合并模式（上传时合并，确保不丢失）

### 数据流程
```
A手机 → 同步到云端 → Supabase
                              ↓
B手机 ← 从云端拉取（完全替换）← Supabase
```

## ✅ 测试步骤

1. **在A手机**：
   - 添加几笔交易
   - 添加信用卡
   - 修改预算、币值、主题
   - 点击"立即同步到云端"

2. **在B手机**：
   - 确保B手机有一些不同的数据（用于测试）
   - 登录账号
   - 点击"立即同步到云端"
   - 检查：
     - B手机的数据应该和A手机完全一致
     - B手机原有的不同数据应该被清除

## 🎉 完成

现在同步功能使用完全替换模式，确保所有设备的数据完全一致！
