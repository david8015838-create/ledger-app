<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨é¢åŒæ­¥æµ‹è¯•å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4ade80;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #a0a0a0;
            margin-bottom: 30px;
        }
        .test-section {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .test-section h2 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .test-item {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #3b82f6;
        }
        .test-item h3 {
            color: #fff;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .button {
            background: #4ade80;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s;
        }
        .button:hover {
            background: #22c55e;
            transform: translateY(-2px);
        }
        .button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .button-secondary {
            background: #3b82f6;
        }
        .button-secondary:hover {
            background: #2563eb;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.pending {
            background: #fbbf2420;
            color: #fbbf24;
        }
        .status.success {
            background: #22c55e20;
            color: #4ade80;
        }
        .status.error {
            background: #ef444420;
            color: #f87171;
        }
        .result-box {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            border: 1px solid #333;
            white-space: pre-wrap;
            color: #a0a0a0;
            max-height: 300px;
            overflow-y: auto;
        }
        .summary {
            background: #1a3a1a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #22c55e;
        }
        .summary h2 {
            color: #4ade80;
            margin-bottom: 15px;
        }
        .summary-item {
            margin: 8px 0;
            padding: 8px;
            background: #0a2a0a;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        th {
            background: #1a1a1a;
            color: #4ade80;
            font-weight: bold;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª å…¨é¢åŒæ­¥æµ‹è¯•å·¥å…·</h1>
        <p class="subtitle">æµ‹è¯•æ‰€æœ‰åŠŸèƒ½çš„ Supabase åŒæ­¥ï¼šå¸å€¼ã€ä¸»é¢˜è‰²ã€ä¿¡ç”¨å¡ã€é¢„ç®—ã€äº¤æ˜“ã€åˆ†ç±»</p>

        <div class="test-section">
            <h2>1. ç™»å½•çŠ¶æ€</h2>
            <button class="button" onclick="checkAuth()">æ£€æŸ¥ç™»å½•</button>
            <div id="authStatus"></div>
        </div>

        <div class="test-section">
            <h2>2. ç”¨æˆ·è®¾ç½®åŒæ­¥æµ‹è¯•</h2>
            <div class="test-item">
                <h3>é¢„ç®— (Budget)</h3>
                <button class="button" onclick="testBudgetSync()">æµ‹è¯•é¢„ç®—åŒæ­¥</button>
                <div id="budgetResult" class="result-box" style="display:none;"></div>
            </div>
            <div class="test-item">
                <h3>å¸å€¼ (Currency)</h3>
                <button class="button" onclick="testCurrencySync()">æµ‹è¯•å¸å€¼åŒæ­¥</button>
                <div id="currencyResult" class="result-box" style="display:none;"></div>
            </div>
            <div class="test-item">
                <h3>ä¸»é¢˜è‰² (Theme & Custom Theme)</h3>
                <button class="button" onclick="testThemeSync()">æµ‹è¯•ä¸»é¢˜åŒæ­¥</button>
                <div id="themeResult" class="result-box" style="display:none;"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>3. ä¿¡ç”¨å¡åŒæ­¥æµ‹è¯•</h2>
            <button class="button" onclick="testCreditCardSync()">æµ‹è¯•ä¿¡ç”¨å¡åŒæ­¥</button>
            <div id="cardResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>4. äº¤æ˜“è®°å½•åŒæ­¥æµ‹è¯•</h2>
            <button class="button" onclick="testTransactionSync()">æµ‹è¯•äº¤æ˜“åŒæ­¥</button>
            <div id="transactionResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>5. åˆ†ç±»åŒæ­¥æµ‹è¯•</h2>
            <button class="button" onclick="testCategorySync()">æµ‹è¯•åˆ†ç±»åŒæ­¥</button>
            <div id="categoryResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>6. å…¨é¢æµ‹è¯•</h2>
            <button class="button button-secondary" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <div id="allTestsResult" class="result-box" style="display:none;"></div>
        </div>

        <div id="summary" class="summary" style="display:none;">
            <h2>ğŸ“Š æµ‹è¯•æ€»ç»“</h2>
            <div id="summaryContent"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ndtkurowumazsgdotlxb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5kdGt1cm93dW1henNnZG90bHhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMzUwMzUsImV4cCI6MjA4MzgxMTAzNX0.tukEU-T8f8Sne7KRFOPBYgtlhalHWaPMJlZ_Qpa6J6E';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        const testResults = {};

        async function checkAuth() {
            const statusDiv = document.getElementById('authStatus');
            statusDiv.innerHTML = '<span class="loading"></span>æ£€æŸ¥ä¸­...';

            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    statusDiv.innerHTML = `<span class="status error">âŒ é”™è¯¯: ${error.message}</span>`;
                    return false;
                }

                if (!session || !session.user) {
                    statusDiv.innerHTML = '<span class="status error">âŒ æœªç™»å½•</span><br><br>è¯·å…ˆåœ¨ä¸»åº”ç”¨ä¸­ç™»å½•ï¼Œç„¶ååˆ·æ–°æ­¤é¡µé¢ã€‚';
                    return false;
                }

                currentUser = session.user;
                statusDiv.innerHTML = `<span class="status success">âœ… å·²ç™»å½•</span><br><br>ç”¨æˆ·ID: ${currentUser.id}<br>é‚®ç®±: ${currentUser.email || 'N/A'}`;
                return true;
            } catch (error) {
                statusDiv.innerHTML = `<span class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</span>`;
                return false;
            }
        }

        async function testBudgetSync() {
            if (!await ensureAuth()) return;
            const resultDiv = document.getElementById('budgetResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="loading"></span>æµ‹è¯•ä¸­...';

            try {
                // è¯»å–å½“å‰è®¾ç½®
                const { data: settings, error: readError } = await supabase
                    .from('user_settings')
                    .select('budget')
                    .eq('user_id', currentUser.id)
                    .single();

                if (readError && readError.code !== 'PGRST116') {
                    throw readError;
                }

                const currentBudget = settings?.budget || 30000;
                const testBudget = currentBudget === 50000 ? 60000 : 50000;

                // æµ‹è¯•å†™å…¥
                const { error: writeError } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: currentUser.id,
                        budget: testBudget,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (writeError) throw writeError;

                // éªŒè¯è¯»å–
                const { data: verifySettings, error: verifyError } = await supabase
                    .from('user_settings')
                    .select('budget')
                    .eq('user_id', currentUser.id)
                    .single();

                if (verifyError) throw verifyError;

                const success = verifySettings.budget == testBudget;
                testResults.budget = success;

                resultDiv.innerHTML = success 
                    ? `âœ… é¢„ç®—åŒæ­¥æµ‹è¯•æˆåŠŸï¼\n\nå½“å‰é¢„ç®—: ${verifySettings.budget}\næµ‹è¯•å€¼: ${testBudget}\n\nâœ… å†™å…¥æˆåŠŸ\nâœ… è¯»å–æˆåŠŸ\nâœ… æ•°æ®ä¸€è‡´`
                    : `âŒ é¢„ç®—åŒæ­¥æµ‹è¯•å¤±è´¥\n\næœŸæœ›: ${testBudget}\nå®é™…: ${verifySettings.budget}`;
            } catch (error) {
                testResults.budget = false;
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n\n${JSON.stringify(error, null, 2)}`;
            }
        }

        async function testCurrencySync() {
            if (!await ensureAuth()) return;
            const resultDiv = document.getElementById('currencyResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="loading"></span>æµ‹è¯•ä¸­...';

            try {
                const currencies = ['TWD', 'USD', 'SGD', 'JPY'];
                const { data: settings } = await supabase
                    .from('user_settings')
                    .select('currency')
                    .eq('user_id', currentUser.id)
                    .single();

                const currentCurrency = settings?.currency || 'TWD';
                const testCurrency = currencies.find(c => c !== currentCurrency) || 'USD';

                const { error } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: currentUser.id,
                        currency: testCurrency,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (error) throw error;

                const { data: verify } = await supabase
                    .from('user_settings')
                    .select('currency')
                    .eq('user_id', currentUser.id)
                    .single();

                const success = verify.currency === testCurrency;
                testResults.currency = success;

                resultDiv.innerHTML = success
                    ? `âœ… å¸å€¼åŒæ­¥æµ‹è¯•æˆåŠŸï¼\n\nå½“å‰å¸å€¼: ${verify.currency}\næµ‹è¯•å€¼: ${testCurrency}\n\nâœ… å†™å…¥æˆåŠŸ\nâœ… è¯»å–æˆåŠŸ\nâœ… æ•°æ®ä¸€è‡´`
                    : `âŒ å¸å€¼åŒæ­¥æµ‹è¯•å¤±è´¥\n\næœŸæœ›: ${testCurrency}\nå®é™…: ${verify.currency}`;
            } catch (error) {
                testResults.currency = false;
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        async function testThemeSync() {
            if (!await ensureAuth()) return;
            const resultDiv = document.getElementById('themeResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="loading"></span>æµ‹è¯•ä¸­...';

            try {
                const themes = ['minimal', 'ocean', 'forest', 'sunset'];
                const { data: settings } = await supabase
                    .from('user_settings')
                    .select('theme_id, custom_theme')
                    .eq('user_id', currentUser.id)
                    .single();

                const currentTheme = settings?.theme_id || 'minimal';
                const testTheme = themes.find(t => t !== currentTheme) || 'ocean';
                const testCustomTheme = {
                    color: '#ff6b6b',
                    rgb: '255, 107, 107',
                    opacity: 0.8,
                    bg: '#1a1a1a'
                };

                // æµ‹è¯•ä¸»é¢˜ID
                const { error: themeError } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: currentUser.id,
                        theme_id: testTheme,
                        custom_theme: testCustomTheme,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (themeError) throw themeError;

                // éªŒè¯
                const { data: verify } = await supabase
                    .from('user_settings')
                    .select('theme_id, custom_theme')
                    .eq('user_id', currentUser.id)
                    .single();

                const themeSuccess = verify.theme_id === testTheme;
                const customThemeSuccess = verify.custom_theme && verify.custom_theme.color === testCustomTheme.color;
                testResults.theme = themeSuccess && customThemeSuccess;

                resultDiv.innerHTML = testResults.theme
                    ? `âœ… ä¸»é¢˜åŒæ­¥æµ‹è¯•æˆåŠŸï¼\n\nä¸»é¢˜ID: ${verify.theme_id}\nè‡ªå®šä¹‰ä¸»é¢˜: ${JSON.stringify(verify.custom_theme, null, 2)}\n\nâœ… ä¸»é¢˜IDåŒæ­¥æˆåŠŸ\nâœ… è‡ªå®šä¹‰ä¸»é¢˜åŒæ­¥æˆåŠŸ`
                    : `âŒ ä¸»é¢˜åŒæ­¥æµ‹è¯•å¤±è´¥\n\nä¸»é¢˜ID: ${themeSuccess ? 'âœ…' : 'âŒ'}\nè‡ªå®šä¹‰ä¸»é¢˜: ${customThemeSuccess ? 'âœ…' : 'âŒ'}`;
            } catch (error) {
                testResults.theme = false;
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        async function testCreditCardSync() {
            if (!await ensureAuth()) return;
            const resultDiv = document.getElementById('cardResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="loading"></span>æµ‹è¯•ä¸­...';

            try {
                const testCard = {
                    id: 'test-card-' + Date.now(),
                    user_id: currentUser.id,
                    name: 'æµ‹è¯•ä¿¡ç”¨å¡',
                    closing_day: 15,
                    due_days_after: 7,
                    carrying_balance: 1000,
                    initial_balance: 0,
                    updated_at: new Date().toISOString(),
                    is_deleted: false
                };

                // å†™å…¥
                const { error: writeError } = await supabase
                    .from('credit_cards')
                    .upsert(testCard, { onConflict: 'id' });

                if (writeError) throw writeError;

                // è¯»å–
                const { data: cards, error: readError } = await supabase
                    .from('credit_cards')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('is_deleted', false);

                if (readError) throw readError;

                const found = cards.find(c => c.id === testCard.id);
                const success = found && found.name === testCard.name;
                testResults.creditCard = success;

                resultDiv.innerHTML = success
                    ? `âœ… ä¿¡ç”¨å¡åŒæ­¥æµ‹è¯•æˆåŠŸï¼\n\næ‰¾åˆ° ${cards.length} å¼ ä¿¡ç”¨å¡\næµ‹è¯•å¡: ${found.name}\nç»“è´¦æ—¥: ${found.closing_day}\n\nâœ… å†™å…¥æˆåŠŸ\nâœ… è¯»å–æˆåŠŸ\nâœ… æ•°æ®ä¸€è‡´`
                    : `âŒ ä¿¡ç”¨å¡åŒæ­¥æµ‹è¯•å¤±è´¥\n\næœŸæœ›æ‰¾åˆ°: ${testCard.name}\nå®é™…æ‰¾åˆ°: ${found ? found.name : 'æ— '}`;
            } catch (error) {
                testResults.creditCard = false;
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n\n${error.code === 'PGRST202' ? 'âš ï¸ credit_cards è¡¨å¯èƒ½ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰§è¡Œ SQL è¿ç§»' : ''}`;
            }
        }

        async function testTransactionSync() {
            if (!await ensureAuth()) return;
            const resultDiv = document.getElementById('transactionResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="loading"></span>æµ‹è¯•ä¸­...';

            try {
                const testTx = {
                    id: Math.floor(Date.now()),
                    user_id: currentUser.id,
                    amount: 100.50,
                    date: new Date().toISOString().split('T')[0],
                    note: 'æµ‹è¯•äº¤æ˜“',
                    category: 'æµ‹è¯•åˆ†ç±»',
                    icon: 'ğŸ§ª',
                    currency: 'TWD',
                    payment_method: 'cash',
                    updated_at: new Date().toISOString(),
                    is_deleted: false
                };

                // å†™å…¥
                const { error: writeError } = await supabase
                    .from('transactions')
                    .upsert(testTx, { onConflict: 'id' });

                if (writeError) throw writeError;

                // è¯»å–
                const { data: transactions, error: readError } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('id', testTx.id)
                    .single();

                if (readError) throw readError;

                const success = transactions && transactions.amount == testTx.amount;
                testResults.transaction = success;

                resultDiv.innerHTML = success
                    ? `âœ… äº¤æ˜“åŒæ­¥æµ‹è¯•æˆåŠŸï¼\n\näº¤æ˜“ID: ${transactions.id}\né‡‘é¢: ${transactions.amount}\næ—¥æœŸ: ${transactions.date}\nåˆ†ç±»: ${transactions.category}\n\nâœ… å†™å…¥æˆåŠŸ\nâœ… è¯»å–æˆåŠŸ\nâœ… æ•°æ®ä¸€è‡´`
                    : `âŒ äº¤æ˜“åŒæ­¥æµ‹è¯•å¤±è´¥`;
            } catch (error) {
                testResults.transaction = false;
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n\n${JSON.stringify(error, null, 2)}`;
            }
        }

        async function testCategorySync() {
            if (!await ensureAuth()) return;
            const resultDiv = document.getElementById('categoryResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="loading"></span>æµ‹è¯•ä¸­...';

            try {
                const testCategory = {
                    id: crypto.randomUUID(),
                    user_id: currentUser.id,
                    name: 'æµ‹è¯•åˆ†ç±»',
                    icon: 'ğŸ§ª',
                    color: '#ff6b6b',
                    updated_at: new Date().toISOString()
                };

                // å†™å…¥
                const { error: writeError } = await supabase
                    .from('categories')
                    .upsert(testCategory, { onConflict: 'id' });

                if (writeError) throw writeError;

                // è¯»å–
                const { data: categories, error: readError } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (readError) throw readError;

                const found = categories.find(c => c.id === testCategory.id);
                const success = found && found.name === testCategory.name;
                testResults.category = success;

                resultDiv.innerHTML = success
                    ? `âœ… åˆ†ç±»åŒæ­¥æµ‹è¯•æˆåŠŸï¼\n\næ‰¾åˆ° ${categories.length} ä¸ªåˆ†ç±»\næµ‹è¯•åˆ†ç±»: ${found.name}\nå›¾æ ‡: ${found.icon}\né¢œè‰²: ${found.color}\n\nâœ… å†™å…¥æˆåŠŸ\nâœ… è¯»å–æˆåŠŸ\nâœ… æ•°æ®ä¸€è‡´`
                    : `âŒ åˆ†ç±»åŒæ­¥æµ‹è¯•å¤±è´¥`;
            } catch (error) {
                testResults.category = false;
                resultDiv.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        async function runAllTests() {
            if (!await ensureAuth()) return;
            
            const resultDiv = document.getElementById('allTestsResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<span class="loading"></span>è¿è¡Œæ‰€æœ‰æµ‹è¯•...\n\n';

            const tests = [
                { name: 'é¢„ç®—', fn: testBudgetSync },
                { name: 'å¸å€¼', fn: testCurrencySync },
                { name: 'ä¸»é¢˜', fn: testThemeSync },
                { name: 'ä¿¡ç”¨å¡', fn: testCreditCardSync },
                { name: 'äº¤æ˜“', fn: testTransactionSync },
                { name: 'åˆ†ç±»', fn: testCategorySync }
            ];

            for (const test of tests) {
                resultDiv.innerHTML += `\næµ‹è¯• ${test.name}...\n`;
                await test.fn();
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // æ˜¾ç¤ºæ€»ç»“
            showSummary();
        }

        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const contentDiv = document.getElementById('summaryContent');
            summaryDiv.style.display = 'block';

            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r === true).length;
            const failed = total - passed;

            let html = `<div class="summary-item">æ€»è®¡: ${total} é¡¹æµ‹è¯•</div>`;
            html += `<div class="summary-item" style="color: #4ade80;">é€šè¿‡: ${passed} é¡¹ âœ…</div>`;
            html += `<div class="summary-item" style="color: ${failed > 0 ? '#f87171' : '#4ade80'};">å¤±è´¥: ${failed} é¡¹ ${failed > 0 ? 'âŒ' : ''}</div>`;
            html += '<br><table><tr><th>æµ‹è¯•é¡¹</th><th>çŠ¶æ€</th></tr>';

            for (const [key, value] of Object.entries(testResults)) {
                html += `<tr><td>${key}</td><td style="color: ${value ? '#4ade80' : '#f87171'}">${value ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</td></tr>`;
            }

            html += '</table>';

            contentDiv.innerHTML = html;
        }

        async function ensureAuth() {
            if (!currentUser) {
                const authOk = await checkAuth();
                if (!authOk) {
                    alert('è¯·å…ˆç™»å½•');
                    return false;
                }
            }
            return true;
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•
        window.addEventListener('load', () => {
            setTimeout(checkAuth, 500);
        });
    </script>
</body>
</html>
